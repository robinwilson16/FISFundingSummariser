CREATE OR ALTER PROCEDURE dbo.SPR_Run_FIS_FundingData
	@FISDatabase NVARCHAR(50),
	@AcademicYear NVARCHAR(5),
	@ILRReturn NVARCHAR(3),
	@IsFinalReturn BIT,
	@Mode NCHAR(1)
AS
BEGIN
	SET XACT_ABORT, NOCOUNT ON;

	/**************************************************
	 * Change/check values each time an import is run *
	 **************************************************/

	-- CHANGE THIS TO CORRECT RETURN
	--DECLARE @ILRReturn NVARCHAR(3) = 'R03' 

	-- IF FINAL RETURN SET THIS TO 1 - ensure only 1 return for each month is set to 1 for accurate year on year reporting
	--DECLARE @IsFinalReturn BIT = 1



	/***********************************************************************************
	 * Change values each year/month such as if ILR database is created as ILR2526_RXX *
	 ***********************************************************************************/

	--Name of the database created by the FIS software (default is ILRXXYY where XXYY is the return year)
	--DECLARE @FISDatabase NVARCHAR(100) = 'ILR2526' 

	--Academic year used for reporting outputs (e.g. XX/YY)
	--DECLARE @AcademicYear NVARCHAR(5) = '25/26' 



	/************************************************************
	 * Once set up values below should generally not be changed *
	 ************************************************************/

	--Split the funding into the 12 periods (default is 0 - 1 or 0)
	DECLARE @Split1619Funding BIT = 0 

	--Reapportion the 16-19 funding by the aim prog weighting factor (default is 0 - 1 or 0)
	DECLARE @Reapportion1619FundingByAimWeighting BIT = 0 

	--Move Apps Funding from Main ZProg to Main Component Aim so aim level fields can be used such as SSA (default is 1 - 1 or 0)
	DECLARE @AppsMoveFundingToMainComponentAim BIT = 1 

	--Deduct this percent from Total Cash Earned for FM25 and assign to ALS column (default is 0 - 1 or 0)
	DECLARE @1619ALSFundingPercent DECIMAL(5,2) = 0 

	--HE Gross Fee is only achieved if at all 3 SLC census points learners remain current (default is 0 - 1 or 0)
	DECLARE @IncludeHEAdvLoanPossibleIncome BIT = 0 

	--Adv Loan bursary income is not income as goes to learners so may want to exclude (default is 0 - 1 or 0)
	DECLARE @IncludeAdvLoanBursaryIncome BIT = 0 

	--Future achievement weighting factor. If 1 then is 100% of all remaining ach monies (default is 0 - decimal value)
	DECLARE @FutureAchievementWeighting DECIMAL(5,2) = 1

	--English and Maths Funding Rates from Allocation Statement
	DECLARE @EnglishMathsFundingHigherRate INT = 418
	DECLARE @EnglishMathsFundingLowerRate INT = 255

	--Core Maths Funding Rate from Allocation Statement
	DECLARE @CoreMathsPremiumFundingRate INT = 900

	--Block 2 Disadvantage Funding Rates from Allocation Statement
	DECLARE @Block2DisadvFundingTLevelRate INT = 825
	DECLARE @Block2DisadvFundingHigherRate INT = 609
	DECLARE @Block2DisadvFundingLowerRate INT = 371

	--Higher Value ourse Premium Funding Rate from Allocation Statement
	--List of Quals at: 
	--https://www.gov.uk/government/publications/qualifications-attracting-high-value-courses-premium
	DECLARE @HighValueCoursesPremiumFundingRate INT = 600

	--Insert new ILR return data leaving existing data from other imported returns or clear out table and replace (default is I for Insert, R = Replace)
	--DECLARE @Mode NCHAR(1) = 'I' 

	--Database to store the summarised table generated by this script (for a linked server use SERVER.DATABASE.SCHEMA (e.g. missrv.misdb.dbo.)
	DECLARE @FISOutputTableLocation NVARCHAR(200) = 'FISFundingSummariser.dbo.' 

	--Table to create/insert data into
	DECLARE @FISOutputTableName NVARCHAR(200) = 'FIS_FundingData'

	--Provider field/s where the course code is stored in your ILR data (if spread across 2 fields enter values for first and second, if stored in 1 leave second NULL)
	DECLARE @ProvSpecDelMonCourseLocation1 NCHAR(1) = 'A'
	DECLARE @ProvSpecDelMonCourseLocation2 NCHAR(1) = 'B'

	--Seperator used between two fields listed above to form the full unique course code (default is blank, only relevant if 2 locations specified for course code)
	DECLARE @ProvSpecDelMonCourseSeperator NVARCHAR(50) = '-'

	--Provider field/s where the parent/programme course is stored to facilitate grouping aims by the programme
	DECLARE @ProvSpecDelMonParentCourseLocation1 NCHAR(1) = NULL
	DECLARE @ProvSpecDelMonParentCourseLocation2 NCHAR(1) = NULL

	--Seperator used between two fields listed above to form the full unique parent/programme course code (default is blank, only relevant if 2 locations specified for parent/programme course code)
	DECLARE @ProvSpecDelMonParentCourseSeperator NVARCHAR(50) = NULL

	--Custom codes for overriding the different levels of structure to move English under that area and out of other curriculum areas
	DECLARE @EnglishCollegeLevel1Code NVARCHAR(50) = NULL
	DECLARE @EnglishCollegeLevel2Code NVARCHAR(50) = NULL
	DECLARE @EnglishCollegeLevel3Code NVARCHAR(50) = NULL
	DECLARE @EnglishCollegeLevel4Code NVARCHAR(50) = NULL

	--Custom codes for overriding the different levels of structure to move Maths under that area and out of other curriculum areas
	DECLARE @MathsCollegeLevel1Code NVARCHAR(50) = NULL
	DECLARE @MathsCollegeLevel2Code NVARCHAR(50) = NULL
	DECLARE @MathsCollegeLevel3Code NVARCHAR(50) = NULL
	DECLARE @MathsCollegeLevel4Code NVARCHAR(50) = NULL

	--Custom codes for overriding the different levels of structure to move franchised out delivery under that area and out of other curriculum areas
	DECLARE @PartnerCollegeLevel1Code NVARCHAR(50) = NULL
	DECLARE @PartnerCollegeLevel2Code NVARCHAR(50) = NULL
	DECLARE @PartnerCollegeLevel3Code NVARCHAR(50) = NULL
	DECLARE @PartnerCollegeLevel4Code NVARCHAR(50) = NULL

	--Calculate which records should be included in QAR measures for each year (replicates what Strata or ProAchieve would do)
	DECLARE @RunQARCalculation BIT = 1 

	--Anonymise ILR data
	DECLARE @AnonymiseData BIT = 0 

	DECLARE @SQLString NVARCHAR(MAX);
	DECLARE @SQLParams NVARCHAR(MAX);

	SET @SQLString = N'
		EXEC SPR_FIS_GenerateFundingData
			@FISDatabase,
			@AcademicYear,
			@ILRReturn,
			@IsFinalReturn,
			@Split1619Funding,
			@Reapportion1619FundingByAimWeighting,
			@AppsMoveFundingToMainComponentAim,
			@1619ALSFundingPercent,
			@IncludeHEAdvLoanPossibleIncome,
			@IncludeAdvLoanBursaryIncome,
			@FutureAchievementWeighting,
			@EnglishMathsFundingHigherRate,
			@EnglishMathsFundingLowerRate,
			@CoreMathsPremiumFundingRate,
			@Block2DisadvFundingTLevelRate,
			@Block2DisadvFundingHigherRate,
			@Block2DisadvFundingLowerRate,
			@HighValueCoursesPremiumFundingRate,
			@Mode,
			@FISOutputTableLocation,
			@FISOutputTableName,
			@ProvSpecDelMonCourseLocation1,
			@ProvSpecDelMonCourseLocation2,
			@ProvSpecDelMonCourseSeperator,
			@ProvSpecDelMonParentCourseLocation1,
			@ProvSpecDelMonParentCourseLocation2,
			@ProvSpecDelMonParentCourseSeperator,
			@EnglishCollegeLevel1Code,
			@EnglishCollegeLevel2Code,
			@EnglishCollegeLevel3Code,
			@EnglishCollegeLevel4Code,
			@MathsCollegeLevel1Code,
			@MathsCollegeLevel2Code,
			@MathsCollegeLevel3Code,
			@MathsCollegeLevel4Code,
			@PartnerCollegeLevel1Code,
			@PartnerCollegeLevel2Code,
			@PartnerCollegeLevel3Code,
			@PartnerCollegeLevel4Code,
			@RunQARCalculation,
			@AnonymiseData';

	SET @SQLParams = 
		N'@FISDatabase NVARCHAR(100),
		@AcademicYear NVARCHAR(5),
		@ILRReturn NVARCHAR(3),
		@IsFinalReturn BIT,
		@Split1619Funding BIT,
		@Reapportion1619FundingByAimWeighting BIT,
		@AppsMoveFundingToMainComponentAim BIT,
		@1619ALSFundingPercent DECIMAL(5,2),
		@IncludeHEAdvLoanPossibleIncome BIT,
		@IncludeAdvLoanBursaryIncome BIT,
		@FutureAchievementWeighting DECIMAL(3,2),
		@EnglishMathsFundingHigherRate INT,
		@EnglishMathsFundingLowerRate INT,
		@CoreMathsPremiumFundingRate INT,
		@Block2DisadvFundingTLevelRate INT,
		@Block2DisadvFundingHigherRate INT,
		@Block2DisadvFundingLowerRate INT,
		@HighValueCoursesPremiumFundingRate INT,
		@Mode NCHAR(1),
		@FISOutputTableLocation NVARCHAR(200),
		@FISOutputTableName NVARCHAR(200),
		@ProvSpecDelMonCourseLocation1 NCHAR(1),
		@ProvSpecDelMonCourseLocation2 NCHAR(1),
		@ProvSpecDelMonCourseSeperator NVARCHAR(50),
		@ProvSpecDelMonParentCourseLocation1 NCHAR(1),
		@ProvSpecDelMonParentCourseLocation2 NCHAR(1),
		@ProvSpecDelMonParentCourseSeperator NVARCHAR(50),
		@EnglishCollegeLevel1Code NVARCHAR(50),
		@EnglishCollegeLevel2Code NVARCHAR(50),
		@EnglishCollegeLevel3Code NVARCHAR(50),
		@EnglishCollegeLevel4Code NVARCHAR(50),
		@MathsCollegeLevel1Code NVARCHAR(50),
		@MathsCollegeLevel2Code NVARCHAR(50),
		@MathsCollegeLevel3Code NVARCHAR(50),
		@MathsCollegeLevel4Code NVARCHAR(50),
		@PartnerCollegeLevel1Code NVARCHAR(50),
		@PartnerCollegeLevel2Code NVARCHAR(50),
		@PartnerCollegeLevel3Code NVARCHAR(50),
		@PartnerCollegeLevel4Code NVARCHAR(50),
		@RunQARCalculation BIT,
		@AnonymiseData BIT';
    
	EXECUTE sp_executesql 
		@SQLString, 
		@SQLParams, 
		@FISDatabase = @FISDatabase,
		@AcademicYear = @AcademicYear,
		@ILRReturn = @ILRReturn,
		@IsFinalReturn = @IsFinalReturn,
		@Split1619Funding = @Split1619Funding,
		@Reapportion1619FundingByAimWeighting = @Reapportion1619FundingByAimWeighting,
		@AppsMoveFundingToMainComponentAim = @AppsMoveFundingToMainComponentAim,
		@1619ALSFundingPercent = @1619ALSFundingPercent,
		@IncludeHEAdvLoanPossibleIncome = @IncludeHEAdvLoanPossibleIncome,
		@IncludeAdvLoanBursaryIncome = @IncludeAdvLoanBursaryIncome,
		@FutureAchievementWeighting = @FutureAchievementWeighting,
		@EnglishMathsFundingHigherRate = @EnglishMathsFundingHigherRate,
		@EnglishMathsFundingLowerRate = @EnglishMathsFundingLowerRate,
		@CoreMathsPremiumFundingRate = @CoreMathsPremiumFundingRate,
		@Block2DisadvFundingTLevelRate = @Block2DisadvFundingTLevelRate,
		@Block2DisadvFundingHigherRate = @Block2DisadvFundingHigherRate,
		@Block2DisadvFundingLowerRate = @Block2DisadvFundingLowerRate,
		@HighValueCoursesPremiumFundingRate = @HighValueCoursesPremiumFundingRate,
		@Mode = @Mode,
		@FISOutputTableLocation = @FISOutputTableLocation,
		@FISOutputTableName = @FISOutputTableName,
		@ProvSpecDelMonCourseLocation1 = @ProvSpecDelMonCourseLocation1,
		@ProvSpecDelMonCourseLocation2 = @ProvSpecDelMonCourseLocation2,
		@ProvSpecDelMonCourseSeperator = @ProvSpecDelMonCourseSeperator,
		@ProvSpecDelMonParentCourseLocation1 = @ProvSpecDelMonParentCourseLocation1,
		@ProvSpecDelMonParentCourseLocation2 = @ProvSpecDelMonParentCourseLocation2,
		@ProvSpecDelMonParentCourseSeperator = @ProvSpecDelMonParentCourseSeperator,
		@EnglishCollegeLevel1Code = @EnglishCollegeLevel1Code,
		@EnglishCollegeLevel2Code = @EnglishCollegeLevel2Code,
		@EnglishCollegeLevel3Code = @EnglishCollegeLevel3Code,
		@EnglishCollegeLevel4Code = @EnglishCollegeLevel4Code,
		@MathsCollegeLevel1Code = @MathsCollegeLevel1Code,
		@MathsCollegeLevel2Code = @MathsCollegeLevel2Code,
		@MathsCollegeLevel3Code = @MathsCollegeLevel3Code,
		@MathsCollegeLevel4Code = @MathsCollegeLevel4Code,
		@PartnerCollegeLevel1Code = @PartnerCollegeLevel1Code,
		@PartnerCollegeLevel2Code = @PartnerCollegeLevel2Code,
		@PartnerCollegeLevel3Code = @PartnerCollegeLevel3Code,
		@PartnerCollegeLevel4Code = @PartnerCollegeLevel4Code,
		@RunQARCalculation = @RunQARCalculation,
		@AnonymiseData = @AnonymiseData;
END