/*
DECLARE @AcademicYear VARCHAR(5) = '20/21'
DECLARE @Provider INT = 10001475
DECLARE @ILRReturn DATETIME = '2020-12-23 10:49:55.000'
DECLARE @FundLine VARCHAR(20) = 'ALL'
DECLARE @Site VARCHAR(50) = 'ALL'
DECLARE @Fac VARCHAR(50) = 'ALL'
DECLARE @Team VARCHAR(50) = 'ALL'
*/

DROP TABLE IF EXISTS #Apps
SELECT
	*
	INTO #Apps
FROM (
	SELECT
		FD.AcademicYear,
		FD.ILRReturn,
		FD.ILRReturnDate,
		FD.LearnerRef,
		FD.Surname,
		FD.Forename,
		FD.CourseCode,
		FD.CourseTitle,
		FD.CompletionCode,
		FD.CompletionDesc,
		FD.StartDate,
		FD.ExpEndDate,
		FD.ActEndDate,
		RestartCompletionCode = RTN.CompletionCode,
		RestartCompletionDesc = RTN.CompletionDesc,
		RestartStartDate = RTN.StartDate,
		RestartExpEndDate = RTN.ExpEndDate,
		RestartActEndDate = RTN.ActEndDate,
		FD.AimCode,
		FD.AimType,
		FD.AimTypeCode,
		FD.IsMainAimInFundModel,
		FD.StandardCode,
		FD.StandardName,
		FD.FrameworkCode,
		FD.FrameworkName,
		FD.TotFundP01,
		FD.TotFundP02,
		FD.TotFundP03,
		FD.TotFundP04,
		FD.TotFundP05,
		FD.TotFundP06,
		FD.TotFundP07,
		FD.TotFundP08,
		FD.TotFundP09,
		FD.TotFundP10,
		FD.TotFundP11,
		FD.TotFundP12,
		FD.TotFundYrEnd,
		RowNum = 
			ROW_NUMBER () OVER (
				PARTITION BY
					FD.LearnerRef
				ORDER BY
					CASE
						WHEN FD.AimCode = 'ZPROG001' THEN 1
						ELSE 2
					END,
					CASE --Ensure the break in learning record is prioritised if learner returned again to ensure the learner 
						--counts in the month they originally started
						WHEN RTN.LearnerRef IS NOT NULL THEN 1
						ELSE 2
					END,
					FD.CompletionCode
			)
	FROM EPNE.dbo.FIS_FundingData FD
	LEFT JOIN (
		SELECT
			FD.LearnerRef,
			FD.AimCode,
			FD.CompletionCode,
			FD.CompletionDesc,
			FD.StartDate,
			FD.ExpEndDate,
			FD.ActEndDate
		FROM EPNE.dbo.FIS_FundingData FD
		WHERE
			FD.AcademicYear = @AcademicYear
			AND FD.ProviderNumber = @Provider
			AND FD.ILRReturnDate = @ILRReturn
			--AND FD.ILRReturn = 'R14'
			--AND FD.IsFinalReturn = 1
			AND FD.IsFunded = 1
			AND FD.FundLineSummary LIKE 'Apprenticeships%'
			AND FD.CompletionCode <> '6'
	) RTN
		ON RTN.LearnerRef = FD.LearnerRef
		AND RTN.AimCode = FD.AimCode
		AND FD.CompletionCode = '6'
	WHERE
		FD.AcademicYear = @AcademicYear
		AND FD.ProviderNumber = @Provider
		AND FD.ILRReturnDate = @ILRReturn
		--AND FD.ILRReturn = 'R14'
		--AND FD.IsFinalReturn = 1
		AND FD.IsFunded = 1
		AND ( FD.FundLine IN ( @FundLine ) OR 'ALL' IN ( @FundLine ) )
		AND ( COALESCE ( FD.ParentSiteCode, FD.SiteCode ) IN ( @Site ) OR 'ALL' IN ( @Site ) )
		AND ( COALESCE ( FD.ParentFacCode, FD.FacCode ) IN ( @Fac ) OR 'ALL' IN ( @Fac ) )
		AND ( COALESCE ( FD.ParentTeamCode, FD.TeamCode ) IN ( @Team ) OR 'ALL' IN ( @Team ) )
		AND FD.FundLineSummary LIKE 'Apprenticeships%'
) FD
WHERE
	FD.RowNum = 1
--ORDER BY
--	FD.Surname,
--	FD.Forename,
--	FD.LearnerRef

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apprentices On Programme at start of month',
	SortOrder = 1,
	Aug = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-08-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + LEFT ( @AcademicYear, 2 ) + '-08-01' ) THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' ) THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-10-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + LEFT ( @AcademicYear, 2 ) + '-10-01' ) THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-11-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + LEFT ( @AcademicYear, 2 ) + '-11-01' ) THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-12-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + LEFT ( @AcademicYear, 2 ) + '-12-01' ) THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-01-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-01-01' ) THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-02-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-02-01' ) THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-03-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-03-01' ) THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-04-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-04-01' ) THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-05-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-05-01' ) THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-06-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-06-01' ) THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-07-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-07-01' ) THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apprentice new starts in month',
	SortOrder = 2,
	Aug = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apprentices Lost in Month (Completed/Withdrawn)',
	SortOrder = 3,
	Aug = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apprentices On Programme at end of month',
	SortOrder = 4,
	Aug = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' ) THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-10-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + LEFT ( @AcademicYear, 2 ) + '-10-01' ) THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-11-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + LEFT ( @AcademicYear, 2 ) + '-11-01' ) THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-12-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + LEFT ( @AcademicYear, 2 ) + '-12-01' ) THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-01-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-01-01' ) THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-02-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-02-01' ) THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-03-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-03-01' ) THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-04-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-04-01' ) THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-05-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-05-01' ) THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-06-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-06-01' ) THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-07-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-07-01' ) THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-08-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) >= '20' + RIGHT ( @AcademicYear, 2 ) + '-08-01' ) THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apprentices - Net in month gain / loss',
	SortOrder = 5,
	Aug = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apprentices - Cumulative in year new starts',
	SortOrder = 6,
	Aug = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apprentices - Cumulative in year finishers (Completed/Withdrawn)',
	SortOrder = 7,
	Aug = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apprentices - Cumulative net in year gain / loss',
	SortOrder = 8,
	Aug = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN FORMAT ( FD.StartDate, 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
		- SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apps Out of Funding',
	SortOrder = 9,
	Aug = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-08-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-10-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-10-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-11-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-11-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-12-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-12-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-01-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-01-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-02-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-02-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-03-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-03-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-04-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-04-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-05-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-05-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-06-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-06-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-07-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-07-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apps 3 months Out of Funding',
	SortOrder = 10,
	Aug = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-08-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-09-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-10-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-10-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-11-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-11-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + LEFT ( @AcademicYear, 2 ) + '-12-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + LEFT ( @AcademicYear, 2 ) + '-12-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-01-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-01-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-02-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-02-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-03-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-03-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-04-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-04-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-05-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-05-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-06-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-06-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN CAST ( FD.StartDate AS DATE ) < '20' + RIGHT ( @AcademicYear, 2 ) + '-07-01' AND ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) IS NULL OR CAST ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ) AS DATE ) > '20' + RIGHT ( @AcademicYear, 2 ) + '-07-01' ) AND FORMAT ( FD.ExpEndDate, 'yyyy-MM' ) <= '20' + LEFT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apps going on a break in learning during month',
	SortOrder = 11,
	Aug = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-09' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-10' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-11' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-12' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-01' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-02' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-03' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-04' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-05' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-06' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-07' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Apps returning from a break in learning during month',
	SortOrder = 12,
	Aug = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-08' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-09' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-10' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-11' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + LEFT ( @AcademicYear, 2 ) + '-12' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-01' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-02' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-03' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-04' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-05' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-06' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN FORMAT ( FD.RestartStartDate, 'yyyy-MM' ) = '20' + RIGHT ( @AcademicYear, 2 ) + '-07' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

UNION ALL

SELECT
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate,
	Measure = 'Total Break in Learning numbers',
	SortOrder = 13,
	Aug = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Sep = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-09' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Oct = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-10' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Nov = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-11' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Dec = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + LEFT ( @AcademicYear, 2 ) + '-12' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Jan = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-01' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Feb = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-02' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Mar = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-03' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Apr = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-04' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	May = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-05' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Jun = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-06' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END ),
	Jul = SUM ( CASE WHEN FORMAT ( COALESCE ( FD.RestartActEndDate, FD.ActEndDate ), 'yyyy-MM' ) BETWEEN '20' + LEFT ( @AcademicYear, 2 ) + '-08' AND '20' + RIGHT ( @AcademicYear, 2 ) + '-07' AND FD.CompletionCode = '6' THEN 1 ELSE 0 END )
FROM #Apps FD
GROUP BY
	FD.AcademicYear,
	FD.ILRReturn,
	FD.ILRReturnDate

ORDER BY
	SortOrder