DECLARE @ProviderNumber INT = 10007928
DECLARE @AcademicYear NVARCHAR(5) = '23/24'
DECLARE @ILRReturn  NVARCHAR(3) = 'R09'
DECLARE @IsFinalReturn BIT = 1
DECLARE @IsFundedStart BIT = 1


DECLARE @SixYearsAgo NVARCHAR(5) = CAST ( CAST ( LEFT( @AcademicYear, 2 ) AS INT ) - 6 AS NVARCHAR(2) ) + '/' + CAST ( CAST ( RIGHT( @AcademicYear, 2 ) AS INT ) - 6 AS NVARCHAR(2) )

DROP TABLE IF EXISTS #MergedData
SELECT
	FD.ProviderNumber,
	FD.LearnRefNumber,
	FD.LearningAimCode,
	FD.LearnerAndAimRowNum,
	FD.StandardCode,
	FD.FrameworkCode,
	FD.PathwayCode,
	FD.StartDate,
	FD.PlannedEndDate,
	FD.CompletionStatusCode,
	FD.StartYear,
	FD.PlannedEndYear,
	FD.AchievementYear,
	FD.HybridEndYear,
	EarliestReportingYear = MIN ( FD.ReportingYear ),
	LatestReportingYear = MAX ( FD.ReportingYear),
	NumMergedRecords = COUNT ( FD.LearningAimCode )
	INTO #MergedData
FROM FIS_FundingData FD
WHERE
	FD.ProviderNumber = @ProviderNumber
	AND FD.HybridEndYear = @AcademicYear
	AND FD.ReportingYear >= @SixYearsAgo
	AND FD.ILRReturn = 
		CASE
			WHEN FD.AcademicYear = @AcademicYear THEN @ILRReturn
			ELSE 'R14'
		END
	AND FD.IsFinalReturn = @IsFinalReturn
	--AND FD.IsFundedStart = @IsFundedStart
	--AND FD.LearningAimTitle LIKE '%Extended Diploma%'
	--AND FD.LearnRefNumber = '40023505'
GROUP BY
	FD.ProviderNumber,
	FD.LearnRefNumber,
	FD.LearningAimCode,
	FD.LearnerAndAimRowNum,
	FD.StandardCode,
	FD.FrameworkCode,
	FD.PathwayCode,
	FD.StartDate,
	FD.PlannedEndDate,
	FD.CompletionStatusCode,
	FD.StartYear,
	FD.PlannedEndYear,
	FD.AchievementYear,
	FD.HybridEndYear
ORDER BY
	FD.LearningAimCode


SELECT
	MD.ProviderNumber,
	MD.LearnRefNumber,
	MD.LearningAimCode,
	MD.LearnerAndAimRowNum,
	MD.StandardCode,
	MD.FrameworkCode,
	MD.PathwayCode,
	MD.StartDate,
	MD.PlannedEndDate,
	FD.ActualEndDate,
	FD.AchievementDate,
	MD.CompletionStatusCode,
	MD.StartYear,
	MD.PlannedEndYear,
	MD.AchievementYear,
	MD.HybridEndYear,
	MD.EarliestReportingYear,
	MD.LatestReportingYear,
	MD.NumMergedRecords,
	FD.IsFundedStart,
	FD.IsOverallWithdrawnNotFunded,
	FD.IsOverallTransferFunded,
	FD.IsOverallWithdrawnFunded,
	FD.IsOverallCompletedFunded,
	FD.IsOverallAchieverFunded,
	FD.IsOverallHighGrade
FROM #MergedData MD
INNER JOIN FIS_FundingData FD
	ON FD.ProviderNumber = MD.ProviderNumber
	AND FD.ReportingYear = MD.LatestReportingYear
	AND FD.LearnRefNumber = MD.LearnRefNumber
	AND FD.LearningAimCode = MD.LearningAimCode
	AND COALESCE ( FD.StandardCode, 0 ) = COALESCE ( MD.StandardCode, 0 )
	AND COALESCE ( FD.FrameworkCode, 0 ) = COALESCE ( MD.FrameworkCode, 0 )
	AND COALESCE ( FD.PathwayCode, 0 ) = COALESCE ( MD.PathwayCode, 0 )
	AND FD.StartDate = MD.StartDate
	AND FD.PlannedEndDate = MD.PlannedEndDate
	AND FD.LearnerAndAimRowNum = MD.LearnerAndAimRowNum
WHERE
	MD.LearningAimCode = '60103103'
ORDER BY
	MD.LearningAimCode,
	MD.LearnRefNumber