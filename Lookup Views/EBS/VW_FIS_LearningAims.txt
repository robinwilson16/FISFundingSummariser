CREATE VIEW VW_FIS_LearningAims
AS
	SELECT DISTINCT
		SSA1Code = FQA.SSA_TIER1_CODE,
		SSA1Name = RIGHT ( '00' + FQA.SSA_TIER1_CODE, 2 ) + ' - ' + FQA.SSA_TIER1_DESCRIPTION,
		SSA2Code = FQA.SSA_TIER2_CODE,
		SSA2Name = RIGHT ( '00' + FQA.SSA_TIER2_CODE, 4 ) + ' - ' + FQA.SSA_TIER2_DESCRIPTION,
		LearningAimCode = UQA.QUAL_CODE,
		LearningAimTitle = FQA.DESCRIPTION,
		LearningAimTypeCode = FQA.QUAL_TYPE,
		LearningAimTypeName = FQA.QUAL_TYPE_DESCRIPTION,
		NVQLevelCode = COALESCE ( FQA.NOTIONAL_LEVEL_V2_CODE, 'X' ),
		NVQLevelName =
			CASE
				WHEN COALESCE ( FQA.NOTIONAL_LEVEL_V2_CODE, 'X' ) = 'E' THEN 'Entry Level'
				ELSE 'Level ' + COALESCE ( FQA.NOTIONAL_LEVEL_V2_CODE, 'X' )
			END,
		NVQLevelOrder = 
			CASE
				WHEN COALESCE ( FQA.NOTIONAL_LEVEL_V2_CODE, 'X' ) = 'E' THEN 0
				WHEN COALESCE ( FQA.NOTIONAL_LEVEL_V2_CODE, 'X' ) = 'X' THEN -1
				ELSE TRY_CAST ( FQA.NOTIONAL_LEVEL_V2_CODE AS INT )
			END,
		IsMathsAndEnglish = 
			CASE
				WHEN 
					FQA.QUAL_TYPE IN (
						'0003', --GCSE
						'1439' --FS
					)
					AND (
						FQA.DESCRIPTION LIKE '%Math%'
						OR FQA.DESCRIPTION LIKE '%English%'
					)
					THEN 'Y'
				ELSE 'N'
			END,
		AwardBodyCode = FQA.AWARD_BODY_1
	FROM [EBS-DB\EBS].ebs.dbo.UNIT_INSTANCE_OCCURRENCES UIO
	INNER JOIN [EBS-DB\EBS].ebs.dbo.UNIT_INSTANCES UI
		ON UI.FES_UNIT_INSTANCE_CODE = UIO.FES_UINS_INSTANCE_CODE
	INNER JOIN [EBS-DB\EBS].ebs.dbo.FUNDING_YEARS FY
		ON FY.FUNDING_YEAR = '32'
	INNER JOIN [EBS-DB\EBS].ebs.dbo.ORGANISATION_UNITS FAC
		ON FAC.ORGANISATION_CODE = UIO.OWNING_ORGANISATION
	INNER JOIN [EBS-DB\EBS].ebs.dbo.ORGANISATION_UNITS TEAM
		ON TEAM.ORGANISATION_CODE = UIO.OFFERING_ORGANISATION
	LEFT JOIN (
		-- In case of duplicates
		SELECT
			AimID = UQA.ID,
			AimFundingYear = UQA.FUNDING_YEAR,
			AimCourseID = UQA.UIO_ID,
			AimIsDefault = UQA.DEFAULT_QA,
			RowNum = 
				ROW_NUMBER () OVER (
					PARTITION BY
						UQA.FUNDING_YEAR,
						UQA.UIO_ID
					ORDER BY
						UQA.DEFAULT_QA DESC
				)
		FROM [EBS-DB\EBS].ebs.dbo.UIO_QUAL_AIMS UQA
		WHERE UQA.FUNDING_YEAR = '32'
	) UQAM
		ON UQAM.AimCourseID = UIO.UIO_ID
		AND UQAM.AimFundingYear = FY.FUNDING_YEAR
		AND UQAM.RowNum = 1
	LEFT JOIN [EBS-DB\EBS].ebs.dbo.UIO_QUAL_AIMS UQA
		ON UQA.ID = UQAM.AimID
	LEFT JOIN [EBS-DB\EBS].ebs.dbo.FEFC_QUAL_AIMS FQA
		ON FQA.QUAL_CODE = UQA.QUAL_CODE
		AND FQA.FUNDING_YEAR = UQA.FUNDING_YEAR
	WHERE
		--UIO.CALOCC_OCCURRENCE_CODE = REPLACE ( @AcademicYear, '/', '' )
		COALESCE ( UQA.START_DATE, UIO.FES_START_DATE ) <= FY.END_DATE
		AND COALESCE ( UQA.END_DATE, UIO.FES_END_DATE ) >= FY.START_DATE
		AND UQA.QUAL_CODE IS NOT NULL