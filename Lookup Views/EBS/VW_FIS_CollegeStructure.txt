CREATE OR ALTER VIEW [dbo].[VW_FIS_CollegeStructure]
AS
	SELECT
		AcademicYear = RIGHT ( CAST ( YEAR ( FY.START_DATE ) AS VARCHAR(4) ), 2 ) + '/' + RIGHT ( CAST ( YEAR ( FY.END_DATE ) AS VARCHAR(4) ), 2 ),
		ProvSpecValue = UIO.COURSE_OCCURRENCE_CODE,
		CourseCode = UIO.FES_UINS_INSTANCE_CODE,
		CourseInstance = UIO.COURSE_OCCURRENCE_CODE,
		CourseTitle = UIO.LONG_DESCRIPTION,
		CollegeLevel1Code = COALESCE ( UIO.OWNING_ORGANISATION, '-' ),
		CollegeLevel1Name = COALESCE ( FAC.FES_FULL_NAME, '-- Unknown --' ),
		CollegeLevel2Code = COALESCE ( UIO.OFFERING_ORGANISATION, '-' ),
		CollegeLevel2Name = COALESCE ( TEAM.FES_FULL_NAME, '-- Unknown --' ),
		CollegeLevel3Code = '-',
		CollegeLevel3Name = '-- None --',
		CollegeLevel4Code = '-',
		CollegeLevel4Name = '-- None --'
	FROM [ebs-db\EBS].ebs.dbo.UNIT_INSTANCE_OCCURRENCES UIO
	INNER JOIN [ebs-db\EBS].ebs.dbo.UNIT_INSTANCES UI
		ON UI.FES_UNIT_INSTANCE_CODE = UIO.FES_UINS_INSTANCE_CODE
	INNER JOIN [ebs-db\EBS].ebs.dbo.FUNDING_YEARS FY
		ON FY.FUNDING_YEAR = '32'
	--INNER JOIN ebs.dbo.ORGANISATION_UNITS FAC
	--	ON FAC.ORGANISATION_CODE = UIO.OWNING_ORGANISATION
	INNER JOIN [ebs-db\EBS].ebs.dbo.ORGANISATION_UNITS TEAM
		ON TEAM.ORGANISATION_CODE = UIO.OFFERING_ORGANISATION
	INNER JOIN [ebs-db\EBS].ebs.dbo.ORG_UNIT_LINKS LNK
		ON LNK.SECONDARY_ORGANISATION = TEAM.ORGANISATION_CODE
	INNER JOIN [ebs-db\EBS].ebs.dbo.ORGANISATION_UNITS FAC
		ON FAC.ORGANISATION_CODE = LNK.PRIMARY_ORGANISATION
	INNER JOIN (
		-- In case of duplicates
		SELECT
			AimID = UQA.ID,
			AimFundingYear = UQA.FUNDING_YEAR,
			AimCourseID = UQA.UIO_ID,
			AimIsDefault = UQA.DEFAULT_QA,
			RowNum = 
				ROW_NUMBER () OVER (
					PARTITION BY
						UQA.FUNDING_YEAR,
						UQA.UIO_ID
					ORDER BY
						UQA.DEFAULT_QA DESC
				)
		FROM [ebs-db\EBS].ebs.dbo.UIO_QUAL_AIMS UQA
		WHERE UQA.FUNDING_YEAR = '32'
	) UQAM
		ON UQAM.AimCourseID = UIO.UIO_ID
		AND UQAM.AimFundingYear = FY.FUNDING_YEAR
		AND UQAM.RowNum = 1
	LEFT JOIN [ebs-db\EBS].ebs.dbo.UIO_QUAL_AIMS UQA
		ON UQA.ID = UQAM.AimID
	LEFT JOIN [ebs-db\EBS].ebs.dbo.FEFC_QUAL_AIMS FQA
		ON FQA.QUAL_CODE = UQA.QUAL_CODE
		AND FQA.FUNDING_YEAR = UQA.FUNDING_YEAR
	WHERE
		--UIO.CALOCC_OCCURRENCE_CODE = REPLACE ( @AcademicYear, '/', '' )
		COALESCE ( UQA.START_DATE, UIO.FES_START_DATE ) <= FY.END_DATE
		--COALESCE ( UQA.END_DATE, UIO.FES_END_DATE ) >= FY.START_DATE
		--AND UIO.COURSE_OCCURRENCE_CODE LIKE '%ACHI0034%'