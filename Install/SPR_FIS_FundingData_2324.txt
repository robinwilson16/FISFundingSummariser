/*
Changes since 22/23
HE Percent Taught First, Second and Third LDCS Depricated and Removed

*/

CREATE PROCEDURE SPR_FIS_FundingData_2324
	@FISDatabase NVARCHAR(50),
	@AcademicYear NVARCHAR(5),
	@ILRReturn INT,
	@IsFinalReturn BIT,
	@Split1619Funding BIT,
	@Reapportion1619FundingByAimWeighting BIT,
	@1619ALSFundingPercent DECIMAL(5,2),
	@IncludeHEAdvLoanPossIncome BIT,
	@IncludeAdvLoanBursaryIncome BIT,
	@FutureAchieveWeighting DECIMAL(5,2),
	@FISOutputTableLocation NVARCHAR(200),
	@FISOutputTableName NVARCHAR(200),
	@ProviderFieldCourseLocation CHAR(1),
	@ProviderFieldParentCourseLocation CHAR(1),
	@OverrideEngFac NVARCHAR(50),
	@OverrideMatFac NVARCHAR(50),
	@OverrideEngTeam NVARCHAR(50),
	@OverrideMatTeam NVARCHAR(50),
	@OverrideEngCostCentre NVARCHAR(50),
	@OverrideMatCostCentre NVARCHAR(50),
	@OverridePartnerFac NVARCHAR(50),
	@OverridePartnerTeam NVARCHAR(50),
	@OverridePartnerCostCentre NVARCHAR(50)
AS
BEGIN
	SET XACT_ABORT, NOCOUNT ON;

	--DECLARE @ILRReturn int = 14 -- CHANGE THIS TO CORRECT RETURN
	--DECLARE @IsFinalReturn BIT = 1 -- IF FINAL RETURN SET THIS TO 1 - ensure only 1 return for each month is set to 1 for accurate year on year reporting

	--DECLARE @FISDatabase NVARCHAR(100) = 'ILR2324'
	--DECLARE @AcademicYear NVARCHAR(5) = '23/24'

	--DECLARE @Split1619Funding BIT = 0 --Split the funding into the 12 periods
	--DECLARE @Reapportion1619FundingByAimWeighting BIT = 0 --Reapportion the 16-19 funding by the aim prog weighting factor
	--DECLARE @1619ALSFundingPercent DECIMAL(5,2) = 0 --Deduct this percent from Tot Funding for FM25 and assign to ALS column
	--DECLARE @IncludeHEAdvLoanPossIncome BIT = 0 --HE gross fee is only achieved if at all 3 SLC census points learners remain current
	--DECLARE @IncludeAdvLoanBursaryIncome BIT = 0 --Adv loan bursary income is not income as goes to learners so may want to exclude
	--DECLARE @FutureAchieveWeighting DECIMAL(5,2) = 1 --Future ach weighting factor. If 1 then is 100% of all remaining ach monies
	--DECLARE @Mode NCHAR(1) = 'I' --I=Insert new ILR return data leaving existing data, R=Replace table
	--DECLARE @FISOutputTableLocation NVARCHAR(200) = 'IEG.dbo.'
	--DECLARE @FISOutputTableName NVARCHAR(200) = 'FIS_FundingData'
	--DECLARE @ProviderFieldCourseLocation NCHAR(1) = 'A'
	--DECLARE @ProviderFieldParentCourseLocation NCHAR(1) = 'B'
	--DECLARE @OverrideEngFac NVARCHAR(50) = NULL
	--DECLARE @OverrideMatFac NVARCHAR(50) = NULL
	--DECLARE @OverrideEngTeam NVARCHAR(50) = NULL
	--DECLARE @OverrideMatTeam NVARCHAR(50) = NULL
	--DECLARE @OverrideEngCostCentre NVARCHAR(50) = NULL
	--DECLARE @OverrideMatCostCentre NVARCHAR(50) = NULL
	--DECLARE @OverridePartnerFac NVARCHAR(50) = NULL
	--DECLARE @OverridePartnerTeam NVARCHAR(50) = NULL
	--DECLARE @OverridePartnerCostCentre NVARCHAR(50) = NULL
	--DECLARE @AnonymiseData BIT = 0 --Anonymise ILR data

	DECLARE @SQLString NVARCHAR(MAX);
    DECLARE @SQLParams NVARCHAR(MAX);

	SET @SQLString = 
        N'
		DROP TABLE IF EXISTS #LearningAims;
		SELECT
			AIM.SSA1Code,
			AIM.SSA1Name,
			AIM.SSA2Code,
			AIM.SSA2Name,
			AIM.LearningAimCode,
			AIM.LearningAimTitle,
			AIM.LearningAimTypeCode,
			AIM.LearningAimTypeName,
			AIM.NVQLevelCode,
			AIM.NVQLevelName,
			AIM.NVQLevelOrder,
			AIM.IsMathsAndEnglish,
			AIM.AwardBodyCode
		INTO #LearningAims
		FROM FIS_LearningAims AIM

		DROP TABLE IF EXISTS #CollegeStructure;
		SELECT
			CS.AcademicYear,
			CS.ProvSpecValue,
			CS.CourseCode,
			CS.CourseTitle,
			CS.CollegeLevel1Code,
			CS.CollegeLevel1Name,
			CS.CollegeLevel2Code,
			CS.CollegeLevel2Name,
			CS.CollegeLevel3Code,
			CS.CollegeLevel3Name,
			CS.CollegeLevel4Code,
			CS.CollegeLevel4Name
		INTO #CollegeStructure
		FROM FIS_CollegeStructure CS
		WHERE
			CS.AcademicYear = @AcademicYear

		DROP TABLE IF EXISTS #CourseHours;
		SELECT
			HRS.AcademicYear,
			HRS.ProvSpecField,
			HRS.CourseCode,
			HRS.PLH,
			HRS.EEP
		INTO #CourseHours
		FROM FIS_CourseHours HRS
		WHERE
			HRS.AcademicYear = @AcademicYear

		DROP TABLE IF EXISTS #Employers;
		SELECT
			EMP.EmployerEDRS,
			EMP.EmployerName
		INTO #Employers
		FROM FIS_Employers EMP

		DROP TABLE IF EXISTS #Partners;
		SELECT
			PAR.PartnerUKPRN,
			PAR.PartnerName
		INTO #Partners
		FROM FIS_Partners PAR

		DROP TABLE IF EXISTS #Standards;
		SELECT
			STD.StandardCode,
			STD.StandardName
		INTO #Standards
		FROM FIS_Standards STD

		DROP TABLE IF EXISTS #Frameworks;
		SELECT
			FW.FrameworkCode,
			FW.FrameworkName
		INTO #Frameworks
		FROM FIS_Frameworks FW

		DROP TABLE IF EXISTS #Pathways;
		SELECT
			PWAY.FrameworkCode,
			PWAY.ProgType,
			PWAY.PathwayCode,
			PWAY.PathwayName
		INTO #Pathways
		FROM FIS_Pathways PWAY

		DROP TABLE IF EXISTS #PostCodes;
		SELECT
			PC.PostCode,
			PC.WardCode,
			PC.WardName,
			PC.DistrictCode,
			PC.DistrictName,
			PC.LEACode,
			PC.LEAName,
			PC.SourceOfFunding,
			PC.DisadvUplift
		INTO #PostCodes
		FROM FIS_PostCodes PC

		DROP TABLE IF EXISTS #PriorLevels;
		SELECT
			PLEV.Code,
			PLEV.Description
		INTO #PriorLevels
		FROM FIS_PriorLevels PLEV

		DROP TABLE IF EXISTS #Ethnicities;
		SELECT
			ETH.Code,
			ETH.Description
		INTO #Ethnicities
		FROM FIS_Ethnicities ETH

		DROP TABLE IF EXISTS #Disabilities;
		SELECT
			DIS.Code,
			DIS.Description
		INTO #Disabilities
		FROM FIS_Disabilities DIS

		DROP TABLE IF EXISTS #DestinationProgressionOutcomes;
		SELECT
			OC.OutcomeCode,
			OC.OutcomeType,
			OC.Code,
			OC.Description
		INTO #DestinationProgressionOutcomes
		FROM FIS_DestinationProgressionOutcomes OC
	'

	SET @SQLString += 
        N'
		DROP TABLE IF EXISTS #FAMLearner
		SELECT
			LearnRefNumber = FAML.LearnRefNumber,
			FAMLearnerHNS = FAML.HNS,
			FAMLearnerEHC = FAML.EHC,
			FAMLearnerDLA = FAML.DLA,
			FAMLearnerLSR = FAML.LSR,
			FAMLearnerSEN = FAML.SEN,
			FAMLearnerNLM = FAML.NLM,
			FAMLearnerEDF = FAML.EDF,
			FAMLearnerMCF = FAML.MCF,
			FAMLearnerECF = FAML.ECF,
			FAMLearnerFME = FAML.FME
			INTO #FAMLearner
		FROM (
			SELECT
				FAML.LearnRefNumber,
				FAML.LearnFAMType,
				FAML.LearnFAMCode
			FROM ' + @FISDatabase + '.Valid.LearnerFAM FAML
		) FAML
		PIVOT (
			MAX ( FAML.LearnFAMCode )
			FOR
				FAML.LearnFAMType IN (
					[HNS],
					[EHC],
					[DLA],
					[LSR],
					[SEN],
					[NLM],
					[EDF],
					[MCF],
					[ECF],
					[FME]
				)
		) FAML

	'

	SET @SQLString += 
        N'
		DROP TABLE IF EXISTS #FAMLearningDelivery
		SELECT
			LearnRefNumber = FAMA.LearnRefNumber,
			AimSeqNumber = FAMA.AimSeqNumber,
			FAMLearningDeliverySOF = FAMA.SOF,
			FAMLearningDeliveryFFI = FAMA.FFI,
			FAMLearningDeliveryEEF = FAMA.EEF,
			FAMLearningDeliveryRES = FAMA.RES,
			FAMLearningDeliveryLSF = FAMA.LSF,
			FAMLearningDeliveryADL = FAMA.ADL,
			FAMLearningDeliveryALB = FAMA.ALB,
			FAMLearningDeliveryASL = FAMA.ASL,
			FAMLearningDeliveryFLN = FAMA.FLN,
			FAMLearningDeliveryLDM = FAMA.LDM,
			FAMLearningDeliveryDAM = FAMA.DAM,
			FAMLearningDeliveryACT = FAMA.ACT,
			FAMLearningDeliveryACL = FAMA.ACL,
			FAMLearningDeliveryAFL = FAMA.AFL
			INTO #FAMLearningDelivery
		FROM (
			SELECT
				FAMA.LearnRefNumber,
				FAMA.AimSeqNumber,
				FAMA.LearnDelFAMType,
				FAMA.LearnDelFAMCode
			FROM (
				SELECT
					FAMA.LearnRefNumber,
					FAMA.AimSeqNumber,
					FAMA.LearnDelFAMType,
					FAMA.LearnDelFAMCode,
					FAMA.LearnDelFAMDateFrom,
					FAMA.LearnDelFAMDateTo,
					RowNum = 
						ROW_NUMBER () OVER (
							PARTITION BY
								FAMA.LearnRefNumber,
								FAMA.AimSeqNumber,
								FAMA.LearnDelFAMType
							ORDER BY
								FAMA.LearnDelFAMDateFrom DESC,
								CASE
									WHEN FAMA.LearnDelFAMDateTo IS NULL THEN 1
									ELSE 2
								END,
								FAMA.LearnDelFAMDateTo DESC
						)
				FROM ' + @FISDatabase + '.Valid.LearningDeliveryFAM FAMA
			) FAMA
			WHERE
				FAMA.RowNum = 1
		) FAMA
		PIVOT (
			MAX ( FAMA.LearnDelFAMCode )
			FOR
				FAMA.LearnDelFAMType IN (
					[SOF],
					[FFI],
					[EEF],
					[RES],
					[LSF],
					[ADL],
					[ALB],
					[ASL],
					[FLN],
					[LDM],
					[DAM],
					[ACT],
					[ACL],
					[AFL]
				)
		) FAMA
	'

	SET @SQLString += 
        N'
		DROP TABLE IF EXISTS #CarryInMonths
		SELECT
			ILRReturn = RN.ILRReturn,
			ReturnYear = RN.ReturnYear,
			YearNum = RN.YearNum,
			DateFrom = RN.ReturnFrom,
			DateTo = DATEADD ( DAY, -1, LEAD ( RN.ReturnFrom ) OVER ( ORDER BY RN.ReturnFrom ) )
			INTO #CarryInMonths
		FROM (
			SELECT
				ILRReturn = 
					''R'' + CASE
						WHEN RN.RowNum >= 20 THEN FORMAT ( RN.RowNum - 19, ''#00'' )
						ELSE FORMAT ( RN.RowNum - 7, ''#00'' )
					END,
				ReturnYear = 
					CASE
						WHEN RN.RowNum >= 20 THEN CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
						ELSE CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) AS VARCHAR(2) )
					END
					+ ''/''
					+ CASE
						WHEN RN.RowNum >= 20 THEN CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 2 AS VARCHAR(2) )
						ELSE CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
					END,
				YearNum = 
					CASE
						WHEN RN.RowNum >= 20 THEN 2
						ELSE 1
					END,
				ReturnFrom = 
					CAST ( 
						CASE
							WHEN RN.RowNum >= 25 THEN ''20'' + CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 2 AS VARCHAR(2) )
							WHEN RN.RowNum >= 13 THEN ''20'' + CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
							ELSE ''20'' + CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) AS VARCHAR(2) )
						END
						+ ''-''
						+ CASE
							WHEN RN.RowNum >= 25 THEN FORMAT ( RN.RowNum - 24, ''#00'' )
							WHEN RN.RowNum >= 13 THEN FORMAT ( RN.RowNum - 12, ''#00'' )
							ELSE FORMAT ( RN.RowNum, ''#00'' )
						END
						+ ''-01''
					AS DATE )
			FROM (
				SELECT
					RowNum =
						ROW_NUMBER () OVER (
							ORDER BY
								NEWID()
						)
				FROM sys.all_objects
			) RN
			WHERE
				RN.RowNum >= 8
				AND RN.RowNum <= 32
		) RN
	'

	SET @SQLString += 
        N'
		DROP TABLE IF EXISTS #CarryIn
		SELECT
			CI.LearnRefNumber,
			CI.AimSeqNumber,
			CI.CarryInOnProgTotal,
			CI.CarryInOnProgMonthly,
			CI.AchieveElement,
			CarryInYr1R01 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R01'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R02 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R02'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R03 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R03'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R04 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R04'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R05 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R05'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R06 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R06'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R07 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R07'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R08 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R08'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R09 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R09'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R10 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R10'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R11 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R11'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R12 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R12'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R01 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R01'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R02 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R02'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R03 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R03'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R04 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R04'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R05 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R05'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R06 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R06'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R07 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R07'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R08 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R08'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R09 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R09'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R10 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R10'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R11 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R11'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R12 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R12'' THEN CI.CarryInAmount ELSE 0 END )
			INTO #CarryIn
		FROM (
			SELECT
				FMC.LearnRefNumber,
				FMC.AimSeqNumber,
				FMC.CarryInOnProgTotal,
				FMC.CarryInOnProgMonthly,
				FMC.AchieveElement,
				CI.ReturnYear,
				CI.YearNum,
				CI.ILRReturn,
				CarryInAmount = 
					(
						CASE --Dates span the month so need a payment
							WHEN FMC.LearnPlanEndDate >= CI.DateTo
							AND FMC.LearnStartDate <= CI.DateTo THEN
								FMC.CarryInOnProgMonthly
							ELSE 0
						END
						*
						CASE --Started in the month so need double payment
							WHEN FMC.LearnStartDate >= CI.DateFrom
							AND FMC.LearnStartDate <= CI.DateTo THEN 2
							ELSE 1
						END
					)
					+
					CASE --Finished in the month so add achievement element
						WHEN FMC.LearnPlanEndDate >= CI.DateFrom
						AND FMC.LearnPlanEndDate <= CI.DateTo THEN FMC.AchieveElement
						ELSE 0
					END
			FROM (
				SELECT
					LD.LearnRefNumber,
					LD.AimSeqNumber,
					LD.PartnerUKPRN,
					LD.LearnStartDate,
					LD.LearnPlanEndDate,
					NumPlannedOnProgPayments = FM35.PlannedNumOnProgInstalm,
					FM35.AchieveElement,
					CarryInOnProgTotal = 
						CASE
							WHEN COALESCE ( FM35.PropFundRemain, 0 ) = 0 THEN 0
							ELSE 
								( FM35.AimValue - FM35.NonGovCont - FM35.AchieveElement ) * FM35.PropFundRemain
						END,
					CarryInOnProgMonthly = 
						CASE
							WHEN FM35.PlannedNumOnProgInstalm = 0 THEN 0
							ELSE
								CASE
									WHEN COALESCE ( FM35.PropFundRemain, 0 ) = 0 THEN 0
									ELSE 
										( FM35.AimValue - FM35.NonGovCont - FM35.AchieveElement ) * FM35.PropFundRemain
								END
								/ 
								FM35.PlannedNumOnProgInstalm
						END
				FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
				INNER JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
					ON FM35.LearnRefNumber = LD.LearnRefNumber
					AND FM35.AimSeqNumber = LD.AimSeqNumber
				WHERE
					LD.CompStatus = 1
					AND LD.LearnPlanEndDate >= ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-08-01''
					AND FM35.FundStart = 1
			) FMC
			INNER JOIN #CarryInMonths CI
				ON CI.DateTo IS NOT NULL
		) CI
		GROUP BY
			CI.LearnRefNumber,
			CI.AimSeqNumber,
			CI.CarryInOnProgTotal,
			CI.CarryInOnProgMonthly,
			CI.AchieveElement
	'

	SET @SQLString += 
        N'
		INSERT INTO ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] WITH (TABLOCKX)
		SELECT
			AcademicYear = @AcademicYear,
            ProviderNumber = SRC.UKPRN,
			ProviderName = PROV.ProviderName,
			ILRReturn = ''R'' + FORMAT ( @ILRReturn, ''#00'' ),
			IsFinalReturn = @IsFinalReturn,
			ILRReturnDate = DATEADD ( MS, - DATEPART ( MS, SRC.DateTime ), SRC.DateTime ), --Remove milliseconds as SSRS truncates these in parameters
			SQLDatabase = ''' + @FISDatabase + ''',
			ImportDate = GETDATE(),
			Is1619FundingSplit = CASE WHEN LD.FundModel = ''25'' AND @Split1619Funding = 1 AND COALESCE ( HRS.PLH, 0 ) > 0 THEN 1 ELSE 0 END,
			ALS1619FundingPercent = @1619ALSFundingPercent,
			Is1619FundingReapportionedByAim = @Reapportion1619FundingByAimWeighting,
			InvalidLearners = INV.InvalidLearners,

			LearnerRef = L.LearnRefNumber,
			Surname = L.FamilyName,
			Forename = L.GivenNames,
			Sex = L.Sex,
			DOB = L.DateOfBirth,
			Age31Aug = 
				CASE
					WHEN MONTH ( L.DateOfBirth ) <= 8 THEN ''20'' + LEFT ( @AcademicYear, 2 ) - YEAR ( L.DateOfBirth )
					ELSE CAST (''20'' + LEFT ( @AcademicYear, 2 ) - 1 AS INT ) - YEAR ( L.DateOfBirth )
				END,
			ULN = L.ULN,
			NINumber = L.NINumber,
			Address1 = L.AddLine1,
			Address2 = L.AddLine2,
			Address3 = L.AddLine3,
			Address4 = L.AddLine4,
			PostCodeCurrent = L.Postcode,
			PostCodePriorToEnrol = L.PostcodePrior,
			PostCodeLearningStartDate = LD.LSDPostcode,
			Tel = L.TelNo,
			Email = L.Email,
			PostCodeWardCode = PC.WardCode,
			PostCodeWardName = PC.WardName,
			PostCodeDistrictCode = PC.DistrictCode,
			PostCodeDistrictName = PC.DistrictName,
			PostCodeLEACode = PC.LEACode,
			PostCodeLEAName = PC.LEAName,
			PostCodeSourceOfFundingCode = PC.SourceOfFunding,
			PostCodeDisadvUplift = COALESCE ( PC.DisadvUplift, 1 ),
			EmpStatusCode = EMP.EmpStatusCode,
			EmpStatusName = EMP.EmpStatusName,
			EmpStatusAppliesDate = EMP.EmpStatusAppliesDate,
			EmpStatusEmployerID = EMP.EmployerID,
			LengthOfEmploy = ESM.LOE,
			LengthOfUnemploy = ESM.LOU,
			BenefitStatusInd = ESM.BSI,
			SmallEmployer = ESM.SEM,
			SelfEmployInd = ESM.SEI,
			EmployIntensityInd = ESM.EII,
			IsFirstFullLevel2 = NULL,
			IsFirstFullLevel3 = NULL,
			PriorLevelCode = ATN.PriorLevel,
			PriorLevelName = PLEV.Description,
			PriorLevelDate = ATN.DateLevelApp,
			EthnicityCode = L.Ethnicity,
			EthnicityName = ETH.Description,
			LLDDHealthProb = L.LLDDHealthProb,
			PrimaryLLDDHealthProblemCode = LLDD.LLDDCat,
			PrimaryLLDDHealthProblemName = DIS.Description,
			FAMLearnerHNS = FAML.FAMLearnerHNS,
			FAMLearnerEHC = FAML.FAMLearnerEHC,
			FAMLearnerDLA = FAML.FAMLearnerDLA,
			FAMLearnerLSR = FAML.FAMLearnerLSR,
			FAMLearnerSEN = FAML.FAMLearnerSEN,
			FAMLearnerNLM = FAML.FAMLearnerNLM,
			FAMLearnerEDF = FAML.FAMLearnerEDF,
			FAMLearnerMCF = FAML.FAMLearnerMCF,
			FAMLearnerECF = FAML.FAMLearnerECF,
			FAMLearnerFME = FAML.FAMLearnerFME,
			DestinationProgressionType = OC.DPOutcomeType,
			DestinationProgressionNumber = OC.DPOutcomeCode,
			DestinationProgressionCode = DES.Code,
			DestinationProgressionName = DES.Description,
			DestinationProgressionStartDate = OC.DPOutcomeStartDate,
			DestinationProgressionEndDate = OC.DPOutcomeEndDate,
			DestinationProgressionCollectionDate = OC.DPOutcomeCollectionDate,

			SoftwareSupplierAimID = LD.SWSupAimId,
			FundLine = 
				COALESCE ( 
					CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
					FM25.FundLine, 
					CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
					CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine <> ''None'' THEN ALB.FundLine END,
					FM36P.FundLineType,
					FM35.FundLine,
					CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
					CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
				),
    '

    SET @SQLString += 
        N'
			FundLineSummary =
				CASE
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) IN (
							''16-19 Students (excluding High Needs Students)'',
							 ''16-19 High Needs Students'',
							 ''19-24 Students with an EHCP'',
							 ''19+ Continuing Students (excluding EHCP)''
						)
							 THEN ''16-19 Funding''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Employer on App Service%''
							 THEN ''Apprenticeships (App Service)''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''Apprenticeships (Legacy)''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''Apprenticeships (Reformed)''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''Apprenticeships (Reformed)''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Employer on App Service%''
							 THEN ''Apprenticeships (App Service)''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''Apprenticeships (Legacy)''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''Apprenticeships (Reformed)''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''Apprenticeships (Reformed)''
                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''Loan%''
                            THEN ''Loans''

                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''Higher Education%''
                            THEN ''HE''

                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%AEB%''
                            THEN ''Adult - ESFA''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Eligible for MCA/GLA funding%''
                            THEN ''Adult - Devolved''
	'

    SET @SQLString += 
        N'
                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) = ''Advanced Learner Loan (ALL)''
                            THEN ''Adult - ESFA''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) = ''ESFA NSF Free Courses for Jobs (non-procured)''
                            THEN ''Adult - ESFA''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''24% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''Apprenticeships (Legacy)''

					ELSE 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						)
				END,
	'

    SET @SQLString += 
        N'
			FundLineDetail =
				CASE
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) IN (
							''16-19 Students (excluding High Needs Students)'',
							 ''16-19 High Needs Students'',
							 ''19-24 Students with an EHCP'',
							 ''19+ Continuing Students (excluding EHCP)''
						)
							 THEN ''16-19 Students (inc. High Needs)''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''16-18 Apprenticeship''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''16-18 Apprenticeship Non-Levy''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''16-18 Apprenticeship Levy''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''19+ Apprenticeship''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''19+ Apprenticeship Non-Levy''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''19+ Apprenticeship Levy''
                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''24% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''19+ Apprenticeship''
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%AEB%''
                            THEN ''AEB - ESFA''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Eligible for MCA/GLA funding%''
                            THEN ''AEB - '' + FM35.LearnDelFundOrgCode

					ELSE 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						)
				END,
    '

    SET @SQLString += 
        N'
			FundModel = LD.FundModel,
			HEFullPartTime = 
				CASE
					WHEN HE.MODESTUD = 1 THEN ''Full Time''
					WHEN HE.MODESTUD = 3 THEN ''Part Time''
					WHEN HE.MODESTUD = 2 THEN ''Year Out''
					ELSE NULL
				END,
			SortOrder =
				CASE
					COALESCE ( 
						CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
						FM25.FundLine, 
						CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
						FM36P.FundLineType,
						FM35.FundLine,
						CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
						CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
					)
					WHEN ''16-19 Students (excluding High Needs Students)'' THEN 1
					WHEN ''16-19 High Needs Students'' THEN 2
					WHEN ''19-24 Students with an EHCP'' THEN 3
					WHEN ''Advanced Learner Loan (ALL)'' THEN 4
					WHEN ''Advanced Learner Loans Bursary'' THEN 5
					WHEN ''19+ Continuing Students (excluding EHCP)'' THEN 6
					WHEN ''AEB - Other Learning (non-procured)'' THEN 7
					WHEN ''ESFA AEB - Adult Skills (non-procured)'' THEN 8
					WHEN ''Adult Education - Eligible for MCA/GLA funding (non-procured)'' THEN 9
					WHEN ''Higher Education'' THEN 10
					WHEN ''Full Cost'' THEN 11
					ELSE 99
				END,
	'

    SET @SQLString += 
        N'
			IsFunded = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ),
			IsPre42DayWdrAllYr = 
				CASE 
					WHEN 
						COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 0 
						AND LD.CompStatus = ''3''
						AND COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' THEN 1 
					ELSE 0 
				END,
			IsXfrAllYr = 
				CASE 
					WHEN 
						LD.CompStatus = ''3'' 
						AND COALESCE ( LD.WithdrawReason, ''0'' ) = ''40'' THEN 1 
					ELSE 0 
				END,
			IsStartAllYr = 
				CASE 
					WHEN COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 1 THEN 1 
					ELSE 0 
				END,
			IsPost42DayWdrAllYr = 
				CASE 
					WHEN 
						COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 1 
						AND LD.CompStatus = ''3'' 
						AND COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' THEN 1 
					ELSE 0 
				END,
			IsCompAllYr = 
				CASE 
					WHEN 
						COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 1 
						AND LD.CompStatus = ''2'' THEN 1 
					ELSE 0 
				END,
			IsAchAllYr = 
				CASE 
					WHEN 
						COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 1 
						AND LD.CompStatus = ''2'' 
						AND LD.Outcome IN ( 1, 7 ) THEN 1 
					ELSE 0 
				END,
			IsPre42DayWdrCurYr = 
				CASE 
					WHEN 
						LD.LearnPlanEndDate <= ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31''
						AND COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 0 
						AND LD.CompStatus = ''3'' 
						AND COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' THEN 1 
					ELSE 0 
				END,
			IsXfrCurYr = 
				CASE 
					WHEN 
						LD.LearnPlanEndDate <= ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31''
						AND LD.CompStatus = ''3'' 
						AND COALESCE ( LD.WithdrawReason, ''0'' ) = ''40'' THEN 1 
					ELSE 0 
				END,
			IsStartCurYr = 
				CASE 
					WHEN 
						LD.LearnPlanEndDate <= ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31''
						AND COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 1 THEN 1
					ELSE 0 
				END,
			IsPost42DayWdrCurYr = 
				CASE 
					WHEN 
						LD.LearnPlanEndDate <= ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31''
						AND COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 1 
						AND LD.CompStatus = ''3'' 
						AND COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' THEN 1 
					ELSE 0 
				END,
			IsCompCurYr = 
				CASE 
					WHEN 
						LD.LearnPlanEndDate <= ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31''
						AND COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 1 
						AND LD.CompStatus = ''2'' THEN 1 
					ELSE 0 
				END,
			IsAchCurYr = 
				CASE 
					WHEN 
						LD.LearnPlanEndDate <= ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31''
						AND COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 1 
						AND LD.CompStatus = ''2'' 
						AND LD.Outcome IN ( 1, 7 ) THEN 1 
					ELSE 0 
				END,
			IsHighGrade = 
				CASE
					WHEN COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 0 THEN 0
					WHEN AIM.LearningAimTypeCode IN ( ''0003'', ''1081'', ''1422'', ''2999'' ) THEN 
						CASE
							WHEN LD.OutGrade IN ( ''A*'', ''A'', ''B'' ) THEN 1
							ELSE 0
						END
					WHEN LD.OutGrade LIKE ''D%'' THEN 1
					ELSE 0
				END,
	'

    SET @SQLString += 
        N'
			IsMainAim = 
				CASE
					WHEN LD.AimSeqNumber = MA.AimSeqNumber THEN 1
					ELSE 0
				END,
			IsMainAimInFundModel = 
				CASE
					WHEN LD.AimSeqNumber = MAFM.AimSeqNumber THEN 1
					ELSE 0
				END,
			IsAdvLearnLoan = ALB.AdvLoan,
			IsAdvLearnLoanBursary = CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine <> ''None'' THEN 1 ELSE 0 END,
			RateBand = HRS.RateBand,
			RateBandOrder = HRS.RateBandOrder,
			GCSEMathsGrade = L.MathGrade,
			GCSEEnglishGrade = L.EngGrade,
			CofMaths = FM25.ConditionOfFundingMaths,
			CofEnglish = FM25.ConditionOfFundingEnglish,
			CofMathsMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN FM25.ConditionOfFundingMaths = ''Doesn''''t have Maths, Not Studying Maths'' THEN 0
                    WHEN FM25.ConditionOfFundingMaths = ''Has Maths GCSE Grade D or Grade 3, Not studying GCSE Maths'' THEN 0
					ELSE 1
				END,
			CofEnglishMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN FM25.ConditionOfFundingEnglish = ''Doesn''''t have English, Not Studying English'' THEN 0
                    WHEN FM25.ConditionOfFundingEnglish = ''Has English GCSE Grade D or Grade 3, Not studying GCSE English'' THEN 0
					ELSE 1
				END,
			CofMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN 
						FM25.ConditionOfFundingEnglish = ''Doesn''''t have English, Not Studying English'' 
                        OR FM25.ConditionOfFundingEnglish = ''Has English GCSE Grade D or Grade 3, Not studying GCSE English'' 
						OR FM25.ConditionOfFundingMaths = ''Doesn''''t have Maths, Not Studying Maths''
                        OR FM25.ConditionOfFundingMaths = ''Has Maths GCSE Grade D or Grade 3, Not studying GCSE Maths''
						THEN 0
					ELSE 1
				END,
			Block1DisadvUplift = FM25.Block1DisadvUpliftNew,
			Block2DisadvElements = FM25.Block2DisadvElementsNew,
			ProgWeightingFactor = FM25.ProgWeightNew,
			ThresholdDays = FM25.ThresholdDays,
			FAMLearningDeliverySOF = FAMA.FAMLearningDeliverySOF,
			FAMLearningDeliveryFFI = FAMA.FAMLearningDeliveryFFI,
			FAMLearningDeliveryEEF = FAMA.FAMLearningDeliveryEEF,
			FAMLearningDeliveryRES = FAMA.FAMLearningDeliveryRES,
			FAMLearningDeliveryLSF = FAMA.FAMLearningDeliveryLSF,
			FAMLearningDeliveryADL = FAMA.FAMLearningDeliveryADL,
			FAMLearningDeliveryALB = FAMA.FAMLearningDeliveryALB,
			FAMLearningDeliveryASL = FAMA.FAMLearningDeliveryASL,
			FAMLearningDeliveryFLN = FAMA.FAMLearningDeliveryFLN,
			FAMLearningDeliveryLDM = FAMA.FAMLearningDeliveryLDM,
			FAMLearningDeliveryDAM = FAMA.FAMLearningDeliveryDAM,
			FAMLearningDeliveryACT = FAMA.FAMLearningDeliveryACT,
			FAMLearningDeliveryACL = FAMA.FAMLearningDeliveryACL,
			FAMLearningDeliveryAFL = FAMA.FAMLearningDeliveryAFL,
			PostCodeDelivery = LD.DelLocPostCode,
	'

    SET @SQLString += 
        N'
			CampusID = L.CampId,
			ParentCollegeLevel1Code = COALESCE ( PCS.CollegeLevel1Code, ''-''),
			ParentCollegeLevel1Name = COALESCE ( PCS.CollegeLevel1Name, ''-- Unknown --''),
			ParentCollegeLevel2Code = COALESCE ( PCS.CollegeLevel2Code, ''-''),
			ParentCollegeLevel2Name = COALESCE ( PCS.CollegeLevel2Name, ''-- Unknown --''),
			ParentCollegeLevel3Code = COALESCE ( PCS.CollegeLevel3Code, ''-''),
			ParentCollegeLevel3Name = COALESCE ( PCS.CollegeLevel3Name, ''-- Unknown --''),
			ParentCollegeLevel4Code = COALESCE ( PCS.CollegeLevel4Code, ''-''),
			ParentCollegeLevel4Name = COALESCE ( PCS.CollegeLevel4Name, ''-- Unknown --''),

			CollegeLevel1Code = COALESCE ( CS.CollegeLevel1Code, ''-''),
			CollegeLevel1Name = COALESCE ( CS.CollegeLevel1Name, ''-- Unknown --''),
			CollegeLevel2Code = COALESCE ( CS.CollegeLevel2Code, ''-''),
			CollegeLevel2Name = COALESCE ( CS.CollegeLevel2Name, ''-- Unknown --''),
    '

    SET @SQLString += 
        N'
			CollegeLevel3Code = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN @OverrideEngFac END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN @OverrideMatFac END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN @OverridePartnerFac END,
					CS.CollegeLevel3Code,
					''-''
				),
			CollegeLevel3Name = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN FENG.CollegeLevel3Name END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN FMAT.CollegeLevel3Name END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN FPAR.CollegeLevel3Name END,
					CS.CollegeLevel3Name,
					''-- Unknown --''
				),
			CollegeLevel4Code = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN @OverrideEngTeam END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN @OverrideMatTeam END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN @OverridePartnerTeam END,
					CS.CollegeLevel4Code,
					''-''
				),
			CollegeLevel4Name = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN TENG.CollegeLevel4Name END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN TMAT.CollegeLevel4Name END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN TPAR.CollegeLevel4Name END,
					CS.CollegeLevel4Name,
					''-- Unknown --''
				),
	'

    SET @SQLString += 
        N'
			OriginalCollegeLevel1Code = COALESCE ( CS.CollegeLevel1Code, ''-''),
			OriginalCollegeLevel1Name = COALESCE ( CS.CollegeLevel1Name, ''-- Unknown --''),
			OriginalCollegeLevel2Code = COALESCE ( CS.CollegeLevel2Code, ''-''),
			OriginalCollegeLevel2Name = COALESCE ( CS.CollegeLevel2Name, ''-- Unknown --''),
			OriginalCollegeLevel3Code = COALESCE ( CS.CollegeLevel3Code, ''-''),
			OriginalCollegeLevel3Name = COALESCE ( CS.CollegeLevel3Name, ''-- Unknown --''),
			OriginalCollegeLevel4Code = COALESCE ( CS.CollegeLevel4Code, ''-''),
			OriginalCollegeLevel4Name = COALESCE ( CS.CollegeLevel4Name, ''-- Unknown --''),
			
			MainAimCollegeLevel1Code = COALESCE ( CS.CollegeLevel1Code, ''-''),
			MainAimCollegeLevel1Name = COALESCE ( CS.CollegeLevel1Name, ''-- Unknown --''),
			MainAimCollegeLevel2Code = COALESCE ( CS.CollegeLevel2Code, ''-''),
			MainAimCollegeLevel2Name = COALESCE ( CS.CollegeLevel2Name, ''-- Unknown --''),
			MainAimCollegeLevel3Code = COALESCE ( CS.CollegeLevel3Code, ''-''),
			MainAimCollegeLevel3Name = COALESCE ( CS.CollegeLevel3Name, ''-- Unknown --''),
			MainAimCollegeLevel4Code = COALESCE ( CS.CollegeLevel4Code, ''-''),
			MainAimCollegeLevel4Name = COALESCE ( CS.CollegeLevel4Name, ''-- Unknown --''),

			SSA1Code = AIM.SSA1Code,
			SSA1Title = AIM.SSA1Name,
			SSA2Code = AIM.SSA2Code,
			SSA2Title = AIM.SSA2Name,
			CourseCode = COALESCE ( CS.CourseCode, ''-''),
			CourseTitle = COALESCE ( CS.CourseTitle, ''-- Unknown --''),

			AimSequence = LD.AimSeqNumber,
			AimType = LD.AimType,
			LearningAimCode = LD.LearnAimRef,
			LearningAimTitle = AIM.LearningAimTitle,
			LearningAimTypeCode = AIM.LearningAimTypeCode,
			LearningAimTypeName = AIM.LearningAimTypeName,
			NVQLevelCode = AIM.NVQLevelCode,
			NVQLevelName = AIM.NVQLevelName,
			NVQLevelCode = AIM.NVQLevelOrder,
			IsMathsAndEnglish = AIM.IsMathsAndEnglish,
			MainAimNVQLevelCode = COALESCE ( MA.NVQLevelCode, AIM.NVQLevelCode ),
			MainAimNVQLevelName = COALESCE ( MA.NVQLevelName, AIM.NVQLevelName ),
			MainAimNVQLevelCode = COALESCE ( MA.NVQLevelOrder, AIM.NVQLevelOrder ),
			MainAimIsMathsAndEnglish = COALESCE ( MA.IsMathsAndEnglish, AIM.IsMathsAndEnglish ),

			StartDate = LD.LearnStartDate,
			OriginalStartDate = LD.OrigLearnStartDate,
			ExpEndDate = LD.LearnPlanEndDate,
			ActEndDate = LD.LearnActEndDate,
			PlanLearnHours = COALESCE ( L.PlanLearnHours, 0 ),
			PlanEEPHours = COALESCE ( L.PlanEEPHours, 0 ),
			FM25PLHAim = COALESCE ( CASE WHEN LD.FundModel = ''25'' AND ( COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 ) THEN CH.PLH END, 0 ),
			FM25EEPAim = COALESCE ( CASE WHEN LD.FundModel = ''25'' AND ( COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 ) THEN CH.EEP END, 0 ),
			FM25PLHAllAims = COALESCE ( HRS.PLH, 0 ),
			FM25EEPAllAims = COALESCE ( HRS.EEP, 0 ),
			IsPartTime = 
				CASE
					WHEN FM25.RateBand LIKE ''%Band 5%'' THEN ''N''
					WHEN FM25.RateBand LIKE ''%Band 4a%'' THEN ''N''
					WHEN FM25.RateBand LIKE ''%T level%'' THEN ''N''
					WHEN HE.MODESTUD = 1 THEN ''N''
					WHEN COALESCE ( L.PlanLearnHours, 0 ) + COALESCE ( L.PlanEEPHours, 0 ) >= 450 THEN ''N''
					ELSE ''Y''
				END,
    '

    SET @SQLString += 
        N'
			CompletionCode = LD.CompStatus,
			CompletionDesc = 
				CASE
					WHEN LD.CompStatus = ''1'' THEN ''Continuing''
					WHEN LD.CompStatus = ''2'' THEN ''Completed''
					WHEN LD.CompStatus = ''3'' THEN ''Withdrawn''
					WHEN LD.CompStatus = ''6'' THEN ''Break in Learning''
					ELSE ''Unknown''
				END,
			OutcomeCode = LD.Outcome,
			OutcomeDesc = 
				CASE
					WHEN LD.Outcome IS NULL THEN NULL
					WHEN LD.Outcome = ''1'' THEN ''Achieved''
					WHEN LD.Outcome = ''2'' THEN ''Partialy Achieved''
					WHEN LD.Outcome = ''3'' THEN ''Fail''
					WHEN LD.Outcome = ''8'' THEN ''Unknown''
					ELSE ''Unknown''
				END,
			WithdrawReason = LD.WithdrawReason,
			Grade = LD.OutGrade,
			AwardBody = AIM.AwardBodyCode,

			ProgType = LD.ProgType,
			StandardCode = LD.StdCode,
			StandardName = COALESCE ( STD.StandardName, CASE WHEN LD.StdCode IS NULL THEN NULL ELSE ''-- Unknown --'' END ),
			FrameworkCode = LD.FworkCode,
			FrameworkName = COALESCE ( FW.FrameworkName, CASE WHEN LD.FworkCode IS NULL THEN NULL ELSE ''-- Unknown --'' END ),
			PathwayCode = LD.PwayCode,
			PathwayName = COALESCE ( PWAY.PathwayName, CASE WHEN LD.PwayCode IS NULL THEN NULL ELSE ''-- Unknown --'' END ),
			OffTheJobActualHours = LD.OTJActHours,
			EmployerID = EMP.EmployerID,
			EmployerName = EMPN.EmployerName,
			PartnerCode = 
				CASE
					WHEN LD.LearnAimRef = ''ZPROG001'' THEN PTR.PartnerUKPRN
					ELSE LD.PartnerUKPRN
				END,
			PartnerName = PAR.PartnerName,

			AimValue = FM35.AimValue,
			ProgWeightFactor = FM35.ApplicProgWeightFact,
			UnweightFundRate = FM35.ApplicUnweightFundRate,
			WeightFundRate = FM35.ApplicWeightFundRate,

			CoFundingIndicator = 
				CASE
					WHEN FFI.LearnDelFAMCode IS NULL THEN NULL
					WHEN FFI.LearnDelFAMCode = ''1'' THEN ''Full''
					WHEN FFI.LearnDelFAMCode = ''2'' THEN ''Co''
					ELSE NULL
				END,
			IsCarryIn = 
				CASE
					WHEN CAST ( LD.LearnStartDate AS DATE ) <= ''20'' + LEFT ( @AcademicYear, 2) + ''-08-01'' THEN 1
					ELSE 0
				END,
			HEQualEnt3 = HE.QUALENT3,
			HESoc2000 = HE.SOC2000,
			HESec = HE.SEC,
			HEUCASAppID = HE.UCASAPPID,
			HETypeYr = HE.TYPEYR,
			HEModeStu = HE.MODESTUD,
			HEFundLev = HE.FUNDLEV,
			HEFundComp = HE.FUNDCOMP,
			HEStuLoad = HE.STULOAD,
			HEYearStu = HE.YEARSTU,
			HEMajorSourceStuFee = HE.MSTUFEE,
			HEPercentageNotTaught = HE.PCOLAB,
			HEPercentTaughtFirstLDCS = NULL,
			HEPercentTaughtSecondLDCS = NULL,
			HEPercentTaughtThirdLDCS = NULL,
			HESpecialFeeIndicator = HE.SPECFEE,
			HENetTuitionFee = HE.NETFEE,
			HEGrossTuitionFee = HE.GROSSFEE,
			HEDomicile = HE.DOMICILE,
			HEELQ = HE.ELQ,
			HEPostCode = HE.HEPostCode,
			EnrolmentID = PSDMC.ProvSpecDelMon,
			FM25TotFund = COALESCE ( HRS.OnProgPayment, 0 ),
	'

    SET @SQLString += 
        N'
			NumPlannedOnProgPayments = COALESCE ( ALB.PlannedNumOnProgInstalm, FM36.PlannedNumOnProgInstalm, FM35.PlannedNumOnProgInstalm ),
			NumOutstandingOnProgPayments = COALESCE ( ALB.OutstndNumOnProgInstalm, FM36.OutstandNumOnProgInstalm, FM35.OutstndNumOnProgInstalm ),
			AchieveElement = FM35.AchieveElement,
			NonGovCont = FM35.NonGovCont,
			PropFundRemain = FM35.PropFundRemain,
			PropFundRemainAch = FM35.PropFundRemainAch,
			CarryInOnProg = 
				CASE
					WHEN COALESCE ( FM35.PropFundRemain, 0 ) = 0 THEN 0
					ELSE 
						( FM35.AimValue - FM35.NonGovCont - FM35.AchieveElement ) * FM35.PropFundRemain
				END,
	'

    SET @SQLString += 
        N'
			CI.CarryInYr1R01,
			CI.CarryInYr1R02,
			CI.CarryInYr1R03,
			CI.CarryInYr1R04,
			CI.CarryInYr1R05,
			CI.CarryInYr1R06,
			CI.CarryInYr1R07,
			CI.CarryInYr1R08,
			CI.CarryInYr1R09,
			CI.CarryInYr1R10,
			CI.CarryInYr1R11,
			CI.CarryInYr1R12,
			CI.CarryInYr2R01,
			CI.CarryInYr2R02,
			CI.CarryInYr2R03,
			CI.CarryInYr2R04,
			CI.CarryInYr2R05,
			CI.CarryInYr2R06,
			CI.CarryInYr2R07,
			CI.CarryInYr2R08,
			CI.CarryInYr2R09,
			CI.CarryInYr2R10,
			CI.CarryInYr2R11,
			CI.CarryInYr2R12,
	'

    SET @SQLString += 
        N'
			OnProgPaymentToPeriod = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) * @ILRReturn END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeHEAdvLoanPossIncome = 1 THEN ALBP.TotFundToPeriod END, FM35P.OnProgPaymentToPeriod, FM36P.OnProgPaymentToPeriod, ( CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * @ILRReturn, 0 ),
			LearnSuppPaymentToPeriod = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) * @ILRReturn END, FM35P.LearnSuppPaymentToPeriod, FM36P.LearnSuppPaymentToPeriod, 0 ),
			AchCompPaymentToPeriod = COALESCE ( FM35P.AchCompPaymentToPeriod, FM36P.AchCompPaymentToPeriod, 0 ),
			BalancePaymentToPeriod = COALESCE ( FM35P.BalancePaymentToPeriod, FM36P.BalancePaymentToPeriod, 0 ),
			EmpOutcomePayToPeriod = COALESCE ( FM35P.EmpOutcomePayToPeriod, 0 ),
			OtherPaymentToPeriod = COALESCE ( FM36P.OtherPaymentToPeriod, 0 ),
			TotFundToPeriod = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) * @ILRReturn END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundToPeriod END, FM35P.TotFundToPeriod, FM36P.TotFundToPeriod, ( CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * @ILRReturn, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPayment6Mon = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) * 6 END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFund6Mon END, FM35P.OnProgPayment6Mon, FM36P.OnProgPayment6Mon, ( CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * 6, 0 ),
			LearnSuppPayment6Mon = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) * 6 END, FM35P.LearnSuppPayment6Mon, FM36P.LearnSuppPayment6Mon, 0 ),
			AchCompPayment6Mon = COALESCE ( FM35P.AchCompPayment6Mon, FM36P.AchCompPayment6Mon, 0 ),
			BalancePayment6Mon = COALESCE ( FM35P.BalancePayment6Mon, FM36P.BalancePayment6Mon, 0 ),
			EmpOutcomePay6Mon = COALESCE ( FM35P.EmpOutcomePay6Mon, 0 ),
			OtherPayment6Mon = COALESCE ( FM36P.OtherPayment6Mon, 0 ),
			TotFund6Mon = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) * 6 END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFund6Mon END, FM35P.TotFund6Mon, FM36P.TotFund6Mon, ( CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * 6, 0 ),
	'

    SET @SQLString += 
		N'
			OnProgPaymentYrEnd = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundYrEnd END, FM35P.OnProgPaymentYrEnd, FM36P.OnProgPaymentYrEnd, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END, 0 ),
			LearnSuppPaymentYrEnd = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END END, FM35P.LearnSuppPaymentYrEnd, FM36P.LearnSuppPaymentYrEnd, 0 ),
			AchCompPaymentYrEnd = COALESCE ( FM35P.AchCompPaymentYrEnd, FM36P.AchCompPaymentYrEnd, 0 ),
			BalancePaymentYrEnd = COALESCE ( FM35P.BalancePaymentYrEnd, FM36P.BalancePaymentYrEnd, 0 ),
			EmpOutcomePayYrEnd = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentYrEnd = COALESCE ( FM36P.OtherPaymentYrEnd, 0 ),
			TotFundYrEnd = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundYrEnd END, FM35P.TotFundYrEnd, FM36P.TotFundYrEnd, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END, 0 ),
	'

    SET @SQLString += 
        N'
			TotFundYrEndNotApportioned = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN 
				CASE
					WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
						( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
						+ ( 
							FM25.OnProgPayment 
							- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
						)
					ELSE FM25.OnProgPayment
				END
				END, 
				CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundYrEnd END, FM35P.TotFundYrEnd, FM36P.TotFundYrEnd, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END, 0 ),

			FutureAchievePayment = 
				CASE
					WHEN LD.CompStatus <> 1 AND NOT ( LD.CompStatus = 2 AND LD.Outcome = 8 ) THEN 0
					WHEN LD.LearnPlanEndDate NOT BETWEEN ''20'' + LEFT ( @AcademicYear, 2 ) + ''-08-01'' AND ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31'' THEN 0
					ELSE COALESCE ( FM35.AchieveElement - FM35P.AchCompPaymentYrEnd, FM36PE.PriceEpisodeCompletionElement - FM36P.AchCompPaymentYrEnd )
				END,
			FutureAchieveWeighting = @FutureAchieveWeighting,
			FutureAchievePaymentWeighted = 
				CASE
					WHEN LD.CompStatus <> 1 AND NOT ( LD.CompStatus = 2 AND LD.Outcome = 8 ) THEN 0
					WHEN LD.LearnPlanEndDate NOT BETWEEN ''20'' + LEFT ( @AcademicYear, 2 ) + ''-08-01'' AND ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31'' THEN 0
					ELSE COALESCE ( FM35.AchieveElement - FM35P.AchCompPaymentYrEnd, FM36PE.PriceEpisodeCompletionElement - FM36P.AchCompPaymentYrEnd ) * @FutureAchieveWeighting
				END,
	'

    SET @SQLString += 
        N'
			AppStandardPriceEpisodeIdentifier = FM36PE.PriceEpisodeIdentifier,
			AppStandardTNP1 = FM36PE.TNP1,
			AppStandardTNP2 = FM36PE.TNP2,
			AppStandardTNP3 = FM36PE.TNP3,
			AppStandardTNP4 = FM36PE.TNP4,
			AppStandardEpisodeStartDate = FM36PE.EpisodeStartDate,
			AppStandardPriceEpisode1618FrameworkUpliftRemainingAmount = FM36PE.PriceEpisode1618FrameworkUpliftRemainingAmount,
			AppStandardPriceEpisode1618FrameworkUpliftTotPrevEarnings = FM36PE.PriceEpisode1618FrameworkUpliftTotPrevEarnings,
			AppStandardPriceEpisode1618FUBalValue = FM36PE.PriceEpisode1618FUBalValue,
			AppStandardPriceEpisode1618FUMonthInstValue = FM36PE.PriceEpisode1618FUMonthInstValue,
			AppStandardPriceEpisode1618FUTotEarnings = FM36PE.PriceEpisode1618FUTotEarnings,
			AppStandardPriceEpisodeUpperBandLimit = FM36PE.PriceEpisodeUpperBandLimit,
			AppStandardPriceEpisodePlannedEndDate = FM36PE.PriceEpisodePlannedEndDate,
			AppStandardPriceEpisodeActualEndDate = FM36PE.PriceEpisodeActualEndDate,
			AppStandardPriceEpisodeActualEndDateIncEPA = FM36PE.PriceEpisodeActualEndDateIncEPA,
			AppStandardPriceEpisodeTotalTNPPrice = FM36PE.PriceEpisodeTotalTNPPrice,
			AppStandardPriceEpisodeUpperLimitAdjustment = FM36PE.PriceEpisodeUpperLimitAdjustment,
			AppStandardPriceEpisodePlannedInstalments = FM36PE.PriceEpisodePlannedInstalments,
			AppStandardPriceEpisodeActualInstalments = FM36PE.PriceEpisodeActualInstalments,
			AppStandardPriceEpisodeCompletionElement = FM36PE.PriceEpisodeCompletionElement,
			AppStandardPriceEpisodePreviousEarnings = FM36PE.PriceEpisodePreviousEarnings,
			AppStandardPriceEpisodeInstalmentValue = FM36PE.PriceEpisodeInstalmentValue,
			AppStandardPriceEpisodeTotalEarnings = FM36PE.PriceEpisodeTotalEarnings,
			AppStandardPriceEpisodeCompleted = FM36PE.PriceEpisodeCompleted,
			AppStandardPriceEpisodeRemainingTNPAmount = FM36PE.PriceEpisodeRemainingTNPAmount,
			AppStandardPriceEpisodeRemainingAmountWithinUpperLimit = FM36PE.PriceEpisodeRemainingAmountWithinUpperLimit,
			AppStandardPriceEpisodeCappedRemainingTNPAmount = FM36PE.PriceEpisodeCappedRemainingTNPAmount,
			AppStandardPriceEpisodeExpectedTotalMonthlyValue = FM36PE.PriceEpisodeExpectedTotalMonthlyValue,
			AppStandardPriceEpisodeAimSeqNumber = FM36PE.PriceEpisodeAimSeqNumber,
			AppStandardPriceEpisodeApplic1618FrameworkUpliftCompElement = FM36PE.PriceEpisodeApplic1618FrameworkUpliftCompElement,
			AppStandardPriceEpisodeFundLineType = FM36PE.PriceEpisodeFundLineType,
			AppStandardEpisodeEffectiveTNPStartDate = FM36PE.EpisodeEffectiveTNPStartDate,
			AppStandardPriceEpisodeFirstAdditionalPaymentThresholdDate = FM36PE.PriceEpisodeFirstAdditionalPaymentThresholdDate,
			AppStandardPriceEpisodeSecondAdditionalPaymentThresholdDate = FM36PE.PriceEpisodeSecondAdditionalPaymentThresholdDate,
			AppStandardPriceEpisodeContractType = FM36PE.PriceEpisodeContractType,
			AppStandardPriceEpisodePreviousEarningsSameProvider = FM36PE.PriceEpisodePreviousEarningsSameProvider,
			AppStandardPriceEpisodeTotalPMRs = FM36PE.PriceEpisodeTotalPMRs,
			AppStandardPriceEpisodeCumulativePMRs = FM36PE.PriceEpisodeCumulativePMRs,
			AppStandardPriceEpisodeCompExemCode = FM36PE.PriceEpisodeCompExemCode,
			AppStandardPriceEpisodeLearnerAdditionalPaymentThresholdDate = FM36PE.PriceEpisodeLearnerAdditionalPaymentThresholdDate,
			AppStandardPriceEpisodeRedStartDate = FM36PE.PriceEpisodeRedStartDate,
			AppStandardPriceEpisodeRedStatusCode = FM36PE.PriceEpisodeRedStatusCode,
	'

    SET @SQLString += 
		N'
			OnProgPaymentP01 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP01 END, FM35P.OnProgPaymentP01, FM36P.OnProgPaymentP01, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP01 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP01, FM36P.LearnSuppPaymentP01, 0 ),
			AchCompPaymentP01 = COALESCE ( FM35P.AchCompPaymentP01, FM36P.AchCompPaymentP01, 0 ),
			BalancePaymentP01 = COALESCE ( FM35P.BalancePaymentP01, FM36P.BalancePaymentP01, 0 ),
			EmpOutcomePayP01 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP01 = COALESCE ( FM36P.OtherPaymentP01, 0 ),
			TotFundP01 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP01 END, FM35P.TotFundP01, FM36P.TotFundP01, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP02 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP02 END, FM35P.OnProgPaymentP02, FM36P.OnProgPaymentP02, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP02 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP02, FM36P.LearnSuppPaymentP02, 0 ),
			AchCompPaymentP02 = COALESCE ( FM35P.AchCompPaymentP02, FM36P.AchCompPaymentP02, 0 ),
			BalancePaymentP02 = COALESCE ( FM35P.BalancePaymentP02, FM36P.BalancePaymentP02, 0 ),
			EmpOutcomePayP02 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP02 = COALESCE ( FM36P.OtherPaymentP02, 0 ),
			TotFundP02 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP02 END, FM35P.TotFundP02, FM36P.TotFundP02, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
		N'
			OnProgPaymentP03 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP03 END, FM35P.OnProgPaymentP03, FM36P.OnProgPaymentP03, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP03 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP03, FM36P.LearnSuppPaymentP03, 0 ),
			AchCompPaymentP03 = COALESCE ( FM35P.AchCompPaymentP03, FM36P.AchCompPaymentP03, 0 ),
			BalancePaymentP03 = COALESCE ( FM35P.BalancePaymentP03, FM36P.BalancePaymentP03, 0 ),
			EmpOutcomePayP03 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP03 = COALESCE ( FM36P.OtherPaymentP03, 0 ),
			TotFundP03 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP03 END, FM35P.TotFundP03, FM36P.TotFundP03, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP04 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP04 END, FM35P.OnProgPaymentP04, FM36P.OnProgPaymentP04, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP04 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP04, FM36P.LearnSuppPaymentP04, 0 ),
			AchCompPaymentP04 = COALESCE ( FM35P.AchCompPaymentP04, FM36P.AchCompPaymentP04, 0 ),
			BalancePaymentP04 = COALESCE ( FM35P.BalancePaymentP04, FM36P.BalancePaymentP04, 0 ),
			EmpOutcomePayP04 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP04 = COALESCE ( FM36P.OtherPaymentP04, 0 ),
			TotFundP04 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP04 END, FM35P.TotFundP04, FM36P.TotFundP04, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
		N'
			OnProgPaymentP05 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP05 END, FM35P.OnProgPaymentP05, FM36P.OnProgPaymentP05, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP05 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP05, FM36P.LearnSuppPaymentP05, 0 ),
			AchCompPaymentP05 = COALESCE ( FM35P.AchCompPaymentP05, FM36P.AchCompPaymentP05, 0 ),
			BalancePaymentP05 = COALESCE ( FM35P.BalancePaymentP05, FM36P.BalancePaymentP05, 0 ),
			EmpOutcomePayP05 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP05 = COALESCE ( FM36P.OtherPaymentP05, 0 ),
			TotFundP05 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP05 END, FM35P.TotFundP05, FM36P.TotFundP05, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP06 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP06 END, FM35P.OnProgPaymentP06, FM36P.OnProgPaymentP06, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP06 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP06, FM36P.LearnSuppPaymentP06, 0 ),
			AchCompPaymentP06 = COALESCE ( FM35P.AchCompPaymentP06, FM36P.AchCompPaymentP06, 0 ),
			BalancePaymentP06 = COALESCE ( FM35P.BalancePaymentP06, FM36P.BalancePaymentP06, 0 ),
			EmpOutcomePayP06 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP06 = COALESCE ( FM36P.OtherPaymentP06, 0 ),
			TotFundP06 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP06 END, FM35P.TotFundP06, FM36P.TotFundP06, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
		N'
			OnProgPaymentP07 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP07 END, FM35P.OnProgPaymentP07, FM36P.OnProgPaymentP07, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP07 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP07, FM36P.LearnSuppPaymentP07, 0 ),
			AchCompPaymentP07 = COALESCE ( FM35P.AchCompPaymentP07, FM36P.AchCompPaymentP07, 0 ),
			BalancePaymentP07 = COALESCE ( FM35P.BalancePaymentP07, FM36P.BalancePaymentP07, 0 ),
			EmpOutcomePayP07 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP07 = COALESCE ( FM36P.OtherPaymentP07, 0 ),
			TotFundP07 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP07 END, FM35P.TotFundP07, FM36P.TotFundP07, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP08 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP08 END, FM35P.OnProgPaymentP08, FM36P.OnProgPaymentP08, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP08 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP08, FM36P.LearnSuppPaymentP08, 0 ),
			AchCompPaymentP08 = COALESCE ( FM35P.AchCompPaymentP08, FM36P.AchCompPaymentP08, 0 ),
			BalancePaymentP08 = COALESCE ( FM35P.BalancePaymentP08, FM36P.BalancePaymentP08, 0 ),
			EmpOutcomePayP08 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP08 = COALESCE ( FM36P.OtherPaymentP08, 0 ),
			TotFundP08 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP08 END, FM35P.TotFundP08, FM36P.TotFundP08, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP09 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP09 END, FM35P.OnProgPaymentP09, FM36P.OnProgPaymentP09, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP09 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP09, FM36P.LearnSuppPaymentP09, 0 ),
			AchCompPaymentP09 = COALESCE ( FM35P.AchCompPaymentP09, FM36P.AchCompPaymentP09, 0 ),
			BalancePaymentP09 = COALESCE ( FM35P.BalancePaymentP09, FM36P.BalancePaymentP09, 0 ),
			EmpOutcomePayP09 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP09 = COALESCE ( FM36P.OtherPaymentP09, 0 ),
			TotFundP09 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP09 END, FM35P.TotFundP09, FM36P.TotFundP09, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP10 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP10 END, FM35P.OnProgPaymentP10, FM36P.OnProgPaymentP10, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP10 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP10, FM36P.LearnSuppPaymentP10, 0 ),
			AchCompPaymentP10 = COALESCE ( FM35P.AchCompPaymentP10, FM36P.AchCompPaymentP10, 0 ),
			BalancePaymentP10 = COALESCE ( FM35P.BalancePaymentP10, FM36P.BalancePaymentP10, 0 ),
			EmpOutcomePayP10 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP10 = COALESCE ( FM36P.OtherPaymentP10, 0 ),
			TotFundP10 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP10 END, FM35P.TotFundP10, FM36P.TotFundP10, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP11 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP11 END, FM35P.OnProgPaymentP11, FM36P.OnProgPaymentP11, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP11 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP11, FM36P.LearnSuppPaymentP11, 0 ),
			AchCompPaymentP11 = COALESCE ( FM35P.AchCompPaymentP11, FM36P.AchCompPaymentP11, 0 ),
			BalancePaymentP11 = COALESCE ( FM35P.BalancePaymentP11, FM36P.BalancePaymentP11, 0 ),
			EmpOutcomePayP11 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP11 = COALESCE ( FM36P.OtherPaymentP11, 0 ),
			TotFundP11 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP11 END, FM35P.TotFundP11, FM36P.TotFundP11, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP12 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP12 END, FM35P.OnProgPaymentP12, FM36P.OnProgPaymentP12, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP12 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP12, FM36P.LearnSuppPaymentP12, 0 ),
			AchCompPaymentP12 = COALESCE ( FM35P.AchCompPaymentP12, FM36P.AchCompPaymentP12, 0 ),
			BalancePaymentP12 = COALESCE ( FM35P.BalancePaymentP12, FM36P.BalancePaymentP12, 0 ),
			EmpOutcomePayP12 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP12 = COALESCE ( FM36P.OtherPaymentP12, 0 ),
			TotFundP12 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP12 END, FM35P.TotFundP12, FM36P.TotFundP12, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 )

			--INTO FundingDataTemp
	'
    
    SET @SQLString += 
        N'
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		INNER JOIN ' + @FISDatabase + '.Valid.Source SRC
			ON 1 = 1
	'
    
    SET @SQLString += 
		N'
		INNER JOIN (
			SELECT
				LD.LearnRefNumber,
				LD.AimSeqNumber,
				CollegeLevel1Code = COALESCE ( CS.CollegeLevel1Code, ''-''),
				CollegeLevel1Name = COALESCE ( CS.CollegeLevel1Name, ''-- Unknown --''),
				CollegeLevel2Code = COALESCE ( CS.CollegeLevel2Code, ''-''),
				CollegeLevel2Name = COALESCE ( CS.CollegeLevel2Name, ''-- Unknown --''),
				CollegeLevel3Code = COALESCE ( CS.CollegeLevel3Code, ''-''),
				CollegeLevel3Name = COALESCE ( CS.CollegeLevel3Name, ''-- Unknown --''),
				CollegeLevel4Code = COALESCE ( CS.CollegeLevel4Code, ''-''),
				CollegeLevel4Name = COALESCE ( CS.CollegeLevel4Name, ''-- Unknown --''),
				CourseCode = COALESCE ( CS.CourseCode, ''-''),
				CourseTitle = COALESCE ( CS.CourseTitle, ''-- Unknown --''),
				SSA1Code = AIM.SSA1Code,
				SSA1Name = AIM.SSA1Name,
				SSA2Code = AIM.SSA2Code,
				SSA2Name = AIM.SSA2Name,
				LearningAimCode = AIM.LearningAimCode,
				LearningAimTitle = AIM.LearningAimTitle,
				LearningAimTypeCode = AIM.LearningAimTypeCode,
				LearningAimTypeName = AIM.LearningAimTypeName,
				NVQLevelCode = AIM.NVQLevelCode,
				NVQLevelName = AIM.NVQLevelName,
				NVQLevelOrder = AIM.NVQLevelOrder,
				IsMathsAndEnglish = AIM.IsMathsAndEnglish,
				AwardBodyCode = AIM.AwardBodyCode,
				RowNum = 
					ROW_NUMBER () OVER ( 
						PARTITION BY
							LD.LearnRefNumber
						ORDER BY
							COALESCE ( FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) DESC,
							LD.CompStatus,
                            CASE
                                COALESCE ( 
                                    FM25.FundLine, 
                                    CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
                                    FM36P.FundLineType,
                                    FM35.FundLine,
                                    CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
                                    CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
                                ) 
                                WHEN ''16-19 Students (inc. High Needs)'' THEN 1
                                WHEN ''None'' THEN 9
                                ELSE 2
                            END,
							COALESCE ( LD.ProgType, ''99'' ),
							CASE
								WHEN LD.AimType = 2 THEN 4.5
								ELSE LD.AimType
							END DESC,
							CASE
								WHEN AIM.LearningAimTypeCode IN (
									''0003'', --GCSE
									''1439'' --Functional Skills
								) THEN 2
								ELSE 1
							END,
							AIM.NVQLevelOrder DESC,
							COALESCE ( L.PlanLearnHours, 0 ) + COALESCE ( L.PlanEEPHours, 0 ) DESC,
							DATEDIFF ( DAY, LD.LearnStartDate, COALESCE ( LD.LearnActEndDate, LD.LearnPlanEndDate ) ) DESC,
							LD.LearnStartDate,
							LD.AimSeqNumber
					)
	'
    
    SET @SQLString += 
        N'
			FROM ' + @FISDatabase + '.Valid.Learner L
			INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
				ON LD.LearnRefNumber = L.LearnRefNumber
			LEFT JOIN #LearningAims AIM
				ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
			LEFT JOIN #CollegeStructure CS
				ON CS.AcademicYear = @AcademicYear
				AND CS.ProvSpecValue COLLATE DATABASE_DEFAULT =
					CASE
						WHEN @ProviderFieldCourseLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
					END COLLATE DATABASE_DEFAULT

			--16-19
			LEFT JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
				AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
				--AND FM25.StartFund = 1

			--AEB and Apps (Legacy)
			LEFT JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
				ON FM35.LearnRefNumber = LD.LearnRefNumber
				AND FM35.AimSeqNumber = LD.AimSeqNumber
				--AND FM35.FundStart = 1

			--Apps (Reformed)
			LEFT JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
				ON FM36.LearnRefNumber = LD.LearnRefNumber
				AND FM36.AimSeqNumber = LD.AimSeqNumber
			LEFT JOIN (
				SELECT
					FM36P.LearnRefNumber,
					FM36P.AimSeqNumber,
					FM36P.FundLineType
				FROM ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery_Period FM36P
				WHERE
					FM36P.FundLineType <> ''None''
				GROUP BY
					FM36P.LearnRefNumber,
					FM36P.AimSeqNumber,
					FM36P.FundLineType
			) FM36P
				ON FM36P.LearnRefNumber = FM36.LearnRefNumber
				AND FM36P.AimSeqNumber = FM36.AimSeqNumber

			--Loans and Bursaries
			LEFT JOIN ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery ALB
				ON ALB.LearnRefNumber = LD.LearnRefNumber
				AND ALB.AimSeqNumber = LD.AimSeqNumber

			--Higher Education
			LEFT JOIN ' + @FISDatabase + '.Valid.LearningDeliveryHE HE
				ON HE.LearnRefNumber = LD.LearnRefNumber
				AND HE.AimSeqNumber = LD.AimSeqNumber
		) MA
			ON MA.LearnRefNumber = LD.LearnRefNumber
			AND MA.RowNum = 1
	'

    SET @SQLString += 
        N'
		LEFT JOIN ' + @FISDatabase + '.Valid.LearningDeliveryFAM FFI
			ON FFI.LearnRefNumber = LD.LearnRefNumber
			AND FFI.AimSeqNumber = LD.AimSeqNumber
			AND FFI.LearnDelFAMType = ''FFI''

		LEFT JOIN (
			SELECT
				LearnerRef = EMP.LearnRefNumber,
				EmpStatusCode = EMP.EmpStat,
				EmpStatusName = 
					CASE
						WHEN EMP.EmpStat = ''10'' THEN ''InEmp''
						WHEN EMP.EmpStat = ''11'' THEN ''NoEmpLooking''
						WHEN EMP.EmpStat = ''12'' THEN ''NoEmpNotLooking''
						WHEN EMP.EmpStat = ''98'' THEN ''Unknown''
						ELSE ''Unknown''
					END,
				EmpStatusAppliesDate = EMP.DateEmpStatApp,
				EmployerID = EMP.EmpId,
				RowNum =
					ROW_NUMBER () OVER (
						PARTITION BY
							EMP.LearnRefNumber
						ORDER BY
							EMP.DateEmpStatApp DESC
					)
			FROM ' + @FISDatabase + '.Valid.LearnerEmploymentStatus EMP
		) EMP
			ON EMP.LearnerRef = L.LearnRefNumber
			AND EMP.RowNum = 1
		LEFT JOIN (
			SELECT
				ATN.UKPRN,
				ATN.LearnRefNumber,
				ATN.PriorLevel,
				ATN.DateLevelApp,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							ATN.UKPRN,
							ATN.LearnRefNumber
						ORDER BY
							ATN.DateLevelApp DESC
					)
			FROM ' + @FISDatabase + '.Valid.LearnerPriorAttain ATN
		) ATN
			ON ATN.LearnRefNumber = L.LearnRefNumber
			AND ATN.UKPRN = L.UKPRN
			AND ATN.RowNum = 1
		LEFT JOIN ' + @FISDatabase + '.Valid.LLDDandHealthProblem LLDD
			ON LLDD.LearnRefNumber = L.LearnRefNumber
			AND LLDD.PrimaryLLDD = 1
		LEFT JOIN (
			SELECT
				PVT.LearnRefNumber,
				PVT.DateEmpStatApp,
				PVT.LOE,
				PVT.LOU,
				PVT.BSI,
				PVT.SEM,
				PVT.SEI,
				PVT.EII,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							PVT.LearnRefNumber
						ORDER BY
							PVT.DateEmpStatApp DESC
					)
			FROM (
				SELECT
					ESM.LearnRefNumber,
					ESM.DateEmpStatApp,
					ESM.ESMType,
					ESM.ESMCode
				FROM ' + @FISDatabase + '.Valid.EmploymentStatusMonitoring ESM
			) ESM
			PIVOT (
				MAX ( ESMCode )
				FOR ESMType IN ( [LOE], [LOU], [BSI], [SEM], [SEI], [EII] )
			) AS PVT
		) ESM
			ON ESM.LearnRefNumber = L.LearnRefNumber
			AND ESM.RowNum = 1
    '

    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				LearnRefNumber = OC.LearnRefNumber,
				DPOutcomeType = OC.OutType,
				DPOutcomeCode = OC.OutCode,
				DPOutcomeStartDate = OC.OutStartDate,
				DPOutcomeEndDate = OC.OutEndDate,
				DPOutcomeCollectionDate = OC.OutCollDate,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							OC.LearnRefNumber
						ORDER BY
							OC.OutCollDate DESC,
							OC.OutStartDate DESC
					)
			FROM ' + @FISDatabase + '.Valid.DPOutcome OC
		) OC
			ON OC.LearnRefNumber = L.LearnRefNumber
			AND OC.RowNum = 1
		LEFT JOIN ( --Partner UKPRN not against prog aim so get this here
			SELECT
				LD.LearnRefNumber,
				LD.PartnerUKPRN,
				RowNum = ROW_NUMBER () OVER (
					PARTITION BY
						LD.LearnRefNumber
					ORDER BY
						LD.CompStatus,
						DATEDIFF ( DAY, LD.LearnStartDate, LD.LearnPlanEndDate ) DESC,
						LD.PartnerUKPRN
				)
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			WHERE
				LD.PartnerUKPRN IS NOT NULL
		) PTR
			ON PTR.LearnRefNumber = L.LearnRefNumber
			AND PTR.RowNum = 1

		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
			ON PSDMA.LearnRefNumber = LD.LearnRefNumber
			AND PSDMA.AimSeqNumber = LD.AimSeqNumber
			AND PSDMA.ProvSpecDelMonOccur = ''A''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
			ON PSDMB.LearnRefNumber = LD.LearnRefNumber
			AND PSDMB.AimSeqNumber = LD.AimSeqNumber
			AND PSDMB.ProvSpecDelMonOccur = ''B''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
			ON PSDMC.LearnRefNumber = LD.LearnRefNumber
			AND PSDMC.AimSeqNumber = LD.AimSeqNumber
			AND PSDMC.ProvSpecDelMonOccur = ''C''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
			ON PSDMD.LearnRefNumber = LD.LearnRefNumber
			AND PSDMD.AimSeqNumber = LD.AimSeqNumber
			AND PSDMD.ProvSpecDelMonOccur = ''D''
	'

    SET @SQLString += 
        N'
		--16-19
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
			ON FM25.LearnRefNumber = LD.LearnRefNumber
			AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
			--AND FM25.StartFund = 1

		--AEB and Apps (Legacy)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
			ON FM35.LearnRefNumber = LD.LearnRefNumber
			AND FM35.AimSeqNumber = LD.AimSeqNumber
			--AND FM35.FundStart = 1

		--Apps (Reformed)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
			ON FM36.LearnRefNumber = LD.LearnRefNumber
			AND FM36.AimSeqNumber = LD.AimSeqNumber
		
		--Loans and Bursaries
		LEFT JOIN ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery ALB
			ON ALB.LearnRefNumber = LD.LearnRefNumber
			AND ALB.AimSeqNumber = LD.AimSeqNumber

		--Higher Education
		LEFT JOIN ' + @FISDatabase + '.Valid.LearningDeliveryHE HE
			ON HE.LearnRefNumber = LD.LearnRefNumber
			AND HE.AimSeqNumber = LD.AimSeqNumber
	'



    SET @SQLString += 
		N'
		LEFT JOIN (
			SELECT
				ALBV.LearnRefNumber,
				ALBV.AimSeqNumber,
				TotFundToPeriod = 
					CASE
						WHEN @ILRReturn = 1 THEN
							ALBV.Period_1
						WHEN @ILRReturn = 2 THEN
							ALBV.Period_1 + ALBV.Period_2
						WHEN @ILRReturn = 3 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3
						WHEN @ILRReturn = 4 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4
						WHEN @ILRReturn = 5 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5
						WHEN @ILRReturn = 6 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6
						WHEN @ILRReturn = 7 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7
						WHEN @ILRReturn = 8 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8
						WHEN @ILRReturn = 9 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9
						WHEN @ILRReturn = 10 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10
						WHEN @ILRReturn = 11 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11
						WHEN @ILRReturn = 12 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11 + ALBV.Period_12
						ELSE 0
					END,
				TotFund6Mon = ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6,
				TotFundYrEnd = ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11 + ALBV.Period_12,
				TotFundP01 = ALBV.Period_1,
				TotFundP02 = ALBV.Period_2,
				TotFundP03 = ALBV.Period_3,
				TotFundP04 = ALBV.Period_4,
				TotFundP05 = ALBV.Period_5,
				TotFundP06 = ALBV.Period_6,
				TotFundP07 = ALBV.Period_7,
				TotFundP08 = ALBV.Period_8,
				TotFundP09 = ALBV.Period_9,
				TotFundP10 = ALBV.Period_10,
				TotFundP11 = ALBV.Period_11,
				TotFundP12 = ALBV.Period_12
			FROM ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery_PeriodisedValues ALBV
			WHERE
				ALBV.AttributeName = ''ALBSupportPayment''
		) ALBP
			ON ALBP.LearnRefNumber = LD.LearnRefNumber
			AND ALBP.AimSeqNumber = LD.AimSeqNumber
	'

    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				FM35P.LearnRefNumber,
				FM35P.AimSeqNumber,

				OnProgPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePay6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFund6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentYrEnd = SUM ( FM35P.OnProgPayment ),
				LearnSuppPaymentYrEnd = SUM ( FM35P.LearnSuppFundCash ),
				AchCompPaymentYrEnd = SUM ( FM35P.AchievePayment ),
				BalancePaymentYrEnd = SUM ( FM35P.BalancePayment ),
				EmpOutcomePayYrEnd = SUM ( FM35P.EmpOutcomePay ),
				TotFundYrEnd = SUM ( 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay 
				),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
	'
    
    SET @SQLString += 
        N'
				OnProgPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END )
			FROM ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery_Period FM35P
			GROUP BY
				FM35P.LearnRefNumber,
				FM35P.AimSeqNumber
		) FM35P
			ON FM35P.LearnRefNumber = FM35.LearnRefNumber
			AND FM35P.AimSeqNumber = FM35.AimSeqNumber
	'

    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				FM36PE.UKPRN,
				FM36PE.LearnRefNumber,
				AimSeqNumber = FM36PE.PriceEpisodeAimSeqNumber,
				FM36PE.PriceEpisodeIdentifier,
				FM36PE.TNP1,
				FM36PE.TNP2,
				FM36PE.TNP3,
				FM36PE.TNP4,
				FM36PE.EpisodeStartDate,
				FM36PE.PriceEpisode1618FrameworkUpliftRemainingAmount,
				FM36PE.PriceEpisode1618FrameworkUpliftTotPrevEarnings,
				FM36PE.PriceEpisode1618FUBalValue,
				FM36PE.PriceEpisode1618FUMonthInstValue,
				FM36PE.PriceEpisode1618FUTotEarnings,
				FM36PE.PriceEpisodeUpperBandLimit,
				FM36PE.PriceEpisodePlannedEndDate,
				FM36PE.PriceEpisodeActualEndDate,
				FM36PE.PriceEpisodeActualEndDateIncEPA,
				FM36PE.PriceEpisodeTotalTNPPrice,
				FM36PE.PriceEpisodeUpperLimitAdjustment,
				FM36PE.PriceEpisodePlannedInstalments,
				FM36PE.PriceEpisodeActualInstalments,
				FM36PE.PriceEpisodeCompletionElement,
				FM36PE.PriceEpisodePreviousEarnings,
				FM36PE.PriceEpisodeInstalmentValue,
				FM36PE.PriceEpisodeTotalEarnings,
				FM36PE.PriceEpisodeCompleted,
				FM36PE.PriceEpisodeRemainingTNPAmount,
				FM36PE.PriceEpisodeRemainingAmountWithinUpperLimit,
				FM36PE.PriceEpisodeCappedRemainingTNPAmount,
				FM36PE.PriceEpisodeExpectedTotalMonthlyValue,
				FM36PE.PriceEpisodeAimSeqNumber,
				FM36PE.PriceEpisodeApplic1618FrameworkUpliftCompElement,
				FM36PE.PriceEpisodeFundLineType,
				FM36PE.EpisodeEffectiveTNPStartDate,
				FM36PE.PriceEpisodeFirstAdditionalPaymentThresholdDate,
				FM36PE.PriceEpisodeSecondAdditionalPaymentThresholdDate,
				FM36PE.PriceEpisodeContractType,
				FM36PE.PriceEpisodePreviousEarningsSameProvider,
				FM36PE.PriceEpisodeTotalPMRs,
				FM36PE.PriceEpisodeCumulativePMRs,
				FM36PE.PriceEpisodeCompExemCode,
				FM36PE.PriceEpisodeLearnerAdditionalPaymentThresholdDate,
				FM36PE.PriceEpisodeRedStartDate,
				FM36PE.PriceEpisodeRedStatusCode,
				RowNum =
					ROW_NUMBER () OVER (
						PARTITION BY
							FM36PE.UKPRN,
							FM36PE.LearnRefNumber,
							FM36PE.PriceEpisodeAimSeqNumber
						ORDER BY
							FM36PE.EpisodeStartDate DESC
					)
			FROM ' + @FISDatabase + '.Rulebase.AEC_ApprenticeshipPriceEpisode FM36PE
				--AND FM36PE.EpisodeStartDate = FM36.AppAdjLearnStartDate
			WHERE
				FM36PE.EpisodeStartDate < ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-08-01''
		) FM36PE
			ON FM36PE.LearnRefNumber = FM36.LearnRefNumber
			AND FM36PE.UKPRN = FM36.UKPRN
			AND FM36PE.AimSeqNumber = FM36.AimSeqNumber
			AND FM36PE.RowNum = 1
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				FM36P.LearnRefNumber,
				FM36P.AimSeqNumber,
				FM36P.FundLineType,

				OnProgPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundToPeriod = 
					SUM (  CASE WHEN FM36P.Period <= @ILRReturn THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFund6Mon = 
					SUM (  CASE WHEN FM36P.Period <= 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentYrEnd = 
					SUM ( 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
					),
				LearnSuppPaymentYrEnd = 
					SUM ( 
						FM36P.LearnSuppFundCash 
					),
				AchCompPaymentYrEnd = 
					SUM ( 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
					),
				BalancePaymentYrEnd = 
					SUM ( 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
					),
				OtherPaymentYrEnd = 
					SUM ( 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
					),
				TotFundYrEnd = 
					SUM (  
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP01 = 
					SUM (  CASE WHEN FM36P.Period = 1 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP02 = 
					SUM (  CASE WHEN FM36P.Period = 2 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP03 = 
					SUM (  CASE WHEN FM36P.Period = 3 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP04 = 
					SUM (  CASE WHEN FM36P.Period = 4 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP05 = 
					SUM (  CASE WHEN FM36P.Period = 5 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP06 = 
					SUM (  CASE WHEN FM36P.Period = 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP07 = 
					SUM (  CASE WHEN FM36P.Period = 7 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP08 = 
					SUM (  CASE WHEN FM36P.Period = 8 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP09 = 
					SUM (  CASE WHEN FM36P.Period = 9 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP10 = 
					SUM (  CASE WHEN FM36P.Period = 10 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP11 = 
					SUM (  CASE WHEN FM36P.Period = 11 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotFundP12 = 
					SUM (  CASE WHEN FM36P.Period = 12 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					)
			FROM ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery_Period FM36P
			WHERE
				FM36P.FundLineType <> ''None''
			GROUP BY
				FM36P.LearnRefNumber,
				FM36P.AimSeqNumber,
				FM36P.FundLineType
		) FM36P
			ON FM36P.LearnRefNumber = FM36.LearnRefNumber
			AND FM36P.AimSeqNumber = FM36.AimSeqNumber
	'
    
    SET @SQLString += 
        N'
		--Invalid Learners
		LEFT JOIN (
			SELECT
				InvalidLearners = COUNT ( L.Learner_Id )
			FROM ' + @FISDatabase + '.Invalid.Learner L
		) INV
			ON 1 = 1
		LEFT JOIN #FAMLearner FAML
			ON FAML.LearnRefNumber = L.LearnRefNumber
		LEFT JOIN #FAMLearningDelivery FAMA
			ON FAMA.LearnRefNumber = LD.LearnRefNumber
			AND FAMA.AimSeqNumber = LD.AimSeqNumber
		LEFT JOIN #Standards STD
			ON STD.StandardCode = LD.StdCode
		LEFT JOIN #Frameworks FW
			ON FW.FrameworkCode = LD.FworkCode
		LEFT JOIN #Pathways PWAY
			ON PWAY.FrameworkCode = LD.FworkCode
			AND PWAY.ProgType = LD.ProgType
			AND PWAY.PathwayCode = LD.PwayCode
		LEFT JOIN #PostCodes PC
			ON PC.PostCode COLLATE DATABASE_DEFAULT = L.Postcode COLLATE DATABASE_DEFAULT
			AND COALESCE (
				PC.SourceOfFunding COLLATE DATABASE_DEFAULT,
				CASE
					WHEN FM35.LearnDelFundOrgCode = ''ESFA'' THEN ''105/107''
					WHEN FM35.LearnDelFundOrgCode = ''WECA'' THEN ''113''
					WHEN FM35.LearnDelFundOrgCode = ''CPCA'' THEN ''115''
					WHEN FM35.LearnDelFundOrgCode = ''London'' THEN ''116''
					ELSE ''105/107''
				END COLLATE DATABASE_DEFAULT
			) = 
				CASE
					WHEN FM35.LearnDelFundOrgCode = ''ESFA'' THEN ''105/107''
					WHEN FM35.LearnDelFundOrgCode = ''WECA'' THEN ''113''
					WHEN FM35.LearnDelFundOrgCode = ''CPCA'' THEN ''115''
					WHEN FM35.LearnDelFundOrgCode = ''London'' THEN ''116''
					ELSE ''105/107''
				END COLLATE DATABASE_DEFAULT
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN #LearningAims AIM
			ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
		LEFT JOIN #CollegeStructure CS
			ON CS.AcademicYear = @AcademicYear
			AND CS.ProvSpecValue COLLATE DATABASE_DEFAULT =
				CASE
					WHEN @ProviderFieldCourseLocation = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''D'' THEN
						PSDMD.ProvSpecDelMon
				END COLLATE DATABASE_DEFAULT
		LEFT JOIN #CollegeStructure PCS
			ON PCS.AcademicYear = @AcademicYear
			AND PCS.ProvSpecValue COLLATE DATABASE_DEFAULT =
				CASE
					WHEN @ProviderFieldParentCourseLocation = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProviderFieldParentCourseLocation = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProviderFieldParentCourseLocation = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProviderFieldParentCourseLocation = ''D'' THEN
						PSDMD.ProvSpecDelMon
				END COLLATE DATABASE_DEFAULT
		LEFT JOIN #CollegeStructure MCS
			ON MCS.AcademicYear = @AcademicYear
			AND MCS.ProvSpecValue COLLATE DATABASE_DEFAULT = MA.CourseCode COLLATE DATABASE_DEFAULT
		LEFT JOIN (
			SELECT
				CollegeLevel3Name = MIN ( CS.CollegeLevel3Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel3Code = @OverrideEngFac
		) FENG
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevel3Name = MIN ( CS.CollegeLevel3Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel3Code = @OverrideMatFac
		) FMAT
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevel3Name = MIN ( CS.CollegeLevel3Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel3Code = @OverridePartnerFac
		) FPAR
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevel4Name = MIN ( CS.CollegeLevel4Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel4Code = @OverrideEngTeam
		) TENG
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevel4Name = MIN ( CS.CollegeLevel4Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel4Code = @OverrideMatTeam
		) TMAT
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevel4Name = MIN ( CS.CollegeLevel4Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel4Code = @OverridePartnerTeam
		) TPAR
			ON 1 = 1
		LEFT JOIN #CourseHours CH
			ON CH.AcademicYear = @AcademicYear
			AND CH.ProvSpecField COLLATE DATABASE_DEFAULT =
				CASE
					WHEN @ProviderFieldCourseLocation = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''D'' THEN
						PSDMD.ProvSpecDelMon
				END COLLATE DATABASE_DEFAULT
	'
    
    SET @SQLString += 
        N'
        LEFT JOIN ' + @FISOutputTableLocation + 'FIS_Providers PROV
			ON PROV.ProviderID = SRC.UKPRN
	'

    SET @SQLString += 
        N'
		--FM25 for counting hours
		LEFT JOIN (
			SELECT
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ORD.RateBandOrder,
				TFerOnly = CASE WHEN ACT.LearnRefNumber IS NULL THEN 1 ELSE 0 END,
				PLH = COALESCE ( SUM ( CH.PLH ), 0 ),
				EEP = COALESCE ( SUM ( CH.EEP ), 0 ),
				OnProgPayment = 
					MAX ( FM25.OnProgPayment )
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END,
				LearnSuppPayment = 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END,
				TotFund = MAX ( FM25.OnProgPayment ),
				IsFunded = MAX ( CAST ( FM25.StartFund AS INT ) )
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
			LEFT JOIN #CourseHours CH
				ON CH.AcademicYear = @AcademicYear
				AND CH.ProvSpecField COLLATE DATABASE_DEFAULT =
					CASE
						WHEN @ProviderFieldCourseLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
					END COLLATE DATABASE_DEFAULT
			LEFT JOIN (
				SELECT DISTINCT
					LD.LearnRefNumber
				FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
				WHERE
					LD.FundModel = ''25''
					AND COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' --Exclude transfers
					--AND LD.LearnRefNumber = ''17002435''
				GROUP BY
					LD.LearnRefNumber
			) ACT
				ON ACT.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN (
				SELECT
					FM25.RateBand,
					RateBandOrder = 
						ROW_NUMBER () OVER (
							ORDER BY
								CASE
									WHEN FM25.RateBand LIKE ''Up to%'' THEN 1
									ELSE 2
								END,
								CASE
									WHEN FM25.RateBand NOT LIKE ''%4a%'' THEN 1
									ELSE 2
								END,
								FM25.RateBand
						)
				FROM (
					SELECT DISTINCT
						FM25.RateBand
					FROM ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				) FM25
			) ORD
				ON ORD.RateBand = FM25.RateBand
			WHERE
				LD.FundModel = ''25''
				--AND LD.LearnRefNumber = ''18000292''
				AND 
					CASE --If lrn has no active aims then count tfer instead
						WHEN ACT.LearnRefNumber IS NOT NULL THEN
							CASE
								WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' THEN 1
								ELSE 0
							END
						ELSE
							1
						END = 1
			GROUP BY
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ORD.RateBandOrder,
				ACT.LearnRefNumber
		) HRS
			ON HRS.LearnRefNumber = L.LearnRefNumber
    '

	SET @SQLString += 
		N'
		LEFT JOIN (
			SELECT
				LD.LearnRefNumber,
				FundLine = 
					COALESCE ( 
						CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
						FM25.FundLine, 
						CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
						CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine <> ''None'' THEN ALB.FundLine END,
						FM36P.FundLineType,
						FM35.FundLine,
						CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
						CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
					),
				LD.FundModel,
				LD.AimSeqNumber,
				CollegeLevel1Code = COALESCE ( CS.CollegeLevel1Code, ''-''),
				CollegeLevel1Name = COALESCE ( CS.CollegeLevel1Name, ''-- Unknown --''),
				CollegeLevel2Code = COALESCE ( CS.CollegeLevel2Code, ''-''),
				CollegeLevel2Name = COALESCE ( CS.CollegeLevel2Name, ''-- Unknown --''),
				CollegeLevel3Code = COALESCE ( CS.CollegeLevel3Code, ''-''),
				CollegeLevel3Name = COALESCE ( CS.CollegeLevel3Name, ''-- Unknown --''),
				CollegeLevel4Code = COALESCE ( CS.CollegeLevel4Code, ''-''),
				CollegeLevel4Name = COALESCE ( CS.CollegeLevel4Name, ''-- Unknown --''),
				CourseCode = COALESCE ( CS.CourseCode, ''-''),
				CourseTitle = COALESCE ( CS.CourseTitle, ''-- Unknown --''),
				SSA1Code = AIM.SSA1Code,
				SSA1Name = AIM.SSA1Name,
				SSA2Code = AIM.SSA2Code,
				SSA2Name = AIM.SSA2Name,
				LearningAimCode = AIM.LearningAimCode,
				LearningAimTitle = AIM.LearningAimTitle,
				LearningAimTypeCode = AIM.LearningAimTypeCode,
				LearningAimTypeName = AIM.LearningAimTypeName,
				NVQLevelCode = AIM.NVQLevelCode,
				NVQLevelName = AIM.NVQLevelName,
				NVQLevelOrder = AIM.NVQLevelOrder,
				IsMathsAndEnglish = AIM.IsMathsAndEnglish,
				AwardBodyCode = AIM.AwardBodyCode,
				RowNum = 
					ROW_NUMBER () OVER ( 
						PARTITION BY
							LD.LearnRefNumber,
							COALESCE ( 
								CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
								FM25.FundLine, 
								CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
								CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine <> ''None'' THEN ALB.FundLine END,
								FM36P.FundLineType,
								FM35.FundLine,
								CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
								CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
							)
						ORDER BY
							COALESCE ( FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) DESC,
							LD.CompStatus,
                            CASE
                                COALESCE ( 
                                    FM25.FundLine, 
                                    CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
                                    FM36P.FundLineType,
                                    FM35.FundLine,
                                    CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
                                    CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
                                ) 
                                WHEN ''16-19 Students (inc. High Needs)'' THEN 1
                                WHEN ''None'' THEN 9
                                ELSE 2
                            END,
							COALESCE ( LD.ProgType, ''99'' ),
							CASE
								WHEN LD.AimType = 2 THEN 4.5
								ELSE LD.AimType
							END DESC,
							CASE
								WHEN AIM.LearningAimTypeCode IN (
									''0003'', --GCSE
									''1439'' --Functional Skills
								) THEN 2
								ELSE 1
							END,
							AIM.NVQLevelOrder DESC,
							COALESCE ( L.PlanLearnHours, 0 ) + COALESCE ( L.PlanEEPHours, 0 ) DESC,
							DATEDIFF ( DAY, LD.LearnStartDate, COALESCE ( LD.LearnActEndDate, LD.LearnPlanEndDate ) ) DESC,
							LD.LearnStartDate,
							LD.AimSeqNumber
					)
	'
    
    SET @SQLString += 
        N'
			FROM ' + @FISDatabase + '.Valid.Learner L
			INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
				ON LD.LearnRefNumber = L.LearnRefNumber
			LEFT JOIN #LearningAims AIM
				ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
			LEFT JOIN #CollegeStructure CS
				ON CS.AcademicYear = @AcademicYear
				AND CS.ProvSpecValue COLLATE DATABASE_DEFAULT =
					CASE
						WHEN @ProviderFieldCourseLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
					END COLLATE DATABASE_DEFAULT

			--16-19
			LEFT JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
				AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
				--AND FM25.StartFund = 1

			--AEB and Apps (Legacy)
			LEFT JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
				ON FM35.LearnRefNumber = LD.LearnRefNumber
				AND FM35.AimSeqNumber = LD.AimSeqNumber
				--AND FM35.FundStart = 1

			--Apps (Reformed)
			LEFT JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
				ON FM36.LearnRefNumber = LD.LearnRefNumber
				AND FM36.AimSeqNumber = LD.AimSeqNumber
			LEFT JOIN (
				SELECT
					FM36P.LearnRefNumber,
					FM36P.AimSeqNumber,
					FM36P.FundLineType
				FROM ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery_Period FM36P
				WHERE
					FM36P.FundLineType <> ''None''
				GROUP BY
					FM36P.LearnRefNumber,
					FM36P.AimSeqNumber,
					FM36P.FundLineType
			) FM36P
				ON FM36P.LearnRefNumber = FM36.LearnRefNumber
				AND FM36P.AimSeqNumber = FM36.AimSeqNumber

			--Loans and Bursaries
			LEFT JOIN ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery ALB
				ON ALB.LearnRefNumber = LD.LearnRefNumber
				AND ALB.AimSeqNumber = LD.AimSeqNumber

			--Higher Education
			LEFT JOIN ' + @FISDatabase + '.Valid.LearningDeliveryHE HE
				ON HE.LearnRefNumber = LD.LearnRefNumber
				AND HE.AimSeqNumber = LD.AimSeqNumber
	'
    
    SET @SQLString += 
        N'
			--FM25 Hours
			LEFT JOIN (
				SELECT
					LD.LearnRefNumber,
					FM25.FundLine,
					FM25.RateBand,
					TFerOnly = CASE WHEN ACT.LearnRefNumber IS NULL THEN 1 ELSE 0 END,
					PLH = COALESCE ( SUM ( CH.PLH ), 0 ),
					EEP = COALESCE ( SUM ( CH.EEP ), 0 ),
					OnProgPayment = 
						MAX ( FM25.OnProgPayment )
						- CASE 
							WHEN @1619ALSFundingPercent > 0 THEN
								( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
							ELSE
								0
						END,
					LearnSuppPayment = 
						CASE 
							WHEN @1619ALSFundingPercent > 0 THEN
								( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
							ELSE
								0
						END,
					TotFund = MAX ( FM25.OnProgPayment ),
					IsFunded = MAX ( CAST ( FM25.StartFund AS INT ) )
				FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
				INNER JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
					ON FM25.LearnRefNumber = LD.LearnRefNumber
				LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
					ON PSDMA.LearnRefNumber = LD.LearnRefNumber
					AND PSDMA.AimSeqNumber = LD.AimSeqNumber
					AND PSDMA.ProvSpecDelMonOccur = ''A''
				LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
					ON PSDMB.LearnRefNumber = LD.LearnRefNumber
					AND PSDMB.AimSeqNumber = LD.AimSeqNumber
					AND PSDMB.ProvSpecDelMonOccur = ''B''
				LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
					ON PSDMC.LearnRefNumber = LD.LearnRefNumber
					AND PSDMC.AimSeqNumber = LD.AimSeqNumber
					AND PSDMC.ProvSpecDelMonOccur = ''C''
				LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
					ON PSDMD.LearnRefNumber = LD.LearnRefNumber
					AND PSDMD.AimSeqNumber = LD.AimSeqNumber
					AND PSDMD.ProvSpecDelMonOccur = ''D''
				LEFT JOIN #CourseHours CH
					ON CH.AcademicYear = @AcademicYear
					AND CH.ProvSpecField COLLATE DATABASE_DEFAULT =
						CASE
							WHEN @ProviderFieldCourseLocation = ''A'' THEN
								PSDMA.ProvSpecDelMon
							WHEN @ProviderFieldCourseLocation = ''B'' THEN
								PSDMB.ProvSpecDelMon
							WHEN @ProviderFieldCourseLocation = ''C'' THEN
								PSDMC.ProvSpecDelMon
							WHEN @ProviderFieldCourseLocation = ''D'' THEN
								PSDMD.ProvSpecDelMon
						END COLLATE DATABASE_DEFAULT
				LEFT JOIN (
					SELECT DISTINCT
						LD.LearnRefNumber
					FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
					WHERE
						LD.FundModel = ''25''
						AND COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' --Exclude transfers
						--AND LD.LearnRefNumber = ''17002435''
					GROUP BY
						LD.LearnRefNumber
				) ACT
					ON ACT.LearnRefNumber = LD.LearnRefNumber
				WHERE
					LD.FundModel = ''25''
					AND 
						CASE --If lrn has no active aims then count tfer instead
							WHEN ACT.LearnRefNumber IS NOT NULL THEN
								CASE
									WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' THEN 1
									ELSE 0
								END
							ELSE
								1
							END = 1
				GROUP BY
					LD.LearnRefNumber,
					FM25.FundLine,
					FM25.RateBand,
					ACT.LearnRefNumber
			) HRS
				ON HRS.LearnRefNumber = L.LearnRefNumber
		) MAFM
			ON MAFM.LearnRefNumber = LD.LearnRefNumber
			AND MAFM.FundLine = 
				COALESCE ( 
					CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
					FM25.FundLine, 
					CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
					CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine <> ''None'' THEN ALB.FundLine END,
					FM36P.FundLineType,
					FM35.FundLine,
					CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
					CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
				)
			AND MAFM.RowNum = 1
	'

    SET @SQLString += 
        N'
		LEFT JOIN #Employers EMPN
			ON EMPN.EmployerEDRS = EMP.EmployerID
		LEFT JOIN #Partners PAR
			ON PAR.PartnerUKPRN = 
				CASE
					WHEN LD.LearnAimRef = ''ZPROG001'' THEN PTR.PartnerUKPRN
					ELSE LD.PartnerUKPRN
				END
		LEFT JOIN #Ethnicities ETH
			ON TRY_CAST ( ETH.Code AS INT ) = L.Ethnicity
		LEFT JOIN #PriorLevels PLEV
			ON PLEV.Code = ATN.PriorLevel
		LEFT JOIN #Disabilities DIS
			ON DIS.Code = LLDD.LLDDCat
		LEFT JOIN #DestinationProgressionOutcomes DES
			ON DES.OutcomeType COLLATE DATABASE_DEFAULT = OC.DPOutcomeType COLLATE DATABASE_DEFAULT
			AND TRY_CAST ( DES.OutcomeCode AS INT ) = OC.DPOutcomeCode
		LEFT JOIN #CarryIn CI
			ON CI.LearnRefNumber COLLATE DATABASE_DEFAULT = LD.LearnRefNumber COLLATE DATABASE_DEFAULT
			AND CI.AimSeqNumber = LD.AimSeqNumber

		--WHERE
			--L.LearnRefNumber = ''11024003''
	'
	
	--SELECT @SQLString AS [processing-instruction(x)] FOR XML PATH('')

	SET @SQLParams = 
		N'@AcademicYear NVARCHAR(5),
		@ILRReturn INT,
		@IsFinalReturn BIT,
		@Split1619Funding BIT,
		@Reapportion1619FundingByAimWeighting BIT,
		@1619ALSFundingPercent DECIMAL(5,2),
		@IncludeHEAdvLoanPossIncome BIT,
		@IncludeAdvLoanBursaryIncome BIT,
		@FutureAchieveWeighting DECIMAL(5,2),
		@FISOutputTableLocation NVARCHAR(200),
		@FISOutputTableName NVARCHAR(200),
		@ProviderFieldCourseLocation CHAR(1),
		@ProviderFieldParentCourseLocation CHAR(1),
		@OverrideEngFac NVARCHAR(50),
		@OverrideMatFac NVARCHAR(50),
		@OverrideEngTeam NVARCHAR(50),
		@OverrideMatTeam NVARCHAR(50),
		@OverrideEngCostCentre NVARCHAR(50),
		@OverrideMatCostCentre NVARCHAR(50),
		@OverridePartnerFac NVARCHAR(50),
		@OverridePartnerTeam NVARCHAR(50),
		@OverridePartnerCostCentre NVARCHAR(50)';
    
    EXECUTE sp_executesql 
		@SQLString, 
		@SQLParams, 
		@AcademicYear = @AcademicYear,
		@ILRReturn = @ILRReturn,
		@IsFinalReturn = @IsFinalReturn,
		@Split1619Funding = @Split1619Funding,
		@Reapportion1619FundingByAimWeighting = @Reapportion1619FundingByAimWeighting,
		@1619ALSFundingPercent = @1619ALSFundingPercent,
		@IncludeHEAdvLoanPossIncome = @IncludeHEAdvLoanPossIncome,
		@IncludeAdvLoanBursaryIncome = @IncludeAdvLoanBursaryIncome,
		@FutureAchieveWeighting = @FutureAchieveWeighting,
		@FISOutputTableLocation = @FISOutputTableLocation,
		@FISOutputTableName = @FISOutputTableName,
		@ProviderFieldCourseLocation = @ProviderFieldCourseLocation,
		@ProviderFieldParentCourseLocation = @ProviderFieldParentCourseLocation,
		@OverrideEngFac = @OverrideEngFac,
		@OverrideMatFac = @OverrideMatFac,
		@OverrideEngTeam = @OverrideEngTeam,
		@OverrideMatTeam = @OverrideMatTeam,
		@OverrideEngCostCentre = @OverrideEngCostCentre,
		@OverrideMatCostCentre = @OverrideMatCostCentre,
		@OverridePartnerFac = @OverridePartnerFac,
		@OverridePartnerTeam = @OverridePartnerTeam,
		@OverridePartnerCostCentre = @OverridePartnerCostCentre;
END