CREATE VIEW [dbo].[FIS_CollegeStructure]
AS
    SELECT DISTINCT
        AcademicYear = CRS.AcademicYearID,
		ProvSpecValue = 
			CASE
				WHEN CRS.AcademicYearID >= '19/20' THEN CRS.Code
				ELSE CRS.Code + '-' + GRP.Code
			END,
		CourseCode = CRS.Code,
		CourseTitle = CRS.Name,
		CollegeLevel1Code = COALESCE ( RTRIM ( CGRP.Code ), '-' ),
		CollegeLevel1Name = COALESCE ( CGRP.Name, '-- Unknown --' ),
		CollegeLevel2Code = COALESCE ( STE.Code, '-' ),
		CollegeLevel2Name = COALESCE ( STE.Description, '-- Unknown --' ),
        CollegeLevel3Code = COALESCE ( RTRIM ( FAC.Code ), '-' ),
		CollegeLevel3Name = COALESCE ( FAC.Name, '-- Unknown --' ),
		CollegeLevel4Code = COALESCE ( RTRIM ( TEAM.Code ), '-' ),
		CollegeLevel4Name = COALESCE ( TEAM.Name, '-- Unknown --' )
    FROM ProSolution.dbo.Offering CRS
	LEFT JOIN ProSolution.dbo.Site STE
		ON STE.SiteID = CRS.SiteID
	LEFT JOIN ProSolution.dbo.CollegeLevel TEAM
		ON TEAM.SID = CRS.SID
	LEFT JOIN ProSolution.dbo.CollegeLevel FAC
		ON FAC.SID = TEAM.ParentSID
	LEFT JOIN ProSolution.dbo.CollegeLevel EXE
		ON EXE.SID = FAC.ParentSID
	LEFT JOIN ProSolution.dbo.CollegeLevel CGRP
		ON CGRP.SID = EXE.ParentSID
	LEFT JOIN ProSolution.dbo.OfferingGroup GRP
        ON GRP.OfferingID = CRS.OfferingID

	UNION ALL
	
	--Hartlepool Prior To Merger
	SELECT
		AcademicYear = CS.AcademicYearID,
		ProvSpecValue = CS.SpCourseCode,
		CourseCode = CS.SpCourseCode,
		CourseTitle = CS.CourseName,
		CollegeLevel1Code = RTRIM ( CGRP.Code ),
		CollegeLevel1Name = CGRP.Name,
		CollegeLevel2Code = 'H6',
		CollegeLevel2Name = 'Hartlepool Sixth Form',
        CollegeLevel3Code = RTRIM ( FAC.Code ),
		CollegeLevel3Name = FAC.Name,
		CollegeLevel4Code = RTRIM ( TEAM.Code ),
		CollegeLevel4Name = TEAM.Name
	FROM ProSolutionReports.dbo.HartlepoolCourseStructure CS
	INNER JOIN ProSolution.dbo.CollegeLevel TEAM
		ON TEAM.Code = CS.Level3Code
	INNER JOIN ProSolution.dbo.CollegeLevel FAC
		ON FAC.SID = TEAM.ParentSID
	INNER JOIN ProSolution.dbo.CollegeLevel EXE
		ON EXE.SID = FAC.ParentSID
	INNER JOIN ProSolution.dbo.CollegeLevel CGRP
		ON CGRP.SID = EXE.ParentSID
	WHERE
		CS.CourseName IS NOT NULL

	UNION ALL

	SELECT
		AcademicYear = NC.AcademicYear,
		ProvSpecValue = MAX ( NC.CourseCode ),
		CourseCode = NC.CourseCode,
		CourseTitle = MAX ( NC.CourseTitle ),
		CollegeLevel1Code = MAX ( NC.CollegeCode ),
		CollegeLevel1Name = MAX ( NC.CollegeName ),
		CollegeLevel2Code = NULL,
		CollegeLevel2Name = NULL,
        CollegeLevel3Code = MAX ( NC.FacCode ),
		CollegeLevel3Name = MAX ( NC.FacName ),
		CollegeLevel4Code = MAX ( NC.TeamCode ),
		CollegeLevel4Name = MAX ( NC.TeamName )		
	FROM (
		SELECT
			CourseCode = CS.Course_Code,
			CourseTitle = MAX ( CS.[Learning Aim Title] ),
			CollegeCode = COALESCE ( RTRIM ( CGRP.Code ), '--UNK--' ),
			CollegeName = COALESCE ( CGRP.Name, '-- Unknown --' ),
			FacCode = COALESCE ( RTRIM ( FAC.Code ), '--UNK--' ),
			FacName = COALESCE ( FAC.Name, '-- Unknown --' ),
			TeamCode = COALESCE ( RTRIM ( TEAM.Code ), '--UNK--' ),
			TeamName = COALESCE ( TEAM.Name, '-- Unknown --' ),
			AcademicYear = AY.AcademicYearID
		FROM NlandCourseStructureMappingsJoCooper CS
		INNER JOIN ProSolution.dbo.CollegeLevel TEAM
			ON TEAM.Code = CS.Team
		INNER JOIN ProSolution.dbo.CollegeLevel FAC
			ON FAC.SID = TEAM.ParentSID
		INNER JOIN ProSolution.dbo.CollegeLevel EXE
			ON EXE.SID = FAC.ParentSID
		INNER JOIN ProSolution.dbo.CollegeLevel CGRP
			ON CGRP.SID = EXE.ParentSID
		INNER JOIN ProSolution.dbo.AcademicYear AY
			ON AY.AcademicYearID >= '14/15'
			AND AY.AcademicYearID <= '18/19'
		WHERE
			TEAM.LevelNum = 4
			AND TEAM.Code IS NOT NULL
			--AND CS.Course_Code = 'BUS0124D'
		GROUP BY
			CS.Course_Code,
			COALESCE ( RTRIM ( CGRP.Code ), '--UNK--' ),
			COALESCE ( CGRP.Name, '-- Unknown --' ),
			COALESCE ( RTRIM ( FAC.Code ), '--UNK--' ),
			COALESCE ( FAC.Name, '-- Unknown --' ),
			COALESCE ( RTRIM ( TEAM.Code ), '--UNK--' ),
			COALESCE ( TEAM.Name, '-- Unknown --' ),
			AY.AcademicYearID

		UNION ALL

		SELECT
			CourseCode = CS.CourseCode,
			CourseTitle = COALESCE ( CS.CourseTitle, CS.AimName ),
			CollegeCode = COALESCE ( RTRIM ( CGRP.Code ), '--UNK--' ),
			CollegeName = COALESCE ( CGRP.Name, '-- Unknown --' ),
			FacCode = COALESCE ( RTRIM ( FAC.Code ), '--UNK--' ),
			FacName = COALESCE ( FAC.Name, '-- Unknown --' ),
			TeamCode = COALESCE ( RTRIM ( TEAM.Code ), '--UNK--' ),
			TeamName = COALESCE ( TEAM.Name, '-- Unknown --' ),
			AcademicYear = AY.AcademicYearID
		FROM NlandCourseStructureMappingsJoCooper2 CS
		INNER JOIN ProSolution.dbo.CollegeLevel TEAM
			ON TEAM.Code = CS.TeamCode
		INNER JOIN ProSolution.dbo.CollegeLevel FAC
			ON FAC.SID = TEAM.ParentSID
		INNER JOIN ProSolution.dbo.CollegeLevel EXE
			ON EXE.SID = FAC.ParentSID
		INNER JOIN ProSolution.dbo.CollegeLevel CGRP
			ON CGRP.SID = EXE.ParentSID
		INNER JOIN ProSolution.dbo.AcademicYear AY
			ON AY.AcademicYearID >= '14/15'
			AND AY.AcademicYearID <= '18/19'
		WHERE
			TEAM.LevelNum = 4
			AND TEAM.Code IS NOT NULL
			AND AY.AcademicYearID IS NOT NULL
			--AND CS.CourseCode = 'BUS0124D'
	) NC
	GROUP BY
		NC.CourseCode,
		NC.AcademicYear
GO


