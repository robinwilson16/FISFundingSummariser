CREATE PROCEDURE SPR_FIS_GenerateFundingData
	@FISDatabase NVARCHAR(50),
	@AcademicYear NVARCHAR(5),
	@ILRReturn NVARCHAR(3),
	@IsFinalReturn BIT,
	@Split1619Funding BIT,
	@Reapportion1619FundingByAimWeighting BIT,
	@AppsMoveFundingToMainComponentAim BIT,
	@1619ALSFundingPercent DECIMAL(5,2),
	@IncludeHEAdvLoanPossIncome BIT,
	@IncludeAdvLoanBursaryIncome BIT,
	@FutureAchieveWeighting DECIMAL(5,2),
	@Mode NCHAR(1),
	@FISOutputTableLocation NVARCHAR(200),
	@FISOutputTableName NVARCHAR(200),
	@ProviderFieldCourseLocation NCHAR(1),
	@ProviderFieldParentCourseLocation NCHAR(1),
	@OverrideEngFac NVARCHAR(50),
	@OverrideMatFac NVARCHAR(50),
	@OverrideEngTeam NVARCHAR(50),
	@OverrideMatTeam NVARCHAR(50),
	@OverrideEngCostCentre NVARCHAR(50),
	@OverrideMatCostCentre NVARCHAR(50),
	@OverridePartnerFac NVARCHAR(50),
	@OverridePartnerTeam NVARCHAR(50),
	@OverridePartnerCostCentre NVARCHAR(50),
	@RunQARCalculation BIT,
	@AnonymiseData BIT
AS
BEGIN
	SET XACT_ABORT, NOCOUNT ON;
	
	--DECLARE @ILRReturn NVARCHAR(3) = 'R04' -- CHANGE THIS TO CORRECT RETURN
	--DECLARE @IsFinalReturn BIT = 1 -- IF FINAL RETURN SET THIS TO 1 - ensure only 1 return for each month is set to 1 for accurate year on year reporting






	--DECLARE @FISDatabase NVARCHAR(100) = 'ILR2324_R04F_Furness'
	--DECLARE @AcademicYear NVARCHAR(5) = '23/24'
	--DECLARE @Split1619Funding BIT = 0 --Split the funding into the 12 periods
	--DECLARE @Reapportion1619FundingByAimWeighting BIT = 0 --Reapportion the 16-19 funding by the aim prog weighting factor
	--DECLARE @AppsMoveFundingToMainComponentAim BIT = 1 --Move Apps Funding from Main ZProg to Main Component Aim
	--DECLARE @1619ALSFundingPercent DECIMAL(5,2) = 0 --Deduct this percent from Tot Funding for FM25 and assign to ALS column
	--DECLARE @IncludeHEAdvLoanPossIncome BIT = 0 --HE gross fee is only achieved if at all 3 SLC census points learners remain current
	--DECLARE @IncludeAdvLoanBursaryIncome BIT = 0 --Adv loan bursary income is not income as goes to learners so may want to exclude
	--DECLARE @FutureAchieveWeighting DECIMAL(5,2) = 1 --Future ach weighting factor. If 1 then is 100% of all remaining ach monies
	--DECLARE @Mode NCHAR(1) = 'I' --I=Insert new ILR return data leaving existing data, R=Replace table
	--DECLARE @FISOutputTableLocation NVARCHAR(200) = 'FISFundingSummariser.dbo.'
	--DECLARE @FISOutputTableName NVARCHAR(200) = 'FIS_FundingData'
	--DECLARE @ProviderFieldCourseLocation NCHAR(1) = 'A'
	--DECLARE @ProviderFieldParentCourseLocation NCHAR(1) = 'B'
	--DECLARE @OverrideEngFac NVARCHAR(50) = NULL
	--DECLARE @OverrideMatFac NVARCHAR(50) = NULL
	--DECLARE @OverrideEngTeam NVARCHAR(50) = NULL
	--DECLARE @OverrideMatTeam NVARCHAR(50) = NULL
	--DECLARE @OverrideEngCostCentre NVARCHAR(50) = NULL
	--DECLARE @OverrideMatCostCentre NVARCHAR(50) = NULL
	--DECLARE @OverridePartnerFac NVARCHAR(50) = NULL
	--DECLARE @OverridePartnerTeam NVARCHAR(50) = NULL
	--DECLARE @OverridePartnerCostCentre NVARCHAR(50) = NULL
	--DECLARE @RunQARCalculation BIT = 1 --Calculate which records should be included in QAR measures for each year
	--DECLARE @AnonymiseData BIT = 0 --Anonymise ILR data


	DECLARE @TableExists BIT = 1;
	DECLARE @ProviderNumber INT;
	DECLARE @FileDate DATETIME;
	DECLARE @NumExistingRecords INT = 0;
	
	DECLARE @SQLString NVARCHAR(MAX);
	DECLARE @SQLParams NVARCHAR(MAX);

	DECLARE @Message NVARCHAR(MAX);

	DECLARE @ILRReturnSummary NVARCHAR(200) = NULL;

	SET @Message = N'Starting Operation at ' + FORMAT ( SYSDATETIME(), 'dd/MM/yyyy HH:mm:ss' );
	RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;

	SET @ILRReturnSummary = 
		N'Importing ' + @AcademicYear + ' ' + @ILRReturn
		+ CASE
			WHEN @IsFinalReturn = 1 THEN N'Final'
			ELSE N'Non-Final'
		END
		+ N' ILR Return';

	SET @Message = @ILRReturnSummary;
	RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;

	SET @Message = N'Using FIS Database ' + @FISDatabase;
	RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;

	SET @Message = N'Importing into ' + @FISOutputTableLocation + @FISOutputTableName;
	RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;

	--Get Provider ID and date of new ILR Return to be imported
	IF @AcademicYear >= '19/20'
	BEGIN
		SET @SQLString = 
		N'
			SELECT
				@ProviderNumber = SRC.UKPRN,
				@FileDate = SRC.DateTime
			FROM ' + @FISDatabase + '.Valid.Source SRC';
	END
	ELSE
	BEGIN
		SET @SQLString = 
		N'
			SELECT
				@ProviderNumber = SRC.UKPRN,
				@FileDate = SRC.DateTime
			FROM ' + @FISDatabase + '.dbo.Valid_Source SRC';
	END

    SET @SQLParams = 
	N'
		@ProviderNumber INT OUTPUT,
		@FileDate DATETIME OUTPUT';

    EXECUTE sp_executesql 
        @SQLString, 
        @SQLParams, 
		@ProviderNumber = @ProviderNumber OUTPUT,
        @FileDate = @FileDate OUTPUT;


	IF @Mode = 'D'
		BEGIN
			SET @SQLString = 
			N'
				DELETE FROM FD
				FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
				WHERE
					FD.ProviderNumber = @ProviderNumber
					AND FD.AcademicYear = @AcademicYear
					AND FD.ILRReturn = @ILRReturn
					AND FD.IsFinalReturn = @IsFinalReturn
					AND FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @FileDate, ''yyyy-MM-dd HH:mm:ss'' )';

			SET @SQLParams = 
			N'
				@ProviderNumber INT,
				@AcademicYear NVARCHAR(5),
				@ILRReturn NVARCHAR(3),
				@IsFinalReturn BIT,
				@FileDate DATETIME';

			EXECUTE sp_executesql 
				@SQLString, 
				@SQLParams, 
				@ProviderNumber = @ProviderNumber,
				@AcademicYear = @AcademicYear,
				@ILRReturn = @ILRReturn,
				@IsFinalReturn = @IsFinalReturn,
				@FileDate = @FileDate;

			SET @Message = N'Number Of Records Removed for Provider ' + CAST ( @ProviderNumber AS VARCHAR(50) ) + ': ' + CAST ( @@ROWCOUNT AS VARCHAR(50) );
			RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;

		END
	ELSE
		BEGIN
			SET @Message = N'Date of ILR Return to be Imported for Provider ' + CAST ( @ProviderNumber AS VARCHAR(50) ) + ': ' + FORMAT ( @FileDate, 'dd/MM/yyyy' );
			RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;

			IF @Mode = N'R'
				--If mode is to replace then drop the table
				BEGIN
					SET @SQLString = 
					N'
						DROP TABLE IF EXISTS dbo.[' + @FISOutputTableName + ']';

					SET @SQLParams = 
					N'';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams;
				END
			ELSE
				--Confirm table exists already
				IF OBJECT_ID(@FISOutputTableLocation + '[' + @FISOutputTableName + ']', 'U') IS NULL 
					SET @TableExists = 0;

			IF @Mode = 'R' OR @TableExists = 0
				--If mode is to replace or table does not exist then create it
				BEGIN
					SET @SQLString = 
					N'
						CREATE TABLE ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] (
							AcademicYear NVARCHAR(5) NULL,
							ProviderNumber INT NULL,
							ProviderName NVARCHAR(200) NULL,
							ILRReturn NVARCHAR(3) NULL,
							IsFinalReturn BIT NULL,
							ILRReturnDate DATETIME NULL,
							SQLDatabase NVARCHAR(50) NULL,
							ImportDate DATETIME NULL,
							Is1619FundingSplit BIT NULL,
							ALS1619FundingPercent DECIMAL(5, 2) NULL,
							Is1619FundingReapportionedByAim BIT NULL,
							AppsMoveFundingToMainComponentAim BIT NULL,
							InvalidLearners INT NULL,

							LearnRefNumber NVARCHAR(12) NULL,
							PrevLearnRefNumber NVARCHAR(50) NULL,
							PrevUKPRN INT NULL,
							Surname NVARCHAR(100) NULL,
							Forename NVARCHAR(100) NULL,
							Sex NVARCHAR(1) NULL,
							DOB DATETIME NULL,
							Age31AugCurrentYear INT NULL,
							Age31AugEarliestStartYear INT NULL,
							AgeGroupCurrentYear NVARCHAR(5) NULL,
							AgeGroupEarliestStartYear NVARCHAR(5) NULL,
							EarliestStartDate DATETIME NULL,
							LatestEndDate DATETIME NULL,
							ULN BIGINT NULL,
							NINumber NVARCHAR(9) NULL,
							Address1 NVARCHAR(50) NULL,
							Address2 NVARCHAR(50) NULL,
							Address3 NVARCHAR(50) NULL,
							Address4 NVARCHAR(50) NULL,
							PostCodeCurrent NVARCHAR(10) NULL,
							PostCodePriorToEnrol NVARCHAR(8) NULL,
							PostCodeLearningStartDate NVARCHAR(8) NULL,
							Tel NVARCHAR(18) NULL,
							Email NVARCHAR(100) NULL,
							PostCodeWardCode NVARCHAR(10) NULL,
							PostCodeWardName NVARCHAR(100) NULL,
							PostCodeDistrictCode NVARCHAR(10) NULL,
							PostCodeDistrictName NVARCHAR(50) NULL,
							PostCodeLEACode NVARCHAR(10) NULL,
							PostCodeLEAName NVARCHAR(50) NULL,
							PostCodeSourceOfFundingCode NVARCHAR(50) NULL,
							PostCodeDisadvUplift DECIMAL(6, 5) NULL,
							EmpStatusCode INT NULL,
							EmpStatusName NVARCHAR(20) NULL,
							EmpStatusAppliesDate DATETIME NULL,
							EmpStatusEmployerID INT NULL,
							LengthOfEmploy INT NULL,
							LengthOfUnemploy INT NULL,
							BenefitStatusInd INT NULL,
							SmallEmployer INT NULL,
							SelfEmployInd INT NULL,
							EmployIntensityInd INT NULL,
							IsFirstFullLevel2 INT NULL,
							IsFirstFullLevel3 INT NULL,
							PriorLevelCode INT NULL,
							PriorLevelName NVARCHAR(80) NULL,
							PriorLevelDate DATE NULL,
							EthnicityCode INT NULL,
							EthnicityName NVARCHAR(62) NULL,
							LLDDHealthProb INT NULL,
							PrimaryLLDDHealthProblemCode INT NULL,
							PrimaryLLDDHealthProblemName NVARCHAR(100) NULL,
							FAMLearnerHNS INT NULL,
							FAMLearnerEHC INT NULL,
							FAMLearnerDLA INT NULL,
							FAMLearnerLSR INT NULL,
							FAMLearnerSEN INT NULL,
							FAMLearnerNLM INT NULL,
							FAMLearnerEDF INT NULL,
							FAMLearnerMCF INT NULL,
							FAMLearnerECF INT NULL,
							FAMLearnerFME INT NULL,
							DestinationProgressionType NVARCHAR(3) NULL,
							DestinationProgressionNumber INT NULL,
							DestinationProgressionCode NVARCHAR(10) NULL,
							DestinationProgressionName NVARCHAR(255) NULL,
							DestinationProgressionStartDate DATETIME NULL,
							DestinationProgressionEndDate DATETIME NULL,
							DestinationProgressionCollectionDate DATETIME NULL,
					'
    
					SET @SQLString += 
						N'
							SoftwareSupplierAimID NVARCHAR(36) NULL,
							FundLineType NVARCHAR(100) NULL,
							FundLineSummary NVARCHAR(100) NULL,
							FundLineDetail NVARCHAR(100) NULL,
							FundLine NVARCHAR(100) NULL,
							FundLineSummaryOrder INT NULL,
							FundLineDetailOrder INT NULL,
							FundLineOrder INT NULL,
							FundModel INT NULL,
							HEFullPartTime NVARCHAR(50) NULL,

							IsMainAim INT NULL,
							IsMainAimInFundModel INT NULL,
							IsAdvLearnLoan INT NULL,
							IsAdvLearnLoanBursary INT NULL,
							RateBand NVARCHAR(50) NULL,
							RateBandOrder INT NULL,
							GCSEMathsGrade NVARCHAR(4) NULL,
							GCSEEnglishGrade NVARCHAR(4) NULL,
							CofMaths NVARCHAR(100) NULL,
							CofEnglish NVARCHAR(100) NULL,
							CofMathsMet INT NULL,
							CofEnglishMet INT NULL,
							CofMet INT NULL,
							Block1DisadvUplift DECIMAL(10, 5) NULL,
							Block2DisadvElements DECIMAL(10, 5) NULL,
							ProgWeightingFactor DECIMAL(10, 5) NULL,
							ThresholdDays INT NULL,
							FAMLearningDeliverySOF NVARCHAR(5) NULL,
							FAMLearningDeliveryFFI NVARCHAR(5) NULL,
							FAMLearningDeliveryEEF NVARCHAR(5) NULL,
							FAMLearningDeliveryRES NVARCHAR(5) NULL,
							FAMLearningDeliveryLSF NVARCHAR(5) NULL,
							FAMLearningDeliveryADL NVARCHAR(5) NULL,
							FAMLearningDeliveryALB NVARCHAR(5) NULL,
							FAMLearningDeliveryASL NVARCHAR(5) NULL,
							FAMLearningDeliveryFLN NVARCHAR(5) NULL,
							FAMLearningDeliveryLDM NVARCHAR(5) NULL,
							FAMLearningDeliveryDAM NVARCHAR(5) NULL,
							FAMLearningDeliveryACT NVARCHAR(5) NULL,
							FAMLearningDeliveryACL NVARCHAR(5) NULL,
							FAMLearningDeliveryAFL NVARCHAR(5) NULL,
					'
    
					SET @SQLString += 
						N'
							PostCodeDelivery NVARCHAR(10) NULL,
							CampusID NVARCHAR(20) NULL,

							ParentCollegeLevel1Code NVARCHAR(20) NULL,
							ParentCollegeLevel1Name NVARCHAR(150) NULL,
							ParentCollegeLevel2Code NVARCHAR(20) NULL,
							ParentCollegeLevel2Name NVARCHAR(150) NULL,
							ParentCollegeLevel3Code NVARCHAR(20) NULL,
							ParentCollegeLevel3Name NVARCHAR(150) NULL,
							ParentCollegeLevel4Code NVARCHAR(20) NULL,
							ParentCollegeLevel4Name NVARCHAR(150) NULL,

							CollegeLevel1Code NVARCHAR(20) NULL,
							CollegeLevel1Name NVARCHAR(150) NULL,
							CollegeLevel2Code NVARCHAR(20) NULL,
							CollegeLevel2Name NVARCHAR(150) NULL,
							CollegeLevel3Code NVARCHAR(20) NULL,
							CollegeLevel3Name NVARCHAR(150) NULL,
							CollegeLevel4Code NVARCHAR(20) NULL,
							CollegeLevel4Name NVARCHAR(150) NULL,

							OriginalCollegeLevel1Code NVARCHAR(20) NULL,
							OriginalCollegeLevel1Name NVARCHAR(150) NULL,
							OriginalCollegeLevel2Code NVARCHAR(20) NULL,
							OriginalCollegeLevel2Name NVARCHAR(150) NULL,
							OriginalCollegeLevel3Code NVARCHAR(20) NULL,
							OriginalCollegeLevel3Name NVARCHAR(150) NULL,
							OriginalCollegeLevel4Code NVARCHAR(20) NULL,
							OriginalCollegeLevel4Name NVARCHAR(150) NULL,
					
							MainAimCollegeLevel1Code NVARCHAR(20) NULL,
							MainAimCollegeLevel1Name NVARCHAR(150) NULL,
							MainAimCollegeLevel2Code NVARCHAR(20) NULL,
							MainAimCollegeLevel2Name NVARCHAR(150) NULL,
							MainAimCollegeLevel3Code NVARCHAR(20) NULL,
							MainAimCollegeLevel3Name NVARCHAR(150) NULL,
							MainAimCollegeLevel4Code NVARCHAR(20) NULL,
							MainAimCollegeLevel4Name NVARCHAR(150) NULL,

							SSA1Code NVARCHAR(5) NULL,
							SSA1Title NVARCHAR(255) NULL,
							SSA2Code NVARCHAR(5) NULL,
							SSA2Title NVARCHAR(255) NULL,
							CourseCode NVARCHAR(20) NULL,
							CourseTitle NVARCHAR(255) NULL,

							AimSeqNumber INT NULL,
							LearnerAndAimRowNum INT NULL,
							AimType INT NULL,

							LearningAimCode NVARCHAR(8) NULL,
							LearningAimTitle NVARCHAR(254) NULL,
							LearningAimTypeCode NVARCHAR(4) NULL,
							LearningAimTypeName NVARCHAR(150) NULL,

							NVQLevelCode NCHAR(1) NULL,
							NVQLevelName NVARCHAR(50) NULL,
							NVQLevelOrder DECIMAL(10, 5) NULL,
							IsMathsAndEnglish NCHAR(1) NULL,
							MainAimNVQLevelCode NCHAR(1) NULL,
							MainAimNVQLevelName NVARCHAR(50) NULL,
							MainAimNVQLevelOrder DECIMAL(10, 5) NULL,
							MainAimIsMathsAndEnglish NCHAR(1) NULL,

							CompletionStatusCode INT NULL,
							CompletionStatusName NVARCHAR(20) NULL,
							OutcomeCode INT NULL,
							OutcomeName NVARCHAR(20) NULL,
							StartDate DATETIME NULL,
							OriginalStartDate DATETIME NULL,
							PlannedEndDate DATETIME NULL,
							ActualEndDate DATETIME NULL,
							AchievementDate DATETIME NULL,
							RestartIndicator BIT NULL,
							Duration NVARCHAR(10) NULL,
							WithdrawReason NVARCHAR(2) NULL,
							Grade NVARCHAR(6) NULL,
							AwardBody NVARCHAR(20) NULL,
							StartYear NVARCHAR(5) NULL,
							AchievementYear NVARCHAR(5) NULL,
							PlannedEndYear NVARCHAR(5) NULL,
							ActualEndYear NVARCHAR(5) NULL,
							ReportingYear NVARCHAR(5) NULL,
							HybridEndYear NVARCHAR(5) NULL,
							LatestImportedFileAcademicYear NVARCHAR(5) NULL,
							LatestImportedFileILRReturnDate DATETIME  NULL,
							LatestImportedFileILRReturn NVARCHAR(3)  NULL,
							LatestImportedFileIsFinalReturn BIT NULL,

							IncludeInQARMeasures INT NULL,
							QARNumberOfMergedYearsOfData INT NULL,
							IsFundedStart INT NULL,

							IsPastPlannedEndDate INT NULL,
							IsOverallStart INT NULL,
							IsTimelyStart INT NULL,
							IsOverallLeaver INT NULL,
							IsTimelyLeaver INT NULL,
							IsOverallLeaverBestCase INT NULL,
							IsTimelyLeaverBestCase INT NULL,
							IsOverallAchieverBestCase INT NULL,
							IsTimelyAchieverBestCase INT NULL,
							IsOverallContinuer INT NULL,
							IsTimelyContinuer INT NULL,
							IsOverallContinuerNotFunded INT NULL,
							IsTimelyContinuerNotFunded INT NULL,
							IsOverallContinuerFunded INT NULL,
							IsTimelyContinuerFunded INT NULL,
							IsOverallCompleted INT NULL,
							IsTimelyCompleted INT NULL,
							IsOverallCompletedNotFunded INT NULL,
							IsTimelyCompletedNotFunded INT NULL,
							IsOverallCompletedFunded INT NULL,
							IsTimelyCompletedFunded INT NULL,
							IsOverallRetained INT NULL,
							IsTimelyRetained INT NULL,
							IsOverallRetainedNotFunded INT NULL,
							IsTimelyRetainedNotFunded INT NULL,
							IsOverallRetainedFunded INT NULL,
							IsTimelyRetainedFunded INT NULL,
							IsOverallWithdrawn INT NULL,
							IsTimelyWithdrawn INT NULL,
							IsOverallWithdrawnNotFunded INT NULL,
							IsTimelyWithdrawnNotFunded INT NULL,
							IsOverallWithdrawnFunded INT NULL,
							IsTimelyWithdrawnFunded INT NULL,
							IsOverallWithdrawnPreEligibility INT NULL,
							IsTimelyWithdrawnPreEligibility INT NULL,
							IsOverallWithdrawnPreEligibilityNotFunded INT NULL,
							IsTimelyWithdrawnPreEligibilityNotFunded INT NULL,
							IsOverallWithdrawnPreEligibilityFunded INT NULL,
							IsTimelyWithdrawnPreEligibilityFunded INT NULL,
							IsOverallWithdrawnPostEligibility INT NULL,
							IsTimelyWithdrawnPostEligibility INT NULL,
							IsOverallWithdrawnPostEligibilityNotFunded INT NULL,
							IsTimelyWithdrawnPostEligibilityNotFunded INT NULL,
							IsOverallWithdrawnPostEligibilityFunded INT NULL,
							IsTimelyWithdrawnPostEligibilityFunded INT NULL,
							IsOverallTransfer INT NULL,
							IsTimelyTransfer INT NULL,
							IsOverallTransferNotFunded INT NULL,
							IsTimelyTransferNotFunded INT NULL,
							IsOverallTransferFunded INT NULL,
							IsTimelyTransferFunded INT NULL,
							IsTransferValid INT NULL,
							IsOverallBreakInLearning INT NULL,
							IsTimelyBreakInLearning INT NULL,
							IsOverallBreakInLearningNotFunded INT NULL,
							IsTimelyBreakInLearningNotFunded INT NULL,
							IsOverallBreakInLearningFunded INT NULL,
							IsTimelyBreakInLearningFunded INT NULL,
							IsBreakInLearningValid INT NULL,
							IsOverallAchiever INT NULL,
							IsTimelyAchiever INT NULL,
							IsOverallAchieverNotFunded INT NULL,
							IsTimelyAchieverNotFunded INT NULL,
							IsOverallAchieverFunded INT NULL,
							IsTimelyAchieverFunded INT NULL,
							IsOverallFailed INT NULL,
							IsTimelyFailed INT NULL,
							IsOverallFailedNotFunded INT NULL,
							IsTimelyFailedNotFunded INT NULL,
							IsOverallFailedFunded INT NULL,
							IsTimelyFailedFunded INT NULL,
							IsOverallUnknownOutcome INT NULL,
							IsTimelyUnknownOutcome INT NULL,
							IsOverallUnknownOutcomeNotFunded INT NULL,
							IsTimelyUnknownOutcomeNotFunded INT NULL,
							IsOverallUnknownOutcomeFunded INT NULL,
							IsTimelyUnknownOutcomeFunded INT NULL,
							IsUnknownOutcomeValid INT NULL,
							IsOverallHighGrade INT NULL,
							IsTimelyHighGrade INT NULL,
							IsOutOfFunding30Days INT NULL,
							IsOutOfFunding60Days INT NULL,
							IsOutOfFunding90Days INT NULL,

							PlanLearnHours INT NULL,
							PlanEEPHours INT NULL,
							FM25PLHAim INT NULL,
							FM25EEPAim INT NULL,
							FM25PLHAllAims INT NULL,
							FM25EEPAllAims INT NULL,
							IsPartTime NCHAR(1) NULL,

							ProgType INT NULL,
							StandardCode INT NULL,
							StandardName NVARCHAR(750) NULL,
							FrameworkCode INT NULL,
							FrameworkName NVARCHAR(150) NULL,
							PathwayCode INT NULL,
							PathwayName NVARCHAR(150) NULL,
							OffTheJobActualHours INT NULL,
							EmployerID INT NULL,
							EmployerName NVARCHAR(100) NULL,
							PartnerCode INT NULL,
							PartnerName NVARCHAR(100) NULL,
					
							AimValue DECIMAL(10, 5) NULL,
							ProgWeightFactor NCHAR(1) NULL,
							UnweightFundRate DECIMAL(10, 5) NULL,
							WeightFundRate DECIMAL(10, 5) NULL,
							CoFundingIndicator NVARCHAR(10) NULL,
							IsCarryIn INT NULL,
							HEQualEnt3 NVARCHAR(3) NULL,
							HESoc2000 INT NULL,
							HESec INT NULL,
							HEUCASAppID NVARCHAR(9) NULL,
							HETypeYr INT NULL,
							HEModeStu INT NULL,
							HEFundLev INT NULL,
							HEFundComp INT NULL,
							HEStuLoad DECIMAL(4, 1) NULL,
							HEYearStu INT NULL,
							HEMajorSourceStuFee INT NULL,
							HEPercentageNotTaught DECIMAL(4, 1) NULL,
							HEPercentTaughtFirstLDCS DECIMAL(4, 1) NULL,
							HEPercentTaughtSecondLDCS DECIMAL(4, 1) NULL,
							HEPercentTaughtThirdLDCS DECIMAL(4, 1) NULL,
							HESpecialFeeIndicator INT NULL,
							HENetTuitionFee INT NULL,
							HEGrossTuitionFee INT NULL,
							HEDomicile NVARCHAR(2) NULL,
							HEELQ INT NULL,
							HEPostCode NVARCHAR(8) NULL,
							EnrolmentID NVARCHAR(20) NULL,
							FM25TotFund DECIMAL(10, 5) NULL,
					'
    
					SET @SQLString += 
						N'
							ProvSpecLearnMonA NVARCHAR(20) NULL,
							ProvSpecLearnMonB NVARCHAR(20) NULL,
							ProvSpecLearnMonC NVARCHAR(20) NULL,
							ProvSpecLearnMonD NVARCHAR(20) NULL,
							ProvSpecDelMonA NVARCHAR(20) NULL,
							ProvSpecDelMonB NVARCHAR(20) NULL,
							ProvSpecDelMonC NVARCHAR(20) NULL,
							ProvSpecDelMonD NVARCHAR(20) NULL,

							NumPlannedOnProgPayments INT NULL,
							NumOutstandingOnProgPayments INT NULL,
							AchieveElement DECIMAL(10, 5) NULL,
							NonGovCont DECIMAL(10, 5) NULL,
							PropFundRemain DECIMAL(10, 5) NULL,
							PropFundRemainAch DECIMAL(10, 5) NULL,
							CarryInOnProg DECIMAL(10, 5) NULL,
							CarryInYr1R01 DECIMAL(10, 5) NULL,
							CarryInYr1R02 DECIMAL(10, 5) NULL,
							CarryInYr1R03 DECIMAL(10, 5) NULL,
							CarryInYr1R04 DECIMAL(10, 5) NULL,
							CarryInYr1R05 DECIMAL(10, 5) NULL,
							CarryInYr1R06 DECIMAL(10, 5) NULL,
							CarryInYr1R07 DECIMAL(10, 5) NULL,
							CarryInYr1R08 DECIMAL(10, 5) NULL,
							CarryInYr1R09 DECIMAL(10, 5) NULL,
							CarryInYr1R10 DECIMAL(10, 5) NULL,
							CarryInYr1R11 DECIMAL(10, 5) NULL,
							CarryInYr1R12 DECIMAL(10, 5) NULL,
							CarryInYr2R01 DECIMAL(10, 5) NULL,
							CarryInYr2R02 DECIMAL(10, 5) NULL,
							CarryInYr2R03 DECIMAL(10, 5) NULL,
							CarryInYr2R04 DECIMAL(10, 5) NULL,
							CarryInYr2R05 DECIMAL(10, 5) NULL,
							CarryInYr2R06 DECIMAL(10, 5) NULL,
							CarryInYr2R07 DECIMAL(10, 5) NULL,
							CarryInYr2R08 DECIMAL(10, 5) NULL,
							CarryInYr2R09 DECIMAL(10, 5) NULL,
							CarryInYr2R10 DECIMAL(10, 5) NULL,
							CarryInYr2R11 DECIMAL(10, 5) NULL,
							CarryInYr2R12 DECIMAL(10, 5) NULL,
					'
    
					SET @SQLString += 
						N'
							OnProgPaymentToPeriod DECIMAL(10, 5) NULL,
							LearnSuppPaymentToPeriod DECIMAL(10, 5) NULL,
							AchCompPaymentToPeriod DECIMAL(10, 5) NULL,
							BalancePaymentToPeriod DECIMAL(10, 5) NULL,
							EmpOutcomePayToPeriod DECIMAL(10, 5) NULL,
							OtherPaymentToPeriod DECIMAL(10, 5) NULL,
							TotFundToPeriod DECIMAL(10, 5) NULL,

							OnProgPayment6Mon DECIMAL(10, 5) NULL,
							LearnSuppPayment6Mon DECIMAL(10, 5) NULL,
							AchCompPayment6Mon DECIMAL(10, 5) NULL,
							BalancePayment6Mon DECIMAL(10, 5) NULL,
							EmpOutcomePay6Mon DECIMAL(10, 5) NULL,
							OtherPayment6Mon DECIMAL(10, 5) NULL,
							TotFund6Mon DECIMAL(10, 5) NULL,

							OnProgPaymentYrEnd DECIMAL(10, 5) NULL,
							LearnSuppPaymentYrEnd DECIMAL(10, 5) NULL,
							AchCompPaymentYrEnd DECIMAL(10, 5) NULL,
							BalancePaymentYrEnd DECIMAL(10, 5) NULL,
							EmpOutcomePayYrEnd DECIMAL(10, 5) NULL,
							OtherPaymentYrEnd DECIMAL(10, 5) NULL,
							TotFundYrEnd DECIMAL(10, 5) NULL,
							TotFundYrEndNotApportioned DECIMAL(10, 5) NULL,

							FutureAchievePayment DECIMAL(10, 5) NULL,
							FutureAchieveWeighting DECIMAL(5, 2) NULL,
							FutureAchievePaymentWeighted DECIMAL(10, 5) NULL,

							AppStandardPriceEpisodeIdentifier NVARCHAR(25) NULL,
							AppStandardTNP1 DECIMAL(12, 5) NULL,
							AppStandardTNP2 DECIMAL(12, 5) NULL,
							AppStandardTNP3 DECIMAL(12, 5) NULL,
							AppStandardTNP4 DECIMAL(12, 5) NULL,
							AppStandardEpisodeStartDate DATE NULL,
							AppStandardPriceEpisode1618FrameworkUpliftRemainingAmount DECIMAL(12, 5) NULL,
							AppStandardPriceEpisode1618FrameworkUpliftTotPrevEarnings DECIMAL(12, 5) NULL,
							AppStandardPriceEpisode1618FUBalValue DECIMAL(12, 5) NULL,
							AppStandardPriceEpisode1618FUMonthInstValue DECIMAL(12, 5) NULL,
							AppStandardPriceEpisode1618FUTotEarnings DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeUpperBandLimit DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodePlannedEndDate DATE NULL,
							AppStandardPriceEpisodeActualEndDate DATE NULL,
							AppStandardPriceEpisodeActualEndDateIncEPA DATE NULL,
							AppStandardPriceEpisodeTotalTNPPrice DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeUpperLimitAdjustment DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodePlannedInstalments INT NULL,
							AppStandardPriceEpisodeActualInstalments INT NULL,
							AppStandardPriceEpisodeCompletionElement DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodePreviousEarnings DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeInstalmentValue DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeTotalEarnings DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeCompleted INT NULL,
							AppStandardPriceEpisodeRemainingTNPAmount DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeRemainingAmountWithinUpperLimit DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeCappedRemainingTNPAmount DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeExpectedTotalMonthlyValue DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeAimSeqNumber INT NULL,
							AppStandardPriceEpisodeApplic1618FrameworkUpliftCompElement DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeFundLineType NVARCHAR(100) NULL,
							AppStandardEpisodeEffectiveTNPStartDate DATE NULL,
							AppStandardPriceEpisodeFirstAdditionalPaymentThresholdDate DATE NULL,
							AppStandardPriceEpisodeSecondAdditionalPaymentThresholdDate DATE NULL,
							AppStandardPriceEpisodeContractType NVARCHAR(50) NULL,
							AppStandardPriceEpisodePreviousEarningsSameProvider DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeTotalPMRs DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeCumulativePMRs DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeCompExemCode INT NULL,
							AppStandardPriceEpisodeLearnerAdditionalPaymentThresholdDate DATE NULL,
							AppStandardPriceEpisodeRedStartDate DATE NULL,
							AppStandardPriceEpisodeRedStatusCode INT NULL,
					'
    
					SET @SQLString += 
						N'
							OnProgPaymentP01 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP01 DECIMAL(10, 5) NULL,
							AchCompPaymentP01 DECIMAL(10, 5) NULL,
							BalancePaymentP01 DECIMAL(10, 5) NULL,
							EmpOutcomePayP01 DECIMAL(10, 5) NULL,
							OtherPaymentP01 DECIMAL(10, 5) NULL,
							TotFundP01 DECIMAL(10, 5) NULL,

							OnProgPaymentP02 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP02 DECIMAL(10, 5) NULL,
							AchCompPaymentP02 DECIMAL(10, 5) NULL,
							BalancePaymentP02 DECIMAL(10, 5) NULL,
							EmpOutcomePayP02 DECIMAL(10, 5) NULL,
							OtherPaymentP02 DECIMAL(10, 5) NULL,
							TotFundP02 DECIMAL(10, 5) NULL,

							OnProgPaymentP03 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP03 DECIMAL(10, 5) NULL,
							AchCompPaymentP03 DECIMAL(10, 5) NULL,
							BalancePaymentP03 DECIMAL(10, 5) NULL,
							EmpOutcomePayP03 DECIMAL(10, 5) NULL,
							OtherPaymentP03 DECIMAL(10, 5) NULL,
							TotFundP03 DECIMAL(10, 5) NULL,

							OnProgPaymentP04 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP04 DECIMAL(10, 5) NULL,
							AchCompPaymentP04 DECIMAL(10, 5) NULL,
							BalancePaymentP04 DECIMAL(10, 5) NULL,
							EmpOutcomePayP04 DECIMAL(10, 5) NULL,
							OtherPaymentP04 DECIMAL(10, 5) NULL,
							TotFundP04 DECIMAL(10, 5) NULL,

							OnProgPaymentP05 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP05 DECIMAL(10, 5) NULL,
							AchCompPaymentP05 DECIMAL(10, 5) NULL,
							BalancePaymentP05 DECIMAL(10, 5) NULL,
							EmpOutcomePayP05 DECIMAL(10, 5) NULL,
							OtherPaymentP05 DECIMAL(10, 5) NULL,
							TotFundP05 DECIMAL(10, 5) NULL,

							OnProgPaymentP06 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP06 DECIMAL(10, 5) NULL,
							AchCompPaymentP06 DECIMAL(10, 5) NULL,
							BalancePaymentP06 DECIMAL(10, 5) NULL,
							EmpOutcomePayP06 DECIMAL(10, 5) NULL,
							OtherPaymentP06 DECIMAL(10, 5) NULL,
							TotFundP06 DECIMAL(10, 5) NULL,

							OnProgPaymentP07 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP07 DECIMAL(10, 5) NULL,
							AchCompPaymentP07 DECIMAL(10, 5) NULL,
							BalancePaymentP07 DECIMAL(10, 5) NULL,
							EmpOutcomePayP07 DECIMAL(10, 5) NULL,
							OtherPaymentP07 DECIMAL(10, 5) NULL,
							TotFundP07 DECIMAL(10, 5) NULL,

							OnProgPaymentP08 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP08 DECIMAL(10, 5) NULL,
							AchCompPaymentP08 DECIMAL(10, 5) NULL,
							BalancePaymentP08 DECIMAL(10, 5) NULL,
							EmpOutcomePayP08 DECIMAL(10, 5) NULL,
							OtherPaymentP08 DECIMAL(10, 5) NULL,
							TotFundP08 DECIMAL(10, 5) NULL,

							OnProgPaymentP09 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP09 DECIMAL(10, 5) NULL,
							AchCompPaymentP09 DECIMAL(10, 5) NULL,
							BalancePaymentP09 DECIMAL(10, 5) NULL,
							EmpOutcomePayP09 DECIMAL(10, 5) NULL,
							OtherPaymentP09 DECIMAL(10, 5) NULL,
							TotFundP09 DECIMAL(10, 5) NULL,

							OnProgPaymentP10 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP10 DECIMAL(10, 5) NULL,
							AchCompPaymentP10 DECIMAL(10, 5) NULL,
							BalancePaymentP10 DECIMAL(10, 5) NULL,
							EmpOutcomePayP10 DECIMAL(10, 5) NULL,
							OtherPaymentP10 DECIMAL(10, 5) NULL,
							TotFundP10 DECIMAL(10, 5) NULL,

							OnProgPaymentP11 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP11 DECIMAL(10, 5) NULL,
							AchCompPaymentP11 DECIMAL(10, 5) NULL,
							BalancePaymentP11 DECIMAL(10, 5) NULL,
							EmpOutcomePayP11 DECIMAL(10, 5) NULL,
							OtherPaymentP11 DECIMAL(10, 5) NULL,
							TotFundP11 DECIMAL(10, 5) NULL,

							OnProgPaymentP12 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP12 DECIMAL(10, 5) NULL,
							AchCompPaymentP12 DECIMAL(10, 5) NULL,
							BalancePaymentP12 DECIMAL(10, 5) NULL,
							EmpOutcomePayP12 DECIMAL(10, 5) NULL,
							OtherPaymentP12 DECIMAL(10, 5) NULL,
							TotFundP12 DECIMAL(10, 5) NULL
						)';

					SET @SQLParams = 
					N'';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams;

					SET @SQLString = 
					N'
						CREATE CLUSTERED INDEX CX_FIS_FundingData ON ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] ( AcademicYear, ILRReturn, ILRReturnDate )';

					SET @SQLParams = 
					N'';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams;

					SET @Message = N'Created ' + @FISOutputTableName + N' Table';
					RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;
				END
			ELSE
				--If mode is to insert instead of replace then see if this ILR has already been imported
				BEGIN
					SET @Message = N'Inserting into Existing ' + @FISOutputTableName + N' Table';
					RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;

					SET @SQLString = 
					N'
						SELECT
							@NumExistingRecords = SUM ( 1 )
						FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
						WHERE
							FD.AcademicYear = @AcademicYear
							AND FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @FileDate, ''yyyy-MM-dd HH:mm:ss'' )';

					SET @SQLParams = 
					N'
						@AcademicYear NVARCHAR(5),
						@FileDate DATETIME,
						@NumExistingRecords INT OUTPUT';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams, 
						@AcademicYear = @AcademicYear, 
						@FileDate = @FileDate,
						@NumExistingRecords = @NumExistingRecords OUTPUT;

					IF @NumExistingRecords > 0
						--If same ILR has already been imported then delete it
						BEGIN
							SET @SQLString = 
							N'
								DELETE FD
								FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
								WHERE
									FD.AcademicYear = @AcademicYear
									AND FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @FileDate, ''yyyy-MM-dd HH:mm:ss'' )';

							SET @SQLParams = 
							N'
								@AcademicYear NVARCHAR(5),
								@FileDate DATETIME';

							EXECUTE sp_executesql 
								@SQLString, 
								@SQLParams,
								@AcademicYear = @AcademicYear,
								@FileDate = @FileDate;

							SET @Message = N'Return Already Imported So Deleting Existing ' + CAST ( @NumExistingRecords AS NVARCHAR(10) ) + ' Records From ' + @FISOutputTableName + ' Table';
							RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;
						END
				END

			--Finally insert new data into table
			SET @SQLString = 
			N'
				EXEC SPR_FIS_FundingData_' + REPLACE ( @AcademicYear, '/', '' ) + '
					@FISDatabase,
					@AcademicYear,
					@ILRReturn,
					@IsFinalReturn,
					@Split1619Funding,
					@Reapportion1619FundingByAimWeighting,
					@AppsMoveFundingToMainComponentAim,
					@1619ALSFundingPercent,
					@IncludeHEAdvLoanPossIncome,
					@IncludeAdvLoanBursaryIncome,
					@FutureAchieveWeighting,
					@FISOutputTableLocation,
					@FISOutputTableName,
					@ProviderFieldCourseLocation,
					@ProviderFieldParentCourseLocation,
					@OverrideEngFac,
					@OverrideMatFac,
					@OverrideEngTeam,
					@OverrideMatTeam,
					@OverrideEngCostCentre,
					@OverrideMatCostCentre,
					@OverridePartnerFac,
					@OverridePartnerTeam,
					@OverridePartnerCostCentre';

			SET @SQLParams = 
			N'
				@FISDatabase NVARCHAR(50),
				@AcademicYear NVARCHAR(5),
    			@ILRReturn NVARCHAR(3),
    			@IsFinalReturn BIT,
    			@Split1619Funding BIT,
				@Reapportion1619FundingByAimWeighting BIT,
				@AppsMoveFundingToMainComponentAim BIT,
				@1619ALSFundingPercent DECIMAL(5,2),
				@IncludeHEAdvLoanPossIncome BIT,
				@IncludeAdvLoanBursaryIncome BIT,
    			@FutureAchieveWeighting DECIMAL(5,2),
				@FISOutputTableLocation NVARCHAR(200),
				@FISOutputTableName NVARCHAR(200),
				@ProviderFieldCourseLocation CHAR(1),
				@ProviderFieldParentCourseLocation CHAR(1),
    			@OverrideEngFac NVARCHAR(50),
    			@OverrideMatFac NVARCHAR(50),
    			@OverrideEngTeam NVARCHAR(50),
    			@OverrideMatTeam NVARCHAR(50),
    			@OverrideEngCostCentre NVARCHAR(50),
    			@OverrideMatCostCentre NVARCHAR(50),
    			@OverridePartnerFac NVARCHAR(50),
    			@OverridePartnerTeam NVARCHAR(50),
    			@OverridePartnerCostCentre NVARCHAR(50)';
    
			--SELECT @SQLString AS [processing-instruction(x)] FOR XML PATH('')

			EXECUTE sp_executesql 
				@SQLString, 
				@SQLParams, 
				@FISDatabase = @FISDatabase,
				@AcademicYear = @AcademicYear,
    			@ILRReturn = @ILRReturn,
    			@IsFinalReturn = @IsFinalReturn,
    			@Split1619Funding = @Split1619Funding,
				@Reapportion1619FundingByAimWeighting = @Reapportion1619FundingByAimWeighting,
				@AppsMoveFundingToMainComponentAim = @AppsMoveFundingToMainComponentAim,
				@1619ALSFundingPercent = @1619ALSFundingPercent,
				@IncludeHEAdvLoanPossIncome = @IncludeHEAdvLoanPossIncome,
				@IncludeAdvLoanBursaryIncome = @IncludeAdvLoanBursaryIncome,
    			@FutureAchieveWeighting = @FutureAchieveWeighting,
				@FISOutputTableLocation = @FISOutputTableLocation,
				@FISOutputTableName = @FISOutputTableName,
				@ProviderFieldCourseLocation = @ProviderFieldCourseLocation,
				@ProviderFieldParentCourseLocation = @ProviderFieldParentCourseLocation,
    			@OverrideEngFac = @OverrideEngFac,
    			@OverrideMatFac = @OverrideMatFac,
    			@OverrideEngTeam = @OverrideEngTeam,
    			@OverrideMatTeam = @OverrideMatTeam,
    			@OverrideEngCostCentre = @OverrideEngCostCentre,
    			@OverrideMatCostCentre = @OverrideMatCostCentre,
    			@OverridePartnerFac = @OverridePartnerFac,
    			@OverridePartnerTeam = @OverridePartnerTeam,
    			@OverridePartnerCostCentre = @OverridePartnerCostCentre;

			SET @Message = @AcademicYear + N' ILR Imported'
			RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;

			--Anonymise the ILR data if required
			IF @AnonymiseData = 1
			BEGIN
				DECLARE @AnonName NVARCHAR(250) = N'Anonymous'
				DECLARE @AnonAddress NVARCHAR(250) = N'Anonymous'
				DECLARE @AnonPostCode NVARCHAR(250) = N'ZZ99 9ZZ'
				DECLARE @AnonTel NVARCHAR(250) = N'000000000000000'
				DECLARE @AnonEmail NVARCHAR(250) = N'anon@anon.com'

				SET @SQLString = 
				N'
					UPDATE FD
					SET
						Surname = CASE WHEN FD.Surname IS NOT NULL THEN @AnonName ELSE NULL END,
						Forename = CASE WHEN FD.Forename IS NOT NULL THEN @AnonName ELSE NULL END,
						Address1 = CASE WHEN FD.Address1 IS NOT NULL THEN @AnonAddress ELSE NULL END,
						Address2 = CASE WHEN FD.Address2 IS NOT NULL THEN @AnonAddress ELSE NULL END,
						Address3 = CASE WHEN FD.Address3 IS NOT NULL THEN @AnonAddress ELSE NULL END,
						Address4 = CASE WHEN FD.Address4 IS NOT NULL THEN @AnonAddress ELSE NULL END,
						PostCodeCurrent = CASE WHEN FD.PostCodeCurrent IS NOT NULL THEN @AnonPostCode ELSE NULL END,
						PostCodePriorToEnrol = CASE WHEN FD.PostCodePriorToEnrol IS NOT NULL THEN @AnonPostCode ELSE NULL END,
						PostCodeLearningStartDate = CASE WHEN FD.PostCodeLearningStartDate IS NOT NULL THEN @AnonPostCode ELSE NULL END,
						Tel = CASE WHEN FD.Tel IS NOT NULL THEN @AnonTel ELSE NULL END,
						Email = CASE WHEN FD.Email IS NOT NULL THEN @AnonEmail ELSE NULL END,
						PostCodeDelivery = CASE WHEN FD.PostCodeDelivery IS NOT NULL THEN @AnonPostCode ELSE NULL END
					FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
					WHERE
						FD.AcademicYear = @AcademicYear
						AND FD.ILRReturnDate = @FileDate';

				SET @SQLParams = 
					N'@AcademicYear NVARCHAR(5),
					@FileDate DATETIME,
					@AnonName VARCHAR(250),
					@AnonAddress VARCHAR(250),
					@AnonPostCode VARCHAR(250),
					@AnonTel VARCHAR(250),
					@AnonEmail VARCHAR(250)';

				EXECUTE sp_executesql 
					@SQLString, 
					@SQLParams,
					@AcademicYear = @AcademicYear,
					@FileDate = @FileDate,
					@AnonName = @AnonName,
					@AnonAddress = @AnonAddress,
					@AnonPostCode = @AnonPostCode,
					@AnonTel = @AnonTel,
					@AnonEmail = @AnonEmail;

				SET @Message = @AcademicYear + N' ILR Anonymised'
				RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;
			END
		END

	--Calculate which records should be included for each year for this provider
	--Latest record for each enrolment matching on provider, learner and learning aim (Art can have 2)
	IF @RunQARCalculation = 1
	BEGIN
		--Get Current Academic Year
		DECLARE @CurrentAcademicYear NVARCHAR(5)

		SET @SQLString = 
		N'
			SELECT
				@CurrentAcademicYear = 
					RIGHT (
						CAST (
							CASE
								WHEN MONTH ( CAST ( GETDATE() AS DATE ) ) <= 7 THEN 
									YEAR ( CAST ( GETDATE() AS DATE ) ) - 1
								ELSE 
									YEAR ( CAST ( GETDATE() AS DATE ) )
							END
							AS VARCHAR(4)
						),
						2
					)
					+ ''/''
					+ RIGHT (
						CAST (
							CASE
								WHEN MONTH ( CAST ( GETDATE() AS DATE ) ) <= 7 THEN 
									YEAR ( CAST ( GETDATE() AS DATE ) )
								ELSE 
									YEAR ( CAST ( GETDATE() AS DATE ) ) + 1
							END
							AS VARCHAR(4)
						),
						2
					)';

		SET @SQLParams = 
		N'
			@CurrentAcademicYear NVARCHAR(5) OUTPUT';



		EXECUTE sp_executesql 
			@SQLString, 
			@SQLParams,
			@CurrentAcademicYear = @CurrentAcademicYear OUTPUT;



		DECLARE @SixYearsAgo NVARCHAR(5) = CAST ( CAST ( LEFT( @CurrentAcademicYear, 2 ) AS INT ) - 6 AS NVARCHAR(2) ) + '/' + CAST ( CAST ( RIGHT( @CurrentAcademicYear, 2 ) AS INT ) - 6 AS NVARCHAR(2) )

		DECLARE @ProviderName NVARCHAR(200)
		DECLARE @LatestImportedFileAcademicYear NVARCHAR(5)
		DECLARE @LatestImportedFileILRReturnDate DATETIME
		DECLARE @LatestImportedFileILRReturn NVARCHAR(3)
		DECLARE @LatestImportedFileIsFinalReturn BIT
		
		SET @SQLString = 
		N'
			SELECT TOP 1
				@ProviderName = FD.ProviderName,
				@LatestImportedFileAcademicYear = FD.AcademicYear,
				@LatestImportedFileILRReturnDate = FD.ILRReturnDate,
				@LatestImportedFileILRReturn = FD.ILRReturn,
				@LatestImportedFileIsFinalReturn = FD.IsFinalReturn
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			WHERE
				FD.ProviderNumber = @ProviderNumber
			ORDER BY
				FD.AcademicYear DESC,
				FD.ILRReturn DESC,
				FD.IsFinalReturn';


		SET @SQLParams = 
		N'
			@AcademicYear NVARCHAR(5),
			@ProviderNumber INT,
			@ProviderName NVARCHAR(200) OUTPUT,
			@LatestImportedFileAcademicYear NVARCHAR(5) OUTPUT,
			@LatestImportedFileILRReturnDate DATETIME OUTPUT,
			@LatestImportedFileILRReturn NVARCHAR(3) OUTPUT,
			@LatestImportedFileIsFinalReturn BIT OUTPUT';

		EXECUTE sp_executesql 
			@SQLString, 
			@SQLParams,
			@AcademicYear = @AcademicYear,
			@ProviderNumber = @ProviderNumber,
			@ProviderName = @ProviderName OUTPUT,
			@LatestImportedFileAcademicYear = @LatestImportedFileAcademicYear OUTPUT,
			@LatestImportedFileILRReturnDate = @LatestImportedFileILRReturnDate OUTPUT,
			@LatestImportedFileILRReturn = @LatestImportedFileILRReturn OUTPUT,
			@LatestImportedFileIsFinalReturn = @LatestImportedFileIsFinalReturn OUTPUT;


		--Clear existing values
		SET @SQLString = 
		N'
			UPDATE FD
			SET
				FD.IncludeInQARMeasures = 0,
				FD.QARNumberOfMergedYearsOfData = NULL,
				FD.LatestImportedFileAcademicYear = NULL,
				FD.LatestImportedFileILRReturnDate = NULL,
				FD.LatestImportedFileILRReturn = NULL,
				FD.LatestImportedFileIsFinalReturn = NULL
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			WHERE
				FD.ProviderNumber = @ProviderNumber
				AND FD.ReportingYear >= @SixYearsAgo';

		SET @SQLParams = 
		N'
			@AcademicYear NVARCHAR(5),
			@ProviderNumber INT,
			@SixYearsAgo NVARCHAR(5)';

		EXECUTE sp_executesql 
			@SQLString, 
			@SQLParams,
			@AcademicYear = @AcademicYear,
			@ProviderNumber = @ProviderNumber,
			@SixYearsAgo = @SixYearsAgo;


		--Get learner mappings between years for QAR calculations - Using ULN
		SET @SQLString = 
		N'
			DROP TABLE IF EXISTS #LearnerMappingDataOnULN
			SELECT
				CurrentProviderNumber = COALESCE ( FDN5.ProviderNumber, FDN4.ProviderNumber, FDN3.ProviderNumber, FDN2.ProviderNumber, FDN1.ProviderNumber, FD.ProviderNumber ),
				CurrentLearnRefNumber = COALESCE ( FDN5.LearnRefNumber, FDN4.LearnRefNumber, FDN3.LearnRefNumber, FDN2.LearnRefNumber, FDN1.LearnRefNumber, FD.LearnRefNumber ),
				ULN = FD.ULN,

				OriginalAcademicYear = FD.AcademicYear,
				OriginalProviderNumber = FD.ProviderNumber,
				OriginalLearnRefNumber = FD.LearnRefNumber,

				NextAcademicYear1 = FDN1.AcademicYear,
				NextLearnRefNumber1 = FDN1.LearnRefNumber,
				NextUKPRN1 = FDN1.ProviderNumber,
	
				NextAcademicYear2 = FDN2.AcademicYear,
				NextLearnRefNumber2 = FDN2.LearnRefNumber,
				NextUKPRN2 = FDN2.ProviderNumber,
	
				NextAcademicYear3 = FDN3.AcademicYear,
				NextLearnRefNumber3 = FDN3.LearnRefNumber,
				NextUKPRN3 = FDN3.ProviderNumber,
	
				NextAcademicYear4 = FDN4.AcademicYear,
				NextLearnRefNumber4 = FDN4.LearnRefNumber,
				NextUKPRN4 = FDN4.ProviderNumber,
	
				NextAcademicYear5 = FDN5.AcademicYear,
				NextLearnRefNumber5 = FDN5.LearnRefNumber,
				NextUKPRN5 = FDN5.ProviderNumber
	
				INTO #LearnerMappingDataOnULN
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN1
				ON COALESCE ( FDN1.PrevUKPRN, FDN1.ProviderNumber ) = FD.ProviderNumber
				AND FDN1.AcademicYear = CAST ( CAST ( LEFT ( FD.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FD.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND FDN1.ULN = FD.ULN
				AND FDN1.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN2
				ON COALESCE ( FDN2.PrevUKPRN, FDN2.ProviderNumber ) = FDN1.ProviderNumber
				AND FDN2.AcademicYear = CAST ( CAST ( LEFT ( FDN1.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN1.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND FDN2.ULN = FDN1.ULN
				AND FDN2.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN3
				ON COALESCE ( FDN3.PrevUKPRN, FDN3.ProviderNumber ) = FDN2.ProviderNumber
				AND FDN3.AcademicYear = CAST ( CAST ( LEFT ( FDN2.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN2.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND FDN3.ULN = FDN2.ULN
				AND FDN3.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN4
				ON COALESCE ( FDN4.PrevUKPRN, FDN4.ProviderNumber ) = FDN3.ProviderNumber
				AND FDN4.AcademicYear = CAST ( CAST ( LEFT ( FDN3.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN3.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND FDN4.ULN = FDN3.ULN
				AND FDN4.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN5
				ON COALESCE ( FDN5.PrevUKPRN, FDN5.ProviderNumber ) = FDN4.ProviderNumber
				AND FDN5.AcademicYear = CAST ( CAST ( LEFT ( FDN4.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN4.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND FDN5.ULN = FDN4.ULN
				AND FDN5.IsMainAim = 1
			WHERE
				COALESCE ( FDN5.ProviderNumber, FDN4.ProviderNumber, FDN3.ProviderNumber, FDN2.ProviderNumber, FDN1.ProviderNumber, FD.ProviderNumber ) = 10004599
				AND FD.IsMainAim = 1
				AND FD.ULN <> ''9999999999''';


		--Get learner mappings between years for QAR calculations - Using LearnRefNumber
		SET @SQLString += 
		N'
			DROP TABLE IF EXISTS #LearnerMappingDataOnRef
			SELECT
				CurrentProviderNumber = COALESCE ( FDN5.ProviderNumber, FDN4.ProviderNumber, FDN3.ProviderNumber, FDN2.ProviderNumber, FDN1.ProviderNumber, FD.ProviderNumber ),
				CurrentLearnRefNumber = COALESCE ( FDN5.LearnRefNumber, FDN4.LearnRefNumber, FDN3.LearnRefNumber, FDN2.LearnRefNumber, FDN1.LearnRefNumber, FD.LearnRefNumber ),
				ULN = FD.ULN,

				OriginalAcademicYear = FD.AcademicYear,
				OriginalProviderNumber = FD.ProviderNumber,
				OriginalLearnRefNumber = FD.LearnRefNumber,

				NextAcademicYear1 = FDN1.AcademicYear,
				NextLearnRefNumber1 = FDN1.LearnRefNumber,
				NextUKPRN1 = FDN1.ProviderNumber,
	
				NextAcademicYear2 = FDN2.AcademicYear,
				NextLearnRefNumber2 = FDN2.LearnRefNumber,
				NextUKPRN2 = FDN2.ProviderNumber,
	
				NextAcademicYear3 = FDN3.AcademicYear,
				NextLearnRefNumber3 = FDN3.LearnRefNumber,
				NextUKPRN3 = FDN3.ProviderNumber,
	
				NextAcademicYear4 = FDN4.AcademicYear,
				NextLearnRefNumber4 = FDN4.LearnRefNumber,
				NextUKPRN4 = FDN4.ProviderNumber,
	
				NextAcademicYear5 = FDN5.AcademicYear,
				NextLearnRefNumber5 = FDN5.LearnRefNumber,
				NextUKPRN5 = FDN5.ProviderNumber
	
				INTO #LearnerMappingDataOnRef
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN1
				ON COALESCE ( FDN1.PrevUKPRN, FDN1.ProviderNumber ) = FD.ProviderNumber
				AND FDN1.AcademicYear = CAST ( CAST ( LEFT ( FD.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FD.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND COALESCE ( FDN1.PrevLearnRefNumber, FDN1.LearnRefNumber ) = FD.LearnRefNumber
				AND FDN1.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN2
				ON COALESCE ( FDN2.PrevUKPRN, FDN2.ProviderNumber ) = FDN1.ProviderNumber
				AND FDN2.AcademicYear = CAST ( CAST ( LEFT ( FDN1.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN1.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND COALESCE ( FDN2.PrevLearnRefNumber, FDN2.LearnRefNumber ) = FDN1.LearnRefNumber
				AND FDN2.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN3
				ON COALESCE ( FDN3.PrevUKPRN, FDN3.ProviderNumber ) = FDN2.ProviderNumber
				AND FDN3.AcademicYear = CAST ( CAST ( LEFT ( FDN2.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN2.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND COALESCE ( FDN3.PrevLearnRefNumber, FDN3.LearnRefNumber ) = FDN2.LearnRefNumber
				AND FDN3.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN4
				ON COALESCE ( FDN4.PrevUKPRN, FDN4.ProviderNumber ) = FDN3.ProviderNumber
				AND FDN4.AcademicYear = CAST ( CAST ( LEFT ( FDN3.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN3.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND COALESCE ( FDN4.PrevLearnRefNumber, FDN4.LearnRefNumber ) = FDN3.LearnRefNumber
				AND FDN4.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN5
				ON COALESCE ( FDN5.PrevUKPRN, FDN5.ProviderNumber ) = FDN4.ProviderNumber
				AND FDN5.AcademicYear = CAST ( CAST ( LEFT ( FDN4.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN4.AcademicYear, 2 ) AS INT ) + 1 AS NVARCHAR(2) )
				AND COALESCE ( FDN5.PrevLearnRefNumber, FDN5.LearnRefNumber ) = FDN4.LearnRefNumber
				AND FDN5.IsMainAim = 1
			WHERE
				COALESCE ( FDN5.ProviderNumber, FDN4.ProviderNumber, FDN3.ProviderNumber, FDN2.ProviderNumber, FDN1.ProviderNumber, FD.ProviderNumber ) = @ProviderNumber
				AND FD.IsMainAim = 1';


		--Take most recent values for learner ref and provider QKPRN and map to previous years where they differ 
		--Using UNION in case of multiple mappings to same values for different previous years
		--Mapping using ULN and prior or current UKPRN
		--Later match on previous learner ref but prioritise ULN matches first (descending order for rownum)
		SET @SQLString += 
		N'
			DROP TABLE IF EXISTS #YearlyLearnerMappings
			SELECT
				YLM.ProviderNumber,
				YLM.ULN,
				YLM.LearnRefNumber,
				YLM.PrevAcademicYear,
				YLM.PrevUKPRN,
				YLM.PrevLearnRefNumber,
				YLM.MatchMode,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							YLM.ProviderNumber,
							YLM.ULN,
							YLM.LearnRefNumber,
							YLM.PrevAcademicYear
						ORDER BY
							YLM.MatchMode DESC
					)
			INTO #YearlyLearnerMappings
			FROM (
				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.OriginalAcademicYear,
					PrevUKPRN = YLM.OriginalProviderNumber,
					PrevLearnRefNumber = YLM.OriginalLearnRefNumber,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.OriginalLearnRefNumber <> YLM.CurrentLearnRefNumber
					OR YLM.OriginalProviderNumber <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear1,
					PrevUKPRN = YLM.NextUKPRN1,
					PrevLearnRefNumber = YLM.NextLearnRefNumber1,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber1 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN1 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear2,
					PrevUKPRN = YLM.NextUKPRN2,
					PrevLearnRefNumber = YLM.NextLearnRefNumber2,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber2 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN2 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear3,
					PrevUKPRN = YLM.NextUKPRN3,
					PrevLearnRefNumber = YLM.NextLearnRefNumber3,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber3 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN3 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear4,
					PrevUKPRN = YLM.NextUKPRN4,
					PrevLearnRefNumber = YLM.NextLearnRefNumber4,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber4 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN4 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear5,
					PrevUKPRN = YLM.NextUKPRN5,
					PrevLearnRefNumber = YLM.NextLearnRefNumber5,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber5 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN5 <> YLM.CurrentProviderNumber
		';


		--Take most recent values for learner ref and provider UKPRN and map to previous years where they differ 
		--Using UNION in case of multiple mappings to same values for different previous years
		--Mapping using prior student ref and prior or current UKPRN
		SET @SQLString += 
			N'
				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.OriginalAcademicYear,
					PrevUKPRN = YLM.OriginalProviderNumber,
					PrevLearnRefNumber = YLM.OriginalLearnRefNumber,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.OriginalLearnRefNumber <> YLM.CurrentLearnRefNumber
					OR YLM.OriginalProviderNumber <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear1,
					PrevUKPRN = YLM.NextUKPRN1,
					PrevLearnRefNumber = YLM.NextLearnRefNumber1,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber1 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN1 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear2,
					PrevUKPRN = YLM.NextUKPRN2,
					PrevLearnRefNumber = YLM.NextLearnRefNumber2,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber2 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN2 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear3,
					PrevUKPRN = YLM.NextUKPRN3,
					PrevLearnRefNumber = YLM.NextLearnRefNumber3,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber3 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN3 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear4,
					PrevUKPRN = YLM.NextUKPRN4,
					PrevLearnRefNumber = YLM.NextLearnRefNumber4,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber4 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN4 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear5,
					PrevUKPRN = YLM.NextUKPRN5,
					PrevLearnRefNumber = YLM.NextLearnRefNumber5,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber5 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN5 <> YLM.CurrentProviderNumber
			) YLM';


		--Set records which should be includes in QAR measures
		--If rolled forward for achievement then last year will not be funded but prior year will
		SET @SQLString += 
		N'
			DROP TABLE IF EXISTS #MergedData
			SELECT
				ProviderNumber = COALESCE ( YLM.ProviderNumber, FD.ProviderNumber ),
				LearnRefNumber = COALESCE ( YLM.LearnRefNumber, FD.LearnRefNumber ),
				FD.LearningAimCode,
				FD.LearnerAndAimRowNum,
				FD.StandardCode,
				FD.FrameworkCode,
				FD.PathwayCode,
				IsFundedStart = MAX ( FD.IsFundedStart ),
				StartDate = COALESCE ( FD.OriginalStartDate, FD.StartDate ),
				CompletionStatusCode = 
					COALESCE (
						MAX ( CASE WHEN FD.CompletionStatusCode <> ''6'' THEN FD.CompletionStatusCode ELSE NULL END ),
						MAX ( FD.CompletionStatusCode )
					),
				FD.StartYear,
				PlannedEndYear = MAX ( FD.PlannedEndYear ),
				AchievementYear = MAX ( FD.AchievementYear ),
				HybridEndYear = MAX ( FD.HybridEndYear ),
				EarliestReportingYear = MIN ( FD.ReportingYear ),
				LatestReportingYear = MAX ( FD.ReportingYear),
				NumMergedRecords = COUNT ( FD.LearningAimCode ),
				IsOverallStart = MAX ( FD.IsOverallStart ),
				IsTimelyStart = MAX ( FD.IsTimelyStart ),
				IsOverallLeaver = MAX ( FD.IsOverallLeaver ),
				IsTimelyLeaver = MAX ( FD.IsTimelyLeaver ),
				IsOverallLeaverBestCase = MAX ( FD.IsOverallLeaverBestCase ),
				IsTimelyLeaverBestCase = MAX ( FD.IsTimelyLeaverBestCase ),
				IsOverallAchieverBestCase = MAX ( FD.IsOverallAchieverBestCase ),
				IsTimelyAchieverBestCase = MAX ( FD.IsTimelyAchieverBestCase ),
				IsOverallContinuer = MAX ( FD.IsOverallContinuer ),
				IsTimelyContinuer = MAX ( FD.IsTimelyContinuer ),
				IsOverallContinuerNotFunded = MIN ( FD.IsOverallContinuerNotFunded ),
				IsTimelyContinuerNotFunded = MIN ( FD.IsTimelyContinuerNotFunded ),
				IsOverallContinuerFunded = MAX ( FD.IsOverallContinuerFunded ),
				IsTimelyContinuerFunded = MAX ( FD.IsTimelyContinuerFunded ),
				IsOverallCompleted = MAX ( FD.IsOverallCompleted ),
				IsTimelyCompleted = MAX ( FD.IsTimelyCompleted ),
				IsOverallCompletedNotFunded = MIN ( FD.IsOverallCompletedNotFunded ),
				IsTimelyCompletedNotFunded = MIN ( FD.IsTimelyCompletedNotFunded ),
				IsOverallCompletedFunded = MAX ( FD.IsOverallCompletedFunded ),
				IsTimelyCompletedFunded = MAX ( FD.IsTimelyCompletedFunded ),
				IsOverallRetained = MAX ( FD.IsOverallRetained ),
				IsTimelyRetained = MAX ( FD.IsTimelyRetained ),
				IsOverallRetainedNotFunded = MIN ( FD.IsOverallRetainedNotFunded ),
				IsTimelyRetainedNotFunded = MIN ( FD.IsTimelyRetainedNotFunded ),
				IsOverallRetainedFunded = MAX ( FD.IsOverallRetainedFunded ),
				IsTimelyRetainedFunded = MAX ( FD.IsTimelyRetainedFunded ),
		'
    
		SET @SQLString += 
			N'
				IsOverallWithdrawn = MAX ( FD.IsOverallWithdrawn ),
				IsTimelyWithdrawn = MAX ( FD.IsTimelyWithdrawn ),
				IsOverallWithdrawnNotFunded = MIN ( FD.IsOverallWithdrawnNotFunded ),
				IsTimelyWithdrawnNotFunded = MIN ( FD.IsTimelyWithdrawnNotFunded ),
				IsOverallWithdrawnFunded = MAX ( FD.IsOverallWithdrawnFunded ),
				IsTimelyWithdrawnFunded = MAX ( FD.IsTimelyWithdrawnFunded ),
				IsOverallTransfer = MAX ( FD.IsOverallTransfer ),
				IsTimelyTransfer = MAX ( FD.IsTimelyTransfer ),
				IsOverallTransferNotFunded = MIN ( FD.IsOverallTransferNotFunded ),
				IsTimelyTransferNotFunded = MIN ( FD.IsTimelyTransferNotFunded ),
				IsOverallTransferFunded = MAX ( FD.IsOverallTransferFunded ),
				IsTimelyTransferFunded = MAX ( FD.IsTimelyTransferFunded ),
				IsTransferValid = MAX ( FD.IsTransferValid ),
				IsOverallBreakInLearning = MAX ( FD.IsOverallBreakInLearning ),
				IsTimelyBreakInLearning = MAX ( FD.IsTimelyBreakInLearning ),
				IsOverallBreakInLearningNotFunded = MIN ( FD.IsOverallBreakInLearningNotFunded ),
				IsTimelyBreakInLearningNotFunded = MIN ( FD.IsTimelyBreakInLearningNotFunded ),
				IsOverallBreakInLearningFunded = MAX ( FD.IsOverallBreakInLearningFunded ),
				IsTimelyBreakInLearningFunded = MAX ( FD.IsTimelyBreakInLearningFunded ),
				IsBreakInLearningValid = MAX ( FD.IsBreakInLearningValid ),
				IsOverallAchiever = MAX ( FD.IsOverallAchiever ),
				IsTimelyAchiever = MAX ( FD.IsTimelyAchiever ),
				IsOverallAchieverNotFunded = MIN ( FD.IsOverallAchieverNotFunded ),
				IsTimelyAchieverNotFunded = MIN ( FD.IsTimelyAchieverNotFunded ),
				IsOverallAchieverFunded = MAX ( FD.IsOverallAchieverFunded ),
				IsTimelyAchieverFunded = MAX ( FD.IsTimelyAchieverFunded ),
				IsOverallFailed = MAX ( FD.IsOverallFailed ),
				IsTimelyFailed = MAX ( FD.IsTimelyFailed ),
				IsOverallFailedNotFunded = MIN ( FD.IsOverallFailedNotFunded ),
				IsTimelyFailedNotFunded = MIN ( FD.IsTimelyFailedNotFunded ),
				IsOverallFailedFunded = MAX ( FD.IsOverallFailedFunded ),
				IsTimelyFailedFunded = MAX ( FD.IsTimelyFailedFunded ),
				IsOverallUnknownOutcome = MAX ( FD.IsOverallUnknownOutcome ),
				IsTimelyUnknownOutcome = MAX ( FD.IsTimelyUnknownOutcome ),
				IsOverallUnknownOutcomeNotFunded = MIN ( FD.IsOverallUnknownOutcomeNotFunded ),
				IsTimelyUnknownOutcomeNotFunded = MIN ( FD.IsTimelyUnknownOutcomeNotFunded ),
				IsOverallUnknownOutcomeFunded = MAX ( FD.IsOverallUnknownOutcomeFunded ),
				IsTimelyUnknownOutcomeFunded = MAX ( FD.IsTimelyUnknownOutcomeFunded ),
				IsUnknownOutcomeValid = MAX ( FD.IsUnknownOutcomeValid ),
				IsOverallHighGrade = MAX ( FD.IsOverallHighGrade ),
				IsTimelyHighGrade = MAX ( FD.IsTimelyHighGrade ),
				IsOutOfFunding30Days = MAX ( FD.IsOutOfFunding30Days ),
				IsOutOfFunding60Days = MAX ( FD.IsOutOfFunding60Days ),
				IsOutOfFunding90Days = MAX ( FD.IsOutOfFunding90Days )
				INTO #MergedData
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			LEFT JOIN #YearlyLearnerMappings YLM
				ON YLM.PrevAcademicYear = FD.AcademicYear
				AND YLM.PrevUKPRN = FD.ProviderNumber
				AND YLM.PrevLearnRefNumber = FD.LearnRefNumber
				AND YLM.RowNum = 1
	'
    
	SET @SQLString += 
		N'
			WHERE
				FD.ProviderNumber = @ProviderNumber
				--AND FD.HybridEndYear = @AcademicYear
				AND FD.ReportingYear >= @SixYearsAgo
				AND FD.ILRReturn = 
					CASE
						WHEN 
							FD.AcademicYear = @CurrentAcademicYear 
							AND @LatestImportedFileAcademicYear = @CurrentAcademicYear
								THEN @LatestImportedFileILRReturn
						ELSE ''R14''
					END
				AND FD.IsFinalReturn = 
					CASE
						WHEN 
							FD.AcademicYear = @CurrentAcademicYear 
							AND @LatestImportedFileAcademicYear = @CurrentAcademicYear
								THEN @LatestImportedFileIsFinalReturn
						ELSE 1
					END
				AND 
					CASE
						WHEN 
							FD.AcademicYear = @CurrentAcademicYear 
							AND @LatestImportedFileAcademicYear = @CurrentAcademicYear THEN
								CASE
									WHEN FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @LatestImportedFileILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) THEN 1
									ELSE 0
								END
						ELSE 1
					END = 1
				--AND FD.CompletionStatusCode <> ''6''
			GROUP BY
				COALESCE ( YLM.ProviderNumber, FD.ProviderNumber ),
				COALESCE ( YLM.LearnRefNumber, FD.LearnRefNumber ),
				FD.LearningAimCode,
				FD.LearnerAndAimRowNum,
				FD.StandardCode,
				FD.FrameworkCode,
				FD.PathwayCode,
				COALESCE ( FD.OriginalStartDate, FD.StartDate ),
				FD.StartYear
		'


		--Update records identified above so they are flagged as include in ILR
		--If merged record was a funded start in previous year then treat as such this year
		SET @SQLString += 
		N'
			UPDATE FD
			SET
				FD.IncludeInQARMeasures = 1,
				FD.QARNumberOfMergedYearsOfData = MD.NumMergedRecords,
				FD.LatestImportedFileAcademicYear = @LatestImportedFileAcademicYear,
				FD.LatestImportedFileILRReturnDate = @LatestImportedFileILRReturnDate,
				FD.LatestImportedFileILRReturn = @LatestImportedFileILRReturn,
				FD.LatestImportedFileIsFinalReturn = @LatestImportedFileIsFinalReturn,
				
				FD.IsOverallStart = MD.IsOverallStart,
				FD.IsTimelyStart = MD.IsTimelyStart,
				FD.IsOverallLeaver = MD.IsOverallLeaver,
				FD.IsTimelyLeaver = MD.IsTimelyLeaver,
				FD.IsOverallLeaverBestCase = MD.IsOverallLeaverBestCase,
				FD.IsTimelyLeaverBestCase = MD.IsTimelyLeaverBestCase,
				FD.IsOverallAchieverBestCase = MD.IsOverallAchieverBestCase,
				FD.IsTimelyAchieverBestCase = MD.IsTimelyAchieverBestCase,
				FD.IsOverallContinuer = MD.IsOverallContinuer,
				FD.IsTimelyContinuer = MD.IsTimelyContinuer,
				FD.IsOverallContinuerNotFunded = MD.IsOverallContinuerNotFunded,
				FD.IsTimelyContinuerNotFunded = MD.IsTimelyContinuerNotFunded,
				FD.IsOverallContinuerFunded = MD.IsOverallContinuerFunded,
				FD.IsTimelyContinuerFunded = MD.IsTimelyContinuerFunded,
				FD.IsOverallCompleted = MD.IsOverallCompleted,
				FD.IsTimelyCompleted = MD.IsTimelyCompleted,
				FD.IsOverallCompletedNotFunded = MD.IsOverallCompletedNotFunded,
				FD.IsTimelyCompletedNotFunded = MD.IsTimelyCompletedNotFunded,
				FD.IsOverallCompletedFunded = MD.IsOverallCompletedFunded,
				FD.IsTimelyCompletedFunded = MD.IsTimelyCompletedFunded,
				FD.IsOverallRetained = MD.IsOverallRetained,
				FD.IsTimelyRetained = MD.IsTimelyRetained,
				FD.IsOverallRetainedNotFunded = MD.IsOverallRetainedNotFunded,
				FD.IsTimelyRetainedNotFunded = MD.IsTimelyRetainedNotFunded,
				FD.IsOverallRetainedFunded = MD.IsOverallRetainedFunded,
				FD.IsTimelyRetainedFunded = MD.IsTimelyRetainedFunded,
		'
    
		SET @SQLString += 
			N'
				FD.IsOverallWithdrawn = MD.IsOverallWithdrawn,
				FD.IsTimelyWithdrawn = MD.IsTimelyWithdrawn,
				FD.IsOverallWithdrawnNotFunded = MD.IsOverallWithdrawnNotFunded,
				FD.IsTimelyWithdrawnNotFunded = MD.IsTimelyWithdrawnNotFunded,
				FD.IsOverallWithdrawnFunded = MD.IsOverallWithdrawnFunded,
				FD.IsTimelyWithdrawnFunded = MD.IsTimelyWithdrawnFunded,
				FD.IsOverallTransfer = MD.IsOverallTransfer,
				FD.IsTimelyTransfer = MD.IsTimelyTransfer,
				FD.IsOverallTransferNotFunded = MD.IsOverallTransferNotFunded,
				FD.IsTimelyTransferNotFunded = MD.IsTimelyTransferNotFunded,
				FD.IsOverallTransferFunded = MD.IsOverallTransferFunded,
				FD.IsTimelyTransferFunded = MD.IsTimelyTransferFunded,
				FD.IsTransferValid = MD.IsTransferValid,
				FD.IsOverallBreakInLearning = MD.IsOverallBreakInLearning,
				FD.IsTimelyBreakInLearning = MD.IsTimelyBreakInLearning,
				FD.IsOverallBreakInLearningNotFunded = MD.IsOverallBreakInLearningNotFunded,
				FD.IsTimelyBreakInLearningNotFunded = MD.IsTimelyBreakInLearningNotFunded,
				FD.IsOverallBreakInLearningFunded = MD.IsOverallBreakInLearningFunded,
				FD.IsTimelyBreakInLearningFunded = MD.IsTimelyBreakInLearningFunded,
				FD.IsBreakInLearningValid = MD.IsBreakInLearningValid,
				FD.IsOverallAchiever = MD.IsOverallAchiever,
				FD.IsTimelyAchiever = MD.IsTimelyAchiever,
				FD.IsOverallAchieverNotFunded = MD.IsOverallAchieverNotFunded,
				FD.IsTimelyAchieverNotFunded = MD.IsTimelyAchieverNotFunded,
				FD.IsOverallAchieverFunded = MD.IsOverallAchieverFunded,
				FD.IsTimelyAchieverFunded = MD.IsTimelyAchieverFunded,
				FD.IsOverallFailed = MD.IsOverallFailed,
				FD.IsTimelyFailed = MD.IsTimelyFailed,
				FD.IsOverallFailedNotFunded = MD.IsOverallFailedNotFunded,
				FD.IsTimelyFailedNotFunded = MD.IsTimelyFailedNotFunded,
				FD.IsOverallFailedFunded = MD.IsOverallFailedFunded,
				FD.IsTimelyFailedFunded = MD.IsTimelyFailedFunded,
				FD.IsOverallUnknownOutcome = MD.IsOverallUnknownOutcome,
				FD.IsTimelyUnknownOutcome = MD.IsTimelyUnknownOutcome,
				FD.IsOverallUnknownOutcomeNotFunded = MD.IsOverallUnknownOutcomeNotFunded,
				FD.IsTimelyUnknownOutcomeNotFunded = MD.IsTimelyUnknownOutcomeNotFunded,
				FD.IsOverallUnknownOutcomeFunded = MD.IsOverallUnknownOutcomeFunded,
				FD.IsTimelyUnknownOutcomeFunded = MD.IsTimelyUnknownOutcomeFunded,
				FD.IsUnknownOutcomeValid = MD.IsUnknownOutcomeValid,
				FD.IsOverallHighGrade = MD.IsOverallHighGrade,
				FD.IsTimelyHighGrade = MD.IsTimelyHighGrade,
				FD.IsOutOfFunding30Days = MD.IsOutOfFunding30Days,
				FD.IsOutOfFunding60Days = MD.IsOutOfFunding60Days,
				FD.IsOutOfFunding90Days = MD.IsOutOfFunding90Days
			FROM #MergedData MD
			INNER JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
				ON FD.ProviderNumber = MD.ProviderNumber
				AND FD.ReportingYear = MD.LatestReportingYear
				AND FD.LearnRefNumber = MD.LearnRefNumber
				AND FD.LearningAimCode = MD.LearningAimCode
				AND COALESCE ( FD.StandardCode, 0 ) = COALESCE ( MD.StandardCode, 0 )
				AND COALESCE ( FD.FrameworkCode, 0 ) = COALESCE ( MD.FrameworkCode, 0 )
				AND COALESCE ( FD.PathwayCode, 0 ) = COALESCE ( MD.PathwayCode, 0 )
				AND COALESCE ( FD.OriginalStartDate, FD.StartDate ) = MD.StartDate
				AND FD.LearnerAndAimRowNum = MD.LearnerAndAimRowNum
				AND FD.CompletionStatusCode <> ''6''';

		SET @SQLParams = 
			N'@AcademicYear NVARCHAR(5),
			@ProviderNumber INT,
			@CurrentAcademicYear NVARCHAR(5),
			@SixYearsAgo NVARCHAR(5),
			@LatestImportedFileAcademicYear NVARCHAR(5) OUTPUT,
			@LatestImportedFileILRReturnDate DATETIME OUTPUT,
			@LatestImportedFileILRReturn NVARCHAR(3) OUTPUT,
			@LatestImportedFileIsFinalReturn BIT OUTPUT';

		EXECUTE sp_executesql 
			@SQLString, 
			@SQLParams,
			@AcademicYear = @AcademicYear,
			@ProviderNumber = @ProviderNumber,
			@CurrentAcademicYear = @CurrentAcademicYear,
			@SixYearsAgo = @SixYearsAgo,
			@LatestImportedFileAcademicYear = @LatestImportedFileAcademicYear,
			@LatestImportedFileILRReturnDate = @LatestImportedFileILRReturnDate,
			@LatestImportedFileILRReturn = @LatestImportedFileILRReturn,
			@LatestImportedFileIsFinalReturn = @LatestImportedFileIsFinalReturn;

		SET @Message = N'Number Of Records Included In QAR Measures Across All Years for ' + @ProviderName + ': ' + CAST ( @@ROWCOUNT AS VARCHAR(50) );
		RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;
	END

	SET @Message = N'Finishing Operation at ' + FORMAT ( SYSDATETIME(), 'dd/MM/yyyy HH:mm:ss' );
	RAISERROR ( @Message, 0, 1 ) WITH NOWAIT;
END