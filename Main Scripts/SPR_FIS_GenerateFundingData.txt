CREATE OR ALTER PROCEDURE dbo.SPR_FIS_GenerateFundingData
	@FISDatabase VARCHAR(50),
	@AcademicYear NVARCHAR(5),
	@ILRReturn NVARCHAR(3),
	@IsFinalReturn BIT,
	@Split1619Funding BIT,
	@Reapportion1619FundingByAimWeighting BIT,
	@AppsMoveFundingToMainComponentAim BIT,
	@1619ALSFundingPercent DECIMAL(5,2),
	@IncludeHEAdvLoanPossibleIncome BIT,
	@IncludeAdvLoanBursaryIncome BIT,
	@FutureAchievementWeighting DECIMAL(3,2),
	@EnglishMathsFundingHigherRate INT,
	@EnglishMathsFundingLowerRate INT,
	@AdvancedMathsPremiumFundingRate INT,
	@CoreMathsPremiumFundingRate INT,
	@Block2DisadvFundingTLevelRate INT,
	@Block2DisadvFundingHigherRate INT,
	@Block2DisadvFundingLowerRate INT,
	@HighValueCoursesPremiumFundingRate INT,
	@ConditionOfFundingAdjustment INT,
	@IndustryPlacementFullFundingRate INT,
	@LargeProgramme10PercentUpliftNumLearners INT,
	@LargeProgramme10PercentUpliftAmount INT,
	@LargeProgramme20PercentUpliftNumLearners INT,
	@LargeProgramme20PercentUpliftAmount INT,
	@Mode NCHAR(1),
	@FISOutputTableLocation NVARCHAR(200),
	@FISOutputTableName NVARCHAR(200),
	@ProvSpecDelMonCourseLocation1 NCHAR(1),
	@ProvSpecDelMonCourseLocation2 NCHAR(1),
	@ProvSpecDelMonCourseSeperator NVARCHAR(50),
	@ProvSpecDelMonParentCourseLocation1 NCHAR(1),
	@ProvSpecDelMonParentCourseLocation2 NCHAR(1),
	@ProvSpecDelMonParentCourseSeperator NVARCHAR(50),
	@EnglishCollegeLevel1Code NVARCHAR(50),
	@EnglishCollegeLevel2Code NVARCHAR(50),
	@EnglishCollegeLevel3Code NVARCHAR(50),
	@EnglishCollegeLevel4Code NVARCHAR(50),
	@MathsCollegeLevel1Code NVARCHAR(50),
	@MathsCollegeLevel2Code NVARCHAR(50),
	@MathsCollegeLevel3Code NVARCHAR(50),
	@MathsCollegeLevel4Code NVARCHAR(50),
	@PartnerCollegeLevel1Code NVARCHAR(50),
	@PartnerCollegeLevel2Code NVARCHAR(50),
	@PartnerCollegeLevel3Code NVARCHAR(50),
	@PartnerCollegeLevel4Code NVARCHAR(50),
	@RunQARCalculation BIT,
	@AnonymiseData BIT
AS
BEGIN
	SET XACT_ABORT, NOCOUNT ON;
	
	/*
	/**************************************************
	 * Change/check values each time an import is run *
	 **************************************************/

	-- CHANGE THIS TO CORRECT RETURN
	DECLARE @ILRReturn NVARCHAR(3) = 'R03' 

	-- IF FINAL RETURN SET THIS TO 1 - ensure only 1 return for each month is set to 1 for accurate year on year reporting
	DECLARE @IsFinalReturn BIT = 1



	/***********************************************************************************
	 * Change values each year/month such as if ILR database is created as ILR2526_RXX *
	 ***********************************************************************************/

	--Name of the database created by the FIS software (default is ILRXXYY where XXYY is the return year)
	DECLARE @FISDatabase NVARCHAR(100) = 'ILR2526' 

	--Academic year used for reporting outputs (e.g. XX/YY)
	DECLARE @AcademicYear NVARCHAR(5) = '25/26' 



	/************************************************************
	 * Once set up values below should generally not be changed *
	 ************************************************************/

	--Split the funding into the 12 periods (default is 0 - 1 or 0)
	DECLARE @Split1619Funding BIT = 0 

	--Reapportion the 16-19 funding by the aim prog weighting factor (default is 0 - 1 or 0)
	DECLARE @Reapportion1619FundingByAimWeighting BIT = 0 

	--Move Apps Funding from Main ZProg to Main Component Aim so aim level fields can be used such as SSA (default is 1 - 1 or 0)
	DECLARE @AppsMoveFundingToMainComponentAim BIT = 1 

	--Deduct this percent from Total Cash Earned for FM25 and assign to ALS column (default is 0 - 1 or 0)
	DECLARE @1619ALSFundingPercent DECIMAL(5,2) = 0 

	--HE Gross Fee is only achieved if at all 3 SLC census points learners remain current (default is 0 - 1 or 0)
	DECLARE @IncludeHEAdvLoanPossibleIncome BIT = 0 

	--Adv Loan bursary income is not income as goes to learners so may want to exclude (default is 0 - 1 or 0)
	DECLARE @IncludeAdvLoanBursaryIncome BIT = 0 

	--Future achievement weighting factor. If 1 then is 100% of all remaining ach monies (default is 0 - decimal value)
	DECLARE @FutureAchievementWeighting DECIMAL(5,2) = 1

	--English and Maths Funding Rates from Allocation Statement
	DECLARE @EnglishMathsFundingHigherRate INT = 418
	DECLARE @EnglishMathsFundingLowerRate INT = 255

	--Core Maths Funding Rate from Allocation Statement
	DECLARE @CoreMathsPremiumFundingRate INT = 900

	--Block 2 Disadvantage Funding Rates for GCSE Maths and English Delivery Costs for Low Attainment Learners from Allocation Statement (Block 1 is Disad Post Codes)
	DECLARE @Block2DisadvFundingTLevelRate INT = 825
	DECLARE @Block2DisadvFundingHigherRate INT = 609
	DECLARE @Block2DisadvFundingLowerRate INT = 371

	--Advanced Maths Premium Funding Rate:
	--List of Quals at: 
	--https://www.gov.uk/guidance/16-to-19-funding-advanced-maths-premium#check-who-is-eligible-for-the-premium
	DECLARE @AdvancedMathsPremiumFundingRate INT = 900

	--Higher Value Course Premium Funding Rate from Allocation Statement
	--List of Quals at: 
	--https://www.gov.uk/government/publications/qualifications-attracting-high-value-courses-premium
	DECLARE @HighValueCoursesPremiumFundingRate INT = 600

	--Conditition of Funding Adjustments Based on Last Year's English and Maths Tolerances Being Hit
	DECLARE @ConditionOfFundingAdjustment INT = 0

	--Industry Placement Full Funding Rate (year 1 and 2)
	DECLARE @IndustryPlacementFullFundingRate INT = 550

	--Large Programme Uplift from Allocation Statement
	DECLARE @LargeProgramme10PercentUpliftNumLearners INT = 0
	DECLARE @LargeProgramme10PercentUpliftAmount INT = 510
	DECLARE @LargeProgramme20PercentUpliftNumLearners INT = 0
	DECLARE @LargeProgramme20PercentUpliftAmount INT = 1021

	--Insert new ILR return data leaving existing data from other imported returns or clear out table and replace (default is I for Insert, R = Replace)
	DECLARE @Mode NCHAR(1) = 'I' 

	--Database to store the summarised table generated by this script (for a linked server use SERVER.DATABASE.SCHEMA (e.g. missrv.misdb.dbo.)
	DECLARE @FISOutputTableLocation NVARCHAR(200) = 'FISFundingSummariser.dbo.' 

	--Table to create/insert data into
	DECLARE @FISOutputTableName NVARCHAR(200) = 'FIS_FundingData'

	--Provider field/s where the course code is stored in your ILR data (if spread across 2 fields enter values for first and second, if stored in 1 leave second NULL)
	DECLARE @ProvSpecDelMonCourseLocation1 NCHAR(1) = 'A'
	DECLARE @ProvSpecDelMonCourseLocation2 NCHAR(1) = 'B'

	--Seperator used between two fields listed above to form the full unique course code (default is blank, only relevant if 2 locations specified for course code)
	DECLARE @ProvSpecDelMonCourseSeperator NVARCHAR(50) = '-'

	--Provider field/s where the parent/programme course is stored to facilitate grouping aims by the programme
	DECLARE @ProvSpecDelMonParentCourseLocation1 NCHAR(1) = NULL
	DECLARE @ProvSpecDelMonParentCourseLocation2 NCHAR(1) = NULL

	--Seperator used between two fields listed above to form the full unique parent/programme course code (default is blank, only relevant if 2 locations specified for parent/programme course code)
	DECLARE @ProvSpecDelMonParentCourseSeperator NVARCHAR(50) = NULL

	--Custom codes for overriding the different levels of structure to move English under that area and out of other curriculum areas
	DECLARE @EnglishCollegeLevel1Code NVARCHAR(50) = NULL
	DECLARE @EnglishCollegeLevel2Code NVARCHAR(50) = NULL
	DECLARE @EnglishCollegeLevel3Code NVARCHAR(50) = NULL
	DECLARE @EnglishCollegeLevel4Code NVARCHAR(50) = NULL

	--Custom codes for overriding the different levels of structure to move Maths under that area and out of other curriculum areas
	DECLARE @MathsCollegeLevel1Code NVARCHAR(50) = NULL
	DECLARE @MathsCollegeLevel2Code NVARCHAR(50) = NULL
	DECLARE @MathsCollegeLevel3Code NVARCHAR(50) = NULL
	DECLARE @MathsCollegeLevel4Code NVARCHAR(50) = NULL

	--Custom codes for overriding the different levels of structure to move franchised out delivery under that area and out of other curriculum areas
	DECLARE @PartnerCollegeLevel1Code NVARCHAR(50) = NULL
	DECLARE @PartnerCollegeLevel2Code NVARCHAR(50) = NULL
	DECLARE @PartnerCollegeLevel3Code NVARCHAR(50) = NULL
	DECLARE @PartnerCollegeLevel4Code NVARCHAR(50) = NULL

	--Calculate which records should be included in QAR measures for each year (replicates what Strata or ProAchieve would do)
	DECLARE @RunQARCalculation BIT = 1 

	--Anonymise ILR data
	DECLARE @AnonymiseData BIT = 0 
	*/


	DECLARE @TableExists BIT = 1;
	DECLARE @TableExtraExists BIT = 1;
	DECLARE @ProviderNumber INT;
	DECLARE @FileDate DATETIME;
	DECLARE @NumExistingRecords INT = 0;
	
	DECLARE @SQLString NVARCHAR(MAX);
	DECLARE @SQLParams NVARCHAR(MAX);

	DECLARE @Message VARCHAR(MAX);

	DECLARE @ILRReturnSummary VARCHAR(200) = NULL;

	SET @Message = N'Starting Operation at ' + FORMAT ( SYSDATETIME(), 'dd/MM/yyyy HH:mm:ss' );
	RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;

	SET @ILRReturnSummary = 
		N'Importing ' + @AcademicYear + ' ' + @ILRReturn
		+ CASE
			WHEN @IsFinalReturn = 1 THEN N' Final'
			ELSE N' Non-Final'
		END
		+ N' ILR Return';

	SET @Message = @ILRReturnSummary;
	RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;

	SET @Message = N'Using FIS Database ' + @FISDatabase;
	RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;

	SET @Message = N'Importing into ' + @FISOutputTableLocation + @FISOutputTableName;
	RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;

	--Get Provider ID and date of new ILR Return to be imported
	IF @AcademicYear >= '19/20'
	BEGIN
		SET @SQLString = 
		N'
			SELECT
				@ProviderNumber = SRC.UKPRN,
				@FileDate = SRC.DateTime
			FROM ' + @FISDatabase + '.Valid.Source SRC';
	END
	ELSE
	BEGIN
		SET @SQLString = 
		N'
			SELECT
				@ProviderNumber = SRC.UKPRN,
				@FileDate = SRC.DateTime
			FROM ' + @FISDatabase + '.dbo.Valid_Source SRC';
	END

    SET @SQLParams = 
	N'
		@ProviderNumber INT OUTPUT,
		@FileDate DATETIME OUTPUT';

    EXECUTE sp_executesql 
        @SQLString, 
        @SQLParams, 
		@ProviderNumber = @ProviderNumber OUTPUT,
        @FileDate = @FileDate OUTPUT;


	IF @Mode = 'D'
		BEGIN
			SET @SQLString = 
			N'
				DELETE FROM FD
				FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
				WHERE
					FD.ProviderNumber = @ProviderNumber
					AND FD.AcademicYear = @AcademicYear
					AND FD.ILRReturn = @ILRReturn
					AND FD.IsFinalReturn = @IsFinalReturn
					AND FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @FileDate, ''yyyy-MM-dd HH:mm:ss'' )';

			SET @SQLParams = 
			N'
				@ProviderNumber INT,
				@AcademicYear VARCHAR(5),
				@ILRReturn VARCHAR(3),
				@IsFinalReturn BIT,
				@FileDate DATETIME';

			EXECUTE sp_executesql 
				@SQLString, 
				@SQLParams, 
				@ProviderNumber = @ProviderNumber,
				@AcademicYear = @AcademicYear,
				@ILRReturn = @ILRReturn,
				@IsFinalReturn = @IsFinalReturn,
				@FileDate = @FileDate;

			SET @Message = N'Number Of Records Removed for Provider ' + CAST ( @ProviderNumber AS VARCHAR(50) ) + ': ' + CAST ( @@ROWCOUNT AS VARCHAR(50) );
			RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;

			SET @SQLString = 
			N'
				DELETE FROM FD
				FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + 'Extra] FD
				WHERE
					FD.ProviderNumber = @ProviderNumber
					AND FD.AcademicYear = @AcademicYear
					AND FD.ILRReturn = @ILRReturn
					AND FD.IsFinalReturn = @IsFinalReturn
					AND FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @FileDate, ''yyyy-MM-dd HH:mm:ss'' )';

			SET @SQLParams = 
			N'
				@ProviderNumber INT,
				@AcademicYear VARCHAR(5),
				@ILRReturn VARCHAR(3),
				@IsFinalReturn BIT,
				@FileDate DATETIME';

			EXECUTE sp_executesql 
				@SQLString, 
				@SQLParams, 
				@ProviderNumber = @ProviderNumber,
				@AcademicYear = @AcademicYear,
				@ILRReturn = @ILRReturn,
				@IsFinalReturn = @IsFinalReturn,
				@FileDate = @FileDate;
		END
	ELSE
		BEGIN
			SET @Message = N'Date of ILR Return to be Imported for Provider ' + CAST ( @ProviderNumber AS VARCHAR(50) ) + ': ' + FORMAT ( @FileDate, 'dd/MM/yyyy' );
			RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;

			IF @Mode = N'R'
				--If mode is to replace then drop the table
				BEGIN
					SET @Message = N'Droping existing ' + @FISOutputTableName + N' table';
					RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;
					
					SET @SQLString = 
					N'
						DROP TABLE IF EXISTS dbo.[' + @FISOutputTableName + N']';

					SET @SQLParams = 
					N'';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams;

					SET @Message = N'Droping existing ' + @FISOutputTableName + N'Extra table';
					RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;
					
					SET @SQLString = 
					N'
						DROP TABLE IF EXISTS dbo.[' + @FISOutputTableName + N'Extra]';

					SET @SQLParams = 
					N'';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams;
				END
			ELSE
				--Confirm table exists already
				IF OBJECT_ID(@FISOutputTableLocation + '[' + @FISOutputTableName + ']', 'U') IS NULL 
					SET @TableExists = 0;

				--Confirm table extra exists already
				IF OBJECT_ID(@FISOutputTableLocation + '[' + @FISOutputTableName + 'Extra]', 'U') IS NULL 
					SET @TableExtraExists = 0;

			IF @Mode = 'R' OR @TableExists = 0
				--If mode is to replace or table does not exist then create it
				BEGIN
					--Create main table
					SET @SQLString = 
					N'
						CREATE TABLE ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] (
							AcademicYear VARCHAR(5) NULL,
							ProviderNumber INT NULL,
							ProviderName VARCHAR(200) NULL,
							ILRReturn VARCHAR(3) NULL,
							IsFinalReturn BIT NULL,
							ILRReturnDate DATETIME NULL,
							SQLDatabase VARCHAR(50) NULL,
							ImportDate DATETIME NULL,
							Is1619FundingSplit BIT NULL,
							ALS1619FundingPercent DECIMAL(5, 2) NULL,
							Is1619FundingReapportionedByAim BIT NULL,
							AppsMoveFundingToMainComponentAim BIT NULL,
							InvalidLearners INT NULL,

							LearnRefNumber VARCHAR(12) NULL,
							PrevLearnRefNumber VARCHAR(50) NULL,
							PrevUKPRN INT NULL,
							Surname VARCHAR(100) NULL,
							Forename VARCHAR(100) NULL,
							Sex VARCHAR(1) NULL,
							DOB DATETIME NULL,
							Age31AugCurrentYear INT NULL,
							Age31AugEarliestStartYear INT NULL,
							AgeGroupCurrentYear VARCHAR(5) NULL,
							AgeGroupEarliestStartYear VARCHAR(5) NULL,
							EarliestStartDate DATETIME NULL,
							LatestEndDate DATETIME NULL,
							ULN BIGINT NULL,
							NINumber VARCHAR(9) NULL,
							Address1 VARCHAR(50) NULL,
							Address2 VARCHAR(50) NULL,
							Address3 VARCHAR(50) NULL,
							Address4 VARCHAR(50) NULL,
							PostCodeCurrent VARCHAR(10) NULL,
							PostCodePriorToEnrol VARCHAR(8) NULL,
							PostCodeLearningStartDate VARCHAR(8) NULL,
							Tel VARCHAR(18) NULL,
							Email VARCHAR(100) NULL,
							PostCodeWardCode VARCHAR(10) NULL,
							PostCodeWardName VARCHAR(100) NULL,
							PostCodeDistrictCode VARCHAR(10) NULL,
							PostCodeDistrictName VARCHAR(50) NULL,
							PostCodeLEACode VARCHAR(10) NULL,
							PostCodeLEAName VARCHAR(50) NULL,
							PostCodeSourceOfFundingCode VARCHAR(50) NULL,
							PostCodeDisadvUplift DECIMAL(6, 5) NULL,
							EmpStatusCode INT NULL,
							EmpStatusName VARCHAR(20) NULL,
							EmpStatusAppliesDate DATETIME NULL,
							EmpStatusEmployerID INT NULL,
							LengthOfEmploy INT NULL,
							LengthOfUnemploy INT NULL,
							BenefitStatusInd INT NULL,
							SmallEmployer INT NULL,
							SelfEmployInd INT NULL,
							EmployIntensityInd INT NULL,
							IsFirstFullLevel2 INT NULL,
							IsFirstFullLevel3 INT NULL,
							PriorLevelCode INT NULL,
							PriorLevelName VARCHAR(80) NULL,
							PriorLevelDate DATE NULL,
							EthnicityCode INT NULL,
							EthnicityName VARCHAR(62) NULL,
							LLDDHealthProb INT NULL,
							PrimaryLLDDHealthProblemCode INT NULL,
							PrimaryLLDDHealthProblemName VARCHAR(100) NULL,
							FAMLearnerHNS INT NULL,
							FAMLearnerEHC INT NULL,
							FAMLearnerDLA INT NULL,
							FAMLearnerLSR INT NULL,
							FAMLearnerSEN INT NULL,
							FAMLearnerNLM INT NULL,
							FAMLearnerEDF INT NULL,
							FAMLearnerMCF INT NULL,
							FAMLearnerECF INT NULL,
							FAMLearnerFME INT NULL,
							DestinationProgressionType VARCHAR(3) NULL,
							DestinationProgressionNumber INT NULL,
							DestinationProgressionCode VARCHAR(10) NULL,
							DestinationProgressionName VARCHAR(255) NULL,
							DestinationProgressionStartDate DATETIME NULL,
							DestinationProgressionEndDate DATETIME NULL,
							DestinationProgressionCollectionDate DATETIME NULL,
					'
    
					SET @SQLString += 
						N'
							SoftwareSupplierAimID VARCHAR(36) NULL,
							FundLineCategory VARCHAR(100) NULL,
							FundLineCategoryOrder INT NULL,
							FundLineSubCategory VARCHAR(100) NULL,
							FundLineSubCategoryOrder INT NULL,
							FundLine VARCHAR(100) NULL,
							FundModel INT NULL,
							LearnDelFundOrgCode VARCHAR(50) NULL,
							HEFullPartTime VARCHAR(50) NULL,

							IsMainAim INT NULL,
							IsMainAimInFundModel INT NULL,
							IsAdvLearnLoan INT NULL,
							IsAdvLearnLoanBursary INT NULL,
							RateBand VARCHAR(50) NULL,
							RateBandOrder INT NULL,
							GCSEMathsGrade VARCHAR(4) NULL,
							GCSEEnglishGrade VARCHAR(4) NULL,
							CofMaths VARCHAR(100) NULL,
							CofEnglish VARCHAR(100) NULL,
							CofMathsMet INT NULL,
							CofEnglishMet INT NULL,
							CofMet INT NULL,
							ThresholdDays INT NULL,
							FAMLearningDeliverySOF VARCHAR(5) NULL,
							FAMLearningDeliveryFFI VARCHAR(5) NULL,
							FAMLearningDeliveryEEF VARCHAR(5) NULL,
							FAMLearningDeliveryRES VARCHAR(5) NULL,
							FAMLearningDeliveryLSF VARCHAR(5) NULL,
							FAMLearningDeliveryADL VARCHAR(5) NULL,
							FAMLearningDeliveryALB VARCHAR(5) NULL,
							FAMLearningDeliveryASL VARCHAR(5) NULL,
							FAMLearningDeliveryFLN VARCHAR(5) NULL,
							FAMLearningDeliveryLDM VARCHAR(5) NULL,
							FAMLearningDeliveryDAM VARCHAR(5) NULL,
							FAMLearningDeliveryACT VARCHAR(5) NULL,
							FAMLearningDeliveryACL VARCHAR(5) NULL,
							FAMLearningDeliveryAFL VARCHAR(5) NULL,
					'
    
					SET @SQLString += 
						N'
							PostCodeDelivery VARCHAR(10) NULL,
							CampusID VARCHAR(20) NULL,

							ParentCollegeLevel1Code VARCHAR(20) NULL,
							ParentCollegeLevel1Name VARCHAR(150) NULL,
							ParentCollegeLevel2Code VARCHAR(20) NULL,
							ParentCollegeLevel2Name VARCHAR(150) NULL,
							ParentCollegeLevel3Code VARCHAR(20) NULL,
							ParentCollegeLevel3Name VARCHAR(150) NULL,
							ParentCollegeLevel4Code VARCHAR(20) NULL,
							ParentCollegeLevel4Name VARCHAR(150) NULL,

							CollegeLevel1Code VARCHAR(20) NULL,
							CollegeLevel1Name VARCHAR(150) NULL,
							CollegeLevel2Code VARCHAR(20) NULL,
							CollegeLevel2Name VARCHAR(150) NULL,
							CollegeLevel3Code VARCHAR(20) NULL,
							CollegeLevel3Name VARCHAR(150) NULL,
							CollegeLevel4Code VARCHAR(20) NULL,
							CollegeLevel4Name VARCHAR(150) NULL,

							OriginalCollegeLevel1Code VARCHAR(20) NULL,
							OriginalCollegeLevel1Name VARCHAR(150) NULL,
							OriginalCollegeLevel2Code VARCHAR(20) NULL,
							OriginalCollegeLevel2Name VARCHAR(150) NULL,
							OriginalCollegeLevel3Code VARCHAR(20) NULL,
							OriginalCollegeLevel3Name VARCHAR(150) NULL,
							OriginalCollegeLevel4Code VARCHAR(20) NULL,
							OriginalCollegeLevel4Name VARCHAR(150) NULL,
					
							MainAimCollegeLevel1Code VARCHAR(20) NULL,
							MainAimCollegeLevel1Name VARCHAR(150) NULL,
							MainAimCollegeLevel2Code VARCHAR(20) NULL,
							MainAimCollegeLevel2Name VARCHAR(150) NULL,
							MainAimCollegeLevel3Code VARCHAR(20) NULL,
							MainAimCollegeLevel3Name VARCHAR(150) NULL,
							MainAimCollegeLevel4Code VARCHAR(20) NULL,
							MainAimCollegeLevel4Name VARCHAR(150) NULL,

							SSA1Code VARCHAR(5) NULL,
							SSA1Title VARCHAR(255) NULL,
							SSA2Code VARCHAR(5) NULL,
							SSA2Title VARCHAR(255) NULL,
							CourseCode VARCHAR(50) NULL,
							CourseInstance VARCHAR(50) NULL,
							CourseTitle VARCHAR(255) NULL,

							AimSeqNumber INT NULL,
							LearnerAndAimRowNum INT NULL,
							AimType INT NULL,

							LearningAimCode VARCHAR(8) NULL,
							LearningAimTitle VARCHAR(254) NULL,
							LearningAimTypeCode VARCHAR(4) NULL,
							LearningAimTypeName VARCHAR(150) NULL,

							NVQLevelCode NCHAR(1) NULL,
							NVQLevelName VARCHAR(50) NULL,
							NVQLevelOrder DECIMAL(10, 5) NULL,
							IsMathsAndEnglish NCHAR(1) NULL,
							MainAimNVQLevelCode NCHAR(1) NULL,
							MainAimNVQLevelName VARCHAR(50) NULL,
							MainAimNVQLevelOrder DECIMAL(10, 5) NULL,
							MainAimIsMathsAndEnglish NCHAR(1) NULL,

							CompletionStatusCode INT NULL,
							CompletionStatusName VARCHAR(20) NULL,
							OutcomeCode INT NULL,
							OutcomeName VARCHAR(20) NULL,
							StartDate DATETIME NULL,
							OriginalStartDate DATETIME NULL,
							PlannedEndDate DATETIME NULL,
							ActualEndDate DATETIME NULL,
							AchievementDate DATETIME NULL,
							RestartIndicator BIT NULL,
							Duration VARCHAR(10) NULL,
							WithdrawReason VARCHAR(2) NULL,
							Grade VARCHAR(6) NULL,
							AwardBody VARCHAR(20) NULL,
							StartYear VARCHAR(5) NULL,
							AchievementYear VARCHAR(5) NULL,
							PlannedEndYear VARCHAR(5) NULL,
							ActualEndYear VARCHAR(5) NULL,
							ReportingYear VARCHAR(5) NULL,
							HybridEndYear VARCHAR(5) NULL,
							LatestImportedFileAcademicYear VARCHAR(5) NULL,
							LatestImportedFileILRReturnDate DATETIME  NULL,
							LatestImportedFileILRReturn VARCHAR(3)  NULL,
							LatestImportedFileIsFinalReturn BIT NULL,

							IncludeInQARMeasures INT NULL,
							QARNumberOfMergedYearsOfData INT NULL,
							IsFundedStart INT NULL,

							IsPastPlannedEndDate INT NULL,
							IsOverallStart INT NULL,
							IsTimelyStart INT NULL,
							IsOverallLeaver INT NULL,
							IsTimelyLeaver INT NULL,
							IsOverallLeaverBestCase INT NULL,
							IsTimelyLeaverBestCase INT NULL,
							IsOverallCompletedBestCase INT NULL,
							IsTimelyCompletedBestCase INT NULL,
							IsOverallAchieverBestCase INT NULL,
							IsTimelyAchieverBestCase INT NULL,
							IsOverallContinuer INT NULL,
							IsTimelyContinuer INT NULL,
							IsOverallContinuerNotFunded INT NULL,
							IsTimelyContinuerNotFunded INT NULL,
							IsOverallContinuerFunded INT NULL,
							IsTimelyContinuerFunded INT NULL,
							IsOverallCompleted INT NULL,
							IsTimelyCompleted INT NULL,
							IsOverallCompletedNotFunded INT NULL,
							IsTimelyCompletedNotFunded INT NULL,
							IsOverallCompletedFunded INT NULL,
							IsTimelyCompletedFunded INT NULL,
							IsOverallRetained INT NULL,
							IsTimelyRetained INT NULL,
							IsOverallRetainedNotFunded INT NULL,
							IsTimelyRetainedNotFunded INT NULL,
							IsOverallRetainedFunded INT NULL,
							IsTimelyRetainedFunded INT NULL,
							IsOverallWithdrawn INT NULL,
							IsTimelyWithdrawn INT NULL,
							IsOverallWithdrawnNotFunded INT NULL,
							IsTimelyWithdrawnNotFunded INT NULL,
							IsOverallWithdrawnFunded INT NULL,
							IsTimelyWithdrawnFunded INT NULL,
							IsOverallWithdrawnPreEligibility INT NULL,
							IsTimelyWithdrawnPreEligibility INT NULL,
							IsOverallWithdrawnPreEligibilityNotFunded INT NULL,
							IsTimelyWithdrawnPreEligibilityNotFunded INT NULL,
							IsOverallWithdrawnPreEligibilityFunded INT NULL,
							IsTimelyWithdrawnPreEligibilityFunded INT NULL,
							IsOverallWithdrawnPostEligibility INT NULL,
							IsTimelyWithdrawnPostEligibility INT NULL,
							IsOverallWithdrawnPostEligibilityNotFunded INT NULL,
							IsTimelyWithdrawnPostEligibilityNotFunded INT NULL,
							IsOverallWithdrawnPostEligibilityFunded INT NULL,
							IsTimelyWithdrawnPostEligibilityFunded INT NULL,
							IsOverallTransfer INT NULL,
							IsTimelyTransfer INT NULL,
							IsOverallTransferNotFunded INT NULL,
							IsTimelyTransferNotFunded INT NULL,
							IsOverallTransferFunded INT NULL,
							IsTimelyTransferFunded INT NULL,
							IsTransferValid INT NULL,
							IsOverallBreakInLearning INT NULL,
							IsTimelyBreakInLearning INT NULL,
							IsOverallBreakInLearningNotFunded INT NULL,
							IsTimelyBreakInLearningNotFunded INT NULL,
							IsOverallBreakInLearningFunded INT NULL,
							IsTimelyBreakInLearningFunded INT NULL,
							IsBreakInLearningValid INT NULL,
							IsOverallAchiever INT NULL,
							IsTimelyAchiever INT NULL,
							IsOverallAchieverNotFunded INT NULL,
							IsTimelyAchieverNotFunded INT NULL,
							IsOverallAchieverFunded INT NULL,
							IsTimelyAchieverFunded INT NULL,
							IsOverallFailed INT NULL,
							IsTimelyFailed INT NULL,
							IsOverallFailedNotFunded INT NULL,
							IsTimelyFailedNotFunded INT NULL,
							IsOverallFailedFunded INT NULL,
							IsTimelyFailedFunded INT NULL,
							IsOverallUnknownOutcome INT NULL,
							IsTimelyUnknownOutcome INT NULL,
							IsOverallUnknownOutcomeNotFunded INT NULL,
							IsTimelyUnknownOutcomeNotFunded INT NULL,
							IsOverallUnknownOutcomeFunded INT NULL,
							IsTimelyUnknownOutcomeFunded INT NULL,
							IsUnknownOutcomeValid INT NULL,
							IsOverallHighGrade INT NULL,
							IsTimelyHighGrade INT NULL,
							IsOutOfFunding30Days INT NULL,
							IsOutOfFunding60Days INT NULL,
							IsOutOfFunding90Days INT NULL,

							PlanLearnHours INT NULL,
							PlanEEPHours INT NULL,
							FM25PlanLearnHoursAim INT NULL,
							FM25EEPHoursAim INT NULL,
							FM25TLevelHoursAim INT NULL,
							FM25PlanLearnHoursAllAims INT NULL,
							FM25EEPHoursAllAims INT NULL,
							FM25TLevelHoursAllAims INT NULL,
							IsPartTime NCHAR(1) NULL,

							ProgType INT NULL,
							StandardCode INT NULL,
							StandardName VARCHAR(150) NULL,
							FrameworkCode INT NULL,
							FrameworkName VARCHAR(150) NULL,
							PathwayCode INT NULL,
							PathwayName VARCHAR(150) NULL,
							OffTheJobActualHours INT NULL,
							EmployerID INT NULL,
							EmployerName VARCHAR(100) NULL,
							PartnerCode INT NULL,
							PartnerName VARCHAR(100) NULL,
					
							AimValue DECIMAL(10, 5) NULL,
							ProgWeightFactor NCHAR(1) NULL,
							UnweightFundRate DECIMAL(10, 5) NULL,
							WeightFundRate DECIMAL(10, 5) NULL,
							CoFundingIndicator VARCHAR(10) NULL,
							IsCarryIn INT NULL,
							HEQualEnt3 VARCHAR(3) NULL,
							HESoc INT NULL,
							HESec INT NULL,
							HEUCASSchemeCode VARCHAR(9) NULL,
							HETypeYr INT NULL,
							HEModeStu INT NULL,
							HEFundLev INT NULL,
							HEFundComp INT NULL,
							HEStuLoad DECIMAL(4, 1) NULL,
							HEYearStu INT NULL,
							HEMajorSourceStuFee INT NULL,
							HEPercentageNotTaught DECIMAL(4, 1) NULL,
							HEPercentTaughtFirstLDCS DECIMAL(4, 1) NULL,
							HEPercentTaughtSecondLDCS DECIMAL(4, 1) NULL,
							HEPercentTaughtThirdLDCS DECIMAL(4, 1) NULL,
							HESpecialFeeIndicator INT NULL,
							HENetTuitionFee INT NULL,
							HEGrossTuitionFee INT NULL,
							HEPermAddCountry VARCHAR(2) NULL,
							HEELQ INT NULL,
							HEPostCode VARCHAR(8) NULL,
							EnrolmentID VARCHAR(20) NULL,
							FM25TotalEarnedCash DECIMAL(10, 5) NULL,
					'
    
					SET @SQLString += 
						N'
							ProvSpecLearnMonA VARCHAR(20) NULL,
							ProvSpecLearnMonB VARCHAR(20) NULL,
							ProvSpecLearnMonC VARCHAR(20) NULL,
							ProvSpecLearnMonD VARCHAR(20) NULL,
							ProvSpecDelMonA VARCHAR(20) NULL,
							ProvSpecDelMonB VARCHAR(20) NULL,
							ProvSpecDelMonC VARCHAR(20) NULL,
							ProvSpecDelMonD VARCHAR(20) NULL,

							NumPlannedOnProgPayments INT NULL,
							NumOutstandingOnProgPayments INT NULL,
							AchieveElement DECIMAL(10, 5) NULL,
							NonGovCont DECIMAL(10, 5) NULL,
							PropFundRemain DECIMAL(10, 5) NULL,
							PropFundRemainAchComp DECIMAL(10, 5) NULL,
							PropFundRemainAch DECIMAL(10, 5) NULL,
							CarryInOnProg DECIMAL(10, 5) NULL,
							CarryInYr1R01 DECIMAL(10, 5) NULL,
							CarryInYr1R02 DECIMAL(10, 5) NULL,
							CarryInYr1R03 DECIMAL(10, 5) NULL,
							CarryInYr1R04 DECIMAL(10, 5) NULL,
							CarryInYr1R05 DECIMAL(10, 5) NULL,
							CarryInYr1R06 DECIMAL(10, 5) NULL,
							CarryInYr1R07 DECIMAL(10, 5) NULL,
							CarryInYr1R08 DECIMAL(10, 5) NULL,
							CarryInYr1R09 DECIMAL(10, 5) NULL,
							CarryInYr1R10 DECIMAL(10, 5) NULL,
							CarryInYr1R11 DECIMAL(10, 5) NULL,
							CarryInYr1R12 DECIMAL(10, 5) NULL,
							CarryInYr2R01 DECIMAL(10, 5) NULL,
							CarryInYr2R02 DECIMAL(10, 5) NULL,
							CarryInYr2R03 DECIMAL(10, 5) NULL,
							CarryInYr2R04 DECIMAL(10, 5) NULL,
							CarryInYr2R05 DECIMAL(10, 5) NULL,
							CarryInYr2R06 DECIMAL(10, 5) NULL,
							CarryInYr2R07 DECIMAL(10, 5) NULL,
							CarryInYr2R08 DECIMAL(10, 5) NULL,
							CarryInYr2R09 DECIMAL(10, 5) NULL,
							CarryInYr2R10 DECIMAL(10, 5) NULL,
							CarryInYr2R11 DECIMAL(10, 5) NULL,
							CarryInYr2R12 DECIMAL(10, 5) NULL,
					'
    
					SET @SQLString += 
						N'
							OnProgPaymentToPeriod DECIMAL(10, 5) NULL,
							LearnSuppPaymentToPeriod DECIMAL(10, 5) NULL,
							AchCompPaymentToPeriod DECIMAL(10, 5) NULL,
							BalancePaymentToPeriod DECIMAL(10, 5) NULL,
							EmpOutcomePayToPeriod DECIMAL(10, 5) NULL,
							OtherPaymentToPeriod DECIMAL(10, 5) NULL,
							TotalEarnedCashToPeriod DECIMAL(10, 5) NULL,

							OnProgPaymentMidYear DECIMAL(10, 5) NULL,
							LearnSuppPaymentMidYear DECIMAL(10, 5) NULL,
							AchCompPaymentMidYear DECIMAL(10, 5) NULL,
							BalancePaymentMidYear DECIMAL(10, 5) NULL,
							EmpOutcomePayMidYear DECIMAL(10, 5) NULL,
							OtherPaymentMidYear DECIMAL(10, 5) NULL,
							TotalEarnedCashMidYear DECIMAL(10, 5) NULL,

							OnProgPaymentYearEnd DECIMAL(10, 5) NULL,
							LearnSuppPaymentYearEnd DECIMAL(10, 5) NULL,
							AchCompPaymentYearEnd DECIMAL(10, 5) NULL,
							BalancePaymentYearEnd DECIMAL(10, 5) NULL,
							EmpOutcomePayYearEnd DECIMAL(10, 5) NULL,
							OtherPaymentYearEnd DECIMAL(10, 5) NULL,
							TotalEarnedCashYearEnd DECIMAL(10, 5) NULL,
							TotalEarnedCashYearEndNotApportioned DECIMAL(10, 5) NULL,

							FutureAchievePayment DECIMAL(10, 5) NULL,
							FutureAchieveWeighting DECIMAL(5, 2) NULL,
							FutureAchievePaymentWeighted DECIMAL(10, 5) NULL,
							'
    
					SET @SQLString += 
						N'
							PrvRetentFactHist DECIMAL(10, 5) NULL,
							ProgWeightHist DECIMAL(10, 5) NULL,
							ProgWeightNew DECIMAL(10, 5) NULL,
							LearnerEnglishMathsFundingRate DECIMAL(10, 5) NULL,
							LearnerEnglishMathsInstances INT NULL,
							Block1DisadvUplift DECIMAL(10, 5) NULL,
							Block2DisadvFundingRate DECIMAL(10, 5) NULL,
							Block2DisadvElementsNew DECIMAL(10, 5) NULL,
							LargeProgrammeUplift DECIMAL(10, 5) NULL,
							AreaCostFact1618Hist DECIMAL(10, 5) NULL,
							ConditionOfFundingAdjustment DECIMAL(10, 5) NULL,
							AdvancedMathsPremium INT NULL,
							CoreMathsPremium INT NULL,
							HighValueCoursePremium INT NULL,
							TLevelIndustryPlacementFunding DECIMAL(10, 5) NULL,
							NationalFundingRate DECIMAL(10, 5) NULL,
					'
    
					SET @SQLString += 
						N'
							AppStandardPriceEpisodeIdentifier VARCHAR(25) NULL,
							AppStandardTNP1 DECIMAL(12, 5) NULL,
							AppStandardTNP2 DECIMAL(12, 5) NULL,
							AppStandardTNP3 DECIMAL(12, 5) NULL,
							AppStandardTNP4 DECIMAL(12, 5) NULL,
							AppStandardEpisodeStartDate DATE NULL,
							AppStandardPriceEpisode1618FrameworkUpliftRemainingAmount DECIMAL(12, 5) NULL,
							AppStandardPriceEpisode1618FrameworkUpliftTotPrevEarnings DECIMAL(12, 5) NULL,
							AppStandardPriceEpisode1618FUBalValue DECIMAL(12, 5) NULL,
							AppStandardPriceEpisode1618FUMonthInstValue DECIMAL(12, 5) NULL,
							AppStandardPriceEpisode1618FUTotEarnings DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeUpperBandLimit DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodePlannedEndDate DATE NULL,
							AppStandardPriceEpisodeActualEndDate DATE NULL,
							AppStandardPriceEpisodeActualEndDateIncEPA DATE NULL,
							AppStandardPriceEpisodeTotalTNPPrice DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeUpperLimitAdjustment DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodePlannedInstalments INT NULL,
							AppStandardPriceEpisodeActualInstalments INT NULL,
							AppStandardPriceEpisodeCompletionElement DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodePreviousEarnings DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeInstalmentValue DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeTotalEarnings DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeCompleted INT NULL,
							AppStandardPriceEpisodeRemainingTNPAmount DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeRemainingAmountWithinUpperLimit DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeCappedRemainingTNPAmount DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeExpectedTotalMonthlyValue DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeAimSeqNumber INT NULL,
							AppStandardPriceEpisodeApplic1618FrameworkUpliftCompElement DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeFundLineType VARCHAR(100) NULL,
							AppStandardEpisodeEffectiveTNPStartDate DATE NULL,
							AppStandardPriceEpisodeFirstAdditionalPaymentThresholdDate DATE NULL,
							AppStandardPriceEpisodeSecondAdditionalPaymentThresholdDate DATE NULL,
							AppStandardPriceEpisodeContractType VARCHAR(50) NULL,
							AppStandardPriceEpisodePreviousEarningsSameProvider DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeTotalPMRs DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeCumulativePMRs DECIMAL(12, 5) NULL,
							AppStandardPriceEpisodeCompExemCode INT NULL,
							AppStandardPriceEpisodeLearnerAdditionalPaymentThresholdDate DATE NULL,
							AppStandardPriceEpisodeRedStartDate DATE NULL,
							AppStandardPriceEpisodeRedStatusCode INT NULL
						)';

					SET @SQLParams = 
					N'';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams;

					SET @SQLString = 
					N'
						CREATE CLUSTERED INDEX [CX_' + @FISOutputTableName + '] ON ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] ( AcademicYear, ProviderNumber, ILRReturn, IsFinalReturn, ILRReturnDate, LearnRefNumber, AimSeqNumber )';

					SET @SQLParams = 
					N'';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams;

					SET @Message = N'Created ' + @FISOutputTableName + N' Table';
					RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;
				END

			IF @Mode = 'R' OR @TableExtraExists = 0
				--If mode is to replace or table does not exist then create it
				BEGIN
					--Add additional data to second table (gets around SQL Server maximum row size of 8060)
					SET @SQLString = 
					N'
						CREATE TABLE ' + @FISOutputTableLocation + '[' + @FISOutputTableName + 'Extra] (
							AcademicYear VARCHAR(5) NULL,
							ProviderNumber INT NULL,
							ILRReturn VARCHAR(3) NULL,
							IsFinalReturn BIT NULL,
							ILRReturnDate DATETIME NULL,
							LearnRefNumber VARCHAR(12) NULL,
							AimSeqNumber INT NULL,
					'
    
					SET @SQLString += 
						N'
							OnProgPaymentP01 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP01 DECIMAL(10, 5) NULL,
							AchCompPaymentP01 DECIMAL(10, 5) NULL,
							BalancePaymentP01 DECIMAL(10, 5) NULL,
							EmpOutcomePayP01 DECIMAL(10, 5) NULL,
							OtherPaymentP01 DECIMAL(10, 5) NULL,
							TotalEarnedCashP01 DECIMAL(10, 5) NULL,

							OnProgPaymentP02 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP02 DECIMAL(10, 5) NULL,
							AchCompPaymentP02 DECIMAL(10, 5) NULL,
							BalancePaymentP02 DECIMAL(10, 5) NULL,
							EmpOutcomePayP02 DECIMAL(10, 5) NULL,
							OtherPaymentP02 DECIMAL(10, 5) NULL,
							TotalEarnedCashP02 DECIMAL(10, 5) NULL,

							OnProgPaymentP03 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP03 DECIMAL(10, 5) NULL,
							AchCompPaymentP03 DECIMAL(10, 5) NULL,
							BalancePaymentP03 DECIMAL(10, 5) NULL,
							EmpOutcomePayP03 DECIMAL(10, 5) NULL,
							OtherPaymentP03 DECIMAL(10, 5) NULL,
							TotalEarnedCashP03 DECIMAL(10, 5) NULL,

							OnProgPaymentP04 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP04 DECIMAL(10, 5) NULL,
							AchCompPaymentP04 DECIMAL(10, 5) NULL,
							BalancePaymentP04 DECIMAL(10, 5) NULL,
							EmpOutcomePayP04 DECIMAL(10, 5) NULL,
							OtherPaymentP04 DECIMAL(10, 5) NULL,
							TotalEarnedCashP04 DECIMAL(10, 5) NULL,

							OnProgPaymentP05 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP05 DECIMAL(10, 5) NULL,
							AchCompPaymentP05 DECIMAL(10, 5) NULL,
							BalancePaymentP05 DECIMAL(10, 5) NULL,
							EmpOutcomePayP05 DECIMAL(10, 5) NULL,
							OtherPaymentP05 DECIMAL(10, 5) NULL,
							TotalEarnedCashP05 DECIMAL(10, 5) NULL,

							OnProgPaymentP06 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP06 DECIMAL(10, 5) NULL,
							AchCompPaymentP06 DECIMAL(10, 5) NULL,
							BalancePaymentP06 DECIMAL(10, 5) NULL,
							EmpOutcomePayP06 DECIMAL(10, 5) NULL,
							OtherPaymentP06 DECIMAL(10, 5) NULL,
							TotalEarnedCashP06 DECIMAL(10, 5) NULL,

							OnProgPaymentP07 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP07 DECIMAL(10, 5) NULL,
							AchCompPaymentP07 DECIMAL(10, 5) NULL,
							BalancePaymentP07 DECIMAL(10, 5) NULL,
							EmpOutcomePayP07 DECIMAL(10, 5) NULL,
							OtherPaymentP07 DECIMAL(10, 5) NULL,
							TotalEarnedCashP07 DECIMAL(10, 5) NULL,

							OnProgPaymentP08 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP08 DECIMAL(10, 5) NULL,
							AchCompPaymentP08 DECIMAL(10, 5) NULL,
							BalancePaymentP08 DECIMAL(10, 5) NULL,
							EmpOutcomePayP08 DECIMAL(10, 5) NULL,
							OtherPaymentP08 DECIMAL(10, 5) NULL,
							TotalEarnedCashP08 DECIMAL(10, 5) NULL,

							OnProgPaymentP09 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP09 DECIMAL(10, 5) NULL,
							AchCompPaymentP09 DECIMAL(10, 5) NULL,
							BalancePaymentP09 DECIMAL(10, 5) NULL,
							EmpOutcomePayP09 DECIMAL(10, 5) NULL,
							OtherPaymentP09 DECIMAL(10, 5) NULL,
							TotalEarnedCashP09 DECIMAL(10, 5) NULL,

							OnProgPaymentP10 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP10 DECIMAL(10, 5) NULL,
							AchCompPaymentP10 DECIMAL(10, 5) NULL,
							BalancePaymentP10 DECIMAL(10, 5) NULL,
							EmpOutcomePayP10 DECIMAL(10, 5) NULL,
							OtherPaymentP10 DECIMAL(10, 5) NULL,
							TotalEarnedCashP10 DECIMAL(10, 5) NULL,

							OnProgPaymentP11 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP11 DECIMAL(10, 5) NULL,
							AchCompPaymentP11 DECIMAL(10, 5) NULL,
							BalancePaymentP11 DECIMAL(10, 5) NULL,
							EmpOutcomePayP11 DECIMAL(10, 5) NULL,
							OtherPaymentP11 DECIMAL(10, 5) NULL,
							TotalEarnedCashP11 DECIMAL(10, 5) NULL,

							OnProgPaymentP12 DECIMAL(10, 5) NULL,
							LearnSuppPaymentP12 DECIMAL(10, 5) NULL,
							AchCompPaymentP12 DECIMAL(10, 5) NULL,
							BalancePaymentP12 DECIMAL(10, 5) NULL,
							EmpOutcomePayP12 DECIMAL(10, 5) NULL,
							OtherPaymentP12 DECIMAL(10, 5) NULL,
							TotalEarnedCashP12 DECIMAL(10, 5) NULL
						)';

					SET @SQLParams = 
					N'';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams;

					SET @SQLString = 
					N'
						CREATE CLUSTERED INDEX [CX_' + @FISOutputTableName + 'Extra] ON ' + @FISOutputTableLocation + '[' + @FISOutputTableName + 'Extra] ( AcademicYear, ProviderNumber, ILRReturn, IsFinalReturn, ILRReturnDate, LearnRefNumber, AimSeqNumber )';

					SET @SQLParams = 
					N'';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams;

					SET @Message = N'Created ' + @FISOutputTableName + N'Extra Table';
					RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;
				END
			ELSE
				--If mode is to insert instead of replace then see if this ILR has already been imported
				BEGIN
					SET @Message = N'Inserting into Existing ' + @FISOutputTableName + N' Table';
					RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;

					SET @SQLString = 
					N'
						SELECT
							@NumExistingRecords = SUM ( 1 )
						FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
						WHERE
							FD.AcademicYear = @AcademicYear
							AND FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @FileDate, ''yyyy-MM-dd HH:mm:ss'' )';

					SET @SQLParams = 
					N'
						@AcademicYear VARCHAR(5),
						@FileDate DATETIME,
						@NumExistingRecords INT OUTPUT';

					EXECUTE sp_executesql 
						@SQLString, 
						@SQLParams, 
						@AcademicYear = @AcademicYear, 
						@FileDate = @FileDate,
						@NumExistingRecords = @NumExistingRecords OUTPUT;

					IF @NumExistingRecords > 0
						--If same ILR has already been imported then delete it
						BEGIN
							SET @SQLString = 
							N'
								DELETE FD
								FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
								WHERE
									FD.AcademicYear = @AcademicYear
									AND FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @FileDate, ''yyyy-MM-dd HH:mm:ss'' )';

							SET @SQLParams = 
							N'
								@AcademicYear VARCHAR(5),
								@FileDate DATETIME';

							EXECUTE sp_executesql 
								@SQLString, 
								@SQLParams,
								@AcademicYear = @AcademicYear,
								@FileDate = @FileDate;

							SET @Message = N'Return Already Imported So Deleting Existing ' + CAST ( @NumExistingRecords AS VARCHAR(10) ) + ' Records From ' + @FISOutputTableName + ' Table';
							RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;

							SET @SQLString = 
							N'
								DELETE FD
								FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + 'Extra] FD
								WHERE
									FD.AcademicYear = @AcademicYear
									AND FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @FileDate, ''yyyy-MM-dd HH:mm:ss'' )';

							SET @SQLParams = 
							N'
								@AcademicYear VARCHAR(5),
								@FileDate DATETIME';

							EXECUTE sp_executesql 
								@SQLString, 
								@SQLParams,
								@AcademicYear = @AcademicYear,
								@FileDate = @FileDate;
						END
				END

			--Finally insert new data into table
			SET @SQLString = 
			N'
				EXEC SPR_FIS_FundingData_' + REPLACE ( @AcademicYear, '/', '' ) + '
					@FISDatabase,
					@AcademicYear,
					@ILRReturn,
					@IsFinalReturn,
					@Split1619Funding,
					@Reapportion1619FundingByAimWeighting,
					@AppsMoveFundingToMainComponentAim,
					@1619ALSFundingPercent,
					@IncludeHEAdvLoanPossibleIncome,
					@IncludeAdvLoanBursaryIncome,
					@FutureAchievementWeighting,
					@EnglishMathsFundingHigherRate,
					@EnglishMathsFundingLowerRate,
					@CoreMathsPremiumFundingRate,
					@Block2DisadvFundingTLevelRate,
					@Block2DisadvFundingHigherRate,
					@Block2DisadvFundingLowerRate,
					@AdvancedMathsPremiumFundingRate,
					@HighValueCoursesPremiumFundingRate,
					@ConditionOfFundingAdjustment,
					@IndustryPlacementFullFundingRate,
					@LargeProgramme10PercentUpliftNumLearners,
					@LargeProgramme10PercentUpliftAmount,
					@LargeProgramme20PercentUpliftNumLearners,
					@LargeProgramme20PercentUpliftAmount,
					@Mode,
					@FISOutputTableLocation,
					@FISOutputTableName,
					@ProvSpecDelMonCourseLocation1,
					@ProvSpecDelMonCourseLocation2,
					@ProvSpecDelMonCourseSeperator,
					@ProvSpecDelMonParentCourseLocation1,
					@ProvSpecDelMonParentCourseLocation2,
					@ProvSpecDelMonParentCourseSeperator,
					@EnglishCollegeLevel1Code,
					@EnglishCollegeLevel2Code,
					@EnglishCollegeLevel3Code,
					@EnglishCollegeLevel4Code,
					@MathsCollegeLevel1Code,
					@MathsCollegeLevel2Code,
					@MathsCollegeLevel3Code,
					@MathsCollegeLevel4Code,
					@PartnerCollegeLevel1Code,
					@PartnerCollegeLevel2Code,
					@PartnerCollegeLevel3Code,
					@PartnerCollegeLevel4Code';

			SET @SQLParams = 
			N'
				@FISDatabase VARCHAR(50),
				@AcademicYear NVARCHAR(5),
				@ILRReturn NVARCHAR(3),
				@IsFinalReturn BIT,
				@Split1619Funding BIT,
				@Reapportion1619FundingByAimWeighting BIT,
				@AppsMoveFundingToMainComponentAim BIT,
				@1619ALSFundingPercent DECIMAL(5,2),
				@IncludeHEAdvLoanPossibleIncome BIT,
				@IncludeAdvLoanBursaryIncome BIT,
				@FutureAchievementWeighting DECIMAL(3,2),
				@EnglishMathsFundingHigherRate INT,
				@EnglishMathsFundingLowerRate INT,
				@AdvancedMathsPremiumFundingRate INT,
				@CoreMathsPremiumFundingRate INT,
				@Block2DisadvFundingTLevelRate INT,
				@Block2DisadvFundingHigherRate INT,
				@Block2DisadvFundingLowerRate INT,
				@HighValueCoursesPremiumFundingRate INT,
				@ConditionOfFundingAdjustment INT,
				@IndustryPlacementFullFundingRate INT,
				@LargeProgramme10PercentUpliftNumLearners INT,
				@LargeProgramme10PercentUpliftAmount INT,
				@LargeProgramme20PercentUpliftNumLearners INT,
				@LargeProgramme20PercentUpliftAmount INT,
				@Mode NCHAR(1),
				@FISOutputTableLocation NVARCHAR(200),
				@FISOutputTableName NVARCHAR(200),
				@ProvSpecDelMonCourseLocation1 NCHAR(1),
				@ProvSpecDelMonCourseLocation2 NCHAR(1),
				@ProvSpecDelMonCourseSeperator NVARCHAR(50),
				@ProvSpecDelMonParentCourseLocation1 NCHAR(1),
				@ProvSpecDelMonParentCourseLocation2 NCHAR(1),
				@ProvSpecDelMonParentCourseSeperator NVARCHAR(50),
				@EnglishCollegeLevel1Code NVARCHAR(50),
				@EnglishCollegeLevel2Code NVARCHAR(50),
				@EnglishCollegeLevel3Code NVARCHAR(50),
				@EnglishCollegeLevel4Code NVARCHAR(50),
				@MathsCollegeLevel1Code NVARCHAR(50),
				@MathsCollegeLevel2Code NVARCHAR(50),
				@MathsCollegeLevel3Code NVARCHAR(50),
				@MathsCollegeLevel4Code NVARCHAR(50),
				@PartnerCollegeLevel1Code NVARCHAR(50),
				@PartnerCollegeLevel2Code NVARCHAR(50),
				@PartnerCollegeLevel3Code NVARCHAR(50),
				@PartnerCollegeLevel4Code NVARCHAR(50)';
    
			--SELECT @SQLString AS [processing-instruction(x)] FOR XML PATH('')

			EXECUTE sp_executesql 
				@SQLString, 
				@SQLParams, 
				@FISDatabase = @FISDatabase,
				@AcademicYear = @AcademicYear,
				@ILRReturn = @ILRReturn,
				@IsFinalReturn = @IsFinalReturn,
				@Split1619Funding = @Split1619Funding,
				@Reapportion1619FundingByAimWeighting = @Reapportion1619FundingByAimWeighting,
				@AppsMoveFundingToMainComponentAim = @AppsMoveFundingToMainComponentAim,
				@1619ALSFundingPercent = @1619ALSFundingPercent,
				@IncludeHEAdvLoanPossibleIncome = @IncludeHEAdvLoanPossibleIncome,
				@IncludeAdvLoanBursaryIncome = @IncludeAdvLoanBursaryIncome,
				@FutureAchievementWeighting = @FutureAchievementWeighting,
				@EnglishMathsFundingHigherRate = @EnglishMathsFundingHigherRate,
				@EnglishMathsFundingLowerRate = @EnglishMathsFundingLowerRate,
				@AdvancedMathsPremiumFundingRate = @AdvancedMathsPremiumFundingRate,
				@CoreMathsPremiumFundingRate = @CoreMathsPremiumFundingRate,
				@Block2DisadvFundingTLevelRate = @Block2DisadvFundingTLevelRate,
				@Block2DisadvFundingHigherRate = @Block2DisadvFundingHigherRate,
				@Block2DisadvFundingLowerRate = @Block2DisadvFundingLowerRate,
				@HighValueCoursesPremiumFundingRate = @HighValueCoursesPremiumFundingRate,
				@ConditionOfFundingAdjustment = @ConditionOfFundingAdjustment,
				@IndustryPlacementFullFundingRate = @IndustryPlacementFullFundingRate,
				@LargeProgramme10PercentUpliftNumLearners = @LargeProgramme10PercentUpliftNumLearners,
				@LargeProgramme10PercentUpliftAmount = @LargeProgramme10PercentUpliftAmount,
				@LargeProgramme20PercentUpliftNumLearners = @LargeProgramme20PercentUpliftNumLearners,
				@LargeProgramme20PercentUpliftAmount = @LargeProgramme20PercentUpliftAmount,
				@Mode = @Mode,
				@FISOutputTableLocation = @FISOutputTableLocation,
				@FISOutputTableName = @FISOutputTableName,
				@ProvSpecDelMonCourseLocation1 = @ProvSpecDelMonCourseLocation1,
				@ProvSpecDelMonCourseLocation2 = @ProvSpecDelMonCourseLocation2,
				@ProvSpecDelMonCourseSeperator = @ProvSpecDelMonCourseSeperator,
				@ProvSpecDelMonParentCourseLocation1 = @ProvSpecDelMonParentCourseLocation1,
				@ProvSpecDelMonParentCourseLocation2 = @ProvSpecDelMonParentCourseLocation2,
				@ProvSpecDelMonParentCourseSeperator = @ProvSpecDelMonParentCourseSeperator,
				@EnglishCollegeLevel1Code = @EnglishCollegeLevel1Code,
				@EnglishCollegeLevel2Code = @EnglishCollegeLevel2Code,
				@EnglishCollegeLevel3Code = @EnglishCollegeLevel3Code,
				@EnglishCollegeLevel4Code = @EnglishCollegeLevel4Code,
				@MathsCollegeLevel1Code = @MathsCollegeLevel1Code,
				@MathsCollegeLevel2Code = @MathsCollegeLevel2Code,
				@MathsCollegeLevel3Code = @MathsCollegeLevel3Code,
				@MathsCollegeLevel4Code = @MathsCollegeLevel4Code,
				@PartnerCollegeLevel1Code = @PartnerCollegeLevel1Code,
				@PartnerCollegeLevel2Code = @PartnerCollegeLevel2Code,
				@PartnerCollegeLevel3Code = @PartnerCollegeLevel3Code,
				@PartnerCollegeLevel4Code = @PartnerCollegeLevel4Code;


			SET @Message = @AcademicYear + N' ILR Imported'
			RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;

			--Anonymise the ILR data if required
			IF @AnonymiseData = 1
			BEGIN
				DECLARE @AnonName VARCHAR(250) = N'Anonymous'
				DECLARE @AnonAddress VARCHAR(250) = N'Anonymous'
				DECLARE @AnonPostCode VARCHAR(250) = N'ZZ99 9ZZ'
				DECLARE @AnonTel VARCHAR(250) = N'000000000000000'
				DECLARE @AnonEmail VARCHAR(250) = N'anon@anon.com'

				SET @SQLString = 
				N'
					UPDATE FD
					SET
						Surname = CASE WHEN FD.Surname IS NOT NULL THEN @AnonName ELSE NULL END,
						Forename = CASE WHEN FD.Forename IS NOT NULL THEN @AnonName ELSE NULL END,
						Address1 = CASE WHEN FD.Address1 IS NOT NULL THEN @AnonAddress ELSE NULL END,
						Address2 = CASE WHEN FD.Address2 IS NOT NULL THEN @AnonAddress ELSE NULL END,
						Address3 = CASE WHEN FD.Address3 IS NOT NULL THEN @AnonAddress ELSE NULL END,
						Address4 = CASE WHEN FD.Address4 IS NOT NULL THEN @AnonAddress ELSE NULL END,
						PostCodeCurrent = CASE WHEN FD.PostCodeCurrent IS NOT NULL THEN @AnonPostCode ELSE NULL END,
						PostCodePriorToEnrol = CASE WHEN FD.PostCodePriorToEnrol IS NOT NULL THEN @AnonPostCode ELSE NULL END,
						PostCodeLearningStartDate = CASE WHEN FD.PostCodeLearningStartDate IS NOT NULL THEN @AnonPostCode ELSE NULL END,
						Tel = CASE WHEN FD.Tel IS NOT NULL THEN @AnonTel ELSE NULL END,
						Email = CASE WHEN FD.Email IS NOT NULL THEN @AnonEmail ELSE NULL END,
						PostCodeDelivery = CASE WHEN FD.PostCodeDelivery IS NOT NULL THEN @AnonPostCode ELSE NULL END
					FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
					WHERE
						FD.AcademicYear = @AcademicYear
						AND FD.ILRReturnDate = @FileDate';

				SET @SQLParams = 
					N'@AcademicYear VARCHAR(5),
					@FileDate DATETIME,
					@AnonName VARCHAR(250),
					@AnonAddress VARCHAR(250),
					@AnonPostCode VARCHAR(250),
					@AnonTel VARCHAR(250),
					@AnonEmail VARCHAR(250)';

				EXECUTE sp_executesql 
					@SQLString, 
					@SQLParams,
					@AcademicYear = @AcademicYear,
					@FileDate = @FileDate,
					@AnonName = @AnonName,
					@AnonAddress = @AnonAddress,
					@AnonPostCode = @AnonPostCode,
					@AnonTel = @AnonTel,
					@AnonEmail = @AnonEmail;

				SET @Message = @AcademicYear + N' ILR Anonymised'
				RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;
			END
		END

	--Calculate which records should be included for each year for this provider
	--Latest record for each enrolment matching on provider, learner and learning aim (Art can have 2)
	IF @RunQARCalculation = 1
	BEGIN
		--Get Current Academic Year
		DECLARE @CurrentAcademicYear VARCHAR(5)

		SET @SQLString = 
		N'
			SELECT
				@CurrentAcademicYear = 
					RIGHT (
						CAST (
							CASE
								WHEN MONTH ( CAST ( GETDATE() AS DATE ) ) <= 7 THEN 
									YEAR ( CAST ( GETDATE() AS DATE ) ) - 1
								ELSE 
									YEAR ( CAST ( GETDATE() AS DATE ) )
							END
							AS VARCHAR(4)
						),
						2
					)
					+ ''/''
					+ RIGHT (
						CAST (
							CASE
								WHEN MONTH ( CAST ( GETDATE() AS DATE ) ) <= 7 THEN 
									YEAR ( CAST ( GETDATE() AS DATE ) )
								ELSE 
									YEAR ( CAST ( GETDATE() AS DATE ) ) + 1
							END
							AS VARCHAR(4)
						),
						2
					)';

		SET @SQLParams = 
		N'
			@CurrentAcademicYear VARCHAR(5) OUTPUT';



		EXECUTE sp_executesql 
			@SQLString, 
			@SQLParams,
			@CurrentAcademicYear = @CurrentAcademicYear OUTPUT;



		DECLARE @SixYearsAgo VARCHAR(5) = CAST ( CAST ( LEFT( @CurrentAcademicYear, 2 ) AS INT ) - 6 AS VARCHAR(2) ) + '/' + CAST ( CAST ( RIGHT( @CurrentAcademicYear, 2 ) AS INT ) - 6 AS VARCHAR(2) )

		DECLARE @ProviderName VARCHAR(200)
		DECLARE @LatestImportedFileAcademicYear VARCHAR(5)
		DECLARE @LatestImportedFileILRReturnDate DATETIME
		DECLARE @LatestImportedFileILRReturn VARCHAR(3)
		DECLARE @LatestImportedFileIsFinalReturn BIT
		
		SET @SQLString = 
		N'
			SELECT TOP 1
				@ProviderName = FD.ProviderName,
				@LatestImportedFileAcademicYear = FD.AcademicYear,
				@LatestImportedFileILRReturnDate = FD.ILRReturnDate,
				@LatestImportedFileILRReturn = FD.ILRReturn,
				@LatestImportedFileIsFinalReturn = FD.IsFinalReturn
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			WHERE
				FD.ProviderNumber = @ProviderNumber
			ORDER BY
				FD.AcademicYear DESC,
				FD.ILRReturn DESC,
				FD.IsFinalReturn';


		SET @SQLParams = 
		N'
			@AcademicYear VARCHAR(5),
			@ProviderNumber INT,
			@ProviderName VARCHAR(200) OUTPUT,
			@LatestImportedFileAcademicYear VARCHAR(5) OUTPUT,
			@LatestImportedFileILRReturnDate DATETIME OUTPUT,
			@LatestImportedFileILRReturn VARCHAR(3) OUTPUT,
			@LatestImportedFileIsFinalReturn BIT OUTPUT';

		EXECUTE sp_executesql 
			@SQLString, 
			@SQLParams,
			@AcademicYear = @AcademicYear,
			@ProviderNumber = @ProviderNumber,
			@ProviderName = @ProviderName OUTPUT,
			@LatestImportedFileAcademicYear = @LatestImportedFileAcademicYear OUTPUT,
			@LatestImportedFileILRReturnDate = @LatestImportedFileILRReturnDate OUTPUT,
			@LatestImportedFileILRReturn = @LatestImportedFileILRReturn OUTPUT,
			@LatestImportedFileIsFinalReturn = @LatestImportedFileIsFinalReturn OUTPUT;


		--Clear existing values
		SET @SQLString = 
		N'
			UPDATE FD
			SET
				FD.IncludeInQARMeasures = 0,
				FD.QARNumberOfMergedYearsOfData = NULL,
				FD.LatestImportedFileAcademicYear = NULL,
				FD.LatestImportedFileILRReturnDate = NULL,
				FD.LatestImportedFileILRReturn = NULL,
				FD.LatestImportedFileIsFinalReturn = NULL
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			WHERE
				FD.ProviderNumber = @ProviderNumber
				AND FD.ReportingYear >= @SixYearsAgo';

		SET @SQLParams = 
		N'
			@AcademicYear VARCHAR(5),
			@ProviderNumber INT,
			@SixYearsAgo VARCHAR(5)';

		EXECUTE sp_executesql 
			@SQLString, 
			@SQLParams,
			@AcademicYear = @AcademicYear,
			@ProviderNumber = @ProviderNumber,
			@SixYearsAgo = @SixYearsAgo;


		--Get learner mappings between years for QAR calculations - Using ULN
		SET @SQLString = 
		N'
			DROP TABLE IF EXISTS #LearnerMappingDataOnULN
			SELECT
				CurrentProviderNumber = COALESCE ( FDN5.ProviderNumber, FDN4.ProviderNumber, FDN3.ProviderNumber, FDN2.ProviderNumber, FDN1.ProviderNumber, FD.ProviderNumber ),
				CurrentLearnRefNumber = COALESCE ( FDN5.LearnRefNumber, FDN4.LearnRefNumber, FDN3.LearnRefNumber, FDN2.LearnRefNumber, FDN1.LearnRefNumber, FD.LearnRefNumber ),
				ULN = FD.ULN,

				OriginalAcademicYear = FD.AcademicYear,
				OriginalProviderNumber = FD.ProviderNumber,
				OriginalLearnRefNumber = FD.LearnRefNumber,

				NextAcademicYear1 = FDN1.AcademicYear,
				NextLearnRefNumber1 = FDN1.LearnRefNumber,
				NextUKPRN1 = FDN1.ProviderNumber,
	
				NextAcademicYear2 = FDN2.AcademicYear,
				NextLearnRefNumber2 = FDN2.LearnRefNumber,
				NextUKPRN2 = FDN2.ProviderNumber,
	
				NextAcademicYear3 = FDN3.AcademicYear,
				NextLearnRefNumber3 = FDN3.LearnRefNumber,
				NextUKPRN3 = FDN3.ProviderNumber,
	
				NextAcademicYear4 = FDN4.AcademicYear,
				NextLearnRefNumber4 = FDN4.LearnRefNumber,
				NextUKPRN4 = FDN4.ProviderNumber,
	
				NextAcademicYear5 = FDN5.AcademicYear,
				NextLearnRefNumber5 = FDN5.LearnRefNumber,
				NextUKPRN5 = FDN5.ProviderNumber
	
				INTO #LearnerMappingDataOnULN
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN1
				ON COALESCE ( FDN1.PrevUKPRN, FDN1.ProviderNumber ) = FD.ProviderNumber
				AND FDN1.AcademicYear = CAST ( CAST ( LEFT ( FD.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FD.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND FDN1.ULN = FD.ULN
				AND FDN1.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN2
				ON COALESCE ( FDN2.PrevUKPRN, FDN2.ProviderNumber ) = FDN1.ProviderNumber
				AND FDN2.AcademicYear = CAST ( CAST ( LEFT ( FDN1.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN1.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND FDN2.ULN = FDN1.ULN
				AND FDN2.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN3
				ON COALESCE ( FDN3.PrevUKPRN, FDN3.ProviderNumber ) = FDN2.ProviderNumber
				AND FDN3.AcademicYear = CAST ( CAST ( LEFT ( FDN2.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN2.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND FDN3.ULN = FDN2.ULN
				AND FDN3.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN4
				ON COALESCE ( FDN4.PrevUKPRN, FDN4.ProviderNumber ) = FDN3.ProviderNumber
				AND FDN4.AcademicYear = CAST ( CAST ( LEFT ( FDN3.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN3.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND FDN4.ULN = FDN3.ULN
				AND FDN4.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN5
				ON COALESCE ( FDN5.PrevUKPRN, FDN5.ProviderNumber ) = FDN4.ProviderNumber
				AND FDN5.AcademicYear = CAST ( CAST ( LEFT ( FDN4.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN4.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND FDN5.ULN = FDN4.ULN
				AND FDN5.IsMainAim = 1
			WHERE
				COALESCE ( FDN5.ProviderNumber, FDN4.ProviderNumber, FDN3.ProviderNumber, FDN2.ProviderNumber, FDN1.ProviderNumber, FD.ProviderNumber ) = 10004599
				AND FD.IsMainAim = 1
				AND FD.ULN <> ''9999999999''';


		--Get learner mappings between years for QAR calculations - Using LearnRefNumber
		SET @SQLString += 
		N'
			DROP TABLE IF EXISTS #LearnerMappingDataOnRef
			SELECT
				CurrentProviderNumber = COALESCE ( FDN5.ProviderNumber, FDN4.ProviderNumber, FDN3.ProviderNumber, FDN2.ProviderNumber, FDN1.ProviderNumber, FD.ProviderNumber ),
				CurrentLearnRefNumber = COALESCE ( FDN5.LearnRefNumber, FDN4.LearnRefNumber, FDN3.LearnRefNumber, FDN2.LearnRefNumber, FDN1.LearnRefNumber, FD.LearnRefNumber ),
				ULN = FD.ULN,

				OriginalAcademicYear = FD.AcademicYear,
				OriginalProviderNumber = FD.ProviderNumber,
				OriginalLearnRefNumber = FD.LearnRefNumber,

				NextAcademicYear1 = FDN1.AcademicYear,
				NextLearnRefNumber1 = FDN1.LearnRefNumber,
				NextUKPRN1 = FDN1.ProviderNumber,
	
				NextAcademicYear2 = FDN2.AcademicYear,
				NextLearnRefNumber2 = FDN2.LearnRefNumber,
				NextUKPRN2 = FDN2.ProviderNumber,
	
				NextAcademicYear3 = FDN3.AcademicYear,
				NextLearnRefNumber3 = FDN3.LearnRefNumber,
				NextUKPRN3 = FDN3.ProviderNumber,
	
				NextAcademicYear4 = FDN4.AcademicYear,
				NextLearnRefNumber4 = FDN4.LearnRefNumber,
				NextUKPRN4 = FDN4.ProviderNumber,
	
				NextAcademicYear5 = FDN5.AcademicYear,
				NextLearnRefNumber5 = FDN5.LearnRefNumber,
				NextUKPRN5 = FDN5.ProviderNumber
	
				INTO #LearnerMappingDataOnRef
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN1
				ON COALESCE ( FDN1.PrevUKPRN, FDN1.ProviderNumber ) = FD.ProviderNumber
				AND FDN1.AcademicYear = CAST ( CAST ( LEFT ( FD.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FD.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND COALESCE ( FDN1.PrevLearnRefNumber, FDN1.LearnRefNumber ) = FD.LearnRefNumber
				AND FDN1.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN2
				ON COALESCE ( FDN2.PrevUKPRN, FDN2.ProviderNumber ) = FDN1.ProviderNumber
				AND FDN2.AcademicYear = CAST ( CAST ( LEFT ( FDN1.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN1.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND COALESCE ( FDN2.PrevLearnRefNumber, FDN2.LearnRefNumber ) = FDN1.LearnRefNumber
				AND FDN2.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN3
				ON COALESCE ( FDN3.PrevUKPRN, FDN3.ProviderNumber ) = FDN2.ProviderNumber
				AND FDN3.AcademicYear = CAST ( CAST ( LEFT ( FDN2.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN2.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND COALESCE ( FDN3.PrevLearnRefNumber, FDN3.LearnRefNumber ) = FDN2.LearnRefNumber
				AND FDN3.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN4
				ON COALESCE ( FDN4.PrevUKPRN, FDN4.ProviderNumber ) = FDN3.ProviderNumber
				AND FDN4.AcademicYear = CAST ( CAST ( LEFT ( FDN3.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN3.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND COALESCE ( FDN4.PrevLearnRefNumber, FDN4.LearnRefNumber ) = FDN3.LearnRefNumber
				AND FDN4.IsMainAim = 1
			LEFT JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FDN5
				ON COALESCE ( FDN5.PrevUKPRN, FDN5.ProviderNumber ) = FDN4.ProviderNumber
				AND FDN5.AcademicYear = CAST ( CAST ( LEFT ( FDN4.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) ) + ''/'' + CAST ( CAST ( RIGHT ( FDN4.AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
				AND COALESCE ( FDN5.PrevLearnRefNumber, FDN5.LearnRefNumber ) = FDN4.LearnRefNumber
				AND FDN5.IsMainAim = 1
			WHERE
				COALESCE ( FDN5.ProviderNumber, FDN4.ProviderNumber, FDN3.ProviderNumber, FDN2.ProviderNumber, FDN1.ProviderNumber, FD.ProviderNumber ) = @ProviderNumber
				AND FD.IsMainAim = 1';


		--Take most recent values for learner ref and provider QKPRN and map to previous years where they differ 
		--Using UNION in case of multiple mappings to same values for different previous years
		--Mapping using ULN and prior or current UKPRN
		--Later match on previous learner ref but prioritise ULN matches first (descending order for rownum)
		SET @SQLString += 
		N'
			DROP TABLE IF EXISTS #YearlyLearnerMappings
			SELECT
				YLM.ProviderNumber,
				YLM.ULN,
				YLM.LearnRefNumber,
				YLM.PrevAcademicYear,
				YLM.PrevUKPRN,
				YLM.PrevLearnRefNumber,
				YLM.MatchMode,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							YLM.ProviderNumber,
							YLM.ULN,
							YLM.LearnRefNumber,
							YLM.PrevAcademicYear
						ORDER BY
							YLM.MatchMode DESC
					)
			INTO #YearlyLearnerMappings
			FROM (
				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.OriginalAcademicYear,
					PrevUKPRN = YLM.OriginalProviderNumber,
					PrevLearnRefNumber = YLM.OriginalLearnRefNumber,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.OriginalLearnRefNumber <> YLM.CurrentLearnRefNumber
					OR YLM.OriginalProviderNumber <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear1,
					PrevUKPRN = YLM.NextUKPRN1,
					PrevLearnRefNumber = YLM.NextLearnRefNumber1,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber1 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN1 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear2,
					PrevUKPRN = YLM.NextUKPRN2,
					PrevLearnRefNumber = YLM.NextLearnRefNumber2,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber2 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN2 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear3,
					PrevUKPRN = YLM.NextUKPRN3,
					PrevLearnRefNumber = YLM.NextLearnRefNumber3,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber3 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN3 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear4,
					PrevUKPRN = YLM.NextUKPRN4,
					PrevLearnRefNumber = YLM.NextLearnRefNumber4,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber4 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN4 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear5,
					PrevUKPRN = YLM.NextUKPRN5,
					PrevLearnRefNumber = YLM.NextLearnRefNumber5,
					MatchMode = ''ULN''
				FROM #LearnerMappingDataOnULN YLM
				WHERE
					YLM.NextLearnRefNumber5 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN5 <> YLM.CurrentProviderNumber
		';


		--Take most recent values for learner ref and provider UKPRN and map to previous years where they differ 
		--Using UNION in case of multiple mappings to same values for different previous years
		--Mapping using prior student ref and prior or current UKPRN
		SET @SQLString += 
			N'
				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.OriginalAcademicYear,
					PrevUKPRN = YLM.OriginalProviderNumber,
					PrevLearnRefNumber = YLM.OriginalLearnRefNumber,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.OriginalLearnRefNumber <> YLM.CurrentLearnRefNumber
					OR YLM.OriginalProviderNumber <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear1,
					PrevUKPRN = YLM.NextUKPRN1,
					PrevLearnRefNumber = YLM.NextLearnRefNumber1,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber1 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN1 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear2,
					PrevUKPRN = YLM.NextUKPRN2,
					PrevLearnRefNumber = YLM.NextLearnRefNumber2,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber2 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN2 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear3,
					PrevUKPRN = YLM.NextUKPRN3,
					PrevLearnRefNumber = YLM.NextLearnRefNumber3,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber3 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN3 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear4,
					PrevUKPRN = YLM.NextUKPRN4,
					PrevLearnRefNumber = YLM.NextLearnRefNumber4,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber4 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN4 <> YLM.CurrentProviderNumber

				UNION

				SELECT
					ProviderNumber = YLM.CurrentProviderNumber,
					ULN = YLM.ULN,
					LearnRefNumber = YLM.CurrentLearnRefNumber,
					PrevAcademicYear = YLM.NextAcademicYear5,
					PrevUKPRN = YLM.NextUKPRN5,
					PrevLearnRefNumber = YLM.NextLearnRefNumber5,
					MatchMode = ''Ref''
				FROM #LearnerMappingDataOnRef YLM
				WHERE
					YLM.NextLearnRefNumber5 <> YLM.CurrentLearnRefNumber
					OR YLM.NextUKPRN5 <> YLM.CurrentProviderNumber
			) YLM';


		--Set records which should be includes in QAR measures
		--If rolled forward for achievement then last year will not be funded but prior year will
		SET @SQLString += 
		N'
			DROP TABLE IF EXISTS #MergedData
			SELECT
				ProviderNumber = COALESCE ( YLM.ProviderNumber, FD.ProviderNumber ),
				LearnRefNumber = COALESCE ( YLM.LearnRefNumber, FD.LearnRefNumber ),
				FD.LearningAimCode,
				FD.LearnerAndAimRowNum,
				FD.StandardCode,
				FD.FrameworkCode,
				FD.PathwayCode,
				IsFundedStart = MAX ( FD.IsFundedStart ),
				StartDate = COALESCE ( FD.OriginalStartDate, FD.StartDate ),
				CompletionStatusCode = 
					COALESCE (
						MAX ( CASE WHEN FD.CompletionStatusCode <> ''6'' THEN FD.CompletionStatusCode ELSE NULL END ),
						MAX ( FD.CompletionStatusCode )
					),
				FD.StartYear,
				PlannedEndYear = MAX ( FD.PlannedEndYear ),
				AchievementYear = MAX ( FD.AchievementYear ),
				HybridEndYear = MAX ( FD.HybridEndYear ),
				EarliestReportingYear = MIN ( FD.ReportingYear ),
				LatestReportingYear = MAX ( FD.ReportingYear),
				NumMergedRecords = COUNT ( FD.LearningAimCode ),
				IsOverallStart = MAX ( FD.IsOverallStart ),
				IsTimelyStart = MAX ( FD.IsTimelyStart ),
				IsOverallLeaver = MAX ( FD.IsOverallLeaver ),
				IsTimelyLeaver = MAX ( FD.IsTimelyLeaver ),
				IsOverallLeaverBestCase = MAX ( FD.IsOverallLeaverBestCase ),
				IsTimelyLeaverBestCase = MAX ( FD.IsTimelyLeaverBestCase ),
				IsOverallCompletedBestCase = MAX ( FD.IsOverallCompletedBestCase ),
				IsTimelyCompletedBestCase = MAX ( FD.IsTimelyCompletedBestCase ),
				IsOverallAchieverBestCase = MAX ( FD.IsOverallAchieverBestCase ),
				IsTimelyAchieverBestCase = MAX ( FD.IsTimelyAchieverBestCase ),
				IsOverallContinuer = MAX ( FD.IsOverallContinuer ),
				IsTimelyContinuer = MAX ( FD.IsTimelyContinuer ),
				IsOverallContinuerNotFunded = MIN ( FD.IsOverallContinuerNotFunded ),
				IsTimelyContinuerNotFunded = MIN ( FD.IsTimelyContinuerNotFunded ),
				IsOverallContinuerFunded = MAX ( FD.IsOverallContinuerFunded ),
				IsTimelyContinuerFunded = MAX ( FD.IsTimelyContinuerFunded ),
				IsOverallCompleted = MAX ( FD.IsOverallCompleted ),
				IsTimelyCompleted = MAX ( FD.IsTimelyCompleted ),
				IsOverallCompletedNotFunded = MIN ( FD.IsOverallCompletedNotFunded ),
				IsTimelyCompletedNotFunded = MIN ( FD.IsTimelyCompletedNotFunded ),
				IsOverallCompletedFunded = MAX ( FD.IsOverallCompletedFunded ),
				IsTimelyCompletedFunded = MAX ( FD.IsTimelyCompletedFunded ),
				IsOverallRetained = MAX ( FD.IsOverallRetained ),
				IsTimelyRetained = MAX ( FD.IsTimelyRetained ),
				IsOverallRetainedNotFunded = MIN ( FD.IsOverallRetainedNotFunded ),
				IsTimelyRetainedNotFunded = MIN ( FD.IsTimelyRetainedNotFunded ),
				IsOverallRetainedFunded = MAX ( FD.IsOverallRetainedFunded ),
				IsTimelyRetainedFunded = MAX ( FD.IsTimelyRetainedFunded ),
		'
    
		SET @SQLString += 
			N'
				IsOverallWithdrawn = MAX ( FD.IsOverallWithdrawn ),
				IsTimelyWithdrawn = MAX ( FD.IsTimelyWithdrawn ),
				IsOverallWithdrawnNotFunded = MIN ( FD.IsOverallWithdrawnNotFunded ),
				IsTimelyWithdrawnNotFunded = MIN ( FD.IsTimelyWithdrawnNotFunded ),
				IsOverallWithdrawnFunded = MAX ( FD.IsOverallWithdrawnFunded ),
				IsTimelyWithdrawnFunded = MAX ( FD.IsTimelyWithdrawnFunded ),
				IsOverallTransfer = MAX ( FD.IsOverallTransfer ),
				IsTimelyTransfer = MAX ( FD.IsTimelyTransfer ),
				IsOverallTransferNotFunded = MIN ( FD.IsOverallTransferNotFunded ),
				IsTimelyTransferNotFunded = MIN ( FD.IsTimelyTransferNotFunded ),
				IsOverallTransferFunded = MAX ( FD.IsOverallTransferFunded ),
				IsTimelyTransferFunded = MAX ( FD.IsTimelyTransferFunded ),
				IsTransferValid = MAX ( FD.IsTransferValid ),
				IsOverallBreakInLearning = MAX ( FD.IsOverallBreakInLearning ),
				IsTimelyBreakInLearning = MAX ( FD.IsTimelyBreakInLearning ),
				IsOverallBreakInLearningNotFunded = MIN ( FD.IsOverallBreakInLearningNotFunded ),
				IsTimelyBreakInLearningNotFunded = MIN ( FD.IsTimelyBreakInLearningNotFunded ),
				IsOverallBreakInLearningFunded = MAX ( FD.IsOverallBreakInLearningFunded ),
				IsTimelyBreakInLearningFunded = MAX ( FD.IsTimelyBreakInLearningFunded ),
				IsBreakInLearningValid = MAX ( FD.IsBreakInLearningValid ),
				IsOverallAchiever = MAX ( FD.IsOverallAchiever ),
				IsTimelyAchiever = MAX ( FD.IsTimelyAchiever ),
				IsOverallAchieverNotFunded = MIN ( FD.IsOverallAchieverNotFunded ),
				IsTimelyAchieverNotFunded = MIN ( FD.IsTimelyAchieverNotFunded ),
				IsOverallAchieverFunded = MAX ( FD.IsOverallAchieverFunded ),
				IsTimelyAchieverFunded = MAX ( FD.IsTimelyAchieverFunded ),
				IsOverallFailed = MAX ( FD.IsOverallFailed ),
				IsTimelyFailed = MAX ( FD.IsTimelyFailed ),
				IsOverallFailedNotFunded = MIN ( FD.IsOverallFailedNotFunded ),
				IsTimelyFailedNotFunded = MIN ( FD.IsTimelyFailedNotFunded ),
				IsOverallFailedFunded = MAX ( FD.IsOverallFailedFunded ),
				IsTimelyFailedFunded = MAX ( FD.IsTimelyFailedFunded ),
				IsOverallUnknownOutcome = MAX ( FD.IsOverallUnknownOutcome ),
				IsTimelyUnknownOutcome = MAX ( FD.IsTimelyUnknownOutcome ),
				IsOverallUnknownOutcomeNotFunded = MIN ( FD.IsOverallUnknownOutcomeNotFunded ),
				IsTimelyUnknownOutcomeNotFunded = MIN ( FD.IsTimelyUnknownOutcomeNotFunded ),
				IsOverallUnknownOutcomeFunded = MAX ( FD.IsOverallUnknownOutcomeFunded ),
				IsTimelyUnknownOutcomeFunded = MAX ( FD.IsTimelyUnknownOutcomeFunded ),
				IsUnknownOutcomeValid = MAX ( FD.IsUnknownOutcomeValid ),
				IsOverallHighGrade = MAX ( FD.IsOverallHighGrade ),
				IsTimelyHighGrade = MAX ( FD.IsTimelyHighGrade ),
				IsOutOfFunding30Days = MAX ( FD.IsOutOfFunding30Days ),
				IsOutOfFunding60Days = MAX ( FD.IsOutOfFunding60Days ),
				IsOutOfFunding90Days = MAX ( FD.IsOutOfFunding90Days )
				INTO #MergedData
			FROM ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
			LEFT JOIN #YearlyLearnerMappings YLM
				ON YLM.PrevAcademicYear = FD.AcademicYear
				AND YLM.PrevUKPRN = FD.ProviderNumber
				AND YLM.PrevLearnRefNumber = FD.LearnRefNumber
				AND YLM.RowNum = 1
	'
    
	SET @SQLString += 
		N'
			WHERE
				FD.ProviderNumber = @ProviderNumber
				--AND FD.HybridEndYear = @AcademicYear
				AND FD.ReportingYear >= @SixYearsAgo
				AND FD.ILRReturn = 
					CASE
						WHEN 
							FD.AcademicYear = @CurrentAcademicYear 
							AND @LatestImportedFileAcademicYear = @CurrentAcademicYear
								THEN @LatestImportedFileILRReturn
						ELSE ''R14''
					END
				AND FD.IsFinalReturn = 
					CASE
						WHEN 
							FD.AcademicYear = @CurrentAcademicYear 
							AND @LatestImportedFileAcademicYear = @CurrentAcademicYear
								THEN @LatestImportedFileIsFinalReturn
						ELSE 1
					END
				AND 
					CASE
						WHEN 
							FD.AcademicYear = @CurrentAcademicYear 
							AND @LatestImportedFileAcademicYear = @CurrentAcademicYear THEN
								CASE
									WHEN FORMAT ( FD.ILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) = FORMAT ( @LatestImportedFileILRReturnDate, ''yyyy-MM-dd HH:mm:ss'' ) THEN 1
									ELSE 0
								END
						ELSE 1
					END = 1
				--AND FD.CompletionStatusCode <> ''6''
			GROUP BY
				COALESCE ( YLM.ProviderNumber, FD.ProviderNumber ),
				COALESCE ( YLM.LearnRefNumber, FD.LearnRefNumber ),
				FD.LearningAimCode,
				FD.LearnerAndAimRowNum,
				FD.StandardCode,
				FD.FrameworkCode,
				FD.PathwayCode,
				COALESCE ( FD.OriginalStartDate, FD.StartDate ),
				FD.StartYear
		'


		--Update records identified above so they are flagged as include in ILR
		--If merged record was a funded start in previous year then treat as such this year
		SET @SQLString += 
		N'
			UPDATE FD
			SET
				FD.IncludeInQARMeasures = 1,
				FD.QARNumberOfMergedYearsOfData = MD.NumMergedRecords,
				FD.LatestImportedFileAcademicYear = @LatestImportedFileAcademicYear,
				FD.LatestImportedFileILRReturnDate = @LatestImportedFileILRReturnDate,
				FD.LatestImportedFileILRReturn = @LatestImportedFileILRReturn,
				FD.LatestImportedFileIsFinalReturn = @LatestImportedFileIsFinalReturn,
				
				FD.IsOverallStart = MD.IsOverallStart,
				FD.IsTimelyStart = MD.IsTimelyStart,
				FD.IsOverallLeaver = MD.IsOverallLeaver,
				FD.IsTimelyLeaver = MD.IsTimelyLeaver,
				FD.IsOverallLeaverBestCase = MD.IsOverallLeaverBestCase,
				FD.IsTimelyLeaverBestCase = MD.IsTimelyLeaverBestCase,
				FD.IsOverallCompletedBestCase = MD.IsOverallCompletedBestCase,
				FD.IsTimelyCompletedBestCase = MD.IsTimelyCompletedBestCase,
				FD.IsOverallAchieverBestCase = MD.IsOverallAchieverBestCase,
				FD.IsTimelyAchieverBestCase = MD.IsTimelyAchieverBestCase,
				FD.IsOverallContinuer = MD.IsOverallContinuer,
				FD.IsTimelyContinuer = MD.IsTimelyContinuer,
				FD.IsOverallContinuerNotFunded = MD.IsOverallContinuerNotFunded,
				FD.IsTimelyContinuerNotFunded = MD.IsTimelyContinuerNotFunded,
				FD.IsOverallContinuerFunded = MD.IsOverallContinuerFunded,
				FD.IsTimelyContinuerFunded = MD.IsTimelyContinuerFunded,
				FD.IsOverallCompleted = MD.IsOverallCompleted,
				FD.IsTimelyCompleted = MD.IsTimelyCompleted,
				FD.IsOverallCompletedNotFunded = MD.IsOverallCompletedNotFunded,
				FD.IsTimelyCompletedNotFunded = MD.IsTimelyCompletedNotFunded,
				FD.IsOverallCompletedFunded = MD.IsOverallCompletedFunded,
				FD.IsTimelyCompletedFunded = MD.IsTimelyCompletedFunded,
				FD.IsOverallRetained = MD.IsOverallRetained,
				FD.IsTimelyRetained = MD.IsTimelyRetained,
				FD.IsOverallRetainedNotFunded = MD.IsOverallRetainedNotFunded,
				FD.IsTimelyRetainedNotFunded = MD.IsTimelyRetainedNotFunded,
				FD.IsOverallRetainedFunded = MD.IsOverallRetainedFunded,
				FD.IsTimelyRetainedFunded = MD.IsTimelyRetainedFunded,
		'
    
		SET @SQLString += 
			N'
				FD.IsOverallWithdrawn = MD.IsOverallWithdrawn,
				FD.IsTimelyWithdrawn = MD.IsTimelyWithdrawn,
				FD.IsOverallWithdrawnNotFunded = MD.IsOverallWithdrawnNotFunded,
				FD.IsTimelyWithdrawnNotFunded = MD.IsTimelyWithdrawnNotFunded,
				FD.IsOverallWithdrawnFunded = MD.IsOverallWithdrawnFunded,
				FD.IsTimelyWithdrawnFunded = MD.IsTimelyWithdrawnFunded,
				FD.IsOverallTransfer = MD.IsOverallTransfer,
				FD.IsTimelyTransfer = MD.IsTimelyTransfer,
				FD.IsOverallTransferNotFunded = MD.IsOverallTransferNotFunded,
				FD.IsTimelyTransferNotFunded = MD.IsTimelyTransferNotFunded,
				FD.IsOverallTransferFunded = MD.IsOverallTransferFunded,
				FD.IsTimelyTransferFunded = MD.IsTimelyTransferFunded,
				FD.IsTransferValid = MD.IsTransferValid,
				FD.IsOverallBreakInLearning = MD.IsOverallBreakInLearning,
				FD.IsTimelyBreakInLearning = MD.IsTimelyBreakInLearning,
				FD.IsOverallBreakInLearningNotFunded = MD.IsOverallBreakInLearningNotFunded,
				FD.IsTimelyBreakInLearningNotFunded = MD.IsTimelyBreakInLearningNotFunded,
				FD.IsOverallBreakInLearningFunded = MD.IsOverallBreakInLearningFunded,
				FD.IsTimelyBreakInLearningFunded = MD.IsTimelyBreakInLearningFunded,
				FD.IsBreakInLearningValid = MD.IsBreakInLearningValid,
				FD.IsOverallAchiever = MD.IsOverallAchiever,
				FD.IsTimelyAchiever = MD.IsTimelyAchiever,
				FD.IsOverallAchieverNotFunded = MD.IsOverallAchieverNotFunded,
				FD.IsTimelyAchieverNotFunded = MD.IsTimelyAchieverNotFunded,
				FD.IsOverallAchieverFunded = MD.IsOverallAchieverFunded,
				FD.IsTimelyAchieverFunded = MD.IsTimelyAchieverFunded,
				FD.IsOverallFailed = MD.IsOverallFailed,
				FD.IsTimelyFailed = MD.IsTimelyFailed,
				FD.IsOverallFailedNotFunded = MD.IsOverallFailedNotFunded,
				FD.IsTimelyFailedNotFunded = MD.IsTimelyFailedNotFunded,
				FD.IsOverallFailedFunded = MD.IsOverallFailedFunded,
				FD.IsTimelyFailedFunded = MD.IsTimelyFailedFunded,
				FD.IsOverallUnknownOutcome = MD.IsOverallUnknownOutcome,
				FD.IsTimelyUnknownOutcome = MD.IsTimelyUnknownOutcome,
				FD.IsOverallUnknownOutcomeNotFunded = MD.IsOverallUnknownOutcomeNotFunded,
				FD.IsTimelyUnknownOutcomeNotFunded = MD.IsTimelyUnknownOutcomeNotFunded,
				FD.IsOverallUnknownOutcomeFunded = MD.IsOverallUnknownOutcomeFunded,
				FD.IsTimelyUnknownOutcomeFunded = MD.IsTimelyUnknownOutcomeFunded,
				FD.IsUnknownOutcomeValid = MD.IsUnknownOutcomeValid,
				FD.IsOverallHighGrade = MD.IsOverallHighGrade,
				FD.IsTimelyHighGrade = MD.IsTimelyHighGrade,
				FD.IsOutOfFunding30Days = MD.IsOutOfFunding30Days,
				FD.IsOutOfFunding60Days = MD.IsOutOfFunding60Days,
				FD.IsOutOfFunding90Days = MD.IsOutOfFunding90Days
			FROM #MergedData MD
			INNER JOIN ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] FD
				ON FD.ProviderNumber = MD.ProviderNumber
				AND FD.ReportingYear = MD.LatestReportingYear
				AND FD.LearnRefNumber = MD.LearnRefNumber
				AND FD.LearningAimCode = MD.LearningAimCode
				AND COALESCE ( FD.StandardCode, 0 ) = COALESCE ( MD.StandardCode, 0 )
				AND COALESCE ( FD.FrameworkCode, 0 ) = COALESCE ( MD.FrameworkCode, 0 )
				AND COALESCE ( FD.PathwayCode, 0 ) = COALESCE ( MD.PathwayCode, 0 )
				AND COALESCE ( FD.OriginalStartDate, FD.StartDate ) = MD.StartDate
				AND FD.LearnerAndAimRowNum = MD.LearnerAndAimRowNum
				AND FD.CompletionStatusCode <> ''6''';

		SET @SQLParams = 
			N'@AcademicYear VARCHAR(5),
			@ProviderNumber INT,
			@CurrentAcademicYear VARCHAR(5),
			@SixYearsAgo VARCHAR(5),
			@LatestImportedFileAcademicYear VARCHAR(5) OUTPUT,
			@LatestImportedFileILRReturnDate DATETIME OUTPUT,
			@LatestImportedFileILRReturn VARCHAR(3) OUTPUT,
			@LatestImportedFileIsFinalReturn BIT OUTPUT';

		EXECUTE sp_executesql 
			@SQLString, 
			@SQLParams,
			@AcademicYear = @AcademicYear,
			@ProviderNumber = @ProviderNumber,
			@CurrentAcademicYear = @CurrentAcademicYear,
			@SixYearsAgo = @SixYearsAgo,
			@LatestImportedFileAcademicYear = @LatestImportedFileAcademicYear,
			@LatestImportedFileILRReturnDate = @LatestImportedFileILRReturnDate,
			@LatestImportedFileILRReturn = @LatestImportedFileILRReturn,
			@LatestImportedFileIsFinalReturn = @LatestImportedFileIsFinalReturn;

		SET @Message = N'Number Of Records Included In QAR Measures Across All Years for ' + @ProviderName + ': ' + CAST ( @@ROWCOUNT AS VARCHAR(50) );
		RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;
	END

	SET @Message = N'Finishing Operation at ' + FORMAT ( SYSDATETIME(), 'dd/MM/yyyy HH:mm:ss' );
	RAISERROR ( @Message, 10, 1 ) WITH NOWAIT;
END