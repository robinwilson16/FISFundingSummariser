/*
Changes since 24/25
Apprenticeship Framework and Pathway Fields Removed
*/

CREATE OR ALTER PROCEDURE dbo.SPR_FIS_FundingData_2526
	@FISDatabase NVARCHAR(50),
	@AcademicYear NVARCHAR(5),
	@ILRReturn NVARCHAR(3),
	@IsFinalReturn BIT,
	@Split1619Funding BIT,
	@Reapportion1619FundingByAimWeighting BIT,
	@AppsMoveFundingToMainComponentAim BIT,
	@1619ALSFundingPercent DECIMAL(5,2),
	@IncludeHEAdvLoanPossibleIncome BIT,
	@IncludeAdvLoanBursaryIncome BIT,
	@FutureAchievementWeighting DECIMAL(3,2),
	@EnglishMathsFundingHigherRate INT,
	@EnglishMathsFundingLowerRate INT,
	@AdvancedMathsPremiumFundingRate INT,
	@CoreMathsPremiumFundingRate INT,
	@Block2DisadvFundingTLevelRate INT,
	@Block2DisadvFundingHigherRate INT,
	@Block2DisadvFundingLowerRate INT,
	@HighValueCoursesPremiumFundingRate INT,
	@ConditionOfFundingAdjustment INT,
	@IndustryPlacementFullFundingRate INT,
	@LargeProgramme10PercentUpliftNumLearners INT,
	@LargeProgramme10PercentUpliftAmount INT,
	@LargeProgramme20PercentUpliftNumLearners INT,
	@LargeProgramme20PercentUpliftAmount INT,
	@Mode NCHAR(1),
	@FISOutputTableLocation NVARCHAR(200),
	@FISOutputTableName NVARCHAR(200),
	@ProvSpecDelMonCourseLocation1 NCHAR(1),
	@ProvSpecDelMonCourseLocation2 NCHAR(1),
	@ProvSpecDelMonCourseSeperator NVARCHAR(50),
	@ProvSpecDelMonParentCourseLocation1 NCHAR(1),
	@ProvSpecDelMonParentCourseLocation2 NCHAR(1),
	@ProvSpecDelMonParentCourseSeperator NVARCHAR(50),
	@EnglishCollegeLevel1Code NVARCHAR(50),
	@EnglishCollegeLevel2Code NVARCHAR(50),
	@EnglishCollegeLevel3Code NVARCHAR(50),
	@EnglishCollegeLevel4Code NVARCHAR(50),
	@MathsCollegeLevel1Code NVARCHAR(50),
	@MathsCollegeLevel2Code NVARCHAR(50),
	@MathsCollegeLevel3Code NVARCHAR(50),
	@MathsCollegeLevel4Code NVARCHAR(50),
	@PartnerCollegeLevel1Code NVARCHAR(50),
	@PartnerCollegeLevel2Code NVARCHAR(50),
	@PartnerCollegeLevel3Code NVARCHAR(50),
	@PartnerCollegeLevel4Code NVARCHAR(50)
AS
BEGIN
	SET XACT_ABORT, NOCOUNT ON;

	/*
	/**************************************************
	 * Change/check values each time an import is run *
	 **************************************************/

	-- CHANGE THIS TO CORRECT RETURN
	DECLARE @ILRReturn NVARCHAR(3) = 'R03' 

	-- IF FINAL RETURN SET THIS TO 1 - ensure only 1 return for each month is set to 1 for accurate year on year reporting
	DECLARE @IsFinalReturn BIT = 1



	/***********************************************************************************
	 * Change values each year/month such as if ILR database is created as ILR2526_RXX *
	 ***********************************************************************************/

	--Name of the database created by the FIS software (default is ILRXXYY where XXYY is the return year)
	DECLARE @FISDatabase NVARCHAR(100) = 'ILR2526' 

	--Academic year used for reporting outputs (e.g. XX/YY)
	DECLARE @AcademicYear NVARCHAR(5) = '25/26' 



	/************************************************************
	 * Once set up values below should generally not be changed *
	 ************************************************************/

	--Split the funding into the 12 periods (default is 0 - 1 or 0)
	DECLARE @Split1619Funding BIT = 0 

	--Reapportion the 16-19 funding by the aim prog weighting factor (default is 0 - 1 or 0)
	DECLARE @Reapportion1619FundingByAimWeighting BIT = 0 

	--Move Apps Funding from Main ZProg to Main Component Aim so aim level fields can be used such as SSA (default is 1 - 1 or 0)
	DECLARE @AppsMoveFundingToMainComponentAim BIT = 1 

	--Deduct this percent from Total Cash Earned for FM25 and assign to ALS column (default is 0 - 1 or 0)
	DECLARE @1619ALSFundingPercent DECIMAL(5,2) = 0 

	--HE Gross Fee is only achieved if at all 3 SLC census points learners remain current (default is 0 - 1 or 0)
	DECLARE @IncludeHEAdvLoanPossibleIncome BIT = 0 

	--Adv Loan bursary income is not income as goes to learners so may want to exclude (default is 0 - 1 or 0)
	DECLARE @IncludeAdvLoanBursaryIncome BIT = 0 

	--Future achievement weighting factor. If 1 then is 100% of all remaining ach monies (default is 0 - decimal value)
	DECLARE @FutureAchievementWeighting DECIMAL(5,2) = 1

	--English and Maths Funding Rates from Allocation Statement
	DECLARE @EnglishMathsFundingHigherRate INT = 0
	DECLARE @EnglishMathsFundingLowerRate INT = 0

	--Core Maths Funding Rate from Allocation Statement
	DECLARE @CoreMathsPremiumFundingRate INT = 0

	--Block 2 Disadvantage Funding Rates from Allocation Statement
	DECLARE @Block2DisadvFundingTLevelRate INT = 0
	DECLARE @Block2DisadvFundingHigherRate INT = 0
	DECLARE @Block2DisadvFundingLowerRate INT = 0

	--Higher Value ourse Premium Funding Rate from Allocation Statement
	--List of Quals at: 
	--https://www.gov.uk/government/publications/qualifications-attracting-high-value-courses-premium
	DECLARE @HighValueCoursesPremiumFundingRate INT = 0

	--Insert new ILR return data leaving existing data from other imported returns or clear out table and replace (default is I for Insert, R = Replace)
	DECLARE @Mode NCHAR(1) = 'I' 

	--Database to store the summarised table generated by this script (for a linked server use SERVER.DATABASE.SCHEMA (e.g. missrv.misdb.dbo.)
	DECLARE @FISOutputTableLocation NVARCHAR(200) = 'FISFundingSummariser.dbo.' 

	--Table to create/insert data into
	DECLARE @FISOutputTableName NVARCHAR(200) = 'FIS_FundingData'

	--Provider field/s where the course code is stored in your ILR data (if spread across 2 fields enter values for first and second, if stored in 1 leave second NULL)
	DECLARE @ProvSpecDelMonCourseLocation1 NCHAR(1) = 'A'
	DECLARE @ProvSpecDelMonCourseLocation2 NCHAR(1) = 'B'

	--Seperator used between two fields listed above to form the full unique course code (default is blank, only relevant if 2 locations specified for course code)
	DECLARE @ProvSpecDelMonCourseSeperator NVARCHAR(50) = '-'

	--Provider field/s where the parent/programme course is stored to facilitate grouping aims by the programme
	DECLARE @ProvSpecDelMonParentCourseLocation1 NCHAR(1) = NULL
	DECLARE @ProvSpecDelMonParentCourseLocation2 NCHAR(1) = NULL

	--Seperator used between two fields listed above to form the full unique parent/programme course code (default is blank, only relevant if 2 locations specified for parent/programme course code)
	DECLARE @ProvSpecDelMonParentCourseSeperator NVARCHAR(50) = NULL

	--Custom codes for overriding the different levels of structure to move English under that area and out of other curriculum areas
	DECLARE @EnglishCollegeLevel1Code NVARCHAR(50) = NULL
	DECLARE @EnglishCollegeLevel2Code NVARCHAR(50) = NULL
	DECLARE @EnglishCollegeLevel3Code NVARCHAR(50) = NULL
	DECLARE @EnglishCollegeLevel4Code NVARCHAR(50) = NULL

	--Custom codes for overriding the different levels of structure to move Maths under that area and out of other curriculum areas
	DECLARE @MathsCollegeLevel1Code NVARCHAR(50) = NULL
	DECLARE @MathsCollegeLevel2Code NVARCHAR(50) = NULL
	DECLARE @MathsCollegeLevel3Code NVARCHAR(50) = NULL
	DECLARE @MathsCollegeLevel4Code NVARCHAR(50) = NULL

	--Custom codes for overriding the different levels of structure to move franchised out delivery under that area and out of other curriculum areas
	DECLARE @PartnerCollegeLevel1Code NVARCHAR(50) = NULL
	DECLARE @PartnerCollegeLevel2Code NVARCHAR(50) = NULL
	DECLARE @PartnerCollegeLevel3Code NVARCHAR(50) = NULL
	DECLARE @PartnerCollegeLevel4Code NVARCHAR(50) = NULL

	--Calculate which records should be included in QAR measures for each year (replicates what Strata or ProAchieve would do)
	DECLARE @RunQARCalculation BIT = 1 

	--Anonymise ILR data
	DECLARE @AnonymiseData BIT = 0 
	*/

	DECLARE @SQLString NVARCHAR(MAX);
    DECLARE @SQLParams NVARCHAR(MAX);

	SET @SQLString = 
        N'
		DROP TABLE IF EXISTS #LearningAims;
		SELECT
			AIM.SSA1Code,
			AIM.SSA1Name,
			AIM.SSA2Code,
			AIM.SSA2Name,
			AIM.LearningAimCode,
			AIM.LearningAimTitle,
			AIM.LearningAimTypeCode,
			AIM.LearningAimTypeName,
			AIM.NVQLevelCode,
			AIM.NVQLevelName,
			AIM.NVQLevelOrder,
			AIM.IsMathsAndEnglish,
			AIM.AwardBodyCode
		INTO #LearningAims
		FROM VW_FIS_LearningAims AIM

		DROP TABLE IF EXISTS #CollegeStructure;
		SELECT
			CS.AcademicYear,
			CS.ProvSpecValue,
			CS.CourseCode,
			CS.CourseInstance,
			CS.CourseTitle,
			CS.CollegeLevel1Code,
			CS.CollegeLevel1Name,
			CS.CollegeLevel2Code,
			CS.CollegeLevel2Name,
			CS.CollegeLevel3Code,
			CS.CollegeLevel3Name,
			CS.CollegeLevel4Code,
			CS.CollegeLevel4Name
		INTO #CollegeStructure
		FROM VW_FIS_CollegeStructure CS
		WHERE
			CS.AcademicYear = @AcademicYear

		DROP TABLE IF EXISTS #CourseHours;
		SELECT
			HRS.AcademicYear,
			HRS.ProvSpecValue,
			HRS.CourseCode,
			HRS.PlannedHours,
			HRS.EEPHours,
			HRS.TLevelHours
		INTO #CourseHours
		FROM VW_FIS_CourseHours HRS
		WHERE
			HRS.AcademicYear = @AcademicYear

		DROP TABLE IF EXISTS #Employers;
		SELECT
			EMP.EmployerEDRS,
			EMP.EmployerName
		INTO #Employers
		FROM VW_FIS_Employers EMP

		DROP TABLE IF EXISTS #Partners;
		SELECT
			PAR.PartnerUKPRN,
			PAR.PartnerName
		INTO #Partners
		FROM VW_FIS_Partners PAR

		DROP TABLE IF EXISTS #Providers;
		SELECT
			PROV.ProviderUKPRN,
			PROV.ProviderName
		INTO #Providers
		FROM VW_FIS_Providers PROV

		DROP TABLE IF EXISTS #Standards;
		SELECT
			STD.StandardCode,
			STD.StandardName
		INTO #Standards
		FROM VW_FIS_Standards STD

		DROP TABLE IF EXISTS #PostCodes;
		SELECT
			PC.PostCode,
			PC.WardCode,
			PC.WardName,
			PC.DistrictCode,
			PC.DistrictName,
			PC.LEACode,
			PC.LEAName,
			PC.SourceOfFunding,
			PC.DisadvUplift
		INTO #PostCodes
		FROM VW_FIS_PostCodes PC

		DROP TABLE IF EXISTS #PriorLevels;
		SELECT
			PLEV.Code,
			PLEV.Description
		INTO #PriorLevels
		FROM VW_FIS_PriorLevels PLEV

		DROP TABLE IF EXISTS #Ethnicities;
		SELECT
			ETH.Code,
			ETH.Description
		INTO #Ethnicities
		FROM VW_FIS_Ethnicities ETH

		DROP TABLE IF EXISTS #Disabilities;
		SELECT
			DIS.Code,
			DIS.Description
		INTO #Disabilities
		FROM VW_FIS_Disabilities DIS

		DROP TABLE IF EXISTS #HighValueCourses;
		SELECT
			HVC.LearnAimRef
		INTO #HighValueCourses
		FROM VW_FIS_HighValueCourses HVC
		WHERE
			HVC.AcademicYear = @AcademicYear

		DROP TABLE IF EXISTS #AdvancedMathsPremium;
		SELECT
			AMP.LearnAimRef
		INTO #AdvancedMathsPremium
		FROM VW_FIS_AdvancedMathsPremium AMP
		WHERE
			AMP.AcademicYear = @AcademicYear
	'

	SET @SQLString += 
        N'
		--Apps - Get the most recent period details where the App was funded
		DROP TABLE IF EXISTS #FM36Periods
		SELECT
			LearnRefNumber = LD.LearnRefNumber,
			AimSeqNumber = LD.AimSeqNumber,
			LearnAimRef = LD.LearnAimRef,
			FundModel = LD.FundModel,
			StdCode = COALESCE ( LD.StdCode, 0 ),
			ProgType = LD.ProgType,
			FundLine = FM36P.FundLineType,
			InitialFundLine = FM36.LearnDelInitialFundLineType,
			Period = FM36P.Period,
			RowNumStandard = 
				ROW_NUMBER () OVER (
					PARTITION BY
						FM36.LearnRefNumber,
						COALESCE ( LD.StdCode, 0 ),
						LD.ProgType
					ORDER BY
						CASE
							WHEN FM36P.FundLineType = ''None'' THEN 2
							ELSE 1
						END,
						CASE
							WHEN FM36.LearnDelInitialFundLineType = ''None'' THEN 2
							ELSE 1
						END,
						FM36P.Period DESC
				),
			RowNumAimSeq = 
				ROW_NUMBER () OVER (
					PARTITION BY
						FM36.LearnRefNumber,
						FM36.AimSeqNumber
					ORDER BY
						CASE
							WHEN FM36P.FundLineType = ''None'' THEN 2
							ELSE 1
						END,
						FM36P.Period DESC
				)
			INTO #FM36Periods
		FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
		INNER JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
			ON FM36.LearnRefNumber = LD.LearnRefNumber
			AND FM36.AimSeqNumber = LD.AimSeqNumber
		INNER JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery_Period FM36P
			ON FM36P.LearnRefNumber = FM36.LearnRefNumber
			AND FM36P.AimSeqNumber = FM36.AimSeqNumber
	'

	SET @SQLString += 
        N'
		--Funding Model 25 Learner Starts
		DROP TABLE IF EXISTS #FM25LearnerStarts
		SELECT
			L.LearnRefNumber,
			CountAsStart = 
				CASE
					WHEN DUR.ActiveAims > 0 THEN 1
					WHEN 
						-- Very Short
						DATEDIFF ( d, DUR.LearnStartDate, DUR.LearnPlanEndDate ) + 1 < 14 -- Course duration less than 2 weeks
						AND (
							DATEDIFF ( d, DUR.LearnStartDate, DUR.LearnActEndDate ) + 1 > 0 -- Studied at all
						)
						THEN 0 -- No longer counted as per QAR rules
					WHEN 
						-- Short
						DATEDIFF ( d, DUR.LearnStartDate, DUR.LearnPlanEndDate ) + 1 < 168 -- Course duration less than 24 weeks
						AND (
							DATEDIFF ( d, DUR.LearnStartDate, DUR.LearnActEndDate ) + 1 >= 14 -- Studied at least 2 weeks
						)
						THEN 1
					WHEN 
						-- Long
						DATEDIFF ( d, DUR.LearnStartDate, DUR.LearnPlanEndDate ) + 1 >= 168 -- Course duration 24 weeks +
						AND (
							DATEDIFF ( d, DUR.LearnStartDate, DUR.LearnActEndDate ) + 1 >= 42 -- Studied at least 6 weeks
						)
						THEN 1
					ELSE 0
				END
			INTO #FM25LearnerStarts
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN (
			SELECT
				L.LearnRefNumber,
				ActiveAims = SUM ( CASE WHEN LD.CompStatus IN ( 1, 2 ) THEN 1 ELSE 0 END ),
				NonActiveAims = SUM ( CASE WHEN LD.CompStatus IN ( 3, 4, 6 ) THEN 1 ELSE 0 END ),
				LearnStartDate = MIN ( LD.LearnStartDate ),
				LearnPlanEndDate = MAX ( LD.LearnPlanEndDate ),
				LearnActEndDate = MAX ( LD.LearnActEndDate )
			FROM ' + @FISDatabase + '.Valid.Learner L
			INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
				ON LD.LearnRefNumber = L.LearnRefNumber
			WHERE
				LD.FundModel = 25
			GROUP BY
				L.LearnRefNumber
		) DUR
			ON DUR.LearnRefNumber = L.LearnRefNumber
	'

	SET @SQLString += 
        N'
		--Check If Core Aim Learners Who Transferred moved to Something Else
		DROP TABLE IF EXISTS #ExclusionsCoreAims
		SELECT
			L.LearnRefNumber,
			LD.LearnAimRef,
			LD.AimSeqNumber,
			LD.CompStatus,
			ShouldBeExcluded = 
				CASE
					WHEN LDR.LearnRefNumber IS NOT NULL THEN 1
					ELSE 0
				END,
			RowNum = 
				ROW_NUMBER () OVER (
					PARTITION BY
						L.LearnRefNumber,
						LD.AimSeqNumber
					ORDER BY
						CASE
							WHEN
								( LD.CompStatus = 3 AND LD.WithdrawReason = 40 )
								OR LD.CompStatus = 4 THEN
								CASE
									WHEN LDR.LearnRefNumber IS NOT NULL THEN 1
									ELSE 0
								END
							WHEN LD.CompStatus = 6 THEN
								CASE
									WHEN LDR.LearnRefNumber IS NOT NULL THEN 1
									WHEN LD.LearnPlanEndDate <= GETDATE() THEN 1
									ELSE 0
								END
							ELSE 0
						END DESC,
						LDR.AimSeqNumber
				)
			INTO #ExclusionsCoreAims
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		LEFT JOIN ' + @FISDatabase + '.Valid.LearningDelivery LDR
			ON LDR.LearnRefNumber = LD.LearnRefNumber
			AND LDR.AimType = LD.AimType
			AND LDR.AimSeqNumber > LD.AimSeqNumber
			--AND DATEDIFF ( DAY, LD.LearnActEndDate, LDR.LearnStartDate ) <= 42
		WHERE
			LD.AimType = 5
			AND (
				( LD.CompStatus = 3 AND LD.WithdrawReason = 40 )
				OR LD.CompStatus = 4
			)
	'

	SET @SQLString += 
        N'
		--Check If Aims That Are Transferred Have a Restart Aim Of Same Learning Aim Type
		DROP TABLE IF EXISTS #ExclusionsNonReturnersTfer
		SELECT
			LearnRefNumber = L.LearnRefNumber,
			AimSeqNumber = LD.AimSeqNumber,
			CompStatus = LD.CompStatus,
			ShouldBeExcluded = 
				CASE
					WHEN RET.LearnRefNumber IS NOT NULL THEN 1
					WHEN COALESCE ( FM38.FundStart, FM35.FundStart ) = 0 THEN 1
					WHEN
						AIM.LearningAimTypeCode IN (
							''0003'' --GCSE and FS Treated as The Same
						) THEN
							CASE
								WHEN 
									-- Very Short
									DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 14 -- Course duration less than 2 weeks
									AND (
										DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 > 0 -- Studied at all
									)
									THEN 1 -- No longer counted as per QAR rules
								WHEN 
									-- Short
									DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 168 -- Course duration less than 24 weeks
									AND (
										DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 >= 14 -- Studied at least 2 weeks
									)
									THEN 0
								WHEN 
									-- Long
									DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 >= 168 -- Course duration 24 weeks +
									AND (
										DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 >= 42 -- Studied at least 6 weeks
									)
									THEN 0
								ELSE 1
							END
					WHEN
						AIM.LearningAimTypeCode NOT IN (
							''0003'' --GCSE and FS Treated as The Same
						) THEN
						CASE
							WHEN DUR.CountAsStart = 0 THEN 1
							ELSE 0
						END
					ELSE 0
				END,
			RowNum = 
				ROW_NUMBER () OVER (
					PARTITION BY
						L.LearnRefNumber,
						LD.AimSeqNumber
					ORDER BY
						CASE
							WHEN RET.LearnRefNumber IS NOT NULL THEN 1
							ELSE 0
						END DESC,
						RET.AimSeqNumber
				)
			INTO #ExclusionsNonReturnersTfer
	'

	SET @SQLString += 
        N'
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		INNER JOIN #LearningAims AIM
			ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
		LEFT JOIN #FM25LearnerStarts DUR
			ON DUR.LearnRefNumber = L.LearnRefNumber
		--ASF (Adult Skills Fund)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM38_LearningDelivery FM38
			ON FM38.LearnRefNumber = LD.LearnRefNumber
			AND FM38.AimSeqNumber = LD.AimSeqNumber
		--AEB (Adult Education Budget) and Legacy Apps
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
			ON FM35.LearnRefNumber = LD.LearnRefNumber
			AND FM35.AimSeqNumber = LD.AimSeqNumber
		LEFT JOIN (
			SELECT
				LearnRefNumber = L.LearnRefNumber,
				LearnAimRef = LD.LearnAimRef,
				AimSeqNumber = LD.AimSeqNumber,
				StartDate = LD.LearnStartDate,
				CompStatus = LD.CompStatus
			FROM ' + @FISDatabase + '.Valid.Learner L
			INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
				ON LD.LearnRefNumber = L.LearnRefNumber
			LEFT JOIN #LearningAims AIM
				ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
		) RET
			ON RET.LearnRefNumber = LD.LearnRefNumber
			AND RET.AimSeqNumber > LD.AimSeqNumber
			AND ( --Transfer Within 120 Days Or Any Date To Same Aim
				(
					DATEDIFF ( DAY, CAST ( LD.LearnActEndDate AS DATE ), CAST ( RET.StartDate AS DATE ) ) >= 0
					AND DATEDIFF ( DAY, CAST ( LD.LearnActEndDate AS DATE ), CAST ( RET.StartDate AS DATE ) ) <= 120
				)
				OR RET.LearnAimRef = LD.LearnAimRef
			)
		WHERE
			(
				( LD.CompStatus = 3 AND LD.WithdrawReason = 40 )
				OR LD.CompStatus = 4
			)
			--AND L.LearnRefNumber = ''F246776''
	'

	SET @SQLString += 
        N'
		--Apps Must Transfer to Another App Otherwise Are Not Excluded As Per QAR Rules
		DROP TABLE IF EXISTS #ExclusionsNonReturnersTferApp
		SELECT
			LearnRefNumber = L.LearnRefNumber,
			AimSeqNumber = LD.AimSeqNumber,
			CompStatus = LD.CompStatus,
			ShouldBeExcluded = 
				CASE
					WHEN RET.LearnRefNumber IS NOT NULL THEN 1
					WHEN DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 14 --Very Short
						THEN 1
					WHEN 
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 168 --Short
						AND DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 < 14
						THEN 1
					WHEN 
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 >= 168 --Long
						AND DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 < 42
						THEN 1
					ELSE 0
				END,
			RowNum = 
				ROW_NUMBER () OVER (
					PARTITION BY
						L.LearnRefNumber,
						LD.AimSeqNumber
					ORDER BY
						CASE
							WHEN RET.LearnRefNumber IS NOT NULL THEN 1
							ELSE 0
						END DESC,
						RET.AimSeqNumber
				)
			INTO #ExclusionsNonReturnersTferApp
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		LEFT JOIN #LearningAims AIM
			ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
		LEFT JOIN (
			SELECT
				LearnRefNumber = L.LearnRefNumber,
				LearnAimRef = LD.LearnAimRef,
				AimSeqNumber = LD.AimSeqNumber,
				StartDate = LD.LearnStartDate,
				CompStatus = LD.CompStatus
			FROM ' + @FISDatabase + '.Valid.Learner L
			INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
				ON LD.LearnRefNumber = L.LearnRefNumber
			LEFT JOIN #LearningAims AIM
				ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
			WHERE
				(
					LD.FundModel = 36
					OR ( LD.FundModel = 35 AND LD.ProgType IS NOT NULL )
				)
		) RET
			ON RET.LearnRefNumber = LD.LearnRefNumber
			AND RET.AimSeqNumber > LD.AimSeqNumber
			AND DATEDIFF ( DAY, CAST ( LD.LearnActEndDate AS DATE ), CAST ( RET.StartDate AS DATE ) ) <= 120
		WHERE
			(
				( LD.CompStatus = 3 AND LD.WithdrawReason = 40 )
				OR LD.CompStatus = 4
			)
			AND (
				LD.FundModel = 36
				OR ( LD.FundModel = 35 AND LD.ProgType IS NOT NULL )
			)
	'

	SET @SQLString += 
        N'
		--Check If Aims That Are Breaks in Learning Without a Restart Aim
		DROP TABLE IF EXISTS #ExclusionsNonReturnersBreaks
		SELECT
			LearnRefNumber = L.LearnRefNumber,
			AimSeqNumber = LD.AimSeqNumber,
			CompStatus = LD.CompStatus,
			ShouldBeExcluded = 
				CASE
					WHEN LDR.LearnRefNumber IS NOT NULL THEN 1
					WHEN LD.LearnPlanEndDate <= GETDATE() THEN 1
					WHEN DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 14 --Very Short
						THEN 1
					WHEN 
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 168 --Short
						AND DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 < 14
						THEN 1
					WHEN 
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 >= 168 --Long
						AND DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 < 42
						THEN 1
					ELSE 0
				END,
			RowNum = 
				ROW_NUMBER () OVER (
					PARTITION BY
						L.LearnRefNumber,
						LD.AimSeqNumber
					ORDER BY
						CASE
							WHEN LDR.LearnRefNumber IS NOT NULL THEN 1
							WHEN LD.LearnPlanEndDate <= GETDATE() THEN 1
							ELSE 0
						END DESC,
						LDR.AimSeqNumber
				)
			INTO #ExclusionsNonReturnersBreaks
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		LEFT JOIN ' + @FISDatabase + '.Valid.LearningDelivery LDR
			ON LDR.LearnRefNumber = LD.LearnRefNumber
			AND LDR.LearnAimRef = LD.LearnAimRef
			AND LDR.AimSeqNumber > LD.AimSeqNumber
		WHERE
			LD.LearnAimRef <> ''ZPROG001''
			AND LD.CompStatus = 6
			--AND L.LearnRefNumber = ''F246776''
	'

	SET @SQLString += 
        N'
		--Establish the Fund Model of the aim
		DROP TABLE IF EXISTS #FundModelType
		SELECT
			L.LearnRefNumber,
			LD.AimSeqNumber,
			AIM.NVQLevelCode,
			FundLineCategory = 
				CASE
					WHEN FM25.FundLine IS NOT NULL THEN ''16-19 Funding''
					WHEN FMALB.AdvLoan = 1 THEN ''Advanced Learner Loan''
					WHEN FM38.FundLine LIKE ''%Adult Skills Fund%'' THEN ''Adult Skills Fund''
					WHEN FM35.FundLine LIKE ''%Adult Skills Fund%'' THEN ''Adult Skills Fund''
					WHEN FM35.FundLine LIKE ''%AEB - Adult Skills%'' THEN ''Adult Education Budget''
					WHEN FM36PMO.FundLine LIKE ''%Apprenticeship%'' THEN ''Apprenticeships''
					WHEN FM36PMO.InitialFundLine LIKE ''%Apprenticeship%'' THEN ''Apprenticeships''
					WHEN FM36PM.FundLine LIKE ''%Apprenticeship%'' THEN ''Apprenticeships''
					WHEN FM36PM.InitialFundLine LIKE ''%Apprenticeship%'' THEN ''Apprenticeships''
					WHEN FM35.FundLine LIKE ''%Apprenticeship%'' THEN ''Apprenticeships''
					WHEN FMHE.MSTUFEE = 98 THEN ''Full Cost''
					WHEN FMHE.LearnRefNumber IS NOT NULL THEN ''Higher Education''
					WHEN LD.FundModel = 99 THEN ''Full Cost''
					WHEN LD.ProgType = 30 THEN ''16-19 Funding''
					WHEN LD.ProgType = 31 THEN ''16-19 Funding''
					WHEN LD.ProgType = 32 THEN ''Skills Bootcamps''
					ELSE ''Full Cost''
				END,
			FundLineCategoryOrder = 
				CASE
					WHEN FM25.FundLine IS NOT NULL THEN 1
					WHEN FMALB.AdvLoan = 1 THEN 4
					WHEN FM38.FundLine LIKE ''%Adult Skills Fund%'' THEN 2
					WHEN FM35.FundLine LIKE ''%Adult Skills Fund%'' THEN 2
					WHEN FM35.FundLine LIKE ''%AEB - Adult Skills%'' THEN 3
					WHEN FM36PMO.FundLine LIKE ''%Apprenticeship%'' THEN 5
					WHEN FM36PMO.InitialFundLine LIKE ''%Apprenticeship%'' THEN 5
					WHEN FM36PM.FundLine LIKE ''%Apprenticeship%'' THEN 5
					WHEN FM36PM.InitialFundLine LIKE ''%Apprenticeship%'' THEN 5
					WHEN FM35.FundLine LIKE ''%Apprenticeship%'' THEN 5
					WHEN FMHE.MSTUFEE = 98 THEN 7
					WHEN FMHE.LearnRefNumber IS NOT NULL THEN 6
					WHEN LD.FundModel = 99 THEN 7
					WHEN LD.ProgType = 30 THEN 1
					WHEN LD.ProgType = 31 THEN 1
					WHEN LD.ProgType = 32 THEN 8
					ELSE 7
				END,
			FundLineSubCategory = 
				CASE
					WHEN FM25.FundLine IS NOT NULL AND LD.ProgType IS NULL THEN ''Study Programmes''
					WHEN FM25.FundLine IS NOT NULL AND LD.ProgType IS NOT NULL THEN ''T Levels''
					WHEN FMALB.AdvLoan = 1 THEN ''Advanced Learner Loan''
					WHEN FM38.FundLine LIKE ''%Adult Skills Fund%'' AND FM38.FundLine LIKE ''%ESFA%'' THEN ''DFE - '' + FM38.LearnDelFundOrgCode
					WHEN FM38.FundLine LIKE ''%Adult Skills Fund%'' AND FM38.FundLine NOT LIKE ''%ESFA%'' THEN ''Devolved - '' + FM38.LearnDelFundOrgCode
					WHEN FM35.FundLine LIKE ''%Adult Skills Fund%'' AND FM35.FundLine LIKE ''%ESFA%'' THEN ''DFE - '' + FM35.LearnDelFundOrgCode
					WHEN FM35.FundLine LIKE ''%Adult Skills Fund%'' AND FM35.FundLine NOT LIKE ''%ESFA%'' THEN ''Devolved - '' + FM35.LearnDelFundOrgCode
					WHEN FM35.FundLine LIKE ''%AEB - Adult Skills%'' AND FM35.FundLine LIKE ''%ESFA%'' THEN ''DFE - '' + FM35.LearnDelFundOrgCode
					WHEN FM35.FundLine LIKE ''%AEB - Adult Skills%'' AND FM35.FundLine NOT LIKE ''%ESFA%'' THEN ''Devolved - '' + FM35.LearnDelFundOrgCode
					WHEN FM36PMO.FundLine LIKE ''%16-18 Apprenticeship%'' THEN ''16-18 Apprenticeships''
					WHEN FM36PMO.InitialFundLine LIKE ''%16-18 Apprenticeship%'' THEN ''16-18 Apprenticeships''
					WHEN FM36PM.FundLine LIKE ''%16-18 Apprenticeship%'' THEN ''16-18 Apprenticeships''
					WHEN FM36PM.InitialFundLine LIKE ''%16-18 Apprenticeship%'' THEN ''16-18 Apprenticeships''
					WHEN FM35.FundLine LIKE ''%16-18 Apprenticeship%'' THEN ''16-18 Apprenticeships''
					WHEN FM36PMO.FundLine LIKE ''%19+ Apprenticeship%'' THEN ''19+ Apprenticeships''
					WHEN FM36PMO.InitialFundLine LIKE ''%19+ Apprenticeship%'' THEN ''19+ Apprenticeships''
					WHEN FM36PM.FundLine LIKE ''%19+ Apprenticeship%'' THEN ''19+ Apprenticeships''
					WHEN FM36PM.InitialFundLine LIKE ''%19+ Apprenticeship%'' THEN ''19+ Apprenticeships''
					WHEN FM35.FundLine LIKE ''%19+ Apprenticeship%'' THEN ''19+ Apprenticeships''
					WHEN FMHE.MSTUFEE = 98 THEN ''Full Cost''
					WHEN FMHE.LearnRefNumber IS NOT NULL THEN ''Higher Education''
					WHEN LD.FundModel = 99 THEN ''Full Cost''
					WHEN LD.ProgType = 30 THEN ''T Levels''
					WHEN LD.ProgType = 31 THEN ''T Levels''
					WHEN LD.ProgType = 32 THEN ''Skills Bootcamps''
					ELSE ''Full Cost''
				END,
			FundLineSubCategoryOrder = 
				CASE
					WHEN FM25.FundLine IS NOT NULL AND LD.ProgType IS NULL THEN 1
					WHEN FM25.FundLine IS NOT NULL AND LD.ProgType IS NOT NULL THEN 2
					WHEN FMALB.AdvLoan = 1 THEN 1
					WHEN FM38.FundLine LIKE ''%Adult Skills Fund%'' AND FM38.FundLine LIKE ''%ESFA%'' THEN 1
					WHEN FM38.FundLine LIKE ''%Adult Skills Fund%'' AND FM38.FundLine NOT LIKE ''%ESFA%'' THEN 2
					WHEN FM35.FundLine LIKE ''%Adult Skills Fund%'' AND FM35.FundLine LIKE ''%ESFA%'' THEN 1
					WHEN FM35.FundLine LIKE ''%Adult Skills Fund%'' AND FM35.FundLine NOT LIKE ''%ESFA%'' THEN 2
					WHEN FM35.FundLine LIKE ''%AEB - Adult Skills%'' AND FM35.FundLine LIKE ''%ESFA%'' THEN 1
					WHEN FM35.FundLine LIKE ''%AEB - Adult Skills%'' AND FM35.FundLine NOT LIKE ''%ESFA%'' THEN 2
					WHEN FM36PMO.FundLine LIKE ''%16-18 Apprenticeship%'' THEN 1
					WHEN FM36PMO.InitialFundLine LIKE ''%16-18 Apprenticeship%'' THEN 1
					WHEN FM36PM.FundLine LIKE ''%16-18 Apprenticeship%'' THEN 1
					WHEN FM36PM.InitialFundLine LIKE ''%16-18 Apprenticeship%'' THEN 1
					WHEN FM35.FundLine LIKE ''%16-18 Apprenticeship%'' THEN 1
					WHEN FM36PMO.FundLine LIKE ''%19+ Apprenticeship%'' THEN 2
					WHEN FM36PMO.InitialFundLine LIKE ''%19+ Apprenticeship%'' THEN 2
					WHEN FM36PM.FundLine LIKE ''%19+ Apprenticeship%'' THEN 2
					WHEN FM36PM.InitialFundLine LIKE ''%19+ Apprenticeship%'' THEN 2
					WHEN FM35.FundLine LIKE ''%19+ Apprenticeship%'' THEN 2
					WHEN FMHE.MSTUFEE = 98 THEN 1
					WHEN FMHE.LearnRefNumber IS NOT NULL THEN 1
					WHEN LD.FundModel = 99 THEN 1
					WHEN LD.ProgType = 30 THEN 2
					WHEN LD.ProgType = 31 THEN 2
					WHEN LD.ProgType = 32 THEN 1
					ELSE 1
				END,
			FundLine = 
				COALESCE (
					FM25.FundLine,
					CASE WHEN FMALB.AdvLoan = 1 THEN ''Advanced Learner Loan'' END,
					CASE WHEN FM36PMO.FundLine = ''None'' THEN NULL ELSE FM36PMO.FundLine END,
					CASE WHEN FM36PMO.InitialFundLine = ''None'' THEN NULL ELSE FM36PMO.InitialFundLine END,
					CASE WHEN FM36PM.FundLine = ''None'' THEN NULL ELSE FM36PM.FundLine END,
					CASE WHEN FM36PM.InitialFundLine = ''None'' THEN NULL ELSE FM36PM.InitialFundLine END,
					FM38.FundLine,
					CASE WHEN FM35.FundLine = ''None'' AND LD.FundModel = 99 THEN ''Full Cost - Level 3 and Below'' END,
					CASE WHEN FM35.FundLine = ''None'' AND LD.ProgType = 30 THEN ''T Level Foundation Year'' END,
					CASE WHEN FM35.FundLine = ''None'' AND LD.ProgType = 31 THEN ''T Level programme'' END,
					FM35.FundLine,
					CASE WHEN FMHE.MSTUFEE = 98 THEN ''Full Cost - Level 4 and Above'' END,
					CASE WHEN FMHE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
					CASE WHEN LD.FundModel = 99 THEN ''Full Cost - Level 3 and Below'' END,
					CASE WHEN LD.ProgType = 30 THEN ''T Level Foundation Year'' END,
					CASE WHEN LD.ProgType = 31 THEN ''T Level programme'' END,
					CASE WHEN LD.ProgType = 32 THEN ''Skills Bootcamps'' END,
					''Full Cost - Level 3 and Below''
				),
	'

	SET @SQLString += 
        N'
			FundStart = COALESCE ( CASE WHEN LD.FundModel = 25 THEN HRS.IsFunded END, FM25.StartFund, FMALB.FundStart, FM38.FundStart, FM35.FundStart, FM36.FundStart, 0 ),
			CompStatus = LD.CompStatus,
			WithdrawReason = LD.WithdrawReason,
			Transfer = 
				CASE
					WHEN LD.CompStatus = 4 THEN 1
					WHEN 
						LD.CompStatus IN ( 3, 4 ) 
						AND COALESCE ( LD.WithdrawReason, 0 ) IN ( 40, 41 ) THEN 1
					ELSE 0
				END,
			TransferValid =
				CASE
					WHEN 
						LD.CompStatus = 4 THEN 
							CASE
								WHEN 
									EXCA.ShouldBeExcluded = 0
									OR EXNRT.ShouldBeExcluded = 0 
									OR EXNRTA.ShouldBeExcluded = 0 
									THEN 0
								ELSE 1
							END
					WHEN 
						LD.CompStatus IN ( 3, 4 ) 
						AND COALESCE ( LD.WithdrawReason, 0 ) IN ( 40, 41 ) THEN
							CASE
								WHEN 
									EXCA.ShouldBeExcluded = 0
									OR EXNRT.ShouldBeExcluded = 0 
									OR EXNRTA.ShouldBeExcluded = 0 
									THEN 0
								ELSE 1
							END
					ELSE 0
				END,
			BreakInLearning = 
				CASE
					WHEN LD.CompStatus = 6 THEN 1
					ELSE 0
				END,
			BreakInLearningValid = 
				CASE
					WHEN LD.CompStatus = 6 THEN
						CASE
							WHEN 
								EXCA.ShouldBeExcluded = 0
								OR EXNRB.ShouldBeExcluded = 0 
								THEN 0
							ELSE 1
						END
					ELSE 0
				END,
			UnknownOutcome = 
				CASE
					WHEN 
						LD.CompStatus = 2
						AND LD.Outcome = 8
						THEN 1
					ELSE 0
				END,
			UnknownOutcomeValid = 
				CASE
					WHEN 
						LD.CompStatus = 2
						AND LD.Outcome = 8 
						THEN
							CASE
								WHEN 
									DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 >= 42
									THEN 1
								ELSE 0
							END
					ELSE 0
				END,
			Duration = 
				CASE
					WHEN 
						-- Very Short
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 14 -- Course duration less than 2 weeks
						THEN ''Very Short'' -- No longer counted as per QAR rules
					WHEN 
						-- Short
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 168 -- Course duration 4-6 weeks
						THEN ''Short''
					WHEN 
						-- Long
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 >= 168 -- Course duration at least 24 weeks
						THEN ''Long''
					ELSE ''?''
				END,
	'

	SET @SQLString += 
        N'
			IsWithdrawnPreEligibility = 
				CASE
					WHEN LD.CompStatus <> 3 THEN 0
					WHEN COALESCE ( LD.WithdrawReason, 0 ) IN ( 40, 41 ) THEN 0
					WHEN 
						-- Very Short
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 14 -- Course duration less than 2 weeks
						AND (
							DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 > 0 -- Studied at all
						)
						THEN 1 -- No longer counted as per QAR rules
					WHEN 
						-- Short
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 168 -- Course duration less than 24 weeks
						AND (
							DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 >= 14 -- Studied at least 2 weeks
						)
						THEN 0
					WHEN 
						-- Long
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 >= 168 -- Course duration 24 weeks +
						AND (
							DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 >= 42 -- Studied at least 6 weeks
						)
						THEN 0
					ELSE 1
				END,
			IsWithdrawnPostEligibility = 
				CASE
					WHEN LD.CompStatus <> 3 THEN 0
					WHEN COALESCE ( LD.WithdrawReason, 0 ) IN ( 40, 41 ) THEN 0
					WHEN 
						-- Very Short
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 14 -- Course duration less than 2 weeks
						AND (
							DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 > 0 -- Studied at all
						)
						THEN 0 -- No longer counted as per QAR rules
					WHEN 
						-- Short
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 < 168 -- Course duration less than 24 weeks
						AND (
							DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 >= 14 -- Studied at least 2 weeks
						)
						THEN 1
					WHEN 
						-- Long
						DATEDIFF ( d, LD.LearnStartDate, LD.LearnPlanEndDate ) + 1 >= 168 -- Course duration 24 weeks +
						AND (
							DATEDIFF ( d, LD.LearnStartDate, LD.LearnActEndDate ) + 1 >= 42 -- Studied at least 6 weeks
						)
						THEN 1
					ELSE 0
				END
			INTO #FundModelType
	'

	SET @SQLString += 
        N'
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		--16-19
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
			ON FM25.LearnRefNumber = LD.LearnRefNumber
			AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
		--ASF (Adult Skills Fund)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM38_LearningDelivery FM38
			ON FM38.LearnRefNumber = LD.LearnRefNumber
			AND FM38.AimSeqNumber = LD.AimSeqNumber
		--AEB (Adult Education Budget) and Legacy Apps
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
			ON FM35.LearnRefNumber = LD.LearnRefNumber
			AND FM35.AimSeqNumber = LD.AimSeqNumber
		--Apps
		LEFT JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
			ON FM36.LearnRefNumber = LD.LearnRefNumber
			AND FM36.AimSeqNumber = LD.AimSeqNumber
		LEFT JOIN #FM36Periods FM36PM
			ON FM36PM.LearnRefNumber = FM36.LearnRefNumber
			AND FM36PM.AimSeqNumber = FM36.AimSeqNumber
			AND FM36PM.RowNumAimSeq = 1
		LEFT JOIN #FM36Periods FM36PMO
			ON FM36PMO.LearnRefNumber = LD.LearnRefNumber
			AND FM36PMO.StdCode = COALESCE ( LD.StdCode, 0 )
			AND FM36PMO.ProgType = LD.ProgType
			AND FM36PMO.RowNumStandard = 1
		--Loans
		LEFT JOIN ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery FMALB
			ON FMALB.LearnRefNumber = LD.LearnRefNumber
			AND FMALB.AimSeqNumber = LD.AimSeqNumber
		--HE
		LEFT JOIN ' + @FISDatabase + '.Valid.LearningDeliveryHE FMHE
			ON FMHE.LearnRefNumber = LD.LearnRefNumber
			AND FMHE.AimSeqNumber = LD.AimSeqNumber
		LEFT JOIN #LearningAims AIM
			ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
		LEFT JOIN #ExclusionsCoreAims EXCA
			ON EXCA.LearnRefNumber = LD.LearnRefNumber
			AND EXCA.AimSeqNumber = LD.AimSeqNumber
			AND EXCA.RowNum = 1
		LEFT JOIN #ExclusionsNonReturnersTfer EXNRT
			ON EXNRT.LearnRefNumber = LD.LearnRefNumber
			AND EXNRT.AimSeqNumber = LD.AimSeqNumber
			AND EXNRT.RowNum = 1
		LEFT JOIN #ExclusionsNonReturnersTfer EXNRTA
			ON EXNRTA.LearnRefNumber = LD.LearnRefNumber
			AND EXNRTA.AimSeqNumber = LD.AimSeqNumber
			AND EXNRTA.RowNum = 1
		LEFT JOIN #ExclusionsNonReturnersBreaks EXNRB
			ON EXNRB.LearnRefNumber = LD.LearnRefNumber
			AND EXNRB.AimSeqNumber = LD.AimSeqNumber
			AND EXNRB.RowNum = 1
	'

	SET @SQLString += 
        N'
		--FM25 for counting hours
		LEFT JOIN (
			SELECT
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ORD.RateBandOrder,
				TFerOnly = CASE WHEN ACT.LearnRefNumber IS NULL THEN 1 ELSE 0 END,
				PlannedHours = COALESCE ( SUM ( CH.PlannedHours ), 0 ),
				EEPHours = COALESCE ( SUM ( CH.EEPHours ), 0 ),
				TLevelHours = COALESCE ( SUM ( CH.TLevelHours ), 0 ),
				OnProgPayment = 
					MAX ( FM25.OnProgPayment )
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END,
				LearnSuppPayment = 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END,
				TotalEarnedCash = MAX ( FM25.OnProgPayment ),
				IsFunded = MAX ( CAST ( FM25.StartFund AS INT ) )
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
	'

	SET @SQLString += 
        N'
			LEFT JOIN #CourseHours CH
				ON CH.AcademicYear = @AcademicYear
				AND CH.ProvSpecValue COLLATE DATABASE_DEFAULT =
					CASE
						WHEN @ProvSpecDelMonCourseLocation1 = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''D'' THEN
							PSDMD.ProvSpecDelMon
					END 
					+ COALESCE ( @ProvSpecDelMonCourseSeperator, '''' )
					+ CASE
						WHEN @ProvSpecDelMonCourseLocation2 = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''''
					END 
					COLLATE DATABASE_DEFAULT
			LEFT JOIN (
				SELECT DISTINCT
					LD.LearnRefNumber
				FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
				WHERE
					LD.FundModel = 25
					AND COALESCE ( LD.WithdrawReason, 0 ) NOT IN ( 40, 41 ) --Exclude transfers
					AND LD.CompStatus <> 4
					--AND LD.LearnRefNumber = ''17002435''
				GROUP BY
					LD.LearnRefNumber
			) ACT
				ON ACT.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN (
				SELECT
					FM25.RateBand,
					RateBandOrder = 
						ROW_NUMBER () OVER (
							ORDER BY
								CASE
									WHEN 
										CHARINDEX ( ''Band '', FM25.RateBand ) > 0 
										AND CHARINDEX ( '')'', FM25.RateBand ) > 0 
										THEN
											SUBSTRING ( 
												FM25.RateBand, 
												CHARINDEX ( ''Band '', FM25.RateBand ) + 5,
												CHARINDEX ( '')'', FM25.RateBand ) - ( CHARINDEX ( ''Band '', FM25.RateBand ) + 5 )
											)
									ELSE ''0''
								END
						)
				FROM (
					SELECT DISTINCT
						FM25.RateBand
					FROM ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				) FM25
			) ORD
				ON ORD.RateBand = FM25.RateBand
			WHERE
				LD.FundModel = 25
				--AND LD.LearnRefNumber = ''18000292''
				AND 
					CASE --If lrn has no active aims then count tfer instead
						WHEN ACT.LearnRefNumber IS NOT NULL THEN
							CASE
								WHEN NOT (
									COALESCE ( LD.WithdrawReason, 0 ) NOT IN ( 40, 41 ) 
									OR LD.CompStatus <> 4
								)
								THEN 1
								ELSE 0
							END
						ELSE
							1
						END = 1
			GROUP BY
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ORD.RateBandOrder,
				ACT.LearnRefNumber
		) HRS
			ON HRS.LearnRefNumber = LD.LearnRefNumber
    '

	SET @SQLString += 
        N'
		--Fund Model for Each Aim with Ordering
		DROP TABLE IF EXISTS #FundModelAim
		SELECT
			LearnRefNumber = FM.LearnRefNumber,
			AimSeqNumber = FM.AimSeqNumber,
			FundLineCategory = FM.FundLineCategory,
			FundLineCategoryOrder = FM.FundLineCategoryOrder,
			FundLineSubCategory = FM.FundLineSubCategory,
			FundLineSubCategoryOrder = FM.FundLineSubCategoryOrder,
	'

	SET @SQLString += 
        N'
			FundLine = FM.FundLine,
			FundStart = FM.FundStart,
			AimStart = 
				CASE
					WHEN FM.IsWithdrawnPreEligibility = 1 THEN 0
					WHEN FM.Transfer = 1 AND FM.TransferValid = 1 THEN 0
					WHEN FM.BreakInLearning = 1 AND FM.BreakInLearningValid = 1 THEN 0
					WHEN FM.UnknownOutcome = 1 AND FM.UnknownOutcomeValid = 0 THEN 0
					ELSE 1
				END,
			Leaver = 
				CASE
					WHEN FM.IsWithdrawnPreEligibility = 1 THEN 0
					WHEN FM.CompStatus NOT IN ( 2, 3 ) THEN 0
					WHEN FM.Transfer = 1 AND FM.TransferValid = 1 THEN 0
					WHEN FM.BreakInLearning = 1 AND FM.BreakInLearningValid = 1 THEN 0
					WHEN FM.UnknownOutcome = 1 AND FM.UnknownOutcomeValid = 0 THEN 0
					ELSE 1
				END,
			Transfer = FM.Transfer,
			TransferValid = FM.TransferValid,
			BreakInLearning = FM.BreakInLearning,
			BreakInLearningValid = FM.BreakInLearningValid,
			UnknownOutcome = FM.UnknownOutcome,
			UnknownOutcomeValid = FM.UnknownOutcomeValid,
			Duration = FM.Duration,
			IsWithdrawnPreEligibility = FM.IsWithdrawnPreEligibility,
			IsWithdrawnPostEligibility = FM.IsWithdrawnPostEligibility
			INTO #FundModelAim
		FROM #FundModelType FM
	'

	SET @SQLString += 
        N'
		--Main Aim Overall and Main Aim In Each Fund Model
		DROP TABLE IF EXISTS #MainAim
		SELECT
				LD.LearnRefNumber,
				FM.FundLine,
				LD.AimSeqNumber,
				StdCode = COALESCE ( LD.StdCode, 0 ),
				ProgType = LD.ProgType,
				CollegeLevel1Code = COALESCE ( CS.CollegeLevel1Code, ''-''),
				CollegeLevel1Name = COALESCE ( CS.CollegeLevel1Name, ''-- Unknown --''),
				CollegeLevel2Code = COALESCE ( CS.CollegeLevel2Code, ''-''),
				CollegeLevel2Name = COALESCE ( CS.CollegeLevel2Name, ''-- Unknown --''),
				CollegeLevel3Code = COALESCE ( CS.CollegeLevel3Code, ''-''),
				CollegeLevel3Name = COALESCE ( CS.CollegeLevel3Name, ''-- Unknown --''),
				CollegeLevel4Code = COALESCE ( CS.CollegeLevel4Code, ''-''),
				CollegeLevel4Name = COALESCE ( CS.CollegeLevel4Name, ''-- Unknown --''),
				CourseCode = COALESCE ( CS.CourseCode, ''-''),
				CourseInstance = COALESCE ( CS.CourseInstance, ''-''),
				CourseTitle = COALESCE ( CS.CourseTitle, ''-- Unknown --''),
				SSA1Code = AIM.SSA1Code,
				SSA1Name = AIM.SSA1Name,
				SSA2Code = AIM.SSA2Code,
				SSA2Name = AIM.SSA2Name,
				LearningAimCode = AIM.LearningAimCode,
				LearningAimTitle = AIM.LearningAimTitle,
				LearningAimTypeCode = AIM.LearningAimTypeCode,
				LearningAimTypeName = AIM.LearningAimTypeName,
				NVQLevelCode = AIM.NVQLevelCode,
				NVQLevelName = AIM.NVQLevelName,
				NVQLevelOrder = AIM.NVQLevelOrder,
				IsMathsAndEnglish = AIM.IsMathsAndEnglish,
				AwardBodyCode = AIM.AwardBodyCode,
				RowNumLearner = 
					ROW_NUMBER () OVER ( 
						PARTITION BY
							LD.LearnRefNumber
						ORDER BY
							FM.FundStart DESC,
							LD.CompStatus,
							CASE
								--In case learners in gateway so only parent active but have started something else
								WHEN LD.LearnAimRef = ''ZPROG001'' THEN 2
								ELSE 1
							END,
							COALESCE ( LD.ProgType, 99 ),
							CASE
								WHEN LD.AimType = 1 THEN 1 --Programme Aim
								WHEN LD.AimType = 2 THEN 2 --Core Aim
								ELSE 3
							END,
							CASE
								WHEN AIM.LearningAimTypeCode IN (
									''0003'', --GCSE
									''1439'' --Functional Skills
								) THEN 2
								ELSE 1
							END,
							AIM.NVQLevelOrder DESC,
							COALESCE ( LD.PHours, 0 ) + COALESCE ( LD.AddHours, 0 ) DESC,
							DATEDIFF ( DAY, LD.LearnStartDate, COALESCE ( LD.LearnActEndDate, LD.LearnPlanEndDate ) ) DESC,
							LD.LearnStartDate,
							LD.AimSeqNumber
					),
				RowNumFundLine = 
					ROW_NUMBER () OVER ( 
						PARTITION BY
							LD.LearnRefNumber,
							FM.FundLine
						ORDER BY
							FM.FundStart DESC,
							LD.CompStatus,
							CASE
								--In case learners in gateway so only parent active but have started something else
								WHEN LD.LearnAimRef = ''ZPROG001'' THEN 2
								ELSE 1
							END,
							COALESCE ( LD.ProgType, 99 ),
							CASE
								WHEN LD.AimType = 1 THEN 1 --Programme Aim
								WHEN LD.AimType = 2 THEN 2 --Core Aim
								ELSE 3
							END,
							CASE
								WHEN AIM.LearningAimTypeCode IN (
									''0003'', --GCSE
									''1439'' --Functional Skills
								) THEN 2
								ELSE 1
							END,
							AIM.NVQLevelOrder DESC,
							COALESCE ( LD.PHours, 0 ) + COALESCE ( LD.AddHours, 0 ) DESC,
							DATEDIFF ( DAY, LD.LearnStartDate, COALESCE ( LD.LearnActEndDate, LD.LearnPlanEndDate ) ) DESC,
							LD.LearnStartDate,
							LD.AimSeqNumber
					),
				RowNumFundLineApps = 
					ROW_NUMBER () OVER ( 
						PARTITION BY
							LD.LearnRefNumber,
							FM.FundLine,
							COALESCE ( LD.StdCode, 0 ),
							LD.ProgType
						ORDER BY
							FM.FundStart DESC,
							LD.CompStatus,
							CASE
								--In case learners in gateway so only parent active but have started something else
								WHEN LD.LearnAimRef = ''ZPROG001'' THEN 2
								ELSE 1
							END,
							COALESCE ( LD.ProgType, 99 ),
							CASE
								WHEN LD.AimType = 1 THEN 1 --Programme Aim
								WHEN LD.AimType = 2 THEN 2 --Core Aim
								ELSE 3
							END,
							CASE
								WHEN AIM.LearningAimTypeCode IN (
									''0003'', --GCSE
									''1439'' --Functional Skills
								) THEN 2
								ELSE 1
							END,
							AIM.NVQLevelOrder DESC,
							COALESCE ( LD.PHours, 0 ) + COALESCE ( LD.AddHours, 0 ) DESC,
							DATEDIFF ( DAY, LD.LearnStartDate, COALESCE ( LD.LearnActEndDate, LD.LearnPlanEndDate ) ) DESC,
							LD.LearnStartDate,
							LD.AimSeqNumber
					)
				INTO #MainAim
	'
    
    SET @SQLString += 
        N'
			FROM ' + @FISDatabase + '.Valid.Learner L
			INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
				ON LD.LearnRefNumber = L.LearnRefNumber
			LEFT JOIN #LearningAims AIM
				ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
			LEFT JOIN #CollegeStructure CS
				ON CS.AcademicYear = @AcademicYear
				AND CS.ProvSpecValue COLLATE DATABASE_DEFAULT =
					CASE
						WHEN @ProvSpecDelMonCourseLocation1 = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''D'' THEN
							PSDMD.ProvSpecDelMon
					END 
					+ COALESCE ( @ProvSpecDelMonCourseSeperator, '''' )
					+ CASE
						WHEN @ProvSpecDelMonCourseLocation2 = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''''
					END 
					COLLATE DATABASE_DEFAULT

			LEFT JOIN #FundModelAim FM
				ON FM.LearnRefNumber = LD.LearnRefNumber
				AND FM.AimSeqNumber = LD.AimSeqNumber
	'

	SET @SQLString += 
        N'
		--Fund Model 38 Period Funding
		DROP TABLE IF EXISTS #FM38PeriodFunding
		SELECT
				LearnRefNumber = LD.LearnRefNumber,
				AimSeqNumber = LD.AimSeqNumber,
				LearnAimRef = LD.LearnAimRef,
				FundModel = LD.FundModel,
				CompStatus = LD.CompStatus,
				StdCode = COALESCE ( LD.StdCode, 0 ),
				ProgType = LD.ProgType,

				OnProgPaymentToPeriod = SUM ( CASE WHEN FM38P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentToPeriod = SUM ( CASE WHEN FM38P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentToPeriod = SUM ( CASE WHEN FM38P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentToPeriod = SUM ( CASE WHEN FM38P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayToPeriod = SUM ( CASE WHEN FM38P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashToPeriod = SUM ( CASE WHEN FM38P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentMidYear = SUM ( CASE WHEN FM38P.Period BETWEEN 1 AND 6 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentMidYear = SUM ( CASE WHEN FM38P.Period BETWEEN 1 AND 6 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentMidYear = SUM ( CASE WHEN FM38P.Period BETWEEN 1 AND 6 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentMidYear = SUM ( CASE WHEN FM38P.Period BETWEEN 1 AND 6 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayMidYear = SUM ( CASE WHEN FM38P.Period BETWEEN 1 AND 6 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashMidYear = SUM ( CASE WHEN FM38P.Period BETWEEN 1 AND 6 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentYearEnd = SUM ( FM38P.OnProgPayment ),
				LearnSuppPaymentYearEnd = SUM ( FM38P.LearnSuppFundCash ),
				AchCompPaymentYearEnd = SUM ( FM38P.CompletionPayment + FM38P.AchievePayment ),
				BalancePaymentYearEnd = SUM ( FM38P.BalancePayment ),
				EmpOutcomePayYearEnd = SUM ( FM38P.EmpOutcomePay ),
				TotalEarnedCashYearEnd = SUM ( 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay 
				),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP01 = SUM ( CASE WHEN FM38P.Period = 1 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP01 = SUM ( CASE WHEN FM38P.Period = 1 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP01 = SUM ( CASE WHEN FM38P.Period = 1 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP01 = SUM ( CASE WHEN FM38P.Period = 1 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP01 = SUM ( CASE WHEN FM38P.Period = 1 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP01 = SUM ( CASE WHEN FM38P.Period = 1 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP02 = SUM ( CASE WHEN FM38P.Period = 2 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP02 = SUM ( CASE WHEN FM38P.Period = 2 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP02 = SUM ( CASE WHEN FM38P.Period = 2 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP02 = SUM ( CASE WHEN FM38P.Period = 2 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP02 = SUM ( CASE WHEN FM38P.Period = 2 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP02 = SUM ( CASE WHEN FM38P.Period = 2 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP03 = SUM ( CASE WHEN FM38P.Period = 3 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP03 = SUM ( CASE WHEN FM38P.Period = 3 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP03 = SUM ( CASE WHEN FM38P.Period = 3 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP03 = SUM ( CASE WHEN FM38P.Period = 3 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP03 = SUM ( CASE WHEN FM38P.Period = 3 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP03 = SUM ( CASE WHEN FM38P.Period = 3 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP04 = SUM ( CASE WHEN FM38P.Period = 4 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP04 = SUM ( CASE WHEN FM38P.Period = 4 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP04 = SUM ( CASE WHEN FM38P.Period = 4 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP04 = SUM ( CASE WHEN FM38P.Period = 4 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP04 = SUM ( CASE WHEN FM38P.Period = 4 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP04 = SUM ( CASE WHEN FM38P.Period = 4 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),
	'
    
    SET @SQLString += 
        N'
				OnProgPaymentP05 = SUM ( CASE WHEN FM38P.Period = 5 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP05 = SUM ( CASE WHEN FM38P.Period = 5 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP05 = SUM ( CASE WHEN FM38P.Period = 5 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP05 = SUM ( CASE WHEN FM38P.Period = 5 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP05 = SUM ( CASE WHEN FM38P.Period = 5 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP05 = SUM ( CASE WHEN FM38P.Period = 5 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP06 = SUM ( CASE WHEN FM38P.Period = 6 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP06 = SUM ( CASE WHEN FM38P.Period = 6 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP06 = SUM ( CASE WHEN FM38P.Period = 6 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP06 = SUM ( CASE WHEN FM38P.Period = 6 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP06 = SUM ( CASE WHEN FM38P.Period = 6 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP06 = SUM ( CASE WHEN FM38P.Period = 6 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP07 = SUM ( CASE WHEN FM38P.Period = 7 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP07 = SUM ( CASE WHEN FM38P.Period = 7 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP07 = SUM ( CASE WHEN FM38P.Period = 7 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP07 = SUM ( CASE WHEN FM38P.Period = 7 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP07 = SUM ( CASE WHEN FM38P.Period = 7 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP07 = SUM ( CASE WHEN FM38P.Period = 7 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP08 = SUM ( CASE WHEN FM38P.Period = 8 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP08 = SUM ( CASE WHEN FM38P.Period = 8 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP08 = SUM ( CASE WHEN FM38P.Period = 8 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP08 = SUM ( CASE WHEN FM38P.Period = 8 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP08 = SUM ( CASE WHEN FM38P.Period = 8 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP08 = SUM ( CASE WHEN FM38P.Period = 8 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP09 = SUM ( CASE WHEN FM38P.Period = 9 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP09 = SUM ( CASE WHEN FM38P.Period = 9 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP09 = SUM ( CASE WHEN FM38P.Period = 9 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP09 = SUM ( CASE WHEN FM38P.Period = 9 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP09 = SUM ( CASE WHEN FM38P.Period = 9 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP09 = SUM ( CASE WHEN FM38P.Period = 9 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP10 = SUM ( CASE WHEN FM38P.Period = 10 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP10 = SUM ( CASE WHEN FM38P.Period = 10 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP10 = SUM ( CASE WHEN FM38P.Period = 10 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP10 = SUM ( CASE WHEN FM38P.Period = 10 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP10 = SUM ( CASE WHEN FM38P.Period = 10 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP10 = SUM ( CASE WHEN FM38P.Period = 10 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP11 = SUM ( CASE WHEN FM38P.Period = 11 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP11 = SUM ( CASE WHEN FM38P.Period = 11 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP11 = SUM ( CASE WHEN FM38P.Period = 11 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP11 = SUM ( CASE WHEN FM38P.Period = 11 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP11 = SUM ( CASE WHEN FM38P.Period = 11 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP11 = SUM ( CASE WHEN FM38P.Period = 11 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP12 = SUM ( CASE WHEN FM38P.Period = 12 THEN FM38P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP12 = SUM ( CASE WHEN FM38P.Period = 12 THEN FM38P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP12 = SUM ( CASE WHEN FM38P.Period = 12 THEN FM38P.CompletionPayment + FM38P.AchievePayment ELSE 0 END ),
				BalancePaymentP12 = SUM ( CASE WHEN FM38P.Period = 12 THEN FM38P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP12 = SUM ( CASE WHEN FM38P.Period = 12 THEN FM38P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP12 = SUM ( CASE WHEN FM38P.Period = 12 THEN 
					FM38P.OnProgPayment 
					+ FM38P.LearnSuppFundCash
					+ FM38P.CompletionPayment
					+ FM38P.AchievePayment
					+ FM38P.BalancePayment
					+ FM38P.EmpOutcomePay
				ELSE 0 END )
				INTO #FM38PeriodFunding
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.Rulebase.FM38_LearningDelivery FM38
				ON FM38.LearnRefNumber = LD.LearnRefNumber
				AND FM38.AimSeqNumber = LD.AimSeqNumber
			INNER JOIN ' + @FISDatabase + '.Rulebase.FM38_LearningDelivery_Period FM38P
				ON FM38P.LearnRefNumber = FM38.LearnRefNumber
				AND FM38P.AimSeqNumber = FM38.AimSeqNumber
			GROUP BY
				LD.LearnRefNumber,
				LD.AimSeqNumber,
				LD.LearnAimRef,
				LD.FundModel,
				LD.CompStatus,
				COALESCE ( LD.StdCode, 0 ),
				LD.ProgType
	'

	SET @SQLString += 
        N'
		--Fund Model 35 Period Funding
		DROP TABLE IF EXISTS #FM35PeriodFunding
		SELECT
				LearnRefNumber = LD.LearnRefNumber,
				AimSeqNumber = LD.AimSeqNumber,
				LearnAimRef = LD.LearnAimRef,
				FundModel = LD.FundModel,
				CompStatus = LD.CompStatus,
				StdCode = COALESCE ( LD.StdCode, 0 ),
				ProgType = LD.ProgType,

				OnProgPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayToPeriod = SUM ( CASE WHEN FM35P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashToPeriod = SUM ( CASE WHEN FM35P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentMidYear = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentMidYear = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentMidYear = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentMidYear = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayMidYear = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashMidYear = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentYearEnd = SUM ( FM35P.OnProgPayment ),
				LearnSuppPaymentYearEnd = SUM ( FM35P.LearnSuppFundCash ),
				AchCompPaymentYearEnd = SUM ( FM35P.AchievePayment ),
				BalancePaymentYearEnd = SUM ( FM35P.BalancePayment ),
				EmpOutcomePayYearEnd = SUM ( FM35P.EmpOutcomePay ),
				TotalEarnedCashYearEnd = SUM ( 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay 
				),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
	'
    
    SET @SQLString += 
        N'
				OnProgPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotalEarnedCashP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END )
				INTO #FM35PeriodFunding
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
				ON FM35.LearnRefNumber = LD.LearnRefNumber
				AND FM35.AimSeqNumber = LD.AimSeqNumber
			INNER JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery_Period FM35P
				ON FM35P.LearnRefNumber = FM35.LearnRefNumber
				AND FM35P.AimSeqNumber = FM35.AimSeqNumber
			GROUP BY
				LD.LearnRefNumber,
				LD.AimSeqNumber,
				LD.LearnAimRef,
				LD.FundModel,
				LD.CompStatus,
				COALESCE ( LD.StdCode, 0 ),
				LD.ProgType
	'

	SET @SQLString += 
        N'
			--Fund Model 36 Price Episode
			DROP TABLE IF EXISTS #FM36PriceEpisode
			SELECT
				FM36PE.UKPRN,
				LearnRefNumber = LD.LearnRefNumber,
				AimSeqNumber = LD.AimSeqNumber,
				LearnAimRef = LD.LearnAimRef,
				FundModel = LD.FundModel,
				CompStatus = LD.CompStatus,
				StdCode = COALESCE ( LD.StdCode, 0 ),
				ProgType = LD.ProgType,

				FM36PE.PriceEpisodeIdentifier,
				FM36PE.TNP1,
				FM36PE.TNP2,
				FM36PE.TNP3,
				FM36PE.TNP4,
				FM36PE.EpisodeStartDate,
				FM36PE.PriceEpisodeUpperBandLimit,
				FM36PE.PriceEpisodePlannedEndDate,
				FM36PE.PriceEpisodeActualEndDate,
				FM36PE.PriceEpisodeActualEndDateIncEPA,
				FM36PE.PriceEpisodeTotalTNPPrice,
				FM36PE.PriceEpisodeUpperLimitAdjustment,
				FM36PE.PriceEpisodePlannedInstalments,
				FM36PE.PriceEpisodeActualInstalments,
				FM36PE.PriceEpisodeCompletionElement,
				FM36PE.PriceEpisodePreviousEarnings,
				FM36PE.PriceEpisodeInstalmentValue,
				FM36PE.PriceEpisodeTotalEarnings,
				FM36PE.PriceEpisodeCompleted,
				FM36PE.PriceEpisodeRemainingTNPAmount,
				FM36PE.PriceEpisodeRemainingAmountWithinUpperLimit,
				FM36PE.PriceEpisodeCappedRemainingTNPAmount,
				FM36PE.PriceEpisodeExpectedTotalMonthlyValue,
				FM36PE.PriceEpisodeAimSeqNumber,
				FM36PE.PriceEpisodeFundLineType,
				FM36PE.EpisodeEffectiveTNPStartDate,
				FM36PE.PriceEpisodeFirstAdditionalPaymentThresholdDate,
				FM36PE.PriceEpisodeSecondAdditionalPaymentThresholdDate,
				FM36PE.PriceEpisodeContractType,
				FM36PE.PriceEpisodePreviousEarningsSameProvider,
				FM36PE.PriceEpisodeTotalPMRs,
				FM36PE.PriceEpisodeCumulativePMRs,
				FM36PE.PriceEpisodeCompExemCode,
				FM36PE.PriceEpisodeLearnerAdditionalPaymentThresholdDate,
				FM36PE.PriceEpisodeRedStartDate,
				FM36PE.PriceEpisodeRedStatusCode,
				RowNum =
					ROW_NUMBER () OVER (
						PARTITION BY
							FM36PE.UKPRN,
							FM36PE.LearnRefNumber,
							FM36PE.PriceEpisodeAimSeqNumber
						ORDER BY
							FM36PE.EpisodeStartDate DESC
					)
				INTO #FM36PriceEpisode
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
				ON FM36.LearnRefNumber = LD.LearnRefNumber
				AND FM36.AimSeqNumber = LD.AimSeqNumber
			INNER JOIN ' + @FISDatabase + '.Rulebase.AEC_ApprenticeshipPriceEpisode FM36PE
				ON FM36PE.LearnRefNumber = FM36.LearnRefNumber
				AND FM36PE.PriceEpisodeAimSeqNumber = FM36.AimSeqNumber
			WHERE
				FM36PE.EpisodeStartDate < ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-08-01''
	'

	SET @SQLString += 
        N'
			--Fund Model 36 Period Funding
			DROP TABLE IF EXISTS #FM36PeriodFunding
			SELECT
				LearnRefNumber = LD.LearnRefNumber,
				AimSeqNumber = LD.AimSeqNumber,
				LearnAimRef = LD.LearnAimRef,
				FundModel = LD.FundModel,
				CompStatus = LD.CompStatus,
				StdCode = COALESCE ( LD.StdCode, 0 ),
				ProgType = LD.ProgType,
				FundLineType = FM36P.FundLineType,

				OnProgPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment  
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						+ FM36P.MathEngBalPayment
						ELSE 0 END
					),
				OtherPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashToPeriod = 
					SUM (  CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						+ FM36P.MathEngBalPayment
						ELSE 0 END
					),
				OtherPaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashMidYear = 
					SUM (  CASE WHEN FM36P.Period <= 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentYearEnd = 
					SUM ( 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
					),
				LearnSuppPaymentYearEnd = 
					SUM ( 
						FM36P.LearnSuppFundCash 
					),
				AchCompPaymentYearEnd = 
					SUM ( 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
					),
				BalancePaymentYearEnd = 
					SUM ( 
						+ FM36P.MathEngBalPayment 
					),
				OtherPaymentYearEnd = 
					SUM ( 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
					),
				TotalEarnedCashYearEnd = 
					SUM (  
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP01 = 
					SUM (  CASE WHEN FM36P.Period = 1 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment  
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP02 = 
					SUM (  CASE WHEN FM36P.Period = 2 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP03 = 
					SUM (  CASE WHEN FM36P.Period = 3 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP04 = 
					SUM (  CASE WHEN FM36P.Period = 4 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP05 = 
					SUM (  CASE WHEN FM36P.Period = 5 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP06 = 
					SUM (  CASE WHEN FM36P.Period = 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP07 = 
					SUM (  CASE WHEN FM36P.Period = 7 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP08 = 
					SUM (  CASE WHEN FM36P.Period = 8 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP09 = 
					SUM (  CASE WHEN FM36P.Period = 9 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP10 = 
					SUM (  CASE WHEN FM36P.Period = 10 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP11 = 
					SUM (  CASE WHEN FM36P.Period = 11 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP12 = 
					SUM (  CASE WHEN FM36P.Period = 12 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					)
				INTO #FM36PeriodFunding
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
				ON FM36.LearnRefNumber = LD.LearnRefNumber
				AND FM36.AimSeqNumber = LD.AimSeqNumber
			INNER JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery_Period FM36P
				ON FM36P.LearnRefNumber = FM36.LearnRefNumber
				AND FM36P.AimSeqNumber = FM36.AimSeqNumber
			WHERE
				FM36P.FundLineType <> ''None''
			GROUP BY
				LD.LearnRefNumber,
				LD.AimSeqNumber,
				LD.LearnAimRef,
				LD.CompStatus,
				LD.FundModel,
				COALESCE ( LD.StdCode, 0 ),
				LD.ProgType,
				FM36P.FundLineType
	'

	SET @SQLString += 
        N'
			--Fund Model 36 Period Funding Summary
			DROP TABLE IF EXISTS #FM36PeriodFundingSummary
			SELECT
				LearnRefNumber = LD.LearnRefNumber,
				FundModel = LD.FundModel,
				StdCode = COALESCE ( LD.StdCode, 0 ),
				ProgType = LD.ProgType,
				FundLineType = FM36P.FundLineType,

				OnProgPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment  
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						+ FM36P.MathEngBalPayment
						ELSE 0 END
					),
				OtherPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashToPeriod = 
					SUM (  CASE WHEN FM36P.Period <= TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						+ FM36P.MathEngBalPayment
						ELSE 0 END
					),
				OtherPaymentMidYear = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashMidYear = 
					SUM (  CASE WHEN FM36P.Period <= 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentYearEnd = 
					SUM ( 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
					),
				LearnSuppPaymentYearEnd = 
					SUM ( 
						FM36P.LearnSuppFundCash 
					),
				AchCompPaymentYearEnd = 
					SUM ( 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
					),
				BalancePaymentYearEnd = 
					SUM ( 
						+ FM36P.MathEngBalPayment 
					),
				OtherPaymentYearEnd = 
					SUM ( 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
					),
				TotalEarnedCashYearEnd = 
					SUM (  
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP01 = 
					SUM (  CASE WHEN FM36P.Period = 1 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment  
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP02 = 
					SUM (  CASE WHEN FM36P.Period = 2 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP03 = 
					SUM (  CASE WHEN FM36P.Period = 3 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP04 = 
					SUM (  CASE WHEN FM36P.Period = 4 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP05 = 
					SUM (  CASE WHEN FM36P.Period = 5 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP06 = 
					SUM (  CASE WHEN FM36P.Period = 6 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP07 = 
					SUM (  CASE WHEN FM36P.Period = 7 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP08 = 
					SUM (  CASE WHEN FM36P.Period = 8 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP09 = 
					SUM (  CASE WHEN FM36P.Period = 9 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP10 = 
					SUM (  CASE WHEN FM36P.Period = 10 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP11 = 
					SUM (  CASE WHEN FM36P.Period = 11 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),

				OnProgPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						+ FM36P.MathEngBalPayment 
						ELSE 0 END
					),
				OtherPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					),
				TotalEarnedCashP12 = 
					SUM (  CASE WHEN FM36P.Period = 12 THEN 
						CASE WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType IN ( ''Levy Contract'', ''Contract for services with the employer'' ) THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						+ FM36P.LearnDelLearnAddPayment
						ELSE 0 END
					)
				INTO #FM36PeriodFundingSummary
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
				ON FM36.LearnRefNumber = LD.LearnRefNumber
				AND FM36.AimSeqNumber = LD.AimSeqNumber
			INNER JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery_Period FM36P
				ON FM36P.LearnRefNumber = FM36.LearnRefNumber
				AND FM36P.AimSeqNumber = FM36.AimSeqNumber
			WHERE
				FM36P.FundLineType <> ''None''
			GROUP BY
				LD.LearnRefNumber,
				LD.FundModel,
				COALESCE ( LD.StdCode, 0 ),
				LD.ProgType,
				FM36P.FundLineType
	'

	SET @SQLString += 
        N'
		--Dates for Hybrid End Year Calculation
		DROP TABLE IF EXISTS #EnrolDates
		SELECT
			LD.LearnRefNumber,
			LD.AimSeqNumber,
			LD.OrigLearnStartDate,
			LD.LearnStartDate,
			LD.LearnPlanEndDate,
			LD.LearnActEndDate,
			LD.AchDate,
			StartYear = 
				RIGHT (
					CAST (
						CASE
							WHEN MONTH ( COALESCE ( LD.OrigLearnStartDate, LD.LearnStartDate ) ) <= 7 THEN 
								YEAR ( COALESCE ( LD.OrigLearnStartDate, LD.LearnStartDate ) ) - 1
							ELSE 
								YEAR ( COALESCE ( LD.OrigLearnStartDate, LD.LearnStartDate ) )
						END
						AS VARCHAR(4)
					),
					2
				)
				+ ''/''
				+ RIGHT (
					CAST (
						CASE
							WHEN MONTH ( COALESCE ( LD.OrigLearnStartDate, LD.LearnStartDate ) ) <= 7 THEN 
								YEAR ( COALESCE ( LD.OrigLearnStartDate, LD.LearnStartDate ) )
							ELSE 
								YEAR ( COALESCE ( LD.OrigLearnStartDate, LD.LearnStartDate ) ) + 1
						END
						AS VARCHAR(4)
					),
					2
				),
			AchievementYear = 
				RIGHT (
					CAST (
						CASE
							WHEN MONTH ( LD.AchDate ) <= 7 THEN 
								YEAR ( LD.AchDate ) - 1
							ELSE 
								YEAR ( LD.AchDate )
						END
						AS VARCHAR(4)
					),
					2
				)
				+ ''/''
				+ RIGHT (
					CAST (
						CASE
							WHEN MONTH ( LD.AchDate ) <= 7 THEN 
								YEAR ( LD.AchDate )
							ELSE 
								YEAR ( LD.AchDate ) + 1
						END
						AS VARCHAR(4)
					),
					2
				),
			PlannedEndYear = 
				RIGHT (
					CAST (
						CASE
							WHEN MONTH ( LD.LearnPlanEndDate ) <= 7 THEN 
								YEAR ( LD.LearnPlanEndDate ) - 1
							ELSE 
								YEAR ( LD.LearnPlanEndDate )
						END
						AS VARCHAR(4)
					),
					2
				)
				+ ''/''
				+ RIGHT (
					CAST (
						CASE
							WHEN MONTH ( LD.LearnPlanEndDate ) <= 7 THEN 
								YEAR ( LD.LearnPlanEndDate )
							ELSE 
								YEAR ( LD.LearnPlanEndDate ) + 1
						END
						AS VARCHAR(4)
					),
					2
				),
			ActualEndYear = 
				RIGHT (
					CAST (
						CASE
							WHEN MONTH ( LD.LearnActEndDate ) <= 7 THEN 
								YEAR ( LD.LearnActEndDate ) - 1
							ELSE 
								YEAR ( LD.LearnActEndDate )
						END
						AS VARCHAR(4)
					),
					2
				)
				+ ''/''
				+ RIGHT (
					CAST (
						CASE
							WHEN MONTH ( LD.LearnActEndDate ) <= 7 THEN 
								YEAR ( LD.LearnActEndDate )
							ELSE 
								YEAR ( LD.LearnActEndDate ) + 1
						END
						AS VARCHAR(4)
					),
					2
				),
			ReportingYear = @AcademicYear
			INTO #EnrolDates
		FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
	'

	SET @SQLString += 
        N'
		--Hybrid End Years - Following QAR Rules
		--Latest of achievement year, planned end year, actual end year, reporting year
		DROP TABLE IF EXISTS #HybridEndYears
		SELECT
			ENR.LearnRefNumber,
			ENR.AimSeqNumber,
			ENR.OrigLearnStartDate,
			ENR.LearnStartDate,
			ENR.LearnPlanEndDate,
			ENR.LearnActEndDate,
			ENR.AchDate,
			ENR.StartYear,
			ENR.AchievementYear,
			ENR.PlannedEndYear,
			ENR.ActualEndYear,
			ENR.ReportingYear,
			HybridEndYear = (
				SELECT 
					MAX(years)
				FROM (
					VALUES
						(ENR.AchievementYear),
						(ENR.PlannedEndYear),
						(ENR.ActualEndYear),
						(ENR.ReportingYear)
				)
				AS VALUE(years)
			)
			INTO #HybridEndYears
		FROM #EnrolDates ENR
	'

	SET @SQLString += 
        N'
		DROP TABLE IF EXISTS #LearnerOverallDates
		SELECT
			LearnRefNumber = L.LearnRefNumber,
			EarliestStartDate = MIN ( LD.LearnStartDate ),
			LatestEndDate = MAX ( COALESCE ( LD.AchDate, LD.LearnActEndDate, LD.LearnPlanEndDate ) )
			INTO #LearnerOverallDates
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		--16-19
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
			ON FM25.LearnRefNumber = LD.LearnRefNumber
			AND FM25.CoreAimSeqNumber = LD.AimSeqNumber

		--ASF (Adult Skills Fund)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM38_LearningDelivery FM38
			ON FM38.LearnRefNumber = LD.LearnRefNumber
			AND FM38.AimSeqNumber = LD.AimSeqNumber

		--AEB (Adult Education Budget) and Legacy Apps
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
			ON FM35.LearnRefNumber = LD.LearnRefNumber
			AND FM35.AimSeqNumber = LD.AimSeqNumber

		--Apps (Reformed)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
			ON FM36.LearnRefNumber = LD.LearnRefNumber
			AND FM36.AimSeqNumber = LD.AimSeqNumber

		--Loans and Bursaries
		LEFT JOIN ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery ALB
			ON ALB.LearnRefNumber = LD.LearnRefNumber
			AND ALB.AimSeqNumber = LD.AimSeqNumber

		--Higher Education
		LEFT JOIN ' + @FISDatabase + '.Valid.LearningDeliveryHE HE
			ON HE.LearnRefNumber = LD.LearnRefNumber
			AND HE.AimSeqNumber = LD.AimSeqNumber
		WHERE
			(
				COALESCE ( FM25.StartFund, ALB.FundStart, FM38.FundStart, FM35.FundStart, FM36.FundStart, 0 ) = 1
				OR COALESCE ( ALB.LearnRefNumber, HE.LearnRefNumber ) IS NOT NULL
			)
		GROUP BY
			L.LearnRefNumber
	'


	SET @SQLString += 
        N'
		DROP TABLE IF EXISTS #FAMLearner
		SELECT
			LearnRefNumber = FAML.LearnRefNumber,
			FAMLearnerHNS = FAML.HNS,
			FAMLearnerEHC = FAML.EHC,
			FAMLearnerDLA = FAML.DLA,
			FAMLearnerLSR = FAML.LSR,
			FAMLearnerSEN = FAML.SEN,
			FAMLearnerNLM = FAML.NLM,
			FAMLearnerEDF = FAML.EDF,
			FAMLearnerMCF = FAML.MCF,
			FAMLearnerECF = FAML.ECF,
			FAMLearnerFME = FAML.FME
			INTO #FAMLearner
		FROM (
			SELECT
				FAML.LearnRefNumber,
				FAML.LearnFAMType,
				FAML.LearnFAMCode
			FROM ' + @FISDatabase + '.Valid.LearnerFAM FAML
		) FAML
		PIVOT (
			MAX ( FAML.LearnFAMCode )
			FOR
				FAML.LearnFAMType IN (
					[HNS],
					[EHC],
					[DLA],
					[LSR],
					[SEN],
					[NLM],
					[EDF],
					[MCF],
					[ECF],
					[FME]
				)
		) FAML

	'

	SET @SQLString += 
        N'
		DROP TABLE IF EXISTS #FAMLearningDelivery
		SELECT
			LearnRefNumber = FAMA.LearnRefNumber,
			AimSeqNumber = FAMA.AimSeqNumber,
			FAMLearningDeliverySOF = FAMA.SOF,
			FAMLearningDeliveryFFI = FAMA.FFI,
			FAMLearningDeliveryEEF = FAMA.EEF,
			FAMLearningDeliveryRES = FAMA.RES,
			FAMLearningDeliveryLSF = FAMA.LSF,
			FAMLearningDeliveryADL = FAMA.ADL,
			FAMLearningDeliveryALB = FAMA.ALB,
			FAMLearningDeliveryASL = FAMA.ASL,
			FAMLearningDeliveryFLN = FAMA.FLN,
			FAMLearningDeliveryLDM = FAMA.LDM,
			FAMLearningDeliveryDAM = FAMA.DAM,
			FAMLearningDeliveryACT = FAMA.ACT,
			FAMLearningDeliveryACL = FAMA.ACL,
			FAMLearningDeliveryAFL = FAMA.AFL
			INTO #FAMLearningDelivery
		FROM (
			SELECT
				FAMA.LearnRefNumber,
				FAMA.AimSeqNumber,
				FAMA.LearnDelFAMType,
				FAMA.LearnDelFAMCode
			FROM (
				SELECT
					FAMA.LearnRefNumber,
					FAMA.AimSeqNumber,
					FAMA.LearnDelFAMType,
					FAMA.LearnDelFAMCode,
					FAMA.LearnDelFAMDateFrom,
					FAMA.LearnDelFAMDateTo,
					RowNum = 
						ROW_NUMBER () OVER (
							PARTITION BY
								FAMA.LearnRefNumber,
								FAMA.AimSeqNumber,
								FAMA.LearnDelFAMType
							ORDER BY
								FAMA.LearnDelFAMDateFrom DESC,
								CASE
									WHEN FAMA.LearnDelFAMDateTo IS NULL THEN 1
									ELSE 2
								END,
								FAMA.LearnDelFAMDateTo DESC
						)
				FROM ' + @FISDatabase + '.Valid.LearningDeliveryFAM FAMA
			) FAMA
			WHERE
				FAMA.RowNum = 1
		) FAMA
		PIVOT (
			MAX ( FAMA.LearnDelFAMCode )
			FOR
				FAMA.LearnDelFAMType IN (
					[SOF],
					[FFI],
					[EEF],
					[RES],
					[LSF],
					[ADL],
					[ALB],
					[ASL],
					[FLN],
					[LDM],
					[DAM],
					[ACT],
					[ACL],
					[AFL]
				)
		) FAMA
	'

	SET @SQLString += 
        N'
		DROP TABLE IF EXISTS #CarryInMonths
		SELECT
			ILRReturn = RN.ILRReturn,
			ReturnYear = RN.ReturnYear,
			YearNum = RN.YearNum,
			DateFrom = RN.ReturnFrom,
			DateTo = DATEADD ( DAY, -1, LEAD ( RN.ReturnFrom ) OVER ( ORDER BY RN.ReturnFrom ) )
			INTO #CarryInMonths
		FROM (
			SELECT
				ILRReturn = 
					''R'' + CASE
						WHEN RN.RowNum >= 20 THEN FORMAT ( RN.RowNum - 19, ''#00'' )
						ELSE FORMAT ( RN.RowNum - 7, ''#00'' )
					END,
				ReturnYear = 
					CASE
						WHEN RN.RowNum >= 20 THEN CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
						ELSE CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) AS VARCHAR(2) )
					END
					+ ''/''
					+ CASE
						WHEN RN.RowNum >= 20 THEN CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 2 AS VARCHAR(2) )
						ELSE CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
					END,
				YearNum = 
					CASE
						WHEN RN.RowNum >= 20 THEN 2
						ELSE 1
					END,
				ReturnFrom = 
					CAST ( 
						CASE
							WHEN RN.RowNum >= 25 THEN ''20'' + CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 2 AS VARCHAR(2) )
							WHEN RN.RowNum >= 13 THEN ''20'' + CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) + 1 AS VARCHAR(2) )
							ELSE ''20'' + CAST ( CAST ( RIGHT ( @AcademicYear, 2 ) AS INT ) AS VARCHAR(2) )
						END
						+ ''-''
						+ CASE
							WHEN RN.RowNum >= 25 THEN FORMAT ( RN.RowNum - 24, ''#00'' )
							WHEN RN.RowNum >= 13 THEN FORMAT ( RN.RowNum - 12, ''#00'' )
							ELSE FORMAT ( RN.RowNum, ''#00'' )
						END
						+ ''-01''
					AS DATE )
			FROM (
				SELECT
					RowNum =
						ROW_NUMBER () OVER (
							ORDER BY
								NEWID()
						)
				FROM sys.all_objects
			) RN
			WHERE
				RN.RowNum >= 8
				AND RN.RowNum <= 32
		) RN
	'

	SET @SQLString += 
        N'
		--FM38 Carry In Funding
		DROP TABLE IF EXISTS #FM38CarryIn
		SELECT
			CI.LearnRefNumber,
			CI.AimSeqNumber,
			CI.CarryInOnProgTotal,
			CI.CarryInOnProgMonthly,
			CI.AchieveElement,
			CarryInYr1R01 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R01'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R02 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R02'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R03 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R03'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R04 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R04'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R05 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R05'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R06 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R06'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R07 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R07'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R08 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R08'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R09 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R09'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R10 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R10'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R11 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R11'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R12 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R12'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R01 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R01'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R02 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R02'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R03 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R03'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R04 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R04'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R05 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R05'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R06 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R06'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R07 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R07'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R08 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R08'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R09 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R09'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R10 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R10'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R11 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R11'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R12 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R12'' THEN CI.CarryInAmount ELSE 0 END )
			INTO #FM38CarryIn
		FROM (
			SELECT
				FMC.LearnRefNumber,
				FMC.AimSeqNumber,
				FMC.CarryInOnProgTotal,
				FMC.CarryInOnProgMonthly,
				FMC.AchieveElement,
				CI.ReturnYear,
				CI.YearNum,
				CI.ILRReturn,
				CarryInAmount = 
					(
						CASE --Dates span the month so need a payment
							WHEN FMC.LearnPlanEndDate >= CI.DateTo
							AND FMC.LearnStartDate <= CI.DateTo THEN
								FMC.CarryInOnProgMonthly
							ELSE 0
						END
						*
						CASE --Started in the month so need double payment
							WHEN FMC.LearnStartDate >= CI.DateFrom
							AND FMC.LearnStartDate <= CI.DateTo THEN 2
							ELSE 1
						END
					)
					+
					CASE --Finished in the month so add achievement element
						WHEN FMC.LearnPlanEndDate >= CI.DateFrom
						AND FMC.LearnPlanEndDate <= CI.DateTo THEN FMC.AchieveElement
						ELSE 0
					END
			FROM (
				SELECT
					LD.LearnRefNumber,
					LD.AimSeqNumber,
					LD.PartnerUKPRN,
					LD.LearnStartDate,
					LD.LearnPlanEndDate,
					NumPlannedOnProgPayments = FM38.PlannedNumOnProgInstalm,
					FM38.AchieveElement,
					CarryInOnProgTotal = 
						CASE
							WHEN COALESCE ( FM38.PropFundRemain, 0 ) = 0 THEN 0
							ELSE 
								( FM38.AimValue - FM38.NonGovCont - FM38.AchieveElement ) * FM38.PropFundRemain
						END,
					CarryInOnProgMonthly = 
						CASE
							WHEN FM38.PlannedNumOnProgInstalm = 0 THEN 0
							ELSE
								CASE
									WHEN COALESCE ( FM38.PropFundRemain, 0 ) = 0 THEN 0
									ELSE 
										( FM38.AimValue - FM38.NonGovCont - FM38.AchieveElement ) * FM38.PropFundRemain
								END
								/ 
								FM38.PlannedNumOnProgInstalm
						END
				FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
				INNER JOIN ' + @FISDatabase + '.Rulebase.FM38_LearningDelivery FM38
					ON FM38.LearnRefNumber = LD.LearnRefNumber
					AND FM38.AimSeqNumber = LD.AimSeqNumber
				WHERE
					LD.CompStatus = 1
					AND LD.LearnPlanEndDate >= ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-08-01''
					AND FM38.FundStart = 1
			) FMC
			INNER JOIN #CarryInMonths CI
				ON CI.DateTo IS NOT NULL
		) CI
		GROUP BY
			CI.LearnRefNumber,
			CI.AimSeqNumber,
			CI.CarryInOnProgTotal,
			CI.CarryInOnProgMonthly,
			CI.AchieveElement
	'

	SET @SQLString += 
        N'
		--FM35 Carry In Funding
		DROP TABLE IF EXISTS #FM35CarryIn
		SELECT
			CI.LearnRefNumber,
			CI.AimSeqNumber,
			CI.CarryInOnProgTotal,
			CI.CarryInOnProgMonthly,
			CI.AchieveElement,
			CarryInYr1R01 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R01'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R02 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R02'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R03 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R03'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R04 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R04'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R05 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R05'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R06 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R06'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R07 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R07'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R08 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R08'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R09 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R09'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R10 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R10'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R11 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R11'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr1R12 = MAX ( CASE WHEN CI.YearNum = 1 AND CI.ILRReturn = ''R12'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R01 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R01'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R02 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R02'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R03 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R03'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R04 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R04'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R05 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R05'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R06 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R06'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R07 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R07'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R08 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R08'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R09 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R09'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R10 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R10'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R11 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R11'' THEN CI.CarryInAmount ELSE 0 END ),
			CarryInYr2R12 = MAX ( CASE WHEN CI.YearNum = 2 AND CI.ILRReturn = ''R12'' THEN CI.CarryInAmount ELSE 0 END )
			INTO #FM35CarryIn
		FROM (
			SELECT
				FMC.LearnRefNumber,
				FMC.AimSeqNumber,
				FMC.CarryInOnProgTotal,
				FMC.CarryInOnProgMonthly,
				FMC.AchieveElement,
				CI.ReturnYear,
				CI.YearNum,
				CI.ILRReturn,
				CarryInAmount = 
					(
						CASE --Dates span the month so need a payment
							WHEN FMC.LearnPlanEndDate >= CI.DateTo
							AND FMC.LearnStartDate <= CI.DateTo THEN
								FMC.CarryInOnProgMonthly
							ELSE 0
						END
						*
						CASE --Started in the month so need double payment
							WHEN FMC.LearnStartDate >= CI.DateFrom
							AND FMC.LearnStartDate <= CI.DateTo THEN 2
							ELSE 1
						END
					)
					+
					CASE --Finished in the month so add achievement element
						WHEN FMC.LearnPlanEndDate >= CI.DateFrom
						AND FMC.LearnPlanEndDate <= CI.DateTo THEN FMC.AchieveElement
						ELSE 0
					END
			FROM (
				SELECT
					LD.LearnRefNumber,
					LD.AimSeqNumber,
					LD.PartnerUKPRN,
					LD.LearnStartDate,
					LD.LearnPlanEndDate,
					NumPlannedOnProgPayments = FM35.PlannedNumOnProgInstalm,
					FM35.AchieveElement,
					CarryInOnProgTotal = 
						CASE
							WHEN COALESCE ( FM35.PropFundRemain, 0 ) = 0 THEN 0
							ELSE 
								( FM35.AimValue - FM35.NonGovCont - FM35.AchieveElement ) * FM35.PropFundRemain
						END,
					CarryInOnProgMonthly = 
						CASE
							WHEN FM35.PlannedNumOnProgInstalm = 0 THEN 0
							ELSE
								CASE
									WHEN COALESCE ( FM35.PropFundRemain, 0 ) = 0 THEN 0
									ELSE 
										( FM35.AimValue - FM35.NonGovCont - FM35.AchieveElement ) * FM35.PropFundRemain
								END
								/ 
								FM35.PlannedNumOnProgInstalm
						END
				FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
				INNER JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
					ON FM35.LearnRefNumber = LD.LearnRefNumber
					AND FM35.AimSeqNumber = LD.AimSeqNumber
				WHERE
					LD.CompStatus = 1
					AND LD.LearnPlanEndDate >= ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-08-01''
					AND FM35.FundStart = 1
			) FMC
			INNER JOIN #CarryInMonths CI
				ON CI.DateTo IS NOT NULL
		) CI
		GROUP BY
			CI.LearnRefNumber,
			CI.AimSeqNumber,
			CI.CarryInOnProgTotal,
			CI.CarryInOnProgMonthly,
			CI.AchieveElement
	'

	SET @SQLString += 
        N'
		INSERT INTO ' + @FISOutputTableLocation + '[' + @FISOutputTableName + '] WITH (TABLOCKX)
		SELECT
			AcademicYear = @AcademicYear,
            ProviderNumber = SRC.UKPRN,
			ProviderName = PROV.ProviderName,
			ILRReturn = @ILRReturn,
			IsFinalReturn = @IsFinalReturn,
			ILRReturnDate = DATEADD ( MS, - DATEPART ( MS, SRC.DateTime ), SRC.DateTime ), --Remove milliseconds as SSRS truncates these in parameters
			SQLDatabase = ''' + @FISDatabase + ''',
			ImportDate = GETDATE(),
			Is1619FundingSplit = CASE WHEN LD.FundModel = 25 AND @Split1619Funding = 1 AND COALESCE ( HRS.PlannedHours, 0 ) > 0 THEN 1 ELSE 0 END,
			ALS1619FundingPercent = @1619ALSFundingPercent,
			Is1619FundingReapportionedByAim = @Reapportion1619FundingByAimWeighting,
			AppsMoveFundingToMainComponentAim = @AppsMoveFundingToMainComponentAim,
			InvalidLearners = INV.InvalidLearners,

			LearnRefNumber = L.LearnRefNumber,
			PrevLearnRefNumber = L.PrevLearnRefNumber,
			PrevUKPRN = L.PrevUKPRN,
			Surname = L.FamilyName,
			Forename = L.GivenNames,
			Sex = L.Sex,
			DOB = L.DateOfBirth,
			Age31AugCurrentYear = 
				CASE
					WHEN MONTH ( L.DateOfBirth ) <= 8 THEN ''20'' + LEFT ( @AcademicYear, 2 ) - YEAR ( L.DateOfBirth )
					ELSE CAST (''20'' + LEFT ( @AcademicYear, 2 ) - 1 AS INT ) - YEAR ( L.DateOfBirth )
				END,
			Age31AugEarliestStartYear = 
				CASE
					WHEN MONTH ( L.DateOfBirth ) <= 8 THEN YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - YEAR ( L.DateOfBirth )
					ELSE YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - 1 - YEAR ( L.DateOfBirth )
				END,
			AgeGroupCurrentYear = 
				CASE
					WHEN
						CASE
							WHEN MONTH ( L.DateOfBirth ) <= 8 THEN ''20'' + LEFT ( @AcademicYear, 2 ) - YEAR ( L.DateOfBirth )
							ELSE CAST (''20'' + LEFT ( @AcademicYear, 2 ) - 1 AS INT ) - YEAR ( L.DateOfBirth )
						END <= 15 THEN ''14-15''
					WHEN
						CASE
							WHEN MONTH ( L.DateOfBirth ) <= 8 THEN ''20'' + LEFT ( @AcademicYear, 2 ) - YEAR ( L.DateOfBirth )
							ELSE CAST (''20'' + LEFT ( @AcademicYear, 2 ) - 1 AS INT ) - YEAR ( L.DateOfBirth )
						END <= 18 THEN ''16-18''
					WHEN
						CASE
							WHEN MONTH ( L.DateOfBirth ) <= 8 THEN ''20'' + LEFT ( @AcademicYear, 2 ) - YEAR ( L.DateOfBirth )
							ELSE CAST (''20'' + LEFT ( @AcademicYear, 2 ) - 1 AS INT ) - YEAR ( L.DateOfBirth )
						END <= 24 THEN ''19-24''
					WHEN
						CASE
							WHEN MONTH ( L.DateOfBirth ) <= 8 THEN ''20'' + LEFT ( @AcademicYear, 2 ) - YEAR ( L.DateOfBirth )
							ELSE CAST (''20'' + LEFT ( @AcademicYear, 2 ) - 1 AS INT ) - YEAR ( L.DateOfBirth )
						END >= 25 THEN ''25+''
					ELSE ''-''
				END,
			AgeGroupEarliestStartYear = 
				CASE
					WHEN
						CASE
							WHEN MONTH ( L.DateOfBirth ) <= 8 THEN YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - YEAR ( L.DateOfBirth )
							ELSE YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - 1 - YEAR ( L.DateOfBirth )
						END <= 15 THEN ''14-15''
					WHEN
						CASE
							WHEN MONTH ( L.DateOfBirth ) <= 8 THEN YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - YEAR ( L.DateOfBirth )
							ELSE YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - 1 - YEAR ( L.DateOfBirth )
						END <= 18 THEN ''16-18''
					WHEN
						CASE
							WHEN MONTH ( L.DateOfBirth ) <= 8 THEN YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - YEAR ( L.DateOfBirth )
							ELSE YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - 1 - YEAR ( L.DateOfBirth )
						END <= 24 THEN ''19-24''
					WHEN
						CASE
							WHEN MONTH ( L.DateOfBirth ) <= 8 THEN YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - YEAR ( L.DateOfBirth )
							ELSE YEAR ( COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ) ) - 1 - YEAR ( L.DateOfBirth )
						END >= 25 THEN ''25+''
					ELSE ''-''
				END,
	'

	SET @SQLString += 
        N'
			EarliestStartDate = COALESCE ( LOD.EarliestStartDate, LD.LearnStartDate ),
			LatestEndDate = COALESCE ( LOD.LatestEndDate, LD.AchDate, LD.LearnActEndDate, LD.LearnPlanEndDate ),
			ULN = L.ULN,
			NINumber = L.NINumber,
			Address1 = L.AddLine1,
			Address2 = L.AddLine2,
			Address3 = L.AddLine3,
			Address4 = L.AddLine4,
			PostCodeCurrent = L.Postcode,
			PostCodePriorToEnrol = L.PostcodePrior,
			PostCodeLearningStartDate = LD.LSDPostcode,
			Tel = L.TelNo,
			Email = L.Email,
			PostCodeWardCode = PC.WardCode,
			PostCodeWardName = PC.WardName,
			PostCodeDistrictCode = PC.DistrictCode,
			PostCodeDistrictName = PC.DistrictName,
			PostCodeLEACode = PC.LEACode,
			PostCodeLEAName = PC.LEAName,
			PostCodeSourceOfFundingCode = PC.SourceOfFunding,
			PostCodeDisadvUplift = COALESCE ( PC.DisadvUplift, 1 ),
			EmpStatusCode = EMP.EmpStatusCode,
			EmpStatusName = EMP.EmpStatusName,
			EmpStatusAppliesDate = EMP.EmpStatusAppliesDate,
			EmpStatusEmployerID = EMP.EmployerID,
			LengthOfEmploy = ESM.LOE,
			LengthOfUnemploy = ESM.LOU,
			BenefitStatusInd = ESM.BSI,
			SmallEmployer = ESM.SEM,
			SelfEmployInd = ESM.SEI,
			EmployIntensityInd = ESM.EII,
			IsFirstFullLevel2 = NULL,
			IsFirstFullLevel3 = NULL,
			PriorLevelCode = ATN.PriorLevel,
			PriorLevelName = PLEV.Description,
			PriorLevelDate = ATN.DateLevelApp,
			EthnicityCode = L.Ethnicity,
			EthnicityName = ETH.Description,
			LLDDHealthProb = L.LLDDHealthProb,
			PrimaryLLDDHealthProblemCode = LLDD.LLDDCat,
			PrimaryLLDDHealthProblemName = DIS.Description,
			FAMLearnerHNS = FAML.FAMLearnerHNS,
			FAMLearnerEHC = FAML.FAMLearnerEHC,
			FAMLearnerDLA = FAML.FAMLearnerDLA,
			FAMLearnerLSR = FAML.FAMLearnerLSR,
			FAMLearnerSEN = FAML.FAMLearnerSEN,
			FAMLearnerNLM = FAML.FAMLearnerNLM,
			FAMLearnerEDF = FAML.FAMLearnerEDF,
			FAMLearnerMCF = FAML.FAMLearnerMCF,
			FAMLearnerECF = FAML.FAMLearnerECF,
			FAMLearnerFME = FAML.FAMLearnerFME,
			DestinationProgressionType = NULL,
			DestinationProgressionNumber = NULL,
			DestinationProgressionCode = NULL,
			DestinationProgressionName = NULL,
			DestinationProgressionStartDate = NULL,
			DestinationProgressionEndDate = NULL,
			DestinationProgressionCollectionDate = NULL,

			SoftwareSupplierAimID = LD.SWSupAimId,
			FundLineCategory = FM.FundLineCategory,
			FundLineCategoryOrder = FM.FundLineCategoryOrder,
			FundLineSubCategory = FM.FundLineSubCategory,
			FundLineSubCategoryOrder = FM.FundLineSubCategoryOrder,
			FundLine = FM.FundLine,
    '

    SET @SQLString += 
        N'
			FundModel = LD.FundModel,
			LearnDelFundOrgCode = COALESCE ( FM38.LearnDelFundOrgCode, FM35.LearnDelFundOrgCode ),
			HEFullPartTime = 
				CASE
					WHEN HE.MODESTUD = 1 THEN ''Full Time''
					WHEN HE.MODESTUD = 3 THEN ''Part Time''
					WHEN HE.MODESTUD = 2 THEN ''Year Out''
					ELSE NULL
				END,
			IsMainAim = 
				CASE
					WHEN LD.AimSeqNumber = MA.AimSeqNumber THEN 1
					ELSE 0
				END,
			IsMainAimInFundModel = 
				CASE
					WHEN LD.AimSeqNumber = MAFM.AimSeqNumber THEN 1
					ELSE 0
				END,
			IsAdvLearnLoan = ALB.AdvLoan,
			IsAdvLearnLoanBursary = CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine <> ''None'' THEN 1 ELSE 0 END,
			RateBand = HRS.RateBand,
			RateBandOrder = HRS.RateBandOrder,
			GCSEMathsGrade = L.MathGrade,
			GCSEEnglishGrade = L.EngGrade,
			CofMaths = FM25.ConditionOfFundingMaths,
			CofEnglish = FM25.ConditionOfFundingEnglish,
			CofMathsMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN FM25.ConditionOfFundingMaths = ''Doesn''''t have Maths, Not Studying Maths'' THEN 0
                    WHEN FM25.ConditionOfFundingMaths = ''Has Maths GCSE Grade D or Grade 3, Not studying GCSE Maths'' THEN 0
					ELSE 1
				END,
			CofEnglishMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN FM25.ConditionOfFundingEnglish = ''Doesn''''t have English, Not Studying English'' THEN 0
                    WHEN FM25.ConditionOfFundingEnglish = ''Has English GCSE Grade D or Grade 3, Not studying GCSE English'' THEN 0
					ELSE 1
				END,
			CofMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN 
						FM25.ConditionOfFundingEnglish = ''Doesn''''t have English, Not Studying English'' 
                        OR FM25.ConditionOfFundingEnglish = ''Has English GCSE Grade D or Grade 3, Not studying GCSE English'' 
						OR FM25.ConditionOfFundingMaths = ''Doesn''''t have Maths, Not Studying Maths''
                        OR FM25.ConditionOfFundingMaths = ''Has Maths GCSE Grade D or Grade 3, Not studying GCSE Maths''
						THEN 0
					ELSE 1
				END,
			ThresholdDays = FM25.ThresholdDays,
			FAMLearningDeliverySOF = FAMA.FAMLearningDeliverySOF,
			FAMLearningDeliveryFFI = FAMA.FAMLearningDeliveryFFI,
			FAMLearningDeliveryEEF = FAMA.FAMLearningDeliveryEEF,
			FAMLearningDeliveryRES = FAMA.FAMLearningDeliveryRES,
			FAMLearningDeliveryLSF = FAMA.FAMLearningDeliveryLSF,
			FAMLearningDeliveryADL = FAMA.FAMLearningDeliveryADL,
			FAMLearningDeliveryALB = FAMA.FAMLearningDeliveryALB,
			FAMLearningDeliveryASL = FAMA.FAMLearningDeliveryASL,
			FAMLearningDeliveryFLN = FAMA.FAMLearningDeliveryFLN,
			FAMLearningDeliveryLDM = FAMA.FAMLearningDeliveryLDM,
			FAMLearningDeliveryDAM = FAMA.FAMLearningDeliveryDAM,
			FAMLearningDeliveryACT = FAMA.FAMLearningDeliveryACT,
			FAMLearningDeliveryACL = FAMA.FAMLearningDeliveryACL,
			FAMLearningDeliveryAFL = FAMA.FAMLearningDeliveryAFL,
			PostCodeDelivery = LD.DelLocPostCode,
	'

    SET @SQLString += 
        N'
			CampusID = L.CampId,
			ParentCollegeLevel1Code = COALESCE ( PCS.CollegeLevel1Code, ''-''),
			ParentCollegeLevel1Name = COALESCE ( PCS.CollegeLevel1Name, ''-- Unknown --''),
			ParentCollegeLevel2Code = COALESCE ( PCS.CollegeLevel2Code, ''-''),
			ParentCollegeLevel2Name = COALESCE ( PCS.CollegeLevel2Name, ''-- Unknown --''),
			ParentCollegeLevel3Code = COALESCE ( PCS.CollegeLevel3Code, ''-''),
			ParentCollegeLevel3Name = COALESCE ( PCS.CollegeLevel3Name, ''-- Unknown --''),
			ParentCollegeLevel4Code = COALESCE ( PCS.CollegeLevel4Code, ''-''),
			ParentCollegeLevel4Name = COALESCE ( PCS.CollegeLevel4Name, ''-- Unknown --''),
    '

    SET @SQLString += 
        N'
			CollegeLevel1Code = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN @EnglishCollegeLevel1Code END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN @MathsCollegeLevel1Code END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( 25, 35 ) THEN @PartnerCollegeLevel1Code END,
					CS.CollegeLevel1Code,
					''-''
				),
			CollegeLevel1Name = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN CL1ENG.CollegeLevelName END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN CL1MAT.CollegeLevelName END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( 25, 35 ) THEN CL1PAR.CollegeLevelName END,
					CS.CollegeLevel1Name,
					''-- Unknown --''
				),
			CollegeLevel2Code = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN @EnglishCollegeLevel2Code END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN @MathsCollegeLevel2Code END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( 25, 35 ) THEN @PartnerCollegeLevel2Code END,
					CS.CollegeLevel2Code,
					''-''
				),
			CollegeLevel2Name = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN CL2ENG.CollegeLevelName END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN CL2MAT.CollegeLevelName END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( 25, 35 ) THEN CL2PAR.CollegeLevelName END,
					CS.CollegeLevel2Name,
					''-- Unknown --''
				),
			CollegeLevel3Code = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN @EnglishCollegeLevel3Code END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN @MathsCollegeLevel3Code END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( 25, 35 ) THEN @PartnerCollegeLevel3Code END,
					CS.CollegeLevel3Code,
					''-''
				),
			CollegeLevel3Name = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN CL3ENG.CollegeLevelName END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN CL3MAT.CollegeLevelName END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( 25, 35 ) THEN CL3PAR.CollegeLevelName END,
					CS.CollegeLevel3Name,
					''-- Unknown --''
				),
			CollegeLevel4Code = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN @EnglishCollegeLevel4Code END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN @MathsCollegeLevel4Code END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( 25, 35 ) THEN @PartnerCollegeLevel4Code END,
					CS.CollegeLevel4Code,
					''-''
				),
			CollegeLevel4Name = 
				COALESCE (
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%English%'' THEN CL4ENG.CollegeLevelName END,
					CASE WHEN AIM.LearningAimTypeCode IN (''0003'', ''2999'', ''1439'') AND  AIM.LearningAimTitle LIKE ''%Math%'' THEN CL4MAT.CollegeLevelName END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( 25, 35 ) THEN CL4PAR.CollegeLevelName END,
					CS.CollegeLevel4Name,
					''-- Unknown --''
				),
	'

    SET @SQLString += 
        N'
			OriginalCollegeLevel1Code = COALESCE ( CS.CollegeLevel1Code, ''-''),
			OriginalCollegeLevel1Name = COALESCE ( CS.CollegeLevel1Name, ''-- Unknown --''),
			OriginalCollegeLevel2Code = COALESCE ( CS.CollegeLevel2Code, ''-''),
			OriginalCollegeLevel2Name = COALESCE ( CS.CollegeLevel2Name, ''-- Unknown --''),
			OriginalCollegeLevel3Code = COALESCE ( CS.CollegeLevel3Code, ''-''),
			OriginalCollegeLevel3Name = COALESCE ( CS.CollegeLevel3Name, ''-- Unknown --''),
			OriginalCollegeLevel4Code = COALESCE ( CS.CollegeLevel4Code, ''-''),
			OriginalCollegeLevel4Name = COALESCE ( CS.CollegeLevel4Name, ''-- Unknown --''),
			
			MainAimCollegeLevel1Code = COALESCE ( MCS.CollegeLevel1Code, ''-''),
			MainAimCollegeLevel1Name = COALESCE ( MCS.CollegeLevel1Name, ''-- Unknown --''),
			MainAimCollegeLevel2Code = COALESCE ( MCS.CollegeLevel2Code, ''-''),
			MainAimCollegeLevel2Name = COALESCE ( MCS.CollegeLevel2Name, ''-- Unknown --''),
			MainAimCollegeLevel3Code = COALESCE ( MCS.CollegeLevel3Code, ''-''),
			MainAimCollegeLevel3Name = COALESCE ( MCS.CollegeLevel3Name, ''-- Unknown --''),
			MainAimCollegeLevel4Code = COALESCE ( MCS.CollegeLevel4Code, ''-''),
			MainAimCollegeLevel4Name = COALESCE ( MCS.CollegeLevel4Name, ''-- Unknown --''),

			SSA1Code = AIM.SSA1Code,
			SSA1Title = AIM.SSA1Name,
			SSA2Code = AIM.SSA2Code,
			SSA2Title = AIM.SSA2Name,
			CourseCode = COALESCE ( CS.CourseCode, ''-''),
			CourseInstance = COALESCE ( CS.CourseInstance, ''-''),
			CourseTitle = COALESCE ( CS.CourseTitle, ''-- Unknown --''),

			AimSeqNumber = LD.AimSeqNumber,
			LearnerAndAimRowNum = 
				ROW_NUMBER () OVER (
					PARTITION BY
						LD.LearnRefNumber,
						LD.LearnAimRef,
						LD.StdCode,
						COALESCE ( LD.OrigLearnStartDate, LD.LearnStartDate )
					ORDER BY
						LD.CompStatus,
						COALESCE ( LD.ProgType, 99 ),
						CASE
							WHEN LD.AimType = 1 THEN 1 --Programme Aim
							WHEN LD.AimType = 5 THEN 2 --Core Aim
							ELSE 3
						END,
						COALESCE ( LD.PHours, 0 ) + COALESCE ( LD.AddHours, 0 ) DESC,
						DATEDIFF ( DAY, LD.LearnStartDate, COALESCE ( LD.LearnActEndDate, LD.LearnPlanEndDate ) ) DESC,
						LD.LearnStartDate,
						LD.AimSeqNumber
				),
			AimType = LD.AimType,
			LearningAimCode = LD.LearnAimRef,
			LearningAimTitle = AIM.LearningAimTitle,
			LearningAimTypeCode = AIM.LearningAimTypeCode,
			LearningAimTypeName = AIM.LearningAimTypeName,
			NVQLevelCode = AIM.NVQLevelCode,
			NVQLevelName = AIM.NVQLevelName,
			NVQLevelOrder = AIM.NVQLevelOrder,
			IsMathsAndEnglish = AIM.IsMathsAndEnglish,
			MainAimNVQLevelCode = COALESCE ( MA.NVQLevelCode, AIM.NVQLevelCode ),
			MainAimNVQLevelName = COALESCE ( MA.NVQLevelName, AIM.NVQLevelName ),
			MainAimNVQLevelOrder = COALESCE ( MA.NVQLevelOrder, AIM.NVQLevelOrder ),
			MainAimIsMathsAndEnglish = COALESCE ( MA.IsMathsAndEnglish, AIM.IsMathsAndEnglish ),
	'

	SET @SQLString += 
        N'
			CompletionStatusCode = LD.CompStatus,
			CompletionStatusName = 
				CASE
					WHEN LD.CompStatus = 1 THEN ''Continuing''
					WHEN LD.CompStatus = 2 THEN ''Completed''
					WHEN LD.CompStatus = 3 THEN ''Withdrawn''
					WHEN LD.CompStatus = 6 THEN ''Break in Learning''
					ELSE ''Unknown''
				END,
			OutcomeCode = LD.Outcome,
			OutcomeName = 
				CASE
					WHEN LD.Outcome IS NULL THEN NULL
					WHEN LD.Outcome = 1 THEN ''Achieved''
					WHEN LD.Outcome = 2 THEN ''Partialy Achieved''
					WHEN LD.Outcome = 3 THEN ''Fail''
					WHEN LD.Outcome = 8 THEN ''Unknown''
					ELSE ''Unknown''
				END,
			StartDate = LD.LearnStartDate,
			OriginalStartDate = LD.OrigLearnStartDate,
			PlannedEndDate = LD.LearnPlanEndDate,
			ActualEndDate = LD.LearnActEndDate,
			AchievementDate = LD.AchDate,
			RestartIndicator = COALESCE ( FM38.Restart, FM35.Restart, 0 ),
			Duration = FM.Duration,
			WithdrawReason = LD.WithdrawReason,
			Grade = LD.OutGrade,
			AwardBody = AIM.AwardBodyCode,
			StartYear = EY.StartYear,
			AchievementYear = EY.AchievementYear,
			PlannedEndYear = EY.PlannedEndYear,
			ActualEndYear = EY.ActualEndYear,
			ReportingYear = EY.ReportingYear,
			HybridEndYear = EY.HybridEndYear,
			LatestImportedFileAcademicYear = NULL,
			LatestImportedFileILRReturnDate = NULL,
			LatestImportedFileILRReturn = NULL,
			LatestImportedFileIsFinalReturn = NULL,
    '

	SET @SQLString += 
        N'
			IncludeInQARMeasures = NULL,
			QARNumberOfMergedYearsOfData = NULL,
			IsFundedStart = FM.FundStart,
			IsPastPlannedEndDate =
				CASE
					WHEN 
						COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
						THEN 1
					ELSE 0
				END,
			IsOverallStart = 
				CASE
					WHEN FM.AimStart = 1 THEN 1
					ELSE 0
				END,
			IsTimelyStart = 
				CASE
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						THEN 1
					ELSE 0
				END,
			IsOverallLeaver = 
				CASE
					WHEN 
						FM.Leaver = 1
						THEN 1
					ELSE 0
				END,
			IsTimelyLeaver = 
				CASE
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.Leaver = 1
						THEN 1
					ELSE 0
				END,
			IsOverallLeaverBestCase = 
				CASE
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus IN ( 1, 2, 3 )
						THEN 1
					ELSE 0
				END,
			IsTimelyLeaverBestCase = 
				CASE
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus IN ( 1, 2, 3 )
						THEN 1
					ELSE 0
				END,
			IsOverallAchieverBestCase = 
				CASE
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus IN ( 1, 2 )
						AND NOT LD.Outcome = 3
						THEN 1
					ELSE 0
				END,
			IsTimelyAchieverBestCase = 
				CASE
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus IN ( 1, 2 )
						AND NOT LD.Outcome = 3
						THEN 1
					ELSE 0
				END,
	'

    SET @SQLString += 
        N'
			IsOverallContinuer = 
				CASE 
					WHEN 
						LD.CompStatus = 1
						THEN 1 
					ELSE 0 
				END,
			IsTimelyContinuer = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND LD.CompStatus = 1
						THEN 1 
					ELSE 0 
				END,
			IsOverallContinuerNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND LD.CompStatus = 1
						THEN 1
					ELSE 0 
				END,
			IsTimelyContinuerNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND LD.CompStatus = 1
						THEN 1
					ELSE 0 
				END,
			IsOverallContinuerFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 1
						THEN 1 
					ELSE 0 
				END,
			IsTimelyContinuerFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 1
						THEN 1 
					ELSE 0 
				END,
	'

    SET @SQLString += 
        N'
			IsOverallCompleted = 
				CASE 
					WHEN 
						LD.CompStatus = 2
						THEN 1 
					ELSE 0 
				END,
			IsTimelyCompleted = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND LD.CompStatus = 2
						THEN 1 
					ELSE 0 
				END,
			IsOverallCompletedNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND LD.CompStatus = 2
						THEN 1
					ELSE 0 
				END,
			IsTimelyCompletedNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND LD.CompStatus = 2
						THEN 1
					ELSE 0 
				END,
			IsOverallCompletedFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 2
						THEN 1 
					ELSE 0 
				END,
			IsTimelyCompletedFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 2
						THEN 1 
					ELSE 0 
				END,
	'

    SET @SQLString += 
        N'
			IsOverallRetained = 
				CASE 
					WHEN 
						LD.CompStatus IN ( 1, 2 )
						THEN 1 
					ELSE 0 
				END,
			IsTimelyRetained = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND LD.CompStatus IN ( 1, 2 )
						THEN 1 
					ELSE 0 
				END,
			IsOverallRetainedNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND LD.CompStatus IN ( 1, 2 )
						THEN 1
					ELSE 0 
				END,
			IsTimelyRetainedNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND LD.CompStatus IN ( 1, 2 )
						THEN 1
					ELSE 0 
				END,
			IsOverallRetainedFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus IN ( 1, 2 )
						THEN 1 
					ELSE 0 
				END,
			IsTimelyRetainedFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus IN ( 1, 2 )
						THEN 1 
					ELSE 0 
				END,
	'

    SET @SQLString += 
        N'
			IsOverallWithdrawn = 
				CASE 
					WHEN 
						LD.CompStatus = 3
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
			IsTimelyWithdrawn = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND LD.CompStatus = 3
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
			IsOverallWithdrawnNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND LD.CompStatus = 3
						AND FM.Transfer = 0
						THEN 1
					ELSE 0 
				END,
			IsTimelyWithdrawnNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND LD.CompStatus = 3
						AND FM.Transfer = 0
						THEN 1
					ELSE 0 
				END,
			IsOverallWithdrawnFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 3
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
			IsTimelyWithdrawnFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 3
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
	'

	SET @SQLString += 
        N'
			IsOverallWithdrawnPreEligibility = 
				CASE 
					WHEN 
						FM.IsWithdrawnPreEligibility = 1
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
			IsTimelyWithdrawnPreEligibility = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.IsWithdrawnPreEligibility = 1
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
			IsOverallWithdrawnPreEligibilityNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND FM.IsWithdrawnPreEligibility = 1
						AND FM.Transfer = 0
						THEN 1
					ELSE 0 
				END,
			IsTimelyWithdrawnPreEligibilityNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND FM.IsWithdrawnPreEligibility = 1
						AND FM.Transfer = 0
						THEN 1
					ELSE 0 
				END,
			IsOverallWithdrawnPreEligibilityFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND FM.IsWithdrawnPreEligibility = 1
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
			IsTimelyWithdrawnPreEligibilityFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND FM.IsWithdrawnPreEligibility = 1
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
	'

	SET @SQLString += 
        N'
			IsOverallWithdrawnPostEligibility = 
				CASE 
					WHEN 
						FM.IsWithdrawnPostEligibility = 1
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
			IsTimelyWithdrawnPostEligibility = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.IsWithdrawnPostEligibility = 1
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
			IsOverallWithdrawnPostEligibilityNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND FM.IsWithdrawnPostEligibility = 1
						AND FM.Transfer = 0
						THEN 1
					ELSE 0 
				END,
			IsTimelyWithdrawnPostEligibilityNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND FM.IsWithdrawnPostEligibility = 1
						AND FM.Transfer = 0
						THEN 1
					ELSE 0 
				END,
			IsOverallWithdrawnPostEligibilityFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND FM.IsWithdrawnPostEligibility = 1
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
			IsTimelyWithdrawnPostEligibilityFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND FM.IsWithdrawnPostEligibility = 1
						AND FM.Transfer = 0
						THEN 1 
					ELSE 0 
				END,
	'

    SET @SQLString += 
        N'
			IsOverallTransfer = 
				CASE 
					WHEN 
						FM.Transfer = 1
						THEN 1 
					ELSE 0 
				END,
			IsTimelyTransfer = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.Transfer = 1
						THEN 1 
					ELSE 0 
				END,
			IsOverallTransferNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND FM.Transfer = 1
						THEN 1 
					ELSE 0 
				END,
			IsTimelyTransferNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND FM.Transfer = 1
						THEN 1 
					ELSE 0 
				END,
			IsOverallTransferFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND FM.Transfer = 1
						THEN 1 
					ELSE 0 
				END,
			IsTimelyTransferFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND FM.Transfer = 1
						THEN 1 
					ELSE 0 
				END,
			IsTransferValid = FM.TransferValid,
	'

    SET @SQLString += 
        N'
			IsOverallBreakInLearning = 
				CASE 
					WHEN 
						FM.BreakInLearning = 1
						THEN 1 
					ELSE 0 
				END,
			IsTimelyBreakInLearning = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND FM.BreakInLearning = 1
						THEN 1 
					ELSE 0 
				END,
			IsOverallBreakInLearningNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND FM.BreakInLearning = 1
						THEN 1
					ELSE 0 
				END,
			IsTimelyBreakInLearningNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND FM.BreakInLearning = 1
						THEN 1
					ELSE 0 
				END,
			IsOverallBreakInLearningFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND FM.BreakInLearning = 1
						THEN 1 
					ELSE 0 
				END,
			IsTimelyBreakInLearningFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND FM.BreakInLearning = 1
						THEN 1 
					ELSE 0 
				END,
			IsBreakInLearningValid = FM.BreakInLearningValid,
	'

    SET @SQLString += 
        N'
			IsOverallAchiever = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						THEN 1 
					ELSE 0 
				END,
			IsTimelyAchiever = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						THEN 1 
					ELSE 0 
				END,
			IsOverallAchieverNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						THEN 1
					ELSE 0 
				END,
			IsTimelyAchieverNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						THEN 1
					ELSE 0 
				END,
			IsOverallAchieverFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						THEN 1 
					ELSE 0 
				END,
			IsTimelyAchieverFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						THEN 1 
					ELSE 0 
				END,
	'

    SET @SQLString += 
        N'
			IsOverallFailed = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 3
						THEN 1 
					ELSE 0 
				END,
			IsTimelyFailed = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 3
						THEN 1 
					ELSE 0 
				END,
			IsOverallFailedNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND LD.CompStatus = 2
						AND LD.Outcome = 3
						THEN 1
					ELSE 0 
				END,
			IsTimelyFailedNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND LD.CompStatus = 2
						AND LD.Outcome = 3
						THEN 1
					ELSE 0 
				END,
			IsOverallFailedFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 3
						THEN 1 
					ELSE 0 
				END,
			IsTimelyFailedFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 3
						THEN 1 
					ELSE 0 
				END,
	'

    SET @SQLString += 
        N'
			IsOverallUnknownOutcome = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 8
						THEN 1 
					ELSE 0 
				END,
			IsTimelyUnknownOutcome = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 8
						THEN 1 
					ELSE 0 
				END,
			IsOverallUnknownOutcomeNotFunded = 
				CASE 
					WHEN 
						FM.AimStart = 0
						AND LD.CompStatus = 2
						AND LD.Outcome = 8
						THEN 1
					ELSE 0 
				END,
			IsTimelyUnknownOutcomeNotFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 0
						AND LD.CompStatus = 2
						AND LD.Outcome = 8
						THEN 1
					ELSE 0 
				END,
			IsOverallUnknownOutcomeFunded = 
				CASE 
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 8
						THEN 1 
					ELSE 0 
				END,
			IsTimelyUnknownOutcomeFunded = 
				CASE 
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 8
						THEN 1 
					ELSE 0 
				END,
			IsUnknownOutcomeValid = FM.UnknownOutcomeValid,
	'

    SET @SQLString += 
        N'
			IsOverallHighGrade = 
				CASE
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						AND AIM.LearningAimTypeCode IN ( ''0001'', ''0002'' ) 
						AND LD.OutGrade IN ( ''A*'', ''A'', ''B'' ) 
							THEN 1
					WHEN 
						FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						AND AIM.LearningAimTypeCode IN ( ''0003'', ''1422'', ''2999'' )
						AND LD.OutGrade IN ( ''A*'', ''A'', ''B'', ''C'', ''9'', ''8'', ''7'', ''6'', ''5'', ''4'' ) 
							THEN 1
					WHEN 
						LD.OutGrade LIKE ''D%'' 
							THEN 1
					ELSE 0
				END,
			IsTimelyHighGrade = 
				CASE
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						AND AIM.LearningAimTypeCode IN ( ''0001'', ''0002'' ) 
						AND LD.OutGrade IN ( ''A*'', ''A'', ''B'' ) 
						THEN 1
					WHEN 
						CASE
							WHEN 
								COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) > LD.LearnPlanEndDate
								THEN 1
							ELSE 0
						END = 0
						AND FM.AimStart = 1
						AND LD.CompStatus = 2
						AND LD.Outcome = 1
						AND AIM.LearningAimTypeCode IN ( ''0003'', ''1422'', ''2999'' )
						AND LD.OutGrade IN ( ''A*'', ''A'', ''B'', ''C'', ''9'', ''8'', ''7'', ''6'', ''5'', ''4'' ) 
							THEN 1
					WHEN 
						LD.OutGrade LIKE ''D%'' 
							THEN 1
					ELSE 0
				END,
	'

    SET @SQLString += 
        N'
			IsOutOfFunding30Days = 
				CASE
					WHEN
						FM.AimStart = 1
						AND FM.FundLine LIKE ''%Apprenticeship%''
						AND DATEDIFF ( DAY, LD.LearnPlanEndDate, COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) ) >= 30
							THEN 1
					ELSE 0
				END,
			IsOutOfFunding60Days = 
				CASE
					WHEN
						FM.AimStart = 1
						AND FM.FundLine LIKE ''%Apprenticeship%''
						AND DATEDIFF ( DAY, LD.LearnPlanEndDate, COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) ) >= 60
							THEN 1
					ELSE 0
				END,
			IsOutOfFunding90Days = 
				CASE
					WHEN
						FM.AimStart = 1
						AND FM.FundLine LIKE ''%Apprenticeship%''
						AND DATEDIFF ( DAY, LD.LearnPlanEndDate, COALESCE ( LD.LearnActEndDate, CAST ( GETDATE() AS DATE ) ) ) >= 90
							THEN 1
					ELSE 0
				END,

	'

    SET @SQLString += 
        N'
			PlanLearnHours = COALESCE ( L.PlanLearnHours, 0 ),
			PlanEEPHours = COALESCE ( L.PlanEEPHours, 0 ),
			FM25PlanLearnHoursAim = COALESCE ( CASE WHEN LD.FundModel = 25 AND ( FM.Transfer = 0 OR HRS.TFerOnly = 1 ) THEN CH.PlannedHours END, 0 ),
			FM25EEPHoursAim = COALESCE ( CASE WHEN LD.FundModel = 25 AND ( FM.Transfer = 0 OR HRS.TFerOnly = 1 ) THEN CH.EEPHours END, 0 ),
			FM25TLevelHoursAim = COALESCE ( CASE WHEN LD.FundModel = 25 AND ( FM.Transfer = 0 OR HRS.TFerOnly = 1 ) THEN CH.TLevelHours END, 0 ),
			FM25PlanLearnHoursAllAims = COALESCE ( HRS.PlannedHours, 0 ),
			FM25EEPHoursAllAims = COALESCE ( HRS.EEPHours, 0 ),
			FM25TLevelHoursAllAims = COALESCE ( HRS.TLevelHours, 0 ),
			IsPartTime = 
				CASE
					WHEN FM25.RateBand LIKE ''%Band 5%'' THEN ''N''
					WHEN FM25.RateBand LIKE ''%Band 4a%'' THEN ''N''
					WHEN FM25.RateBand LIKE ''%T level%'' THEN ''N''
					WHEN HE.MODESTUD = 1 THEN ''N''
					WHEN COALESCE ( L.PlanLearnHours, 0 ) + COALESCE ( L.PlanEEPHours, 0 ) >= 450 THEN ''N''
					ELSE ''Y''
				END,

			ProgType = LD.ProgType,
			StandardCode = LD.StdCode,
			StandardName = COALESCE ( STD.StandardName, CASE WHEN LD.StdCode IS NULL THEN NULL ELSE ''-- Unknown --'' END ),
			FrameworkCode = NULL,
			FrameworkName = NULL,
			PathwayCode = NULL,
			PathwayName = NULL,
			OffTheJobActualHours = LD.OTJActHours,
			EmployerID = EMP.EmployerID,
			EmployerName = EMPN.EmployerName,
			PartnerCode = 
				CASE
					WHEN LD.LearnAimRef = ''ZPROG001'' THEN PTR.PartnerUKPRN
					ELSE LD.PartnerUKPRN
				END,
			PartnerName = PAR.PartnerName,

			AimValue = COALESCE ( FM38.AimValue, FM35.AimValue ),
			ProgWeightFactor = FM35.ApplicProgWeightFact,
			UnweightFundRate = COALESCE ( FM38.ApplicUnweightFundRate, FM35.ApplicUnweightFundRate ),
			WeightFundRate = COALESCE ( FM38.ApplicWeightFundRate, FM35.ApplicWeightFundRate ),

			CoFundingIndicator = 
				CASE
					WHEN FFI.LearnDelFAMCode IS NULL THEN NULL
					WHEN FFI.LearnDelFAMCode = ''1'' THEN ''Full''
					WHEN FFI.LearnDelFAMCode = ''2'' THEN ''Co''
					ELSE NULL
				END,
			IsCarryIn = 
				CASE
					WHEN CAST ( LD.LearnStartDate AS DATE ) <= ''20'' + LEFT ( @AcademicYear, 2) + ''-08-01'' THEN 1
					ELSE 0
				END,
			HEQualEnt3 = HE.QUALENT3,
			HESoc = HE.SOC,
			HESec = HE.SEC,
			HEUCASSchemeCode = HE.UCASSCHEMECODE,
			HETypeYr = HE.TYPEYR,
			HEModeStu = HE.MODESTUD,
			HEFundLev = HE.FUNDLEV,
			HEFundComp = HE.FUNDCOMP,
			HEStuLoad = HE.STULOAD,
			HEYearStu = HE.YEARSTU,
			HEMajorSourceStuFee = HE.MSTUFEE,
			HEPercentageNotTaught = HE.PCOLAB,
			HEPercentTaughtFirstLDCS = NULL,
			HEPercentTaughtSecondLDCS = NULL,
			HEPercentTaughtThirdLDCS = NULL,
			HESpecialFeeIndicator = HE.SPECFEE,
			HENetTuitionFee = HE.NETFEE,
			HEGrossTuitionFee = HE.GROSSFEE,
			HEPermAddCountry = HE.PERMADDCOUNTRY,
			HEELQ = HE.ELQ,
			HEPostCode = HE.HEPostCode,
			EnrolmentID = PSDMC.ProvSpecDelMon,
			FM25TotalEarnedCash = COALESCE ( HRS.OnProgPayment, 0 ),
	'

    SET @SQLString += 
        N'
			ProvSpecLearnMonA = PSLMA.ProvSpecLearnMon,
			ProvSpecLearnMonB = PSLMB.ProvSpecLearnMon,
			ProvSpecLearnMonC = PSLMC.ProvSpecLearnMon,
			ProvSpecLearnMonD = PSLMD.ProvSpecLearnMon,
			ProvSpecDelMonA = PSDMA.ProvSpecDelMon,
			ProvSpecDelMonB = PSDMB.ProvSpecDelMon,
			ProvSpecDelMonC = PSDMC.ProvSpecDelMon,
			ProvSpecDelMonD = PSDMD.ProvSpecDelMon,
			
			NumPlannedOnProgPayments = COALESCE ( ALB.PlannedNumOnProgInstalm, FM36.PlannedNumOnProgInstalm, FM38.PlannedNumOnProgInstalm, FM35.PlannedNumOnProgInstalm ),
			NumOutstandingOnProgPayments = COALESCE ( ALB.OutstndNumOnProgInstalm, FM36.OutstandNumOnProgInstalm, FM38.OutstndNumOnProgInstalm, FM35.OutstndNumOnProgInstalm ),
			AchieveElement = COALESCE ( FM38.AchieveElement, FM35.AchieveElement ),
			NonGovCont = COALESCE ( FM38.NonGovCont, FM35.NonGovCont ),
			PropFundRemain = COALESCE ( FM38.PropFundRemain, FM35.PropFundRemain ),
			PropFundRemainAchComp = FM38.PropFundRemainAchComp,
			PropFundRemainAch = FM35.PropFundRemainAch,
			CarryInOnProg = 
				CASE
					WHEN COALESCE ( FM38.PropFundRemain, FM35.PropFundRemain, 0 ) = 0 THEN 0
					ELSE 
						( COALESCE ( FM38.AimValue, FM35.AimValue ) - COALESCE ( FM38.NonGovCont, FM35.NonGovCont ) - COALESCE ( FM38.AchieveElement, FM35.AchieveElement ) ) * COALESCE ( FM38.PropFundRemain, FM35.PropFundRemain )
				END,
	'

    SET @SQLString += 
        N'
			CarryInYr1R01 = COALESCE ( FM38CI.CarryInYr1R01, FM35CI.CarryInYr1R01 ),
			CarryInYr1R02 = COALESCE ( FM38CI.CarryInYr1R02, FM35CI.CarryInYr1R02 ),
			CarryInYr1R03 = COALESCE ( FM38CI.CarryInYr1R03, FM35CI.CarryInYr1R03 ),
			CarryInYr1R04 = COALESCE ( FM38CI.CarryInYr1R04, FM35CI.CarryInYr1R04 ),
			CarryInYr1R05 = COALESCE ( FM38CI.CarryInYr1R05, FM35CI.CarryInYr1R05 ),
			CarryInYr1R06 = COALESCE ( FM38CI.CarryInYr1R06, FM35CI.CarryInYr1R06 ),
			CarryInYr1R07 = COALESCE ( FM38CI.CarryInYr1R07, FM35CI.CarryInYr1R07 ),
			CarryInYr1R08 = COALESCE ( FM38CI.CarryInYr1R08, FM35CI.CarryInYr1R08 ),
			CarryInYr1R09 = COALESCE ( FM38CI.CarryInYr1R09, FM35CI.CarryInYr1R09 ),
			CarryInYr1R10 = COALESCE ( FM38CI.CarryInYr1R10, FM35CI.CarryInYr1R10 ),
			CarryInYr1R11 = COALESCE ( FM38CI.CarryInYr1R11, FM35CI.CarryInYr1R11 ),
			CarryInYr1R12 = COALESCE ( FM38CI.CarryInYr1R12, FM35CI.CarryInYr1R12 ),
			CarryInYr2R01 = COALESCE ( FM38CI.CarryInYr2R01, FM35CI.CarryInYr2R01 ),
			CarryInYr2R02 = COALESCE ( FM38CI.CarryInYr2R02, FM35CI.CarryInYr2R02 ),
			CarryInYr2R03 = COALESCE ( FM38CI.CarryInYr2R03, FM35CI.CarryInYr2R03 ),
			CarryInYr2R04 = COALESCE ( FM38CI.CarryInYr2R04, FM35CI.CarryInYr2R04 ),
			CarryInYr2R05 = COALESCE ( FM38CI.CarryInYr2R05, FM35CI.CarryInYr2R05 ),
			CarryInYr2R06 = COALESCE ( FM38CI.CarryInYr2R06, FM35CI.CarryInYr2R06 ),
			CarryInYr2R07 = COALESCE ( FM38CI.CarryInYr2R07, FM35CI.CarryInYr2R07 ),
			CarryInYr2R08 = COALESCE ( FM38CI.CarryInYr2R08, FM35CI.CarryInYr2R08 ),
			CarryInYr2R09 = COALESCE ( FM38CI.CarryInYr2R09, FM35CI.CarryInYr2R09 ),
			CarryInYr2R10 = COALESCE ( FM38CI.CarryInYr2R10, FM35CI.CarryInYr2R10 ),
			CarryInYr2R11 = COALESCE ( FM38CI.CarryInYr2R11, FM35CI.CarryInYr2R11 ),
			CarryInYr2R12 = COALESCE ( FM38CI.CarryInYr2R12, FM35CI.CarryInYr2R12 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentToPeriod = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) * TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeHEAdvLoanPossibleIncome = 1 THEN ALBP.TotalEarnedCashToPeriod END, FM38P.OnProgPaymentToPeriod, FM35P.OnProgPaymentToPeriod, FM36PM.OnProgPaymentToPeriod, FM36P.OnProgPaymentToPeriod, ( CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ), 0 ),
			LearnSuppPaymentToPeriod = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) * TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) END, FM38P.LearnSuppPaymentToPeriod, FM35P.LearnSuppPaymentToPeriod, FM36PM.LearnSuppPaymentToPeriod, FM36P.LearnSuppPaymentToPeriod, 0 ),
			AchCompPaymentToPeriod = COALESCE ( FM38P.AchCompPaymentToPeriod, FM35P.AchCompPaymentToPeriod, FM36PM.AchCompPaymentToPeriod, FM36P.AchCompPaymentToPeriod, 0 ),
			BalancePaymentToPeriod = COALESCE ( FM38P.BalancePaymentToPeriod, FM35P.BalancePaymentToPeriod, FM36PM.BalancePaymentToPeriod, FM36P.BalancePaymentToPeriod, 0 ),
			EmpOutcomePayToPeriod = COALESCE ( FM38P.EmpOutcomePayToPeriod, FM35P.EmpOutcomePayToPeriod, 0 ),
			OtherPaymentToPeriod = COALESCE ( FM36PM.OtherPaymentToPeriod, FM36P.OtherPaymentToPeriod, 0 ),
			TotalEarnedCashToPeriod = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) * TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashToPeriod END, FM38P.TotalEarnedCashToPeriod, FM35P.TotalEarnedCashToPeriod, FM36PM.TotalEarnedCashToPeriod, FM36P.TotalEarnedCashToPeriod, ( CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ), 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentMidYear = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) * 6 END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashMidYear END, FM38P.OnProgPaymentMidYear, FM35P.OnProgPaymentMidYear, FM36PM.OnProgPaymentMidYear, FM36P.OnProgPaymentMidYear, ( CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * 6, 0 ),
			LearnSuppPaymentMidYear = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) * 6 END, FM38P.LearnSuppPaymentMidYear, FM35P.LearnSuppPaymentMidYear, FM36PM.LearnSuppPaymentMidYear, FM36P.LearnSuppPaymentMidYear, 0 ),
			AchCompPaymentMidYear = COALESCE ( FM38P.AchCompPaymentMidYear, FM35P.AchCompPaymentMidYear, FM36PM.AchCompPaymentMidYear, FM36P.AchCompPaymentMidYear, 0 ),
			BalancePaymentMidYear = COALESCE ( FM38P.BalancePaymentMidYear, FM35P.BalancePaymentMidYear, FM36PM.BalancePaymentMidYear, FM36P.BalancePaymentMidYear, 0 ),
			EmpOutcomePayMidYear = COALESCE ( FM38P.EmpOutcomePayMidYear, FM35P.EmpOutcomePayMidYear, 0 ),
			OtherPaymentMidYear = COALESCE ( FM36PM.OtherPaymentMidYear, FM36P.OtherPaymentMidYear, 0 ),
			TotalEarnedCashMidYear = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) * 6 END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashMidYear END, FM38P.TotalEarnedCashMidYear, FM35P.TotalEarnedCashMidYear, FM36PM.TotalEarnedCashMidYear, FM36P.TotalEarnedCashMidYear, ( CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * 6, 0 ),
	'

    SET @SQLString += 
		N'
			OnProgPaymentYearEnd = COALESCE ( CASE WHEN LD.FundModel = 25 THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashYearEnd END, FM38P.OnProgPaymentYearEnd, FM35P.OnProgPaymentYearEnd, FM36PM.OnProgPaymentYearEnd, FM36P.OnProgPaymentYearEnd, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END, 0 ),
			LearnSuppPaymentYearEnd = COALESCE ( CASE WHEN LD.FundModel = 25 THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END END, FM38P.LearnSuppPaymentYearEnd, FM35P.LearnSuppPaymentYearEnd, FM36PM.LearnSuppPaymentYearEnd, FM36P.LearnSuppPaymentYearEnd, 0 ),
			AchCompPaymentYearEnd = COALESCE ( FM38P.AchCompPaymentYearEnd, FM35P.AchCompPaymentYearEnd, FM36PM.AchCompPaymentYearEnd, FM36P.AchCompPaymentYearEnd, 0 ),
			BalancePaymentYearEnd = COALESCE ( FM38P.BalancePaymentYearEnd, FM35P.BalancePaymentYearEnd, FM36PM.BalancePaymentYearEnd, FM36P.BalancePaymentYearEnd, 0 ),
			EmpOutcomePayYearEnd = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentYearEnd = COALESCE ( FM36PM.OtherPaymentYearEnd, FM36P.OtherPaymentYearEnd, 0 ),
			TotalEarnedCashYearEnd = COALESCE ( CASE WHEN LD.FundModel = 25 THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashYearEnd END, FM38P.TotalEarnedCashYearEnd, FM35P.TotalEarnedCashYearEnd, FM36PM.TotalEarnedCashYearEnd, FM36P.TotalEarnedCashYearEnd, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END, 0 ),
	'

    SET @SQLString += 
        N'
			TotalEarnedCashYearEndNotApportioned = COALESCE ( CASE WHEN LD.FundModel = 25 THEN 
				CASE
					WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
						( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
						+ ( 
							FM25.OnProgPayment 
							- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
						)
					ELSE FM25.OnProgPayment
				END
				END, 
				CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashYearEnd END, FM38P.TotalEarnedCashYearEnd, FM35P.TotalEarnedCashYearEnd, FM36PM.TotalEarnedCashYearEnd, FM36P.TotalEarnedCashYearEnd, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END, 0 ),

			FutureAchievePayment = 
				CASE
					WHEN LD.CompStatus <> 1 AND NOT ( LD.CompStatus = 2 AND LD.Outcome = 8 ) THEN 0
					WHEN LD.LearnPlanEndDate NOT BETWEEN ''20'' + LEFT ( @AcademicYear, 2 ) + ''-08-01'' AND ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31'' THEN 0
					ELSE COALESCE ( FM38.AchieveElement - FM38P.AchCompPaymentYearEnd, FM35.AchieveElement - FM35P.AchCompPaymentYearEnd, FM36PE.PriceEpisodeCompletionElement - COALESCE ( FM36PM.AchCompPaymentYearEnd, FM36P.AchCompPaymentYearEnd ) )
				END,
			FutureAchieveWeighting = @FutureAchievementWeighting,
			FutureAchievePaymentWeighted = 
				CASE
					WHEN LD.CompStatus <> 1 AND NOT ( LD.CompStatus = 2 AND LD.Outcome = 8 ) THEN 0
					WHEN LD.LearnPlanEndDate NOT BETWEEN ''20'' + LEFT ( @AcademicYear, 2 ) + ''-08-01'' AND ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31'' THEN 0
					ELSE COALESCE ( FM38.AchieveElement - FM38P.AchCompPaymentYearEnd, FM35.AchieveElement - FM35P.AchCompPaymentYearEnd, FM36PE.PriceEpisodeCompletionElement - COALESCE ( FM36PM.AchCompPaymentYearEnd, FM36P.AchCompPaymentYearEnd ) ) * @FutureAchievementWeighting
				END,
	'

	SET @SQLString += 
        N'
			--Info needed for calculating funding formula
			PrvRetentFactHist = FM25.PrvRetentFactHist,
			ProgWeightHist = FM25.ProgWeightHist,
			ProgWeightNew = FM25.ProgWeightNew,
			LearnerEnglishMathsFundingRate = 
				CASE
					WHEN FM25.StartFund = 0 THEN 0
					WHEN FM25.RateBand LIKE ''%T level Band 8%'' THEN COALESCE ( @EnglishMathsFundingHigherRate, 0 )
					WHEN FM25.RateBand LIKE ''%T level Band 7%'' THEN COALESCE ( @EnglishMathsFundingHigherRate, 0 )
					WHEN FM25.RateBand LIKE ''%T level Band 6%'' THEN COALESCE ( @EnglishMathsFundingHigherRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 5%'' THEN COALESCE ( @EnglishMathsFundingHigherRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 4b%'' THEN COALESCE ( @EnglishMathsFundingHigherRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 4a%'' THEN COALESCE ( @EnglishMathsFundingHigherRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 3%'' THEN COALESCE ( @EnglishMathsFundingLowerRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 2%'' THEN COALESCE ( @EnglishMathsFundingLowerRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 1%'' THEN COALESCE ( @EnglishMathsFundingHigherRate, 0 ) * FM25.FullTimeEquiv
					ELSE 0
				END,
			LearnerEnglishMathsInstances = COALESCE ( FM25.LearnerEnglishMathsInstances, 0 ),
			Block1DisadvUplift = COALESCE ( FM25.Block1DisadvUpliftNew, 0 ),
			Block2DisadvFundingRate = 
				CASE
					WHEN FM25.StartFund = 0 THEN 0
					WHEN FM25.RateBand LIKE ''%T level Band 8%'' THEN COALESCE ( @Block2DisadvFundingTLevelRate, 0 )
					WHEN FM25.RateBand LIKE ''%T level Band 7%'' THEN COALESCE ( @Block2DisadvFundingTLevelRate, 0 )
					WHEN FM25.RateBand LIKE ''%T level Band 6%'' THEN COALESCE ( @Block2DisadvFundingTLevelRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 5%'' THEN COALESCE ( @Block2DisadvFundingHigherRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 4b%'' THEN COALESCE ( @Block2DisadvFundingHigherRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 4a%'' THEN COALESCE ( @Block2DisadvFundingHigherRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 3%'' THEN COALESCE ( @Block2DisadvFundingLowerRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 2%'' THEN COALESCE ( @Block2DisadvFundingLowerRate, 0 )
					WHEN FM25.RateBand LIKE ''%Band 1%'' THEN COALESCE ( @Block2DisadvFundingHigherRate, 0 ) * FM25.FullTimeEquiv
					ELSE 0
				END,
			Block2DisadvElementsNew = COALESCE ( FM25.Block2DisadvElementsNew, 0 ),
			LargeProgrammeUplift = 
				(
					(
						@LargeProgramme10PercentUpliftAmount
						*
						@LargeProgramme10PercentUpliftNumLearners
					)
					+
					(
						@LargeProgramme20PercentUpliftAmount
						*
						@LargeProgramme20PercentUpliftNumLearners
					)
				)
				/
				CAST ( COALESCE ( FM25LRNS.Learners, 0 ) AS FLOAT ),
			AreaCostFact1618Hist = COALESCE ( FM25.AreaCostFact1618Hist, 0 ),
			ConditionOfFundingAdjustment = 
				CASE
					WHEN COALESCE ( FM25LRNS.Learners, 0 ) = 0 THEN 0
					ELSE 
						CAST ( @ConditionOfFundingAdjustment AS FLOAT ) 
						/ 
						CAST ( COALESCE ( FM25LRNS.Learners, 0 ) AS FLOAT )
				END,
			AdvancedMathsPremium = 
				CASE
					WHEN AMP.LearnAimRef IS NOT NULL THEN COALESCE ( @AdvancedMathsPremiumFundingRate, 0 )
					ELSE 0
				END,
			CoreMathsPremium = 
				CASE
					WHEN FM25.StartFund = 0 THEN 0
					WHEN AMP.LearnAimRef IS NOT NULL THEN 0 --Do not fund same learner for both adv and core Maths
					WHEN LD.LearnAimRef IN (
						''60147830'',
						''60147829'',
						''60148573'',
						''60149450''
					) THEN COALESCE ( @CoreMathsPremiumFundingRate, 0 ) 
					ELSE 0
				END,
			HighValueCoursePremium = 
				CASE
					WHEN HVC.LearnAimRef IS NOT NULL THEN COALESCE ( @HighValueCoursesPremiumFundingRate, 0 )
					ELSE 0
				END,
			TLevelIndustryPlacementFunding = 
				CASE
					WHEN IND.LearnRefNumber IS NOT NULL THEN CAST ( COALESCE ( @IndustryPlacementFullFundingRate, 0 ) AS FLOAT ) / CAST ( 2 AS FLOAT )
					ELSE 0
				END,
			NationalFundingRate = 
				CASE 
					WHEN FM25.StartFund = 0 THEN 0
					WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN FM25.NatRate 
					ELSE 0 
				END,
	'

    SET @SQLString += 
        N'
			AppStandardPriceEpisodeIdentifier = FM36PE.PriceEpisodeIdentifier,
			AppStandardTNP1 = FM36PE.TNP1,
			AppStandardTNP2 = FM36PE.TNP2,
			AppStandardTNP3 = FM36PE.TNP3,
			AppStandardTNP4 = FM36PE.TNP4,
			AppStandardEpisodeStartDate = FM36PE.EpisodeStartDate,
			AppStandardPriceEpisode1618FrameworkUpliftRemainingAmount = NULL,
			AppStandardPriceEpisode1618FrameworkUpliftTotPrevEarnings = NULL,
			AppStandardPriceEpisode1618FUBalValue = NULL,
			AppStandardPriceEpisode1618FUMonthInstValue = NULL,
			AppStandardPriceEpisode1618FUTotEarnings = NULL,
			AppStandardPriceEpisodeUpperBandLimit = FM36PE.PriceEpisodeUpperBandLimit,
			AppStandardPriceEpisodePlannedEndDate = FM36PE.PriceEpisodePlannedEndDate,
			AppStandardPriceEpisodeActualEndDate = FM36PE.PriceEpisodeActualEndDate,
			AppStandardPriceEpisodeActualEndDateIncEPA = FM36PE.PriceEpisodeActualEndDateIncEPA,
			AppStandardPriceEpisodeTotalTNPPrice = FM36PE.PriceEpisodeTotalTNPPrice,
			AppStandardPriceEpisodeUpperLimitAdjustment = FM36PE.PriceEpisodeUpperLimitAdjustment,
			AppStandardPriceEpisodePlannedInstalments = FM36PE.PriceEpisodePlannedInstalments,
			AppStandardPriceEpisodeActualInstalments = FM36PE.PriceEpisodeActualInstalments,
			AppStandardPriceEpisodeCompletionElement = FM36PE.PriceEpisodeCompletionElement,
			AppStandardPriceEpisodePreviousEarnings = FM36PE.PriceEpisodePreviousEarnings,
			AppStandardPriceEpisodeInstalmentValue = FM36PE.PriceEpisodeInstalmentValue,
			AppStandardPriceEpisodeTotalEarnings = FM36PE.PriceEpisodeTotalEarnings,
			AppStandardPriceEpisodeCompleted = FM36PE.PriceEpisodeCompleted,
			AppStandardPriceEpisodeRemainingTNPAmount = FM36PE.PriceEpisodeRemainingTNPAmount,
			AppStandardPriceEpisodeRemainingAmountWithinUpperLimit = FM36PE.PriceEpisodeRemainingAmountWithinUpperLimit,
			AppStandardPriceEpisodeCappedRemainingTNPAmount = FM36PE.PriceEpisodeCappedRemainingTNPAmount,
			AppStandardPriceEpisodeExpectedTotalMonthlyValue = FM36PE.PriceEpisodeExpectedTotalMonthlyValue,
			AppStandardPriceEpisodeAimSeqNumber = FM36PE.PriceEpisodeAimSeqNumber,
			AppStandardPriceEpisodeApplic1618FrameworkUpliftCompElement = NULL,
			AppStandardPriceEpisodeFundLineType = FM36PE.PriceEpisodeFundLineType,
			AppStandardEpisodeEffectiveTNPStartDate = FM36PE.EpisodeEffectiveTNPStartDate,
			AppStandardPriceEpisodeFirstAdditionalPaymentThresholdDate = FM36PE.PriceEpisodeFirstAdditionalPaymentThresholdDate,
			AppStandardPriceEpisodeSecondAdditionalPaymentThresholdDate = FM36PE.PriceEpisodeSecondAdditionalPaymentThresholdDate,
			AppStandardPriceEpisodeContractType = FM36PE.PriceEpisodeContractType,
			AppStandardPriceEpisodePreviousEarningsSameProvider = FM36PE.PriceEpisodePreviousEarningsSameProvider,
			AppStandardPriceEpisodeTotalPMRs = FM36PE.PriceEpisodeTotalPMRs,
			AppStandardPriceEpisodeCumulativePMRs = FM36PE.PriceEpisodeCumulativePMRs,
			AppStandardPriceEpisodeCompExemCode = FM36PE.PriceEpisodeCompExemCode,
			AppStandardPriceEpisodeLearnerAdditionalPaymentThresholdDate = FM36PE.PriceEpisodeLearnerAdditionalPaymentThresholdDate,
			AppStandardPriceEpisodeRedStartDate = FM36PE.PriceEpisodeRedStartDate,
			AppStandardPriceEpisodeRedStatusCode = FM36PE.PriceEpisodeRedStatusCode

			--INTO FIS_FundingDataTemp
	'
    
    SET @SQLString += 
        N'
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		INNER JOIN ' + @FISDatabase + '.Valid.Source SRC
			ON 1 = 1
		INNER JOIN #HybridEndYears EY
			ON EY.LearnRefNumber = LD.LearnRefNumber
			AND EY.AimSeqNumber = LD.AimSeqNumber
	'
    
    SET @SQLString += 
		N'
		INNER JOIN #MainAim MA
			ON MA.LearnRefNumber = LD.LearnRefNumber
			AND MA.RowNumLearner = 1
	'

    SET @SQLString += 
        N'
		LEFT JOIN ' + @FISDatabase + '.Valid.LearningDeliveryFAM FFI
			ON FFI.LearnRefNumber = LD.LearnRefNumber
			AND FFI.AimSeqNumber = LD.AimSeqNumber
			AND FFI.LearnDelFAMType = ''FFI''

		LEFT JOIN (
			SELECT
				LearnerRef = EMP.LearnRefNumber,
				EmpStatusCode = EMP.EmpStat,
				EmpStatusName = 
					CASE
						WHEN EMP.EmpStat = 10 THEN ''InEmp''
						WHEN EMP.EmpStat = 11 THEN ''NoEmpLooking''
						WHEN EMP.EmpStat = 12 THEN ''NoEmpNotLooking''
						WHEN EMP.EmpStat = 98 THEN ''Unknown''
						ELSE ''Unknown''
					END,
				EmpStatusAppliesDate = EMP.DateEmpStatApp,
				EmployerID = EMP.EmpId,
				RowNum =
					ROW_NUMBER () OVER (
						PARTITION BY
							EMP.LearnRefNumber
						ORDER BY
							EMP.DateEmpStatApp DESC
					)
			FROM ' + @FISDatabase + '.Valid.LearnerEmploymentStatus EMP
		) EMP
			ON EMP.LearnerRef = L.LearnRefNumber
			AND EMP.RowNum = 1
		LEFT JOIN (
			SELECT
				ATN.UKPRN,
				ATN.LearnRefNumber,
				ATN.PriorLevel,
				ATN.DateLevelApp,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							ATN.UKPRN,
							ATN.LearnRefNumber
						ORDER BY
							ATN.DateLevelApp DESC
					)
			FROM ' + @FISDatabase + '.Valid.LearnerPriorAttain ATN
		) ATN
			ON ATN.LearnRefNumber = L.LearnRefNumber
			AND ATN.UKPRN = L.UKPRN
			AND ATN.RowNum = 1
		LEFT JOIN ' + @FISDatabase + '.Valid.LLDDandHealthProblem LLDD
			ON LLDD.LearnRefNumber = L.LearnRefNumber
			AND LLDD.PrimaryLLDD = 1
		LEFT JOIN (
			SELECT
				PVT.LearnRefNumber,
				PVT.DateEmpStatApp,
				PVT.LOE,
				PVT.LOU,
				PVT.BSI,
				PVT.SEM,
				PVT.SEI,
				PVT.EII,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							PVT.LearnRefNumber
						ORDER BY
							PVT.DateEmpStatApp DESC
					)
			FROM (
				SELECT
					ESM.LearnRefNumber,
					ESM.DateEmpStatApp,
					ESM.ESMType,
					ESM.ESMCode
				FROM ' + @FISDatabase + '.Valid.EmploymentStatusMonitoring ESM
			) ESM
			PIVOT (
				MAX ( ESMCode )
				FOR ESMType IN ( [LOE], [LOU], [BSI], [SEM], [SEI], [EII] )
			) AS PVT
		) ESM
			ON ESM.LearnRefNumber = L.LearnRefNumber
			AND ESM.RowNum = 1
    '

    SET @SQLString += 
        N'
		LEFT JOIN ( --Partner UKPRN not against prog aim so get this here
			SELECT
				LD.LearnRefNumber,
				LD.PartnerUKPRN,
				RowNum = ROW_NUMBER () OVER (
					PARTITION BY
						LD.LearnRefNumber
					ORDER BY
						LD.CompStatus,
						DATEDIFF ( DAY, LD.LearnStartDate, LD.LearnPlanEndDate ) DESC,
						LD.PartnerUKPRN
				)
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			WHERE
				LD.PartnerUKPRN IS NOT NULL
		) PTR
			ON PTR.LearnRefNumber = L.LearnRefNumber
			AND PTR.RowNum = 1

		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecLearnerMonitoring PSLMA
			ON PSLMA.LearnRefNumber = LD.LearnRefNumber
			AND PSLMA.ProvSpecLearnMonOccur = ''A''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecLearnerMonitoring PSLMB
			ON PSLMB.LearnRefNumber = LD.LearnRefNumber
			AND PSLMB.ProvSpecLearnMonOccur = ''B''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecLearnerMonitoring PSLMC
			ON PSLMC.LearnRefNumber = LD.LearnRefNumber
			AND PSLMC.ProvSpecLearnMonOccur = ''C''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecLearnerMonitoring PSLMD
			ON PSLMD.LearnRefNumber = LD.LearnRefNumber
			AND PSLMD.ProvSpecLearnMonOccur = ''D''

		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
			ON PSDMA.LearnRefNumber = LD.LearnRefNumber
			AND PSDMA.AimSeqNumber = LD.AimSeqNumber
			AND PSDMA.ProvSpecDelMonOccur = ''A''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
			ON PSDMB.LearnRefNumber = LD.LearnRefNumber
			AND PSDMB.AimSeqNumber = LD.AimSeqNumber
			AND PSDMB.ProvSpecDelMonOccur = ''B''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
			ON PSDMC.LearnRefNumber = LD.LearnRefNumber
			AND PSDMC.AimSeqNumber = LD.AimSeqNumber
			AND PSDMC.ProvSpecDelMonOccur = ''C''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
			ON PSDMD.LearnRefNumber = LD.LearnRefNumber
			AND PSDMD.AimSeqNumber = LD.AimSeqNumber
			AND PSDMD.ProvSpecDelMonOccur = ''D''
	'

    SET @SQLString += 
        N'
		--16-19
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
			ON FM25.LearnRefNumber = LD.LearnRefNumber
			AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
			--AND FM25.StartFund = 1

		--ASF (Adult Skills Fund)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM38_LearningDelivery FM38
			ON FM38.LearnRefNumber = LD.LearnRefNumber
			AND FM38.AimSeqNumber = LD.AimSeqNumber
			--AND FM38.FundStart = 1

		--AEB (Adult Education Budget) and Legacy Apps
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
			ON FM35.LearnRefNumber = LD.LearnRefNumber
			AND FM35.AimSeqNumber = LD.AimSeqNumber
			--AND FM35.FundStart = 1

		--Apps (Reformed)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
			ON FM36.LearnRefNumber = LD.LearnRefNumber
			AND FM36.AimSeqNumber = LD.AimSeqNumber
		
		--Loans and Bursaries
		LEFT JOIN ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery ALB
			ON ALB.LearnRefNumber = LD.LearnRefNumber
			AND ALB.AimSeqNumber = LD.AimSeqNumber

		--Higher Education
		LEFT JOIN ' + @FISDatabase + '.Valid.LearningDeliveryHE HE
			ON HE.LearnRefNumber = LD.LearnRefNumber
			AND HE.AimSeqNumber = LD.AimSeqNumber
	'

    SET @SQLString += 
		N'
		LEFT JOIN (
			SELECT
				ALBV.LearnRefNumber,
				ALBV.AimSeqNumber,
				TotalEarnedCashToPeriod = 
					CASE
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 1 THEN
							ALBV.Period_1
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 2 THEN
							ALBV.Period_1 + ALBV.Period_2
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 3 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 4 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 5 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 6 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 7 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 8 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 9 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 10 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 11 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 12 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11 + ALBV.Period_12
						ELSE 0
					END,
				TotalEarnedCashMidYear = ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6,
				TotalEarnedCashYearEnd = ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11 + ALBV.Period_12,
				TotalEarnedCashP01 = ALBV.Period_1,
				TotalEarnedCashP02 = ALBV.Period_2,
				TotalEarnedCashP03 = ALBV.Period_3,
				TotalEarnedCashP04 = ALBV.Period_4,
				TotalEarnedCashP05 = ALBV.Period_5,
				TotalEarnedCashP06 = ALBV.Period_6,
				TotalEarnedCashP07 = ALBV.Period_7,
				TotalEarnedCashP08 = ALBV.Period_8,
				TotalEarnedCashP09 = ALBV.Period_9,
				TotalEarnedCashP10 = ALBV.Period_10,
				TotalEarnedCashP11 = ALBV.Period_11,
				TotalEarnedCashP12 = ALBV.Period_12
			FROM ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery_PeriodisedValues ALBV
			WHERE
				ALBV.AttributeName = ''ALBSupportPayment''
		) ALBP
			ON ALBP.LearnRefNumber = LD.LearnRefNumber
			AND ALBP.AimSeqNumber = LD.AimSeqNumber
	'

    SET @SQLString += 
        N'
		--Invalid Learners
		LEFT JOIN (
			SELECT
				InvalidLearners = COUNT ( L.Learner_Id )
			FROM ' + @FISDatabase + '.Invalid.Learner L
		) INV
			ON 1 = 1
		LEFT JOIN #LearnerOverallDates LOD
			ON LOD.LearnRefNumber = L.LearnRefNumber
		LEFT JOIN #FAMLearner FAML
			ON FAML.LearnRefNumber = L.LearnRefNumber
		LEFT JOIN #FundModelAim FM
			ON FM.LearnRefNumber = LD.LearnRefNumber
			AND FM.AimSeqNumber = LD.AimSeqNumber
		LEFT JOIN #FAMLearningDelivery FAMA
			ON FAMA.LearnRefNumber = LD.LearnRefNumber
			AND FAMA.AimSeqNumber = LD.AimSeqNumber
		LEFT JOIN #Standards STD
			ON STD.StandardCode = LD.StdCode
		LEFT JOIN #PostCodes PC
			ON PC.PostCode COLLATE DATABASE_DEFAULT = L.Postcode COLLATE DATABASE_DEFAULT
			AND COALESCE (
				PC.SourceOfFunding COLLATE DATABASE_DEFAULT,
				CASE
					WHEN COALESCE ( FM38.LearnDelFundOrgCode, FM35.LearnDelFundOrgCode ) = ''ESFA'' THEN ''105/107''
					WHEN COALESCE ( FM38.LearnDelFundOrgCode, FM35.LearnDelFundOrgCode ) = ''WECA'' THEN ''113''
					WHEN COALESCE ( FM38.LearnDelFundOrgCode, FM35.LearnDelFundOrgCode ) = ''CPCA'' THEN ''115''
					WHEN COALESCE ( FM38.LearnDelFundOrgCode, FM35.LearnDelFundOrgCode ) = ''London'' THEN ''116''
					ELSE ''105/107''
				END COLLATE DATABASE_DEFAULT
			) = 
				CASE
					WHEN COALESCE ( FM38.LearnDelFundOrgCode, FM35.LearnDelFundOrgCode ) = ''ESFA'' THEN ''105/107''
					WHEN COALESCE ( FM38.LearnDelFundOrgCode, FM35.LearnDelFundOrgCode ) = ''WECA'' THEN ''113''
					WHEN COALESCE ( FM38.LearnDelFundOrgCode, FM35.LearnDelFundOrgCode ) = ''CPCA'' THEN ''115''
					WHEN COALESCE ( FM38.LearnDelFundOrgCode, FM35.LearnDelFundOrgCode ) = ''London'' THEN ''116''
					ELSE ''105/107''
				END COLLATE DATABASE_DEFAULT
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN #LearningAims AIM
			ON AIM.LearningAimCode COLLATE DATABASE_DEFAULT = LD.LearnAimRef COLLATE DATABASE_DEFAULT
		LEFT JOIN #CollegeStructure CS
			ON CS.AcademicYear = @AcademicYear
			AND CS.ProvSpecValue COLLATE DATABASE_DEFAULT =
				CASE
					WHEN @ProvSpecDelMonCourseLocation1 = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation1 = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation1 = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation1 = ''D'' THEN
						PSDMD.ProvSpecDelMon
				END 
				+ COALESCE ( @ProvSpecDelMonCourseSeperator, '''' )
				+ CASE
					WHEN @ProvSpecDelMonCourseLocation2 = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation2 = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation2 = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation2 = ''D'' THEN
						PSDMD.ProvSpecDelMon
					ELSE ''''
				END 
				COLLATE DATABASE_DEFAULT
		LEFT JOIN #CollegeStructure PCS
			ON PCS.AcademicYear = @AcademicYear
			AND PCS.ProvSpecValue COLLATE DATABASE_DEFAULT =
				CASE
					WHEN @ProvSpecDelMonParentCourseLocation1 = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProvSpecDelMonParentCourseLocation1 = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProvSpecDelMonParentCourseLocation1 = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProvSpecDelMonParentCourseLocation1 = ''D'' THEN
						PSDMD.ProvSpecDelMon
				END 
				+ COALESCE ( @ProvSpecDelMonParentCourseSeperator, '''' )
				+ CASE
					WHEN @ProvSpecDelMonParentCourseLocation2 = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProvSpecDelMonParentCourseLocation2 = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProvSpecDelMonParentCourseLocation2 = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProvSpecDelMonParentCourseLocation2 = ''D'' THEN
						PSDMD.ProvSpecDelMon
					ELSE ''''
				END 
				COLLATE DATABASE_DEFAULT
		LEFT JOIN #CollegeStructure MCS
			ON MCS.AcademicYear = @AcademicYear
			AND MCS.ProvSpecValue COLLATE DATABASE_DEFAULT = MA.CourseCode COLLATE DATABASE_DEFAULT
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel1Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel1Code = @EnglishCollegeLevel1Code
		) CL1ENG
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel2Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel2Code = @EnglishCollegeLevel2Code
		) CL2ENG
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel3Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel3Code = @EnglishCollegeLevel3Code
		) CL3ENG
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel4Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel4Code = @EnglishCollegeLevel4Code
		) CL4ENG
			ON 1 = 1
	'

	SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel1Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel1Code = @MathsCollegeLevel1Code
		) CL1MAT
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel2Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel2Code = @MathsCollegeLevel2Code
		) CL2MAT
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel3Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel3Code = @MathsCollegeLevel3Code
		) CL3MAT
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel4Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel4Code = @MathsCollegeLevel4Code
		) CL4MAT
			ON 1 = 1
	'

	SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel1Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel1Code = @PartnerCollegeLevel1Code
		) CL1PAR
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel2Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel2Code = @PartnerCollegeLevel2Code
		) CL2PAR
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel3Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel3Code = @PartnerCollegeLevel3Code
		) CL3PAR
			ON 1 = 1
		LEFT JOIN (
			SELECT
				CollegeLevelName = MIN ( CS.CollegeLevel4Name )
			FROM #CollegeStructure CS
			WHERE
				CS.CollegeLevel4Code = @PartnerCollegeLevel4Code
		) CL4PAR
			ON 1 = 1
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN #CourseHours CH
			ON CH.AcademicYear = @AcademicYear
			AND CH.ProvSpecValue COLLATE DATABASE_DEFAULT =
				CASE
					WHEN @ProvSpecDelMonCourseLocation1 = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation1 = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation1 = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation1 = ''D'' THEN
						PSDMD.ProvSpecDelMon
				END 
				+ COALESCE ( @ProvSpecDelMonCourseSeperator, '''' )
				+ CASE
					WHEN @ProvSpecDelMonCourseLocation2 = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation2 = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation2 = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation2 = ''D'' THEN
						PSDMD.ProvSpecDelMon
					ELSE ''''
				END 
				COLLATE DATABASE_DEFAULT
	'
    
    SET @SQLString += 
        N'
        LEFT JOIN #Providers PROV
			ON PROV.ProviderUKPRN = SRC.UKPRN
	'

    SET @SQLString += 
        N'
		--FM25 for counting hours
		LEFT JOIN (
			SELECT
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ORD.RateBandOrder,
				TFerOnly = CASE WHEN ACT.LearnRefNumber IS NULL THEN 1 ELSE 0 END,
				PlannedHours = COALESCE ( SUM ( CH.PlannedHours ), 0 ),
				EEPHours = COALESCE ( SUM ( CH.EEPHours ), 0 ),
				TLevelHours = COALESCE ( SUM ( CH.TLevelHours ), 0 ),
				OnProgPayment = 
					MAX ( FM25.OnProgPayment )
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END,
				LearnSuppPayment = 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END,
				TotalEarnedCash = MAX ( FM25.OnProgPayment ),
				IsFunded = MAX ( CAST ( FM25.StartFund AS INT ) )
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN #FundModelAim FM
				ON FM.LearnRefNumber = LD.LearnRefNumber
				AND FM.AimSeqNumber = LD.AimSeqNumber
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
	'

	SET @SQLString += 
        N'
			LEFT JOIN #CourseHours CH
				ON CH.AcademicYear = @AcademicYear
				AND CH.ProvSpecValue COLLATE DATABASE_DEFAULT =
					CASE
						WHEN @ProvSpecDelMonCourseLocation1 = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''D'' THEN
							PSDMD.ProvSpecDelMon
					END 
					+ COALESCE ( @ProvSpecDelMonCourseSeperator, '''' )
					+ CASE
						WHEN @ProvSpecDelMonCourseLocation2 = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''''
					END 
					COLLATE DATABASE_DEFAULT
			LEFT JOIN (
				SELECT DISTINCT
					LD.LearnRefNumber
				FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
				LEFT JOIN #FundModelAim FM
					ON FM.LearnRefNumber = LD.LearnRefNumber
					AND FM.AimSeqNumber = LD.AimSeqNumber
				WHERE
					LD.FundModel = 25
					AND FM.Transfer = 0 --Exclude transfers
					--AND LD.LearnRefNumber = ''17002435''
				GROUP BY
					LD.LearnRefNumber
			) ACT
				ON ACT.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN (
				SELECT
					FM25.RateBand,
					RateBandOrder = 
						ROW_NUMBER () OVER (
							ORDER BY
								CASE
									WHEN 
										CHARINDEX ( ''Band '', FM25.RateBand ) > 0 
										AND CHARINDEX ( '')'', FM25.RateBand ) > 0 
										THEN
											SUBSTRING ( 
												FM25.RateBand, 
												CHARINDEX ( ''Band '', FM25.RateBand ) + 5,
												CHARINDEX ( '')'', FM25.RateBand ) - ( CHARINDEX ( ''Band '', FM25.RateBand ) + 5 )
											)
									ELSE ''0''
								END
						)
				FROM (
					SELECT DISTINCT
						FM25.RateBand
					FROM ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				) FM25
			) ORD
				ON ORD.RateBand = FM25.RateBand
			WHERE
				LD.FundModel = 25
				--AND LD.LearnRefNumber = ''18000292''
				AND 
					CASE --If lrn has no active aims then count tfer instead
						WHEN ACT.LearnRefNumber IS NOT NULL THEN
							CASE
								WHEN FM.Transfer = 0 THEN 1
								ELSE 0
							END
						ELSE
							1
						END = 1
			GROUP BY
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ORD.RateBandOrder,
				ACT.LearnRefNumber
		) HRS
			ON HRS.LearnRefNumber = L.LearnRefNumber
    '

	SET @SQLString += 
		N'
		LEFT JOIN #MainAim MAFM
			ON MAFM.LearnRefNumber = LD.LearnRefNumber
			AND MAFM.FundLine = FM.FundLine
			AND MAFM.RowNumFundLine = 1
		LEFT JOIN #MainAim MAFMA
			ON MAFMA.LearnRefNumber = LD.LearnRefNumber
			AND MAFMA.FundLine = FM.FundLine
			AND MAFMA.StdCode = COALESCE ( LD.StdCode, 0 )
			AND MAFMA.ProgType = LD.ProgType
			AND MAFMA.RowNumFundLineApps = 1
	'

	SET @SQLString += 
        N'
		LEFT JOIN #FM38PeriodFunding FM38P
			ON FM38P.LearnRefNumber = FM38.LearnRefNumber
			AND FM38P.AimSeqNumber = FM38.AimSeqNumber
		LEFT JOIN #FM38PeriodFunding FM38PM
			ON FM38PM.LearnRefNumber = FM38.LearnRefNumber
			AND FM38PM.LearnAimRef = ''ZPROG001''
			AND FM38PM.FundModel = LD.FundModel
			AND FM38PM.StdCode = COALESCE ( LD.StdCode, 0 )
			AND FM38PM.ProgType = LD.ProgType
			AND 
				CASE
					WHEN LD.CompStatus = 6 THEN
						CASE
							WHEN FM38PM.CompStatus = 6 THEN 1
							ELSE 0
						END
					ELSE
						CASE
							WHEN FM38PM.CompStatus = 6 THEN 0
							ELSE 1
						END
				END = 1
			AND LD.AimSeqNumber = MAFM.AimSeqNumber
	'

	SET @SQLString += 
        N'
		LEFT JOIN #FM35PeriodFunding FM35P
			ON FM35P.LearnRefNumber = FM35.LearnRefNumber
			AND FM35P.AimSeqNumber = FM35.AimSeqNumber
		LEFT JOIN #FM35PeriodFunding FM35PM
			ON FM35PM.LearnRefNumber = FM35.LearnRefNumber
			AND FM35PM.LearnAimRef = ''ZPROG001''
			AND FM35PM.FundModel = LD.FundModel
			AND FM35PM.StdCode = COALESCE ( LD.StdCode, 0 )
			AND FM35PM.ProgType = LD.ProgType
			AND 
				CASE
					WHEN LD.CompStatus = 6 THEN
						CASE
							WHEN FM35PM.CompStatus = 6 THEN 1
							ELSE 0
						END
					ELSE
						CASE
							WHEN FM35PM.CompStatus = 6 THEN 0
							ELSE 1
						END
				END = 1
			AND LD.AimSeqNumber = MAFM.AimSeqNumber
	'

    SET @SQLString += 
        N'
		LEFT JOIN #FM36PriceEpisode FM36PE
			ON FM36PE.LearnRefNumber = FM36.LearnRefNumber
			AND FM36PE.UKPRN = FM36.UKPRN
			AND FM36PE.AimSeqNumber = FM36.AimSeqNumber
			AND FM36PE.RowNum = 1
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN #FM36PeriodFunding FM36P
			ON FM36P.LearnRefNumber = FM36.LearnRefNumber
			AND FM36P.AimSeqNumber = FM36.AimSeqNumber
			AND @AppsMoveFundingToMainComponentAim = 0
		LEFT JOIN #FM36PeriodFundingSummary FM36PM
			ON FM36PM.LearnRefNumber = FM36.LearnRefNumber
			AND FM36PM.FundModel = LD.FundModel
			AND FM36PM.StdCode = COALESCE ( LD.StdCode, 0 )
			AND FM36PM.ProgType = LD.ProgType
			AND LD.AimSeqNumber = MAFMA.AimSeqNumber
			AND @AppsMoveFundingToMainComponentAim = 1
	'

    SET @SQLString += 
        N'
		LEFT JOIN #Employers EMPN
			ON EMPN.EmployerEDRS = EMP.EmployerID
		LEFT JOIN #Partners PAR
			ON PAR.PartnerUKPRN = 
				CASE
					WHEN LD.LearnAimRef = ''ZPROG001'' THEN PTR.PartnerUKPRN
					ELSE LD.PartnerUKPRN
				END
		LEFT JOIN #Ethnicities ETH
			ON TRY_CAST ( ETH.Code AS INT ) = L.Ethnicity
		LEFT JOIN #PriorLevels PLEV
			ON PLEV.Code = ATN.PriorLevel
		LEFT JOIN #Disabilities DIS
			ON DIS.Code = LLDD.LLDDCat
		LEFT JOIN (
			SELECT
				Learners = COUNT ( FM25.LearnRefNumber )
			FROM ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
			WHERE
				FM25.StartFund = 1
		) FM25LRNS
			ON 1 = 1
		LEFT JOIN #HighValueCourses HVC
			ON HVC.LearnAimRef = LD.LearnAimRef
		LEFT JOIN #AdvancedMathsPremium AMP
			ON AMP.LearnAimRef = LD.LearnAimRef
		LEFT JOIN (
			SELECT DISTINCT
				LD.LearnRefNumber
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			WHERE
				LD.FundModel = 25
				AND LD.ProgType = 31
				AND LD.AimType = 3
				AND LD.LearnAimRef = ''ZWRKX003'' --Industry Placement
		) IND
			ON IND.LearnRefNumber = L.LearnRefNumber
			AND LD.ProgType = 31
		LEFT JOIN #FM38CarryIn FM38CI
			ON FM38CI.LearnRefNumber COLLATE DATABASE_DEFAULT = LD.LearnRefNumber COLLATE DATABASE_DEFAULT
			AND FM38CI.AimSeqNumber = LD.AimSeqNumber
		LEFT JOIN #FM35CarryIn FM35CI
			ON FM35CI.LearnRefNumber COLLATE DATABASE_DEFAULT = LD.LearnRefNumber COLLATE DATABASE_DEFAULT
			AND FM35CI.AimSeqNumber = LD.AimSeqNumber

		--WHERE
			--L.LearnRefNumber = ''11024003''
	'



	SET @SQLString += 
        N'
		INSERT INTO ' + @FISOutputTableLocation + '[' + @FISOutputTableName + 'Extra] WITH (TABLOCKX)
		SELECT
			AcademicYear = @AcademicYear,
            ProviderNumber = SRC.UKPRN,
			ILRReturn = @ILRReturn,
			IsFinalReturn = @IsFinalReturn,
			ILRReturnDate = DATEADD ( MS, - DATEPART ( MS, SRC.DateTime ), SRC.DateTime ), --Remove milliseconds as SSRS truncates these in parameters
			LearnRefNumber = L.LearnRefNumber,
			AimSeqNumber = LD.AimSeqNumber,
	'

    SET @SQLString += 
		N'
			OnProgPaymentP01 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP01 END, FM38P.OnProgPaymentP01, FM35P.OnProgPaymentP01, FM36PM.OnProgPaymentP01, FM36P.OnProgPaymentP01, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP01 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP01, FM35P.LearnSuppPaymentP01, FM36PM.LearnSuppPaymentP01, FM36P.LearnSuppPaymentP01, 0 ),
			AchCompPaymentP01 = COALESCE ( FM38P.AchCompPaymentP01, FM35P.AchCompPaymentP01, FM36PM.AchCompPaymentP01, FM36P.AchCompPaymentP01, 0 ),
			BalancePaymentP01 = COALESCE ( FM38P.BalancePaymentP01, FM35P.BalancePaymentP01, FM36PM.BalancePaymentP01, FM36P.BalancePaymentP01, 0 ),
			EmpOutcomePayP01 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP01 = COALESCE ( FM36PM.OtherPaymentP01, FM36P.OtherPaymentP01, 0 ),
			TotalEarnedCashP01 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP01 END, FM38P.TotalEarnedCashP01, FM35P.TotalEarnedCashP01, FM36PM.TotalEarnedCashP01, FM36P.TotalEarnedCashP01, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP02 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP02 END, FM38P.OnProgPaymentP02, FM35P.OnProgPaymentP02, FM36PM.OnProgPaymentP02, FM36P.OnProgPaymentP02, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP02 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP02, FM35P.LearnSuppPaymentP02, FM36PM.LearnSuppPaymentP02, FM36P.LearnSuppPaymentP02, 0 ),
			AchCompPaymentP02 = COALESCE ( FM38P.AchCompPaymentP02, FM35P.AchCompPaymentP02, FM36PM.AchCompPaymentP02, FM36P.AchCompPaymentP02, 0 ),
			BalancePaymentP02 = COALESCE ( FM38P.BalancePaymentP02, FM35P.BalancePaymentP02, FM36PM.BalancePaymentP02, FM36P.BalancePaymentP02, 0 ),
			EmpOutcomePayP02 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP02 = COALESCE ( FM36PM.OtherPaymentP02, FM36P.OtherPaymentP02, 0 ),
			TotalEarnedCashP02 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP02 END, FM38P.TotalEarnedCashP02, FM35P.TotalEarnedCashP02, FM36PM.TotalEarnedCashP02, FM36P.TotalEarnedCashP02, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
		N'
			OnProgPaymentP03 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP03 END, FM38P.OnProgPaymentP03, FM35P.OnProgPaymentP03, FM36PM.OnProgPaymentP03, FM36P.OnProgPaymentP03, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP03 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP03, FM35P.LearnSuppPaymentP03, FM36PM.LearnSuppPaymentP03, FM36P.LearnSuppPaymentP03, 0 ),
			AchCompPaymentP03 = COALESCE ( FM38P.AchCompPaymentP03, FM35P.AchCompPaymentP03, FM36PM.AchCompPaymentP03, FM36P.AchCompPaymentP03, 0 ),
			BalancePaymentP03 = COALESCE ( FM38P.BalancePaymentP03, FM35P.BalancePaymentP03, FM36PM.BalancePaymentP03, FM36P.BalancePaymentP03, 0 ),
			EmpOutcomePayP03 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP03 = COALESCE ( FM36PM.OtherPaymentP03, FM36P.OtherPaymentP03, 0 ),
			TotalEarnedCashP03 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP03 END, FM38P.TotalEarnedCashP03, FM35P.TotalEarnedCashP03, FM36PM.TotalEarnedCashP03, FM36P.TotalEarnedCashP03, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP04 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP04 END, FM38P.OnProgPaymentP04, FM35P.OnProgPaymentP04, FM36PM.OnProgPaymentP04, FM36P.OnProgPaymentP04, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP04 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP04, FM35P.LearnSuppPaymentP04, FM36PM.LearnSuppPaymentP04, FM36P.LearnSuppPaymentP04, 0 ),
			AchCompPaymentP04 = COALESCE ( FM38P.AchCompPaymentP04, FM35P.AchCompPaymentP04, FM36PM.AchCompPaymentP04, FM36P.AchCompPaymentP04, 0 ),
			BalancePaymentP04 = COALESCE ( FM38P.BalancePaymentP04, FM35P.BalancePaymentP04, FM36PM.BalancePaymentP04, FM36P.BalancePaymentP04, 0 ),
			EmpOutcomePayP04 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP04 = COALESCE ( FM36PM.OtherPaymentP04, FM36P.OtherPaymentP04, 0 ),
			TotalEarnedCashP04 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP04 END, FM38P.TotalEarnedCashP04, FM35P.TotalEarnedCashP04, FM36PM.TotalEarnedCashP04, FM36P.TotalEarnedCashP04, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
		N'
			OnProgPaymentP05 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP05 END, FM38P.OnProgPaymentP05, FM35P.OnProgPaymentP05, FM36PM.OnProgPaymentP05, FM36P.OnProgPaymentP05, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP05 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP05, FM35P.LearnSuppPaymentP05, FM36PM.LearnSuppPaymentP05, FM36P.LearnSuppPaymentP05, 0 ),
			AchCompPaymentP05 = COALESCE ( FM38P.AchCompPaymentP05, FM35P.AchCompPaymentP05, FM36PM.AchCompPaymentP05, FM36P.AchCompPaymentP05, 0 ),
			BalancePaymentP05 = COALESCE ( FM38P.BalancePaymentP05, FM35P.BalancePaymentP05, FM36PM.BalancePaymentP05, FM36P.BalancePaymentP05, 0 ),
			EmpOutcomePayP05 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP05 = COALESCE ( FM36PM.OtherPaymentP05, FM36P.OtherPaymentP05, 0 ),
			TotalEarnedCashP05 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP05 END, FM38P.TotalEarnedCashP05, FM35P.TotalEarnedCashP05, FM36PM.TotalEarnedCashP05, FM36P.TotalEarnedCashP05, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP06 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP06 END, FM38P.OnProgPaymentP06, FM35P.OnProgPaymentP06, FM36PM.OnProgPaymentP06, FM36P.OnProgPaymentP06, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP06 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP06, FM35P.LearnSuppPaymentP06, FM36PM.LearnSuppPaymentP06, FM36P.LearnSuppPaymentP06, 0 ),
			AchCompPaymentP06 = COALESCE ( FM38P.AchCompPaymentP06, FM35P.AchCompPaymentP06, FM36PM.AchCompPaymentP06, FM36P.AchCompPaymentP06, 0 ),
			BalancePaymentP06 = COALESCE ( FM38P.BalancePaymentP06, FM35P.BalancePaymentP06, FM36PM.BalancePaymentP06, FM36P.BalancePaymentP06, 0 ),
			EmpOutcomePayP06 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP06 = COALESCE ( FM36PM.OtherPaymentP06, FM36P.OtherPaymentP06, 0 ),
			TotalEarnedCashP06 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP06 END, FM38P.TotalEarnedCashP06, FM35P.TotalEarnedCashP06, FM36PM.TotalEarnedCashP06, FM36P.TotalEarnedCashP06, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
		N'
			OnProgPaymentP07 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP07 END, FM38P.OnProgPaymentP07, FM35P.OnProgPaymentP07, FM36PM.OnProgPaymentP07, FM36P.OnProgPaymentP07, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP07 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP07, FM35P.LearnSuppPaymentP07, FM36PM.LearnSuppPaymentP07, FM36P.LearnSuppPaymentP07, 0 ),
			AchCompPaymentP07 = COALESCE ( FM38P.AchCompPaymentP07, FM35P.AchCompPaymentP07, FM36PM.AchCompPaymentP07, FM36P.AchCompPaymentP07, 0 ),
			BalancePaymentP07 = COALESCE ( FM38P.BalancePaymentP07, FM35P.BalancePaymentP07, FM36PM.BalancePaymentP07, FM36P.BalancePaymentP07, 0 ),
			EmpOutcomePayP07 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP07 = COALESCE ( FM36PM.OtherPaymentP07, FM36P.OtherPaymentP07, 0 ),
			TotalEarnedCashP07 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP07 END, FM38P.TotalEarnedCashP07, FM35P.TotalEarnedCashP07, FM36PM.TotalEarnedCashP07, FM36P.TotalEarnedCashP07, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP08 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP08 END, FM38P.OnProgPaymentP08, FM35P.OnProgPaymentP08, FM36PM.OnProgPaymentP08, FM36P.OnProgPaymentP08, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP08 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP08, FM35P.LearnSuppPaymentP08, FM36PM.LearnSuppPaymentP08, FM36P.LearnSuppPaymentP08, 0 ),
			AchCompPaymentP08 = COALESCE ( FM38P.AchCompPaymentP08, FM35P.AchCompPaymentP08, FM36PM.AchCompPaymentP08, FM36P.AchCompPaymentP08, 0 ),
			BalancePaymentP08 = COALESCE ( FM38P.BalancePaymentP08, FM35P.BalancePaymentP08, FM36PM.BalancePaymentP08, FM36P.BalancePaymentP08, 0 ),
			EmpOutcomePayP08 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP08 = COALESCE ( FM36PM.OtherPaymentP08, FM36P.OtherPaymentP08, 0 ),
			TotalEarnedCashP08 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP08 END, FM38P.TotalEarnedCashP08, FM35P.TotalEarnedCashP08, FM36PM.TotalEarnedCashP08, FM36P.TotalEarnedCashP08, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP09 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP09 END, FM38P.OnProgPaymentP09, FM35P.OnProgPaymentP09, FM36PM.OnProgPaymentP09, FM36P.OnProgPaymentP09, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP09 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP09, FM35P.LearnSuppPaymentP09, FM36PM.LearnSuppPaymentP09, FM36P.LearnSuppPaymentP09, 0 ),
			AchCompPaymentP09 = COALESCE ( FM38P.AchCompPaymentP09, FM35P.AchCompPaymentP09, FM36PM.AchCompPaymentP09, FM36P.AchCompPaymentP09, 0 ),
			BalancePaymentP09 = COALESCE ( FM38P.BalancePaymentP09, FM35P.BalancePaymentP09, FM36PM.BalancePaymentP09, FM36P.BalancePaymentP09, 0 ),
			EmpOutcomePayP09 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP09 = COALESCE ( FM36PM.OtherPaymentP09, FM36P.OtherPaymentP09, 0 ),
			TotalEarnedCashP09 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP09 END, FM38P.TotalEarnedCashP09, FM35P.TotalEarnedCashP09, FM36PM.TotalEarnedCashP09, FM36P.TotalEarnedCashP09, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP10 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP10 END, FM38P.OnProgPaymentP10, FM35P.OnProgPaymentP10, FM36PM.OnProgPaymentP10, FM36P.OnProgPaymentP10, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP10 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP10, FM35P.LearnSuppPaymentP10, FM36PM.LearnSuppPaymentP10, FM36P.LearnSuppPaymentP10, 0 ),
			AchCompPaymentP10 = COALESCE ( FM38P.AchCompPaymentP10, FM35P.AchCompPaymentP10, FM36PM.AchCompPaymentP10, FM36P.AchCompPaymentP10, 0 ),
			BalancePaymentP10 = COALESCE ( FM38P.BalancePaymentP10, FM35P.BalancePaymentP10, FM36PM.BalancePaymentP10, FM36P.BalancePaymentP10, 0 ),
			EmpOutcomePayP10 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP10 = COALESCE ( FM36PM.OtherPaymentP10, FM36P.OtherPaymentP10, 0 ),
			TotalEarnedCashP10 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP10 END, FM38P.TotalEarnedCashP10, FM35P.TotalEarnedCashP10, FM36PM.TotalEarnedCashP10, FM36P.TotalEarnedCashP10, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP11 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP11 END, FM38P.OnProgPaymentP11, FM35P.OnProgPaymentP11, FM36PM.OnProgPaymentP11, FM36P.OnProgPaymentP11, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP11 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP11, FM35P.LearnSuppPaymentP11, FM36PM.LearnSuppPaymentP11, FM36P.LearnSuppPaymentP11, 0 ),
			AchCompPaymentP11 = COALESCE ( FM38P.AchCompPaymentP11, FM35P.AchCompPaymentP11, FM36PM.AchCompPaymentP11, FM36P.AchCompPaymentP11, 0 ),
			BalancePaymentP11 = COALESCE ( FM38P.BalancePaymentP11, FM35P.BalancePaymentP11, FM36PM.BalancePaymentP11, FM36P.BalancePaymentP11, 0 ),
			EmpOutcomePayP11 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP11 = COALESCE ( FM36PM.OtherPaymentP11, FM36P.OtherPaymentP11, 0 ),
			TotalEarnedCashP11 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP11 END, FM38P.TotalEarnedCashP11, FM35P.TotalEarnedCashP11, FM36PM.TotalEarnedCashP11, FM36P.TotalEarnedCashP11, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP12 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP12 END, FM38P.OnProgPaymentP12, FM35P.OnProgPaymentP12, FM36PM.OnProgPaymentP12, FM36P.OnProgPaymentP12, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP12 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( 
								CASE
									WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
										( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
										+ ( 
											FM25.OnProgPayment 
											- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
										)
									ELSE FM25.OnProgPayment
								END
								/ 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END
				END / 12 ) END, FM38P.LearnSuppPaymentP12, FM35P.LearnSuppPaymentP12, FM36PM.LearnSuppPaymentP12, FM36P.LearnSuppPaymentP12, 0 ),
			AchCompPaymentP12 = COALESCE ( FM38P.AchCompPaymentP12, FM35P.AchCompPaymentP12, FM36PM.AchCompPaymentP12, FM36P.AchCompPaymentP12, 0 ),
			BalancePaymentP12 = COALESCE ( FM38P.BalancePaymentP12, FM35P.BalancePaymentP12, FM36PM.BalancePaymentP12, FM36P.BalancePaymentP12, 0 ),
			EmpOutcomePayP12 = COALESCE ( FM38P.EmpOutcomePayYearEnd, FM35P.EmpOutcomePayYearEnd, 0 ),
			OtherPaymentP12 = COALESCE ( FM36PM.OtherPaymentP12, FM36P.OtherPaymentP12, 0 ),
			TotalEarnedCashP12 = COALESCE ( CASE WHEN LD.FundModel = 25 THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PlannedHours, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotalEarnedCash, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotalEarnedCash, 0 ) / COALESCE ( HRS.PlannedHours, 0 ) ) * COALESCE ( CASE WHEN FM.Transfer = 0 OR HRS.TFerOnly = 1 THEN CH.PlannedHours END, 0 )
					END
				ELSE 
					CASE
						WHEN @Reapportion1619FundingByAimWeighting = 1 AND FM25.StartFund = 1 THEN
							( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightNew ) 
							+ ( 
								FM25.OnProgPayment 
								- ( FM25.NatRate * FM25.PrvRetentFactHist * FM25.ProgWeightHist ) 
							)
						ELSE FM25.OnProgPayment
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotalEarnedCashP12 END, FM38P.TotalEarnedCashP12, FM35P.TotalEarnedCashP12, FM36PM.TotalEarnedCashP12, FM36P.TotalEarnedCashP12, CASE WHEN @IncludeHEAdvLoanPossibleIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 )

			--INTO FIS_FundingDataTemp
	'
    
    SET @SQLString += 
        N'
		FROM ' + @FISDatabase + '.Valid.Learner L
		INNER JOIN ' + @FISDatabase + '.Valid.LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		INNER JOIN ' + @FISDatabase + '.Valid.Source SRC
			ON 1 = 1
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
			ON PSDMA.LearnRefNumber = LD.LearnRefNumber
			AND PSDMA.AimSeqNumber = LD.AimSeqNumber
			AND PSDMA.ProvSpecDelMonOccur = ''A''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
			ON PSDMB.LearnRefNumber = LD.LearnRefNumber
			AND PSDMB.AimSeqNumber = LD.AimSeqNumber
			AND PSDMB.ProvSpecDelMonOccur = ''B''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
			ON PSDMC.LearnRefNumber = LD.LearnRefNumber
			AND PSDMC.AimSeqNumber = LD.AimSeqNumber
			AND PSDMC.ProvSpecDelMonOccur = ''C''
		LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
			ON PSDMD.LearnRefNumber = LD.LearnRefNumber
			AND PSDMD.AimSeqNumber = LD.AimSeqNumber
			AND PSDMD.ProvSpecDelMonOccur = ''D''
	'

    SET @SQLString += 
        N'
		--16-19
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
			ON FM25.LearnRefNumber = LD.LearnRefNumber
			AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
			--AND FM25.StartFund = 1

		--ASF (Adult Skills Fund)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM38_LearningDelivery FM38
			ON FM38.LearnRefNumber = LD.LearnRefNumber
			AND FM38.AimSeqNumber = LD.AimSeqNumber
			--AND FM38.FundStart = 1

		--AEB (Adult Education Budget) and Legacy Apps
		LEFT JOIN ' + @FISDatabase + '.Rulebase.FM35_LearningDelivery FM35
			ON FM35.LearnRefNumber = LD.LearnRefNumber
			AND FM35.AimSeqNumber = LD.AimSeqNumber
			--AND FM35.FundStart = 1

		--Apps (Reformed)
		LEFT JOIN ' + @FISDatabase + '.Rulebase.AEC_LearningDelivery FM36
			ON FM36.LearnRefNumber = LD.LearnRefNumber
			AND FM36.AimSeqNumber = LD.AimSeqNumber
		
		--Loans and Bursaries
		LEFT JOIN ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery ALB
			ON ALB.LearnRefNumber = LD.LearnRefNumber
			AND ALB.AimSeqNumber = LD.AimSeqNumber

		--Higher Education
		LEFT JOIN ' + @FISDatabase + '.Valid.LearningDeliveryHE HE
			ON HE.LearnRefNumber = LD.LearnRefNumber
			AND HE.AimSeqNumber = LD.AimSeqNumber
	'

    SET @SQLString += 
		N'
		LEFT JOIN (
			SELECT
				ALBV.LearnRefNumber,
				ALBV.AimSeqNumber,
				TotalEarnedCashToPeriod = 
					CASE
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 1 THEN
							ALBV.Period_1
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 2 THEN
							ALBV.Period_1 + ALBV.Period_2
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 3 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 4 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 5 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 6 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 7 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 8 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 9 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 10 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 11 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11
						WHEN TRY_CAST ( REPLACE ( @ILRReturn, ''R'', '''' ) AS INT ) = 12 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11 + ALBV.Period_12
						ELSE 0
					END,
				TotalEarnedCashMidYear = ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6,
				TotalEarnedCashYearEnd = ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11 + ALBV.Period_12,
				TotalEarnedCashP01 = ALBV.Period_1,
				TotalEarnedCashP02 = ALBV.Period_2,
				TotalEarnedCashP03 = ALBV.Period_3,
				TotalEarnedCashP04 = ALBV.Period_4,
				TotalEarnedCashP05 = ALBV.Period_5,
				TotalEarnedCashP06 = ALBV.Period_6,
				TotalEarnedCashP07 = ALBV.Period_7,
				TotalEarnedCashP08 = ALBV.Period_8,
				TotalEarnedCashP09 = ALBV.Period_9,
				TotalEarnedCashP10 = ALBV.Period_10,
				TotalEarnedCashP11 = ALBV.Period_11,
				TotalEarnedCashP12 = ALBV.Period_12
			FROM ' + @FISDatabase + '.Rulebase.ALB_LearningDelivery_PeriodisedValues ALBV
			WHERE
				ALBV.AttributeName = ''ALBSupportPayment''
		) ALBP
			ON ALBP.LearnRefNumber = LD.LearnRefNumber
			AND ALBP.AimSeqNumber = LD.AimSeqNumber
	'

	SET @SQLString += 
		N'
		LEFT JOIN #FundModelAim FM
			ON FM.LearnRefNumber = LD.LearnRefNumber
			AND FM.AimSeqNumber = LD.AimSeqNumber
	'

    SET @SQLString += 
        N'
		LEFT JOIN #CourseHours CH
			ON CH.AcademicYear = @AcademicYear
			AND CH.ProvSpecValue COLLATE DATABASE_DEFAULT =
				CASE
					WHEN @ProvSpecDelMonCourseLocation1 = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation1 = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation1 = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation1 = ''D'' THEN
						PSDMD.ProvSpecDelMon
				END 
				+ COALESCE ( @ProvSpecDelMonCourseSeperator, '''' )
				+ CASE
					WHEN @ProvSpecDelMonCourseLocation2 = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation2 = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation2 = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProvSpecDelMonCourseLocation2 = ''D'' THEN
						PSDMD.ProvSpecDelMon
					ELSE ''''
				END 
				COLLATE DATABASE_DEFAULT
	'

    SET @SQLString += 
        N'
		--FM25 for counting hours
		LEFT JOIN (
			SELECT
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ORD.RateBandOrder,
				TFerOnly = CASE WHEN ACT.LearnRefNumber IS NULL THEN 1 ELSE 0 END,
				PlannedHours = COALESCE ( SUM ( CH.PlannedHours ), 0 ),
				EEPHours = COALESCE ( SUM ( CH.EEPHours ), 0 ),
				TLevelHours = COALESCE ( SUM ( CH.TLevelHours ), 0 ),
				OnProgPayment = 
					MAX ( FM25.OnProgPayment )
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END,
				LearnSuppPayment = 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * @1619ALSFundingPercent
						ELSE
							0
					END,
				TotalEarnedCash = MAX ( FM25.OnProgPayment ),
				IsFunded = MAX ( CAST ( FM25.StartFund AS INT ) )
			FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN #FundModelAim FM
				ON FM.LearnRefNumber = LD.LearnRefNumber
				AND FM.AimSeqNumber = LD.AimSeqNumber
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.Valid.ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
	'

	SET @SQLString += 
        N'
			LEFT JOIN #CourseHours CH
				ON CH.AcademicYear = @AcademicYear
				AND CH.ProvSpecValue COLLATE DATABASE_DEFAULT =
					CASE
						WHEN @ProvSpecDelMonCourseLocation1 = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation1 = ''D'' THEN
							PSDMD.ProvSpecDelMon
					END 
					+ COALESCE ( @ProvSpecDelMonCourseSeperator, '''' )
					+ CASE
						WHEN @ProvSpecDelMonCourseLocation2 = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProvSpecDelMonCourseLocation2 = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''''
					END 
					COLLATE DATABASE_DEFAULT
			LEFT JOIN (
				SELECT DISTINCT
					LD.LearnRefNumber
				FROM ' + @FISDatabase + '.Valid.LearningDelivery LD
				LEFT JOIN #FundModelAim FM
					ON FM.LearnRefNumber = LD.LearnRefNumber
					AND FM.AimSeqNumber = LD.AimSeqNumber
				WHERE
					LD.FundModel = 25
					AND FM.Transfer = 0 --Exclude transfers
					--AND LD.LearnRefNumber = ''17002435''
				GROUP BY
					LD.LearnRefNumber
			) ACT
				ON ACT.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN (
				SELECT
					FM25.RateBand,
					RateBandOrder = 
						ROW_NUMBER () OVER (
							ORDER BY
								CASE
									WHEN 
										CHARINDEX ( ''Band '', FM25.RateBand ) > 0 
										AND CHARINDEX ( '')'', FM25.RateBand ) > 0 
										THEN
											SUBSTRING ( 
												FM25.RateBand, 
												CHARINDEX ( ''Band '', FM25.RateBand ) + 5,
												CHARINDEX ( '')'', FM25.RateBand ) - ( CHARINDEX ( ''Band '', FM25.RateBand ) + 5 )
											)
									ELSE ''0''
								END
						)
				FROM (
					SELECT DISTINCT
						FM25.RateBand
					FROM ' + @FISDatabase + '.Rulebase.FM25_Learner FM25
				) FM25
			) ORD
				ON ORD.RateBand = FM25.RateBand
			WHERE
				LD.FundModel = 25
				--AND LD.LearnRefNumber = ''18000292''
				AND 
					CASE --If lrn has no active aims then count tfer instead
						WHEN ACT.LearnRefNumber IS NOT NULL THEN
							CASE
								WHEN FM.Transfer = 0 THEN 1
								ELSE 0
							END
						ELSE
							1
						END = 1
			GROUP BY
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ORD.RateBandOrder,
				ACT.LearnRefNumber
		) HRS
			ON HRS.LearnRefNumber = L.LearnRefNumber
    '

	SET @SQLString += 
		N'
		LEFT JOIN #MainAim MAFM
			ON MAFM.LearnRefNumber = LD.LearnRefNumber
			AND MAFM.FundLine = FM.FundLine
			AND MAFM.RowNumFundLine = 1
		LEFT JOIN #MainAim MAFMA
			ON MAFMA.LearnRefNumber = LD.LearnRefNumber
			AND MAFMA.FundLine = FM.FundLine
			AND MAFMA.StdCode = COALESCE ( LD.StdCode, 0 )
			AND MAFMA.ProgType = LD.ProgType
			AND MAFMA.RowNumFundLineApps = 1
	'

	SET @SQLString += 
        N'
		LEFT JOIN #FM38PeriodFunding FM38P
			ON FM38P.LearnRefNumber = FM38.LearnRefNumber
			AND FM38P.AimSeqNumber = FM38.AimSeqNumber
		LEFT JOIN #FM38PeriodFunding FM38PM
			ON FM38PM.LearnRefNumber = FM38.LearnRefNumber
			AND FM38PM.LearnAimRef = ''ZPROG001''
			AND FM38PM.FundModel = LD.FundModel
			AND FM38PM.StdCode = COALESCE ( LD.StdCode, 0 )
			AND FM38PM.ProgType = LD.ProgType
			AND 
				CASE
					WHEN LD.CompStatus = 6 THEN
						CASE
							WHEN FM38PM.CompStatus = 6 THEN 1
							ELSE 0
						END
					ELSE
						CASE
							WHEN FM38PM.CompStatus = 6 THEN 0
							ELSE 1
						END
				END = 1
			AND LD.AimSeqNumber = MAFM.AimSeqNumber
	'

	SET @SQLString += 
        N'
		LEFT JOIN #FM35PeriodFunding FM35P
			ON FM35P.LearnRefNumber = FM35.LearnRefNumber
			AND FM35P.AimSeqNumber = FM35.AimSeqNumber
		LEFT JOIN #FM35PeriodFunding FM35PM
			ON FM35PM.LearnRefNumber = FM35.LearnRefNumber
			AND FM35PM.LearnAimRef = ''ZPROG001''
			AND FM35PM.FundModel = LD.FundModel
			AND FM35PM.StdCode = COALESCE ( LD.StdCode, 0 )
			AND FM35PM.ProgType = LD.ProgType
			AND 
				CASE
					WHEN LD.CompStatus = 6 THEN
						CASE
							WHEN FM35PM.CompStatus = 6 THEN 1
							ELSE 0
						END
					ELSE
						CASE
							WHEN FM35PM.CompStatus = 6 THEN 0
							ELSE 1
						END
				END = 1
			AND LD.AimSeqNumber = MAFM.AimSeqNumber
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN #FM36PeriodFunding FM36P
			ON FM36P.LearnRefNumber = FM36.LearnRefNumber
			AND FM36P.AimSeqNumber = FM36.AimSeqNumber
			AND @AppsMoveFundingToMainComponentAim = 0
		LEFT JOIN #FM36PeriodFundingSummary FM36PM
			ON FM36PM.LearnRefNumber = FM36.LearnRefNumber
			AND FM36PM.FundModel = LD.FundModel
			AND FM36PM.StdCode = COALESCE ( LD.StdCode, 0 )
			AND FM36PM.ProgType = LD.ProgType
			AND LD.AimSeqNumber = MAFMA.AimSeqNumber
			AND @AppsMoveFundingToMainComponentAim = 1

		--WHERE
			--L.LearnRefNumber = ''11024003''
	'

	--SELECT @SQLString AS [processing-instruction(x)] FOR XML PATH('')

	SET @SQLParams = 
		N'@AcademicYear NVARCHAR(5),
		@ILRReturn NVARCHAR(3),
		@IsFinalReturn BIT,
		@Split1619Funding BIT,
		@Reapportion1619FundingByAimWeighting BIT,
		@AppsMoveFundingToMainComponentAim BIT,
		@1619ALSFundingPercent DECIMAL(5,2),
		@IncludeHEAdvLoanPossibleIncome BIT,
		@IncludeAdvLoanBursaryIncome BIT,
		@FutureAchievementWeighting DECIMAL(3,2),
		@EnglishMathsFundingHigherRate INT,
		@EnglishMathsFundingLowerRate INT,
		@AdvancedMathsPremiumFundingRate INT,
		@CoreMathsPremiumFundingRate INT,
		@Block2DisadvFundingTLevelRate INT,
		@Block2DisadvFundingHigherRate INT,
		@Block2DisadvFundingLowerRate INT,
		@HighValueCoursesPremiumFundingRate INT,
		@ConditionOfFundingAdjustment INT,
		@IndustryPlacementFullFundingRate INT,
		@LargeProgramme10PercentUpliftNumLearners INT,
		@LargeProgramme10PercentUpliftAmount INT,
		@LargeProgramme20PercentUpliftNumLearners INT,
		@LargeProgramme20PercentUpliftAmount INT,
		@Mode NCHAR(1),
		@FISOutputTableLocation NVARCHAR(200),
		@FISOutputTableName NVARCHAR(200),
		@ProvSpecDelMonCourseLocation1 NCHAR(1),
		@ProvSpecDelMonCourseLocation2 NCHAR(1),
		@ProvSpecDelMonCourseSeperator NVARCHAR(50),
		@ProvSpecDelMonParentCourseLocation1 NCHAR(1),
		@ProvSpecDelMonParentCourseLocation2 NCHAR(1),
		@ProvSpecDelMonParentCourseSeperator NVARCHAR(50),
		@EnglishCollegeLevel1Code NVARCHAR(50),
		@EnglishCollegeLevel2Code NVARCHAR(50),
		@EnglishCollegeLevel3Code NVARCHAR(50),
		@EnglishCollegeLevel4Code NVARCHAR(50),
		@MathsCollegeLevel1Code NVARCHAR(50),
		@MathsCollegeLevel2Code NVARCHAR(50),
		@MathsCollegeLevel3Code NVARCHAR(50),
		@MathsCollegeLevel4Code NVARCHAR(50),
		@PartnerCollegeLevel1Code NVARCHAR(50),
		@PartnerCollegeLevel2Code NVARCHAR(50),
		@PartnerCollegeLevel3Code NVARCHAR(50),
		@PartnerCollegeLevel4Code NVARCHAR(50)';
    
    EXECUTE sp_executesql 
		@SQLString, 
		@SQLParams, 
		@AcademicYear = @AcademicYear,
		@ILRReturn = @ILRReturn,
		@IsFinalReturn = @IsFinalReturn,
		@Split1619Funding = @Split1619Funding,
		@Reapportion1619FundingByAimWeighting = @Reapportion1619FundingByAimWeighting,
		@AppsMoveFundingToMainComponentAim = @AppsMoveFundingToMainComponentAim,
		@1619ALSFundingPercent = @1619ALSFundingPercent,
		@IncludeHEAdvLoanPossibleIncome = @IncludeHEAdvLoanPossibleIncome,
		@IncludeAdvLoanBursaryIncome = @IncludeAdvLoanBursaryIncome,
		@FutureAchievementWeighting = @FutureAchievementWeighting,
		@EnglishMathsFundingHigherRate = @EnglishMathsFundingHigherRate,
		@EnglishMathsFundingLowerRate = @EnglishMathsFundingLowerRate,
		@AdvancedMathsPremiumFundingRate = @AdvancedMathsPremiumFundingRate,
		@CoreMathsPremiumFundingRate = @CoreMathsPremiumFundingRate,
		@Block2DisadvFundingTLevelRate = @Block2DisadvFundingTLevelRate,
		@Block2DisadvFundingHigherRate = @Block2DisadvFundingHigherRate,
		@Block2DisadvFundingLowerRate = @Block2DisadvFundingLowerRate,
		@HighValueCoursesPremiumFundingRate = @HighValueCoursesPremiumFundingRate,
		@ConditionOfFundingAdjustment = @ConditionOfFundingAdjustment,
		@IndustryPlacementFullFundingRate = @IndustryPlacementFullFundingRate,
		@LargeProgramme10PercentUpliftNumLearners = @LargeProgramme10PercentUpliftNumLearners,
		@LargeProgramme10PercentUpliftAmount = @LargeProgramme10PercentUpliftAmount,
		@LargeProgramme20PercentUpliftNumLearners = @LargeProgramme20PercentUpliftNumLearners,
		@LargeProgramme20PercentUpliftAmount = @LargeProgramme20PercentUpliftAmount,
		@Mode = @Mode,
		@FISOutputTableLocation = @FISOutputTableLocation,
		@FISOutputTableName = @FISOutputTableName,
		@ProvSpecDelMonCourseLocation1 = @ProvSpecDelMonCourseLocation1,
		@ProvSpecDelMonCourseLocation2 = @ProvSpecDelMonCourseLocation2,
		@ProvSpecDelMonCourseSeperator = @ProvSpecDelMonCourseSeperator,
		@ProvSpecDelMonParentCourseLocation1 = @ProvSpecDelMonParentCourseLocation1,
		@ProvSpecDelMonParentCourseLocation2 = @ProvSpecDelMonParentCourseLocation2,
		@ProvSpecDelMonParentCourseSeperator = @ProvSpecDelMonParentCourseSeperator,
		@EnglishCollegeLevel1Code = @EnglishCollegeLevel1Code,
		@EnglishCollegeLevel2Code = @EnglishCollegeLevel2Code,
		@EnglishCollegeLevel3Code = @EnglishCollegeLevel3Code,
		@EnglishCollegeLevel4Code = @EnglishCollegeLevel4Code,
		@MathsCollegeLevel1Code = @MathsCollegeLevel1Code,
		@MathsCollegeLevel2Code = @MathsCollegeLevel2Code,
		@MathsCollegeLevel3Code = @MathsCollegeLevel3Code,
		@MathsCollegeLevel4Code = @MathsCollegeLevel4Code,
		@PartnerCollegeLevel1Code = @PartnerCollegeLevel1Code,
		@PartnerCollegeLevel2Code = @PartnerCollegeLevel2Code,
		@PartnerCollegeLevel3Code = @PartnerCollegeLevel3Code,
		@PartnerCollegeLevel4Code = @PartnerCollegeLevel4Code;

END